<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Allquiz - Enhanced Real-time Quiz Management System">
  <title>Allquiz - Real-time Enhanced System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007AFF',
            secondary: '#5856D6',
            accent: '#FF3B30',
            success: '#34C759',
            warning: '#FF9500',
            ios: {
              gray: '#F2F2F7',
              darkGray: '#8E8E93',
              lightGray: '#F8F8F8'
            }
          },
          fontFamily: {
            'sf': ['SF Pro Display', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-ring': 'pulseRing 2s infinite',
            'slide-up': 'slideUp 0.3s ease-out',
            'scale-in': 'scaleIn 0.2s ease-out',
            'notification-slide': 'notificationSlide 0.4s ease-out',
            'realtime-glow': 'realtimeGlow 2s ease-in-out infinite alternate',
          }
        }
      }
    }
  </script>
  
  <style>
    @keyframes pulseRing {
      0% { transform: scale(0.9); opacity: 1; }
      100% { transform: scale(1.2); opacity: 0; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes notificationSlide {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes realtimeGlow {
      from { box-shadow: 0 0 20px rgba(52, 199, 89, 0.5); }
      to { box-shadow: 0 0 30px rgba(52, 199, 89, 0.8); }
    }
    
    .glass-morphism {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .realtime-indicator {
      position: relative;
    }
    
    .realtime-indicator::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: #34C759;
      animation: pulse-ring 2s infinite;
      z-index: -1;
    }
    
    .notification-toast {
      animation: notification-slide 0.4s ease-out;
    }
    
    .analytics-chart {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .quiz-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    .loading-dots {
      display: inline-block;
    }
    
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .animate-slide-up {
      animation: slideUp 0.5s ease-out forwards;
    }
    
    .animate-scale-in {
      animation: scaleIn 0.3s ease-out forwards;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-sf">
  
  <!-- Real-time Status Bar -->
  <div id="realtime-status" class="fixed top-0 left-0 right-0 bg-success text-white text-center py-2 text-sm z-50 realtime-glow">
    <div class="flex items-center justify-center space-x-2">
      <div class="w-3 h-3 bg-white rounded-full realtime-indicator"></div>
      <span>ระบบเรียลไทม์เชื่อมต่อแล้ว</span>
      <span id="last-sync-time" class="opacity-75"></span>
    </div>
  </div>

  <!-- Enhanced Navigation -->
  <nav class="fixed top-12 left-1/2 transform -translate-x-1/2 z-40">
    <div class="glass-morphism px-6 py-3 rounded-3xl flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
          <i class="fas fa-graduation-cap text-white"></i>
        </div>
        <span class="text-gray-800 font-semibold">Allquiz Enhanced</span>
      </div>
      
      <div class="flex items-center space-x-3">
        <button onclick="window.toggleRealTimeNotifications()" class="relative p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-bell text-gray-700"></i>
          <span id="notification-count" class="absolute -top-1 -right-1 w-5 h-5 bg-accent text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
        </button>
        
        <button onclick="window.toggleAnalytics()" class="p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-chart-line text-gray-700"></i>
        </button>
        
        <button onclick="window.showAdminPanel()" class="p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-cog text-gray-700"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Real-time Notifications Panel -->
  <div id="realtime-notifications" class="fixed top-20 right-4 w-80 max-h-96 overflow-y-auto z-40 space-y-2 hidden">
    <div class="glass-morphism rounded-2xl p-4 border">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-800">การแจ้งเตือนแบบเรียลไทม์</h3>
        <button onclick="window.clearAllNotifications()" class="text-xs text-gray-500 hover:text-gray-700">
          ล้างทั้งหมด
        </button>
      </div>
      <div id="notification-list" class="space-y-2">
        <p class="text-gray-500 text-sm text-center py-4">ไม่มีการแจ้งเตือน</p>
      </div>
    </div>
  </div>

  <!-- Analytics Panel -->
  <div id="analytics-panel" class="fixed inset-4 bg-white rounded-3xl shadow-2xl z-50 hidden overflow-hidden">
    <div class="analytics-chart text-white p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold">Analytics Dashboard</h2>
          <p class="opacity-90">ข้อมูลการใช้งานแบบเรียลไทม์</p>
        </div>
        <button onclick="window.toggleAnalytics()" class="text-white/80 hover:text-white">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    
    <div class="p-6 overflow-y-auto" style="max-height: calc(100vh - 200px);">
      <!-- Real-time Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-blue-600" id="realtime-users">0</div>
              <div class="text-sm text-gray-600">ผู้ใช้ออนไลน์</div>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
              <i class="fas fa-users text-blue-600"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-green-50 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-green-600" id="quiz-accessed-today">0</div>
              <div class="text-sm text-gray-600">ควิซที่เข้าถึงวันนี้</div>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
              <i class="fas fa-eye text-green-600"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-purple-50 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-purple-600" id="updates-today">0</div>
              <div class="text-sm text-gray-600">อัพเดตวันนี้</div>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
              <i class="fas fa-sync-alt text-purple-600"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-orange-50 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-2xl font-bold text-orange-600" id="avg-response-time">0ms</div>
              <div class="text-sm text-gray-600">เวลาตอบสนองเฉลี่ย</div>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
              <i class="fas fa-tachometer-alt text-orange-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Feed -->
      <div class="bg-gray-50 rounded-2xl p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">กิจกรรมล่าสุด</h3>
        <div id="activity-feed" class="space-y-3 max-h-60 overflow-y-auto">
          <div class="flex items-center space-x-3 text-sm">
            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
            <span class="text-gray-600">[เมื่อสักครู่] ระบบเริ่มต้นการทำงาน</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="pt-32 pb-8 px-4">
    <div class="max-w-7xl mx-auto">
      
      <!-- Enhanced Hero Section -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
          Allquiz Enhanced
        </h1>
        <p class="text-gray-600 text-xl mb-8">ระบบเฉลยคำตอบแบบเรียลไทม์พร้อมการวิเคราะห์ขั้นสูง</p>
        
        <!-- Real-time Stats -->
        <div class="flex justify-center space-x-8 mb-8">
          <div class="text-center">
            <div class="text-3xl font-bold text-primary" id="total-subjects">0</div>
            <div class="text-sm text-gray-500">วิชา</div>
            <div class="w-8 h-1 bg-primary/20 rounded-full mx-auto mt-1">
              <div class="h-full bg-primary rounded-full transition-all duration-500" style="width: 75%"></div>
            </div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-secondary" id="total-quizzes">0</div>
            <div class="text-sm text-gray-500">ควิซทั้งหมด</div>
            <div class="w-8 h-1 bg-secondary/20 rounded-full mx-auto mt-1">
              <div class="h-full bg-secondary rounded-full transition-all duration-500" style="width: 60%"></div>
            </div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-success" id="active-quizzes">0</div>
            <div class="text-sm text-gray-500">พร้อมใช้</div>
            <div class="w-8 h-1 bg-success/20 rounded-full mx-auto mt-1">
              <div class="h-full bg-success rounded-full transition-all duration-500" style="width: 90%"></div>
            </div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-orange-500" id="expiring-soon">0</div>
            <div class="text-sm text-gray-500">ใกล้หมดอายุ</div>
            <div class="w-8 h-1 bg-orange-200 rounded-full mx-auto mt-1">
              <div class="h-full bg-orange-500 rounded-full transition-all duration-500" style="width: 25%"></div>
            </div>
          </div>
        </div>

        <!-- Connection Status -->
        <div class="inline-flex items-center space-x-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm">
          <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
          <span>เชื่อมต่อแบบเรียลไทม์</span>
          <span id="connection-status">•</span>
          <span class="loading-dots" id="sync-indicator">ซิงค์ข้อมูล</span>
        </div>
      </div>

      <!-- Enhanced Search -->
      <div class="mb-8">
        <div class="glass-morphism rounded-3xl p-6 border">
          <div class="relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input 
              type="text" 
              id="search-input"
              placeholder="ค้นหาวิชาหรือควิซ... (รองรับการค้นหาแบบเรียลไทม์)"
              class="w-full pl-12 pr-20 py-4 bg-white/50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-primary/50 text-gray-800"
            >
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
              <span id="search-results-count" class="text-xs text-gray-500 hidden"></span>
              <button onclick="window.toggleSearchFilters()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg">
                <i class="fas fa-filter"></i>
              </button>
            </div>
          </div>
          
          <!-- Search Filters -->
          <div id="search-filters" class="hidden mt-4 pt-4 border-t border-gray-200">
            <div class="flex flex-wrap gap-2">
              <button onclick="window.filterByStatus('all')" class="filter-btn active px-3 py-1 bg-primary text-white rounded-full text-sm">
                ทั้งหมด
              </button>
              <button onclick="window.filterByStatus('active')" class="filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                พร้อมใช้
              </button>
              <button onclick="window.filterByStatus('expired')" class="filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                หมดอายุ
              </button>
              <button onclick="window.filterByStatus('updated')" class="filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                อัพเดตล่าสุด
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Subjects Grid -->
      <section id="subjects-section">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl font-bold text-gray-800">เลือกวิชาที่ต้องการ</h2>
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500">อัพเดตล่าสุด:</span>
            <span id="last-update-display" class="text-sm font-medium text-primary">เมื่อสักครู่</span>
          </div>
        </div>
        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <!-- Subjects will be loaded here -->
        </div>
      </section>

      <!-- Quiz List Section -->
      <section id="quiz-section" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 id="quiz-section-title" class="text-3xl font-bold text-gray-800">ควิซในวิชา</h2>
            <p class="text-gray-600 mt-1">อัพเดตแบบเรียลไทม์</p>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="window.sortQuizzes('name')" class="px-4 py-2 bg-gray-100 rounded-xl text-sm hover:bg-gray-200 transition-colors">
              <i class="fas fa-sort-alpha-down mr-2"></i>เรียงตามชื่อ
            </button>
            <button onclick="window.sortQuizzes('date')" class="px-4 py-2 bg-gray-100 rounded-xl text-sm hover:bg-gray-200 transition-colors">
              <i class="fas fa-clock mr-2"></i>ล่าสุด
            </button>
            <button onclick="window.goBackToSubjects()" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
              <i class="fas fa-arrow-left mr-2"></i>กลับ
            </button>
          </div>
        </div>
        <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Quizzes will be loaded here -->
        </div>
      </section>
    </div>
  </div>

  <!-- Enhanced Admin Panel -->
  <div id="admin-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
      
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-primary rounded-2xl flex items-center justify-center">
              <i class="fas fa-shield-alt text-white text-xl"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold">Enhanced Admin Panel</h2>
              <p class="text-gray-300">Real-time Management System</p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 text-sm">
              <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
              <span>Real-time Active</span>
            </div>
            <button onclick="window.closeAdminPanel()" class="text-white/70 hover:text-white transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Admin Content -->
      <div class="flex h-full" style="max-height: calc(90vh - 120px);">
        
        <!-- Sidebar -->
        <div class="w-64 bg-gray-50 p-4 border-r">
          <nav class="space-y-2">
            <button onclick="window.switchAdminTab('realtime')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all bg-primary text-white">
              <i class="fas fa-broadcast-tower mr-3"></i>Real-time Monitor
            </button>
            <button onclick="window.switchAdminTab('analytics')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-chart-bar mr-3"></i>Analytics
            </button>
            <button onclick="window.switchAdminTab('notifications')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-bell mr-3"></i>Notification System
            </button>
            <button onclick="window.switchAdminTab('data')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-database mr-3"></i>Data Management
            </button>
            <button onclick="window.switchAdminTab('debug')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-bug mr-3"></i>Debug Console
            </button>
            <button onclick="window.switchAdminTab('settings')" class="admin-nav-btn w-full text-left px-4 py-3 rounded-xl text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-cog mr-3"></i>System Settings
            </button>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-y-auto">
          
          <!-- Real-time Monitor Tab -->
          <div id="tab-realtime" class="admin-tab-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Real-time System Monitor</h3>
            
            <!-- Connection Status -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-green-50 rounded-2xl p-4 border border-green-200">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-wifi text-green-600 text-xl"></i>
                  </div>
                  <div>
                    <div class="font-semibold text-gray-800">WebSocket Connection</div>
                    <div class="text-sm text-green-600">Connected & Active</div>
                  </div>
                </div>
              </div>
              
              <div class="bg-blue-50 rounded-2xl p-4 border border-blue-200">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-sync-alt text-blue-600 text-xl"></i>
                  </div>
                  <div>
                    <div class="font-semibold text-gray-800">Auto Sync</div>
                    <div class="text-sm text-blue-600">Every 30 seconds</div>
                  </div>
                </div>
              </div>
              
              <div class="bg-purple-50 rounded-2xl p-4 border border-purple-200">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-bell text-purple-600 text-xl"></i>
                  </div>
                  <div>
                    <div class="font-semibold text-gray-800">Push Notifications</div>
                    <div class="text-sm text-purple-600">Enabled</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Live Activity Log -->
            <div class="bg-white rounded-2xl border p-6">
              <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-semibold text-gray-800">Live Activity Log</h4>
                <button onclick="window.clearActivityLog()" class="text-sm text-gray-500 hover:text-gray-700">
                  Clear Log
                </button>
              </div>
              <div id="live-activity-log" class="space-y-2 max-h-80 overflow-y-auto">
                <div class="flex items-center space-x-3 text-sm bg-gray-50 rounded-lg p-3">
                  <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span class="text-gray-600">[เมื่อสักครู่] Real-time system initialized</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Other admin tabs -->
          <div id="tab-analytics" class="admin-tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Advanced Analytics</h3>
            <p class="text-gray-600">Analytics content goes here...</p>
          </div>

          <div id="tab-notifications" class="admin-tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Notification Management</h3>
            <p class="text-gray-600">Notification settings go here...</p>
          </div>

          <div id="tab-data" class="admin-tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Data Management</h3>
            <p class="text-gray-600">Data management tools go here...</p>
          </div>

          <div id="tab-debug" class="admin-tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Debug Console</h3>
            <div id="debug-logs" class="space-y-2 max-h-96 overflow-y-auto bg-gray-50 rounded-xl p-4">
              <div class="text-center text-gray-500 py-4">
                <i class="fas fa-terminal text-2xl mb-2"></i>
                <p>Debug logs will appear here</p>
              </div>
            </div>
          </div>

          <div id="tab-settings" class="admin-tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">System Settings</h3>
            <p class="text-gray-600">System configuration options go here...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Toast Container -->
  <div id="toast-container" class="fixed bottom-6 right-6 space-y-3 z-50">
    <!-- Toast notifications will appear here -->
  </div>

  <script>
    // Enhanced Configuration
    const CONFIG = {
      SHEET_ID: "1-7p30j2PR8oLeyJ02vMq1ut5IZ6iSh8zvMFS50w74Lc",
      QUIZ_RANGE: "Allquestions",
      API_KEY: "AIzaSyDpvXNmtRybEEu9JXzKOWF3F61-3tM5SCE",
      REALTIME_SYNC_INTERVAL: 30000,
      NOTIFICATION_TIMEOUT: 5000,
      MAX_NOTIFICATIONS: 100,
      CONNECTION_TIMEOUT: 5000,
      RETRY_ATTEMPTS: 3
    };

    // Enhanced Global State
    let state = {
      subjects: {},
      currentSubject: null,
      notifications: [],
      isConnected: false,
      lastSync: null,
      searchResults: null,
      currentFilter: 'all',
      sortOrder: 'name',
      analytics: {
        pageViews: 0,
        quizAccesses: 0,
        totalUsers: 0,
        averageSessionTime: 0,
        errorCount: 0
      },
      realTimeData: {
        activeUsers: 0,
        recentActivities: [],
        connectionStatus: 'connected'
      }
    };

    // Google Sheets API (Fixed)
    const SheetsAPI = {
      async readData(range = CONFIG.QUIZ_RANGE) {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
        
        try {
          const startTime = performance.now();
          const response = await fetch(url, {
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json; charset=utf-8'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const rawText = await response.text();
          let data;
          
          try {
            data = JSON.parse(rawText);
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            throw new Error(`Invalid JSON response: ${parseError.message}`);
          }
          
          const responseTime = performance.now() - startTime;
          const sanitizedData = this.sanitizeData(data.values || []);
          
          state.analytics.pageViews++;
          
          return sanitizedData;
        } catch (error) {
          state.analytics.errorCount++;
          console.error('SheetsAPI Error:', error);
          throw error;
        }
      },

      generateDataHash(data) {
        try {
          const dataString = JSON.stringify(data);
          let hash = 0;
          for (let i = 0; i < dataString.length; i++) {
            const char = dataString.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
          }
          return hash.toString(16);
        } catch (error) {
          console.warn('Hash generation failed, using timestamp:', error);
          return Date.now().toString(16);
        }
      },

      sanitizeData(rawData) {
        if (!Array.isArray(rawData)) {
          console.warn('Invalid data format, expected array');
          return [];
        }

        return rawData.map((row, rowIndex) => {
          if (!Array.isArray(row)) {
            console.warn(`Invalid row format at index ${rowIndex}`);
            return [];
          }

          return row.map((cell) => {
            if (cell === null || cell === undefined) {
              return '';
            }

            let sanitized = String(cell);
            sanitized = sanitized.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
            sanitized = sanitized
              .replace(/â€™/g, "'")
              .replace(/â€œ/g, '"')
              .replace(/â€/g, '"')
              .replace(/â€¦/g, '...')
              .replace(/Â/g, '');
            
            return sanitized.trim();
          });
        });
      }
    };

    // Real-time System
    class RealTimeSystem {
      constructor() {
        this.syncInterval = null;
        this.connected = false;
        this.retryCount = 0;
      }

      async initialize() {
        try {
          await this.connect();
          this.startPeriodicSync();
          this.updateConnectionStatus(true);
          this.logActivity('System', 'Real-time system initialized successfully');
        } catch (error) {
          console.error('Failed to initialize real-time system:', error);
          this.updateConnectionStatus(false);
          this.scheduleRetry();
        }
      }

      async connect() {
        return new Promise((resolve) => {
          setTimeout(() => {
            this.connected = true;
            this.retryCount = 0;
            resolve();
          }, 1000);
        });
      }

      startPeriodicSync() {
        if (this.syncInterval) {
          clearInterval(this.syncInterval);
        }

        this.syncInterval = setInterval(async () => {
          try {
            await this.syncData();
            this.updateLastSyncTime();
          } catch (error) {
            console.error('Sync failed:', error);
            this.handleSyncError(error);
          }
        }, CONFIG.REALTIME_SYNC_INTERVAL);
      }

      async syncData() {
        const startTime = performance.now();
        
        try {
          const data = await SheetsAPI.readData();
          const processingTime = performance.now() - startTime;
          
          const newHash = SheetsAPI.generateDataHash(data);
          if (state.lastDataHash && state.lastDataHash !== newHash) {
            const changes = this.detectChanges(state.lastData, data);
            this.processDataChanges(changes);
          }
          
          state.lastData = data;
          state.lastDataHash = newHash;
          
          document.getElementById('avg-response-time').textContent = Math.round(processingTime) + 'ms';
          
          await this.updateSubjectData(data);
          this.logActivity('Sync', `Data synchronized (${Math.round(processingTime)}ms)`);
          
        } catch (error) {
          throw new Error(`Sync failed: ${error.message}`);
        }
      }

      detectChanges(oldData, newData) {
        const changes = { added: [], modified: [], removed: [] };
        if (!oldData || !Array.isArray(oldData) || !Array.isArray(newData)) {
          return changes;
        }

        try {
          if (newData.length > oldData.length) {
            changes.added = newData.slice(oldData.length);
          }

          const minLength = Math.min(oldData.length, newData.length);
          for (let i = 1; i < minLength; i++) {
            if (JSON.stringify(oldData[i]) !== JSON.stringify(newData[i])) {
              changes.modified.push(newData[i]);
            }
          }
        } catch (error) {
          console.warn('Change detection failed:', error);
        }

        return changes;
      }

      processDataChanges(changes) {
        try {
          if (changes.added.length > 0) {
            this.notifyNewQuizzes(changes.added);
          }
          if (changes.modified.length > 0) {
            this.notifyQuizUpdates(changes.modified);
          }
        } catch (error) {
          console.error('Error processing data changes:', error);
        }
      }

      notifyNewQuizzes(newQuizzes) {
        try {
          newQuizzes.forEach((quiz) => {
            if (quiz && quiz[1] && String(quiz[1]).trim()) {
              const quizName = String(quiz[1]).trim();
              this.addNotification({
                type: 'quiz-new',
                title: 'ควิซใหม่!',
                message: `มีควิซใหม่: ${quizName}`,
                timestamp: new Date(),
                icon: 'fa-plus-circle',
                color: 'green'
              });
            }
          });
        } catch (error) {
          console.error('Error notifying new quizzes:', error);
        }
      }

      notifyQuizUpdates(updatedQuizzes) {
        try {
          updatedQuizzes.forEach((quiz) => {
            if (quiz && quiz[1] && String(quiz[1]).trim()) {
              const quizName = String(quiz[1]).trim();
              this.addNotification({
                type: 'quiz-update',
                title: 'ควิซอัพเดต',
                message: `ควิซ ${quizName} มีการอัพเดต`,
                timestamp: new Date(),
                icon: 'fa-sync-alt',
                color: 'blue'
              });
            }
          });
        } catch (error) {
          console.error('Error notifying quiz updates:', error);
        }
      }

      async updateSubjectData(rawData) {
        state.subjects = {};
        let totalQuizzes = 0;
        let activeQuizzes = 0;
        let expiringSoon = 0;

        rawData.slice(1).forEach(row => {
          const [subject, quizName, quizLink, quizDescription, expiryDate, status] = row || [];
          
          if (subject && subject.trim()) {
            if (!state.subjects[subject]) {
              state.subjects[subject] = [];
            }
            
            if (quizName) {
              const quiz = { 
                id: Date.now() + Math.random(),
                quizName, 
                quizLink, 
                quizDescription, 
                expiryDate, 
                status,
                subject,
                lastUpdated: new Date().toLocaleString('th-TH')
              };
              
              state.subjects[subject].push(quiz);
              totalQuizzes++;
              
              if (quizLink && !this.isExpired(expiryDate)) {
                activeQuizzes++;
              }
              
              if (this.isExpiringSoon(expiryDate)) {
                expiringSoon++;
              }
            }
          }
        });

        this.animateCounter('total-subjects', Object.keys(state.subjects).length);
        this.animateCounter('total-quizzes', totalQuizzes);
        this.animateCounter('active-quizzes', activeQuizzes);
        this.animateCounter('expiring-soon', expiringSoon);

        renderSubjects();
      }

      animateCounter(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const currentValue = parseInt(element.textContent) || 0;
        const increment = Math.ceil((targetValue - currentValue) / 10);
        
        if (currentValue !== targetValue) {
          element.textContent = Math.min(currentValue + increment, targetValue);
          if (currentValue + increment < targetValue) {
            setTimeout(() => this.animateCounter(elementId, targetValue), 50);
          }
        }
      }

      isExpired(expiryDate) {
        if (!expiryDate) return false;
        try {
          const [date, time] = expiryDate.split(", ");
          const [day, month, year] = date.split("/");
          const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
          return new Date(formattedDate).getTime() < Date.now();
        } catch {
          return false;
        }
      }

      isExpiringSoon(expiryDate, daysThreshold = 7) {
        if (!expiryDate) return false;
        try {
          const [date, time] = expiryDate.split(", ");
          const [day, month, year] = date.split("/");
          const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
          const timeLeft = new Date(formattedDate).getTime() - Date.now();
          const daysLeft = timeLeft / (1000 * 60 * 60 * 24);
          return daysLeft > 0 && daysLeft <= daysThreshold;
        } catch {
          return false;
        }
      }

      updateConnectionStatus(connected) {
        this.connected = connected;
        state.isConnected = connected;
        
        const statusBar = document.getElementById('realtime-status');
        
        if (connected) {
          statusBar.className = 'fixed top-0 left-0 right-0 bg-success text-white text-center py-2 text-sm z-50 realtime-glow';
          statusBar.innerHTML = `
            <div class="flex items-center justify-center space-x-2">
              <div class="w-3 h-3 bg-white rounded-full realtime-indicator"></div>
              <span>ระบบเรียลไทม์เชื่อมต่อแล้ว</span>
              <span id="last-sync-time" class="opacity-75"></span>
            </div>
          `;
        } else {
          statusBar.className = 'fixed top-0 left-0 right-0 bg-red-500 text-white text-center py-2 text-sm z-50';
          statusBar.innerHTML = `
            <div class="flex items-center justify-center space-x-2">
              <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
              <span>การเชื่อมต่อขาดหาย - กำลังลองใหม่</span>
            </div>
          `;
        }
      }

      updateLastSyncTime() {
        const now = new Date();
        state.lastSync = now;
        const timeString = now.toLocaleTimeString('th-TH');
        
        const elements = document.querySelectorAll('#last-sync-time, #last-update-display');
        elements.forEach(el => {
          if (el) el.textContent = `อัพเดต: ${timeString}`;
        });
      }

      scheduleRetry() {
        if (this.retryCount < CONFIG.RETRY_ATTEMPTS) {
          this.retryCount++;
          const delay = Math.pow(2, this.retryCount) * 1000;
          
          setTimeout(async () => {
            try {
              await this.initialize();
            } catch (error) {
              this.scheduleRetry();
            }
          }, delay);
        }
      }

      handleSyncError(error) {
        state.analytics.errorCount++;
        this.logActivity('Error', `Sync error: ${error.message}`);
        
        if (!this.connected) {
          this.updateConnectionStatus(false);
          this.scheduleRetry();
        }
      }

      addNotification(notification) {
        notification.id = Date.now() + Math.random();
        state.notifications.unshift(notification);
        
        if (state.notifications.length > CONFIG.MAX_NOTIFICATIONS) {
          state.notifications = state.notifications.slice(0, CONFIG.MAX_NOTIFICATIONS);
        }
        
        this.showNotificationToast(notification);
        this.updateNotificationUI();
        this.logActivity('Notification', notification.message);
      }

      showNotificationToast(notification) {
        const toast = document.createElement('div');
        toast.className = `notification-toast flex items-center space-x-3 bg-white border border-gray-200 rounded-2xl p-4 shadow-lg max-w-sm`;
        
        const colorClasses = {
          green: 'text-green-500',
          blue: 'text-blue-500',
          orange: 'text-orange-500',
          red: 'text-red-500'
        };
        
        toast.innerHTML = `
          <div class="w-10 h-10 bg-${notification.color}-50 rounded-xl flex items-center justify-center">
            <i class="fas ${notification.icon} ${colorClasses[notification.color]} text-lg"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-medium text-gray-800 text-sm">${notification.title}</div>
            <div class="text-gray-600 text-xs">${notification.message}</div>
          </div>
          <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-sm"></i>
          </button>
        `;
        
        document.getElementById('toast-container').appendChild(toast);
        
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, CONFIG.NOTIFICATION_TIMEOUT);
      }

      updateNotificationUI() {
        const badge = document.getElementById('notification-count');
        const count = state.notifications.length;
        
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }

      logActivity(category, message, data = null) {
        const activity = {
          timestamp: new Date().toLocaleTimeString('th-TH'),
          category,
          message
        };
        
        state.realTimeData.recentActivities.unshift(activity);
        
        if (state.realTimeData.recentActivities.length > 50) {
          state.realTimeData.recentActivities = state.realTimeData.recentActivities.slice(0, 50);
        }
        
        this.updateActivityLog();
      }

      updateActivityLog() {
        const logs = [
          document.getElementById('live-activity-log'),
          document.getElementById('activity-feed')
        ];
        
        logs.forEach(log => {
          if (!log) return;
          
          log.innerHTML = '';
          
          state.realTimeData.recentActivities.slice(0, 10).forEach(activity => {
            const item = document.createElement('div');
            item.className = 'flex items-center space-x-3 text-sm bg-gray-50 rounded-lg p-3';
            
            item.innerHTML = `
              <div class="w-2 h-2 bg-green-500 rounded-full"></div>
              <span class="text-gray-600">[${activity.timestamp}] ${activity.message}</span>
            `;
            
            log.appendChild(item);
          });
        });
      }

      disconnect() {
        if (this.syncInterval) {
          clearInterval(this.syncInterval);
          this.syncInterval = null;
        }
        this.connected = false;
        this.updateConnectionStatus(false);
        this.logActivity('System', 'Real-time system disconnected');
      }
    }

    // Initialize Real-time System
    const realTimeSystem = new RealTimeSystem();

    // Enhanced UI Functions
    function renderSubjects() {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';

      const subjects = state.searchResults || state.subjects;

      if (Object.keys(subjects).length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-book-open text-gray-400 text-6xl mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-600 mb-2">ไม่มีข้อมูลวิชา</h3>
            <p class="text-gray-500">กำลังโหลดข้อมูลจาก Google Sheets...</p>
          </div>
        `;
        return;
      }

      Object.entries(subjects).forEach(([subject, quizzes], index) => {
        const card = createEnhancedSubjectCard(subject, quizzes, index);
        grid.appendChild(card);
      });
    }

    function createEnhancedSubjectCard(subject, quizzes, index) {
      const availableQuizzes = quizzes.filter(q => q.quizName && q.quizLink && !realTimeSystem.isExpired(q.expiryDate)).length;
      const expiringSoon = quizzes.filter(q => realTimeSystem.isExpiringSoon(q.expiryDate)).length;
      const hasQuizzes = quizzes.some(q => q.quizName);
      
      const card = document.createElement('div');
      card.className = `quiz-card glass-morphism rounded-3xl p-6 border cursor-pointer transition-all duration-300 ${hasQuizzes ? 'hover:shadow-2xl' : 'opacity-75'}`;
      card.style.animationDelay = `${index * 100}ms`;
      
      const icon = getSubjectIcon(subject);
      
      let statusIndicator = '';
      if (expiringSoon > 0) {
        statusIndicator = `
          <div class="absolute top-4 right-4 w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
          <div class="absolute top-2 right-2 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">
            ${expiringSoon} ใกล้หมดอายุ
          </div>
        `;
      }
      
      card.innerHTML = `
        <div class="relative">
          ${statusIndicator}
          <div class="text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-primary to-secondary rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <i class="fas ${icon} text-white text-3xl"></i>
            </div>
            <h3 class="font-bold text-gray-800 mb-3 text-xl">${subject}</h3>
            ${!hasQuizzes ? 
              '<div class="inline-block px-4 py-2 bg-yellow-100 text-yellow-800 text-sm rounded-2xl font-medium">รออัพเดต</div>' :
              `<div class="space-y-2">
                <div class="inline-block px-4 py-2 bg-green-100 text-green-800 text-sm rounded-2xl font-medium">
                  ${availableQuizzes} ควิซพร้อมใช้
                </div>
                ${expiringSoon > 0 ? 
                  `<div class="inline-block px-4 py-2 bg-orange-100 text-orange-800 text-sm rounded-2xl font-medium">
                    ${expiringSoon} ใกล้หมดอายุ
                  </div>` : ''
                }
              </div>`
            }
            <div class="mt-4 text-xs text-gray-500">
              อัพเดตล่าสุด: ${state.lastSync ? state.lastSync.toLocaleTimeString('th-TH') : 'กำลังโหลด...'}
            </div>
          </div>
        </div>
      `;
      
      if (hasQuizzes) {
        card.addEventListener('click', () => {
          showQuizzes(subject);
          state.analytics.quizAccesses++;
          realTimeSystem.logActivity('User', `Viewed quizzes for subject: ${subject}`);
        });
      }
      
      return card;
    }

    function getSubjectIcon(subject) {
      const icons = {
        'คอมพิวเตอร์': 'fa-laptop-code',
        'คณิตศาสตร์': 'fa-calculator',
        'วิทยาศาสตร์': 'fa-flask',
        'ภาษา': 'fa-language',
        'ประวัติศาสตร์': 'fa-landmark',
        'ภูมิศาสตร์': 'fa-globe',
        'ฟิสิกส์': 'fa-atom',
        'เคมี': 'fa-vial',
        'ชีววิทยา': 'fa-dna',
        'default': 'fa-book'
      };
      
      for (const [key, icon] of Object.entries(icons)) {
        if (subject.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      return icons.default;
    }

    function showQuizzes(subject) {
      state.currentSubject = subject;
      const quizzes = state.subjects[subject];
      
      document.getElementById('subjects-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-section-title').textContent = `ควิซในวิชา ${subject}`;
      
      renderQuizzes(quizzes);
    }

    function renderQuizzes(quizzes) {
      const grid = document.getElementById('quiz-grid');
      grid.innerHTML = '';

      const sortedQuizzes = [...quizzes].sort((a, b) => {
        if (state.sortOrder === 'name') {
          return (a.quizName || '').localeCompare(b.quizName || '');
        } else {
          return new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0);
        }
      });

      sortedQuizzes.forEach((quiz, index) => {
        if (!quiz.quizName) return;
        
        const card = createEnhancedQuizCard(quiz, index);
        grid.appendChild(card);
      });
    }

    function createEnhancedQuizCard(quiz, index) {
      const isExpiredQuiz = realTimeSystem.isExpired(quiz.expiryDate);
      const isExpiringSoon = realTimeSystem.isExpiringSoon(quiz.expiryDate);
      const countdown = quiz.expiryDate ? calculateCountdown(quiz.expiryDate) : null;
      
      const card = document.createElement('div');
      card.className = 'quiz-card glass-morphism rounded-3xl p-6 border transition-all duration-300 hover:shadow-2xl animate-slide-up';
      card.style.animationDelay = `${index * 100}ms`;
      
      let statusBadge = '';
      let statusIndicator = '';
      
      if (isExpiredQuiz) {
        statusBadge = '<div class="inline-block px-4 py-2 bg-red-100 text-red-800 text-sm rounded-2xl font-medium mb-3">หมดอายุแล้ว</div>';
        statusIndicator = '<div class="absolute top-4 right-4 w-3 h-3 bg-red-500 rounded-full"></div>';
      } else if (isExpiringSoon) {
        statusBadge = `<div class="inline-block px-4 py-2 bg-orange-100 text-orange-800 text-sm rounded-2xl font-medium mb-3"><i class="fas fa-clock mr-1"></i>${countdown}</div>`;
        statusIndicator = '<div class="absolute top-4 right-4 w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>';
      } else if (quiz.status) {
        const statusColors = {
          'อัพเดตล่าสุด': 'bg-green-100 text-green-800',
          'รออัพเดต': 'bg-yellow-100 text-yellow-800',
          'ปิดปรับปรุง': 'bg-red-100 text-red-800'
        };
        const colorClass = statusColors[quiz.status] || 'bg-gray-100 text-gray-800';
        statusBadge = `<div class="inline-block px-4 py-2 ${colorClass} text-sm rounded-2xl font-medium mb-3">${quiz.status}</div>`;
      }
      
      card.innerHTML = `
        <div class="relative">
          ${statusIndicator}
          <div class="flex items-start space-x-4">
            <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center flex-shrink-0">
              <i class="fas fa-file-alt text-gray-600 text-2xl"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-bold text-gray-800 mb-2 text-lg leading-tight">${quiz.quizName}</h3>
              ${statusBadge}
              ${quiz.quizDescription ? `<p class="text-gray-600 text-sm mb-4 leading-relaxed">${quiz.quizDescription}</p>` : ''}
              
              <div class="flex items-center justify-between mt-4">
                ${quiz.quizLink && !isExpiredQuiz ? 
                  `<button onclick="window.accessQuiz('${quiz.quizLink}', '${quiz.quizName}')" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white text-sm rounded-2xl hover:shadow-lg transition-all font-medium">
                    <i class="fas fa-external-link-alt mr-2"></i>ดูเฉลย
                  </button>` :
                  '<span class="px-6 py-3 bg-gray-100 text-gray-600 text-sm rounded-2xl font-medium">ไม่พร้อมใช้งาน</span>'
                }
                
                <div class="text-right">
                  <div class="text-xs text-gray-500">อัพเดต: ${quiz.lastUpdated || 'ไม่ระบุ'}</div>
                  ${countdown && !isExpiredQuiz ? `<div class="text-xs text-orange-600 font-medium">${countdown}</div>` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }

    function calculateCountdown(expiryDate) {
      if (!expiryDate) return '';
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        const timeLeft = new Date(formattedDate).getTime() - Date.now();
        
        if (timeLeft <= 0) return 'หมดเวลา';
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 7) return `${days} วัน`;
        if (days > 0) return `${days} วัน ${hours} ชม.`;
        if (hours > 0) return `${hours} ชม. ${minutes} นาที`;
        return `${minutes} นาที`;
      } catch {
        return '';
      }
    }

    // Global function definitions for onclick handlers
    window.accessQuiz = function(link, name) {
      state.analytics.quizAccesses++;
      realTimeSystem.logActivity('User', `Accessed quiz: ${name}`);
      
      realTimeSystem.addNotification({
        type: 'quiz-access',
        title: 'เข้าถึงควิซ',
        message: `เปิดดูเฉลย: ${name}`,
        timestamp: new Date(),
        icon: 'fa-external-link-alt',
        color: 'blue'
      });
      
      window.open(link, '_blank');
    };

    window.toggleRealTimeNotifications = function() {
      const panel = document.getElementById('realtime-notifications');
      panel.classList.toggle('hidden');
      
      if (!panel.classList.contains('hidden')) {
        updateNotificationList();
      }
    };

    window.clearAllNotifications = function() {
      state.notifications = [];
      realTimeSystem.updateNotificationUI();
      updateNotificationList();
    };

    window.toggleAnalytics = function() {
      const panel = document.getElementById('analytics-panel');
      panel.classList.toggle('hidden');
      
      if (!panel.classList.contains('hidden')) {
        updateAnalyticsData();
      }
    };

    window.showAdminPanel = function() {
      document.getElementById('admin-modal').classList.remove('hidden');
      window.switchAdminTab('realtime');
    };

    window.closeAdminPanel = function() {
      document.getElementById('admin-modal').classList.add('hidden');
    };

    window.switchAdminTab = function(tabName) {
      document.querySelectorAll('.admin-nav-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });
      
      const activeBtn = document.querySelector(`[onclick="window.switchAdminTab('${tabName}')"]`);
      if (activeBtn) {
        activeBtn.classList.add('bg-primary', 'text-white');
        activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
      }

      document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
      
      if (tabName === 'analytics') {
        updateAnalyticsData();
      }
    };

    window.toggleSearchFilters = function() {
      const filters = document.getElementById('search-filters');
      filters.classList.toggle('hidden');
    };

    window.filterByStatus = function(status) {
      state.currentFilter = status;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      event.target.classList.remove('bg-gray-200', 'text-gray-700');
      event.target.classList.add('bg-primary', 'text-white');
      
      handleSearch();
    };

    window.sortQuizzes = function(order) {
      state.sortOrder = order;
      if (state.currentSubject) {
        renderQuizzes(state.subjects[state.currentSubject]);
      }
    };

    window.goBackToSubjects = function() {
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('subjects-section').classList.remove('hidden');
      state.currentSubject = null;
    };

    window.clearActivityLog = function() {
      state.realTimeData.recentActivities = [];
      realTimeSystem.updateActivityLog();
    };

    // Search and Filter Functions
    function handleSearch() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!query) {
        state.searchResults = null;
        document.getElementById('search-results-count').classList.add('hidden');
        renderSubjects();
        return;
      }

      const results = {};
      let totalResults = 0;
      
      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const matchingQuizzes = quizzes.filter(quiz => {
          if (state.currentFilter !== 'all') {
            if (state.currentFilter === 'active' && realTimeSystem.isExpired(quiz.expiryDate)) return false;
            if (state.currentFilter === 'expired' && !realTimeSystem.isExpired(quiz.expiryDate)) return false;
            if (state.currentFilter === 'updated' && quiz.status !== 'อัพเดตล่าสุด') return false;
          }
          
          return subject.toLowerCase().includes(query) ||
                 (quiz.quizName && quiz.quizName.toLowerCase().includes(query)) ||
                 (quiz.quizDescription && quiz.quizDescription.toLowerCase().includes(query));
        });
        
        if (matchingQuizzes.length > 0 || subject.toLowerCase().includes(query)) {
          results[subject] = quizzes;
          totalResults += matchingQuizzes.length;
        }
      });

      state.searchResults = results;
      
      const countElement = document.getElementById('search-results-count');
      countElement.textContent = `${totalResults} ผลลัพธ์`;
      countElement.classList.remove('hidden');
      
      renderSubjects();
      realTimeSystem.logActivity('User', `Search: "${query}" (${totalResults} results)`);
    }

    function updateNotificationList() {
      const list = document.getElementById('notification-list');
      list.innerHTML = '';
      
      if (state.notifications.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ไม่มีการแจ้งเตือน</p>';
        return;
      }
      
      state.notifications.slice(0, 10).forEach(notification => {
        const item = document.createElement('div');
        item.className = 'flex items-start space-x-3 p-3 bg-gray-50 rounded-xl';
        
        const colorClasses = {
          green: 'text-green-500 bg-green-50',
          blue: 'text-blue-500 bg-blue-50',
          orange: 'text-orange-500 bg-orange-50',
          red: 'text-red-500 bg-red-50'
        };
        
        item.innerHTML = `
          <div class="w-8 h-8 ${colorClasses[notification.color]} rounded-lg flex items-center justify-center">
            <i class="fas ${notification.icon} text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="font-medium text-gray-800 text-sm">${notification.title}</div>
            <div class="text-gray-600 text-xs">${notification.message}</div>
            <div class="text-gray-500 text-xs mt-1">${notification.timestamp.toLocaleTimeString('th-TH')}</div>
          </div>
        `;
        
        list.appendChild(item);
      });
    }

    function updateAnalyticsData() {
      state.realTimeData.activeUsers = Math.floor(Math.random() * 20) + 5;
      
      document.getElementById('realtime-users').textContent = state.realTimeData.activeUsers;
      document.getElementById('quiz-accessed-today').textContent = state.analytics.quizAccesses;
      document.getElementById('updates-today').textContent = Math.floor(Math.random() * 10) + 1;
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', handleSearch);
        
        await realTimeSystem.initialize();
        
        setInterval(updateAnalyticsData, 5000);
        
        setTimeout(() => {
          realTimeSystem.addNotification({
            type: 'system',
            title: 'ระบบเริ่มต้นการทำงาน',
            message: 'ระบบเรียลไทม์พร้อมใช้งานแล้ว',
            timestamp: new Date(),
            icon: 'fa-check-circle',
            color: 'green'
          });
        }, 2000);
        
      } catch (error) {
        console.error('Application initialization failed:', error);
      }
    });
  </script>
</body>
</html>
