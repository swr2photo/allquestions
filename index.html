<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Allquiz - Cross-Platform Quiz Management System">
  <title>Allquiz - Enhanced Cross-Platform System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007AFF',
            secondary: '#5856D6',
            accent: '#FF3B30',
            success: '#34C759',
            warning: '#FF9500',
            ios: {
              gray: '#F2F2F7',
              darkGray: '#8E8E93',
              lightGray: '#F8F8F8'
            }
          },
          fontFamily: {
            'inter': ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-ring': 'pulseRing 2s infinite',
            'slide-up': 'slideUp 0.3s ease-out',
            'scale-in': 'scaleIn 0.2s ease-out',
            'notification-slide': 'notificationSlide 0.4s ease-out',
            'skeleton': 'skeleton 1.5s ease-in-out infinite alternate',
          }
        }
      }
    }
  </script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }
    
    @keyframes pulseRing {
      0% { transform: scale(0.9); opacity: 1; }
      100% { transform: scale(1.2); opacity: 0; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes notificationSlide {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes skeleton {
      from { background-color: #e5e7eb; }
      to { background-color: #f3f4f6; }
    }
    
    .glass-morphism {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    @supports not (backdrop-filter: blur(20px)) {
      .glass-morphism {
        background: rgba(255, 255, 255, 0.95);
      }
    }
    
    .realtime-indicator {
      position: relative;
    }
    
    .realtime-indicator::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: #34C759;
      animation: pulse-ring 2s infinite;
      z-index: -1;
    }
    
    .notification-toast {
      animation: notification-slide 0.4s ease-out;
    }
    
    .quiz-card {
      transition: all 0.3s ease;
    }
    
    .quiz-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    @media (hover: none) {
      .quiz-card:hover {
        transform: none;
      }
      
      .quiz-card:active {
        transform: scale(0.98);
      }
    }
    
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .skeleton {
      animation: skeleton 1.5s ease-in-out infinite alternate;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.75rem;
      outline: none;
      transition: all 0.2s;
      background: #f9fafb;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-input:focus {
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
      background: white;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      touch-action: manipulation;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: #007AFF;
      color: white;
    }

    .btn-primary:hover {
      background: #0056cc;
    }

    .btn-success {
      background: #34C759;
      color: white;
    }

    .btn-danger {
      background: #FF3B30;
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      max-width: 600px;
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 640px) {
      .modal-content {
        max-width: 100%;
        margin: 0.5rem;
      }
      
      .btn {
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
      }
      
      .glass-morphism {
        padding: 1rem;
      }
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .table th,
    .table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .badge-success {
      background: #dcfce7;
      color: #166534;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Touch-friendly scrolling */
    .scroll-container {
      -webkit-overflow-scrolling: touch;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    /* Hide scrollbar on mobile */
    @media (max-width: 768px) {
      .scroll-container::-webkit-scrollbar {
        display: none;
      }
      
      .scroll-container {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    }

    /* Mobile-first navigation */
    @media (max-width: 768px) {
      .nav-mobile {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        z-index: 50;
        padding: 0.5rem;
        display: flex;
        justify-content: space-around;
      }
      
      .nav-desktop {
        display: none;
      }
    }

    @media (min-width: 769px) {
      .nav-mobile {
        display: none;
      }
    }

    /* Improve accessibility */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Focus styles for keyboard navigation */
    :focus-visible {
      outline: 2px solid #007AFF;
      outline-offset: 2px;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-inter">
  
  <!-- Real-time Status Bar -->
  <div id="realtime-status" class="fixed top-0 left-0 right-0 bg-success text-white text-center py-2 text-sm z-50">
    <div class="flex items-center justify-center space-x-2">
      <div class="w-3 h-3 bg-white rounded-full realtime-indicator"></div>
      <span>ระบบพร้อมใช้งาน</span>
      <span id="last-sync-time" class="opacity-75"></span>
    </div>
  </div>

  <!-- Desktop Navigation -->
  <nav class="nav-desktop fixed top-12 left-1/2 transform -translate-x-1/2 z-40">
    <div class="glass-morphism px-6 py-3 rounded-3xl flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
          <i class="fas fa-graduation-cap text-white"></i>
        </div>
        <span class="text-gray-800 font-semibold">Allquiz</span>
      </div>
      
      <div class="flex items-center space-x-3">
        <button onclick="showNotifications()" class="relative p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-bell text-gray-700"></i>
          <span id="notification-count" class="absolute -top-1 -right-1 w-5 h-5 bg-accent text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
        </button>
        
        <button onclick="showQuizManager()" class="p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-edit text-primary"></i>
        </button>
        
        <button onclick="showAdminPanel()" class="p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-cog text-gray-700"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Navigation -->
  <nav class="nav-mobile">
    <button onclick="showHome()" class="p-3 rounded-lg text-gray-600">
      <i class="fas fa-home text-xl"></i>
    </button>
    <button onclick="showQuizManager()" class="p-3 rounded-lg text-gray-600">
      <i class="fas fa-plus-circle text-xl"></i>
    </button>
    <button onclick="showNotifications()" class="p-3 rounded-lg text-gray-600 relative">
      <i class="fas fa-bell text-xl"></i>
      <span id="notification-count-mobile" class="absolute -top-1 -right-1 w-5 h-5 bg-accent text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
    </button>
    <button onclick="showAdminPanel()" class="p-3 rounded-lg text-gray-600">
      <i class="fas fa-cog text-xl"></i>
    </button>
  </nav>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-40 flex items-center justify-center hidden">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">กำลังโหลดข้อมูล<span class="loading-dots"></span></p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="pt-32 pb-24 md:pb-8 px-4">
    <div class="max-w-7xl mx-auto">
      
      <!-- Hero Section -->
      <div class="text-center mb-8 md:mb-12">
        <h1 class="text-3xl md:text-5xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
          Allquiz Enhanced
        </h1>
        <p class="text-gray-600 text-lg md:text-xl mb-6 md:mb-8">ระบบเฉลยคำตอบแบบเรียลไทม์</p>
        
        <!-- Performance Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 md:mb-8">
          <div class="text-center">
            <div class="text-2xl md:text-3xl font-bold text-primary" id="total-subjects">0</div>
            <div class="text-sm text-gray-500">วิชา</div>
          </div>
          <div class="text-center">
            <div class="text-2xl md:text-3xl font-bold text-secondary" id="total-quizzes">0</div>
            <div class="text-sm text-gray-500">ควิซทั้งหมด</div>
          </div>
          <div class="text-center">
            <div class="text-2xl md:text-3xl font-bold text-success" id="active-quizzes">0</div>
            <div class="text-sm text-gray-500">พร้อมใช้</div>
          </div>
          <div class="text-center">
            <div class="text-2xl md:text-3xl font-bold text-orange-500" id="load-time">0ms</div>
            <div class="text-sm text-gray-500">เวลาโหลด</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="mb-6 md:mb-8">
        <div class="glass-morphism rounded-3xl p-4 md:p-6 border">
          <div class="flex flex-wrap gap-2 md:gap-3 justify-center">
            <button onclick="showQuizManager()" class="btn btn-primary btn-sm md:btn">
              <i class="fas fa-plus"></i>
              <span class="hidden sm:inline">เพิ่มควิซ</span>
            </button>
            <button onclick="exportData()" class="btn btn-secondary btn-sm md:btn">
              <i class="fas fa-download"></i>
              <span class="hidden sm:inline">ส่งออก</span>
            </button>
            <button onclick="refreshData()" class="btn btn-warning btn-sm md:btn">
              <i class="fas fa-sync-alt"></i>
              <span class="hidden sm:inline">รีเฟรช</span>
            </button>
            <button onclick="showAdminLogin()" class="btn btn-sm md:btn" id="auth-button" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
              <i class="fas fa-sign-in-alt"></i>
              <span class="hidden sm:inline">เข้าสู่ระบบ</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Search -->
      <div class="mb-6 md:mb-8">
        <div class="glass-morphism rounded-3xl p-4 md:p-6 border">
          <div class="relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input 
              type="text" 
              id="search-input"
              placeholder="ค้นหาวิชาหรือควิซ..."
              class="w-full pl-12 pr-4 py-3 md:py-4 bg-white/50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-primary/50 text-gray-800"
              oninput="handleSearch()"
            >
          </div>
        </div>
      </div>

      <!-- Subjects Grid -->
      <section id="subjects-section">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 md:mb-6">เลือกวิชา</h2>
        <div id="subjects-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
          <!-- Skeleton Loaders -->
          <div class="skeleton-card glass-morphism rounded-3xl p-6 border">
            <div class="w-20 h-20 skeleton rounded-3xl mx-auto mb-4"></div>
            <div class="h-6 skeleton rounded mb-3 mx-auto w-3/4"></div>
            <div class="h-4 skeleton rounded mx-auto w-1/2"></div>
          </div>
          <div class="skeleton-card glass-morphism rounded-3xl p-6 border">
            <div class="w-20 h-20 skeleton rounded-3xl mx-auto mb-4"></div>
            <div class="h-6 skeleton rounded mb-3 mx-auto w-3/4"></div>
            <div class="h-4 skeleton rounded mx-auto w-1/2"></div>
          </div>
        </div>
      </section>

      <!-- Quiz List Section -->
      <section id="quiz-section" class="hidden">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 md:mb-6 gap-4">
          <h2 id="quiz-section-title" class="text-2xl md:text-3xl font-bold text-gray-800">ควิซในวิชา</h2>
          <button onclick="goBackToSubjects()" class="btn btn-primary btn-sm md:btn">
            <i class="fas fa-arrow-left"></i>กลับ
          </button>
        </div>
        <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
          <!-- Quizzes will be loaded here -->
        </div>
      </section>
    </div>
  </div>

  <!-- Quiz Manager Modal -->
  <div id="quiz-manager-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-4 md:p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-xl md:text-2xl font-bold text-gray-800">จัดการควิซ</h3>
          <button onclick="closeQuizManager()" class="text-gray-400 hover:text-gray-600 p-2">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-4 md:p-6">
        <form id="quiz-form" onsubmit="saveQuiz(event)">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">วิชา</label>
              <select id="quiz-subject" class="form-input" required>
                <option value="">เลือกวิชา</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อควิซ</label>
              <input type="text" id="quiz-name" class="form-input" placeholder="ชื่อควิซ" required />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ลิงก์ควิซ</label>
              <input type="url" id="quiz-link" class="form-input" placeholder="https://..." required />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
              <textarea id="quiz-description" class="form-input" rows="3" placeholder="คำอธิบายควิซ (ไม่บังคับ)"></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">วันหมดอายุ</label>
                <input type="datetime-local" id="quiz-expiry" class="form-input" />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
                <select id="quiz-status" class="form-input">
                  <option value="อัพเดตล่าสุด">อัพเดตล่าสุด</option>
                  <option value="รออัพเดต">รออัพเดต</option>
                  <option value="ปิดปรับปรุง">ปิดปรับปรุง</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeQuizManager()" class="btn btn-secondary">
              ยกเลิก
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              บันทึก
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="admin-login-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-md">
      <div class="p-4 md:p-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-t-3xl">
        <div class="text-center">
          <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-shield-alt text-3xl"></i>
          </div>
          <h3 class="text-xl md:text-2xl font-bold">Admin Login</h3>
          <p class="text-blue-100 mt-1">เข้าสู่ระบบเพื่อจัดการข้อมูล</p>
        </div>
      </div>
      
      <div class="p-4 md:p-6">
        <form onsubmit="adminLogin(event)">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label>
              <input type="text" id="admin-username" class="form-input" placeholder="admin" required>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
              <input type="password" id="admin-password" class="form-input" placeholder="••••••••" required>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <p class="text-xs text-blue-600">
                <strong>ข้อมูลทดสอบ:</strong><br>
                ชื่อผู้ใช้: admin<br>
                รหัสผ่าน: admin123
              </p>
            </div>
          </div>
          
          <div class="flex justify-between items-center mt-6">
            <button type="button" onclick="closeAdminLogin()" class="btn btn-secondary">
              ยกเลิก
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-sign-in-alt"></i>
              เข้าสู่ระบบ
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-4xl">
      <div class="p-4 md:p-6 bg-gradient-to-r from-gray-800 to-gray-900 text-white">
        <div class="flex items-center justify-between">
          <h2 class="text-xl md:text-2xl font-bold">Admin Panel</h2>
          <button onclick="closeAdminPanel()" class="text-white/70 hover:text-white p-2">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <div class="p-4 md:p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
          <div class="bg-blue-50 rounded-2xl p-4">
            <h3 class="font-semibold text-gray-800 mb-3">ประสิทธิภาพ</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span>เวลาโหลด:</span>
                <span id="admin-load-time">< 100ms</span>
              </div>
              <div class="flex justify-between">
                <span>ควิซทั้งหมด:</span>
                <span id="admin-total-quizzes">0</span>
              </div>
            </div>
          </div>
          
          <div class="bg-green-50 rounded-2xl p-4">
            <h3 class="font-semibold text-gray-800 mb-3">การดำเนินการ</h3>
            <div class="space-y-2">
              <button onclick="clearCache()" class="w-full btn btn-secondary btn-sm">
                <i class="fas fa-trash"></i>ล้างแคช
              </button>
              <button onclick="backupData()" class="w-full btn btn-primary btn-sm">
                <i class="fas fa-save"></i>สำรองข้อมูล
              </button>
            </div>
          </div>
          
          <div class="bg-purple-50 rounded-2xl p-4">
            <h3 class="font-semibold text-gray-800 mb-3">ข้อมูลระบบ</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span>เวอร์ชัน:</span>
                <span>2.0.0</span>
              </div>
              <div class="flex justify-between">
                <span>สถานะ:</span>
                <span class="text-green-600">ออนไลน์</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Panel -->
  <div id="notifications-panel" class="modal-overlay hidden">
    <div class="modal-content max-w-md">
      <div class="p-4 md:p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-xl md:text-2xl font-bold text-gray-800">การแจ้งเตือน</h3>
          <button onclick="closeNotifications()" class="text-gray-400 hover:text-gray-600 p-2">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-4 md:p-6">
        <div id="notification-list" class="space-y-3">
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-bell-slash text-3xl mb-2 opacity-50"></i>
            <p class="text-sm">ไม่มีการแจ้งเตือน</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-20 md:bottom-6 right-4 md:right-6 space-y-3 z-50">
    <!-- Toast notifications will appear here -->
  </div>

  <script>
    // Global state management (no localStorage/sessionStorage)
    const appState = {
      subjects: {},
      currentSubject: null,
      notifications: [],
      isAuthenticated: false,
      userRole: 'guest',
      loadTime: 0,
      searchResults: null,
      cache: {}
    };

    // Configuration
    const CONFIG = {
      SHEET_ID: "1-7p30j2PR8oLeyJ02vMq1ut5IZ6iSh8zvMFS50w74Lc",
      QUIZ_RANGE: "Allquestions",
      API_KEY: "AIzaSyDpvXNmtRybEEu9JXzKOWF3F61-3tM5SCE",
      CACHE_DURATION: 5 * 60 * 1000
    };

    // In-memory cache system
    class MemoryCache {
      constructor() {
        this.data = {};
      }

      set(key, value, ttl = CONFIG.CACHE_DURATION) {
        this.data[key] = {
          value: value,
          expiry: Date.now() + ttl
        };
      }

      get(key) {
        const item = this.data[key];
        if (!item) return null;
        if (Date.now() > item.expiry) {
          delete this.data[key];
          return null;
        }
        return item.value;
      }

      clear() {
        this.data = {};
      }
    }

    const cache = new MemoryCache();

    // Sheets API
    const SheetsAPI = {
      async readData(range = CONFIG.QUIZ_RANGE) {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
        
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          return data.values || [];
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      }
    };

    // UI Helper Functions
    function showLoadingOverlay(show) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300`;
      toast.innerHTML = `
        <div class="flex items-center space-x-2">
          <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.classList.remove('translate-x-full'), 100);
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Data Management
    async function loadData() {
      const startTime = performance.now();
      showLoadingOverlay(true);
      
      try {
        // Check cache first
        let data = cache.get('quiz_data');
        if (!data) {
          data = await SheetsAPI.readData();
          cache.set('quiz_data', data);
        }
        
        processData(data);
        hideSkeletonLoaders();
        updateLoadTime(performance.now() - startTime);
        
      } catch (error) {
        console.error('Load failed:', error);
        showToast('การโหลดล้มเหลว', 'error');
        loadSampleData();
      } finally {
        showLoadingOverlay(false);
      }
    }

    function processData(rawData) {
      appState.subjects = {};
      let totalQuizzes = 0;
      let activeQuizzes = 0;

      rawData.slice(1).forEach(row => {
        const [subject, quizName, quizLink, quizDescription, expiryDate, status] = row || [];
        
        if (subject && subject.trim()) {
          if (!appState.subjects[subject]) {
            appState.subjects[subject] = [];
          }
          
          if (quizName) {
            const quiz = { 
              id: Math.random().toString(36).substr(2, 9),
              quizName, 
              quizLink, 
              quizDescription, 
              expiryDate, 
              status,
              subject
            };
            
            appState.subjects[subject].push(quiz);
            totalQuizzes++;
            
            if (quizLink && !isExpired(expiryDate)) {
              activeQuizzes++;
            }
          }
        }
      });

      updateCounters(Object.keys(appState.subjects).length, totalQuizzes, activeQuizzes);
      renderSubjects();
    }

    function loadSampleData() {
      const sampleData = [
        ['Subject', 'QuizName', 'QuizLink', 'Description', 'ExpiryDate', 'Status'],
        ['คณิตศาสตร์', 'ควิซเรื่องเซต', 'https://example.com/quiz1', 'เรื่องเซตและความสัมพันธ์', '31/12/2024, 23:59', 'อัพเดตล่าสุด'],
        ['ฟิสิกส์', 'ควิซเรื่องแรง', 'https://example.com/quiz2', 'แรงและการเคลื่อนที่', '31/12/2024, 23:59', 'อัพเดตล่าสุด'],
        ['เคมี', 'ควิซเรื่องธาตุ', 'https://example.com/quiz3', 'ธาตุและสารประกอบ', '31/12/2024, 23:59', 'อัพเดตล่าสุด']
      ];
      
      processData(sampleData);
    }

    function hideSkeletonLoaders() {
      document.querySelectorAll('.skeleton-card').forEach(card => {
        card.style.display = 'none';
      });
    }

    function updateCounters(subjects, total, active) {
      document.getElementById('total-subjects').textContent = subjects;
      document.getElementById('total-quizzes').textContent = total;
      document.getElementById('active-quizzes').textContent = active;
      document.getElementById('admin-total-quizzes').textContent = total;
    }

    function updateLoadTime(time) {
      const loadTime = Math.round(time);
      document.getElementById('load-time').textContent = loadTime + 'ms';
      document.getElementById('admin-load-time').textContent = loadTime + 'ms';
      appState.loadTime = loadTime;
    }

    function isExpired(expiryDate) {
      if (!expiryDate) return false;
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        return new Date(formattedDate).getTime() < Date.now();
      } catch {
        return false;
      }
    }

    // UI Rendering
    function renderSubjects() {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';
      
      const subjects = appState.searchResults || appState.subjects;
      
      Object.entries(subjects).forEach(([subject, quizzes]) => {
        const card = createSubjectCard(subject, quizzes);
        grid.appendChild(card);
      });
    }

    function createSubjectCard(subject, quizzes) {
      const availableQuizzes = quizzes.filter(q => q.quizName && q.quizLink && !isExpired(q.expiryDate)).length;
      
      const card = document.createElement('div');
      card.className = 'quiz-card glass-morphism rounded-3xl p-6 border cursor-pointer';
      card.innerHTML = `
        <div class="text-center">
          <div class="w-20 h-20 bg-gradient-to-br from-primary to-secondary rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-lg">
            <i class="fas fa-book text-white text-3xl"></i>
          </div>
          <h3 class="font-bold text-gray-800 mb-3 text-xl">${subject}</h3>
          <div class="inline-block px-4 py-2 bg-green-100 text-green-800 text-sm rounded-2xl font-medium">
            ${availableQuizzes} ควิซพร้อมใช้
          </div>
        </div>
      `;
      
      card.addEventListener('click', () => showQuizzes(subject));
      return card;
    }

    function showQuizzes(subject) {
      appState.currentSubject = subject;
      const quizzes = appState.subjects[subject];
      
      document.getElementById('subjects-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-section-title').textContent = `ควิซในวิชา ${subject}`;
      
      renderQuizzes(quizzes);
    }

    function renderQuizzes(quizzes) {
      const grid = document.getElementById('quiz-grid');
      grid.innerHTML = '';
      
      quizzes.forEach(quiz => {
        if (!quiz.quizName) return;
        const card = createQuizCard(quiz);
        grid.appendChild(card);
      });
    }

    function createQuizCard(quiz) {
      const isExpiredQuiz = isExpired(quiz.expiryDate);
      
      const card = document.createElement('div');
      card.className = 'quiz-card glass-morphism rounded-3xl p-6 border';
      
      let statusBadge = '';
      if (isExpiredQuiz) {
        statusBadge = '<div class="badge badge-danger mb-3">หมดอายุแล้ว</div>';
      } else if (quiz.status) {
        const statusClass = quiz.status === 'อัพเดตล่าสุด' ? 'badge-success' : 'badge-warning';
        statusBadge = `<div class="badge ${statusClass} mb-3">${quiz.status}</div>`;
      }
      
      card.innerHTML = `
        <h3 class="font-bold text-gray-800 mb-2 text-lg">${quiz.quizName}</h3>
        ${statusBadge}
        ${quiz.quizDescription ? `<p class="text-gray-600 text-sm mb-4">${quiz.quizDescription}</p>` : ''}
        
        <div class="flex justify-between items-center">
          ${quiz.quizLink && !isExpiredQuiz ? 
            `<a href="${quiz.quizLink}" target="_blank" class="btn btn-primary btn-sm">
              <i class="fas fa-external-link-alt"></i>ดูเฉลย
            </a>` :
            '<span class="text-gray-500 text-sm">ไม่พร้อมใช้งาน</span>'
          }
          ${appState.isAuthenticated ? 
            `<button onclick="editQuiz('${quiz.id}')" class="btn btn-secondary btn-sm">
              <i class="fas fa-edit"></i>
            </button>` : ''
          }
        </div>
      `;
      
      return card;
    }

    // Search functionality
    function handleSearch() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!query) {
        appState.searchResults = null;
        renderSubjects();
        return;
      }

      const results = {};
      Object.entries(appState.subjects).forEach(([subject, quizzes]) => {
        const matchingQuizzes = quizzes.filter(quiz => 
          subject.toLowerCase().includes(query) ||
          (quiz.quizName && quiz.quizName.toLowerCase().includes(query)) ||
          (quiz.quizDescription && quiz.quizDescription.toLowerCase().includes(query))
        );
        
        if (matchingQuizzes.length > 0 || subject.toLowerCase().includes(query)) {
          results[subject] = quizzes;
        }
      });

      appState.searchResults = results;
      renderSubjects();
    }

    // Quiz Management
    function showQuizManager() {
      if (!appState.isAuthenticated) {
        showToast('กรุณาเข้าสู่ระบบก่อน', 'warning');
        showAdminLogin();
        return;
      }
      
      const modal = document.getElementById('quiz-manager-modal');
      modal.classList.remove('hidden');
      populateSubjects();
    }

    function closeQuizManager() {
      document.getElementById('quiz-manager-modal').classList.add('hidden');
      document.getElementById('quiz-form').reset();
    }

    function populateSubjects() {
      const select = document.getElementById('quiz-subject');
      select.innerHTML = '<option value="">เลือกวิชา</option>';
      
      Object.keys(appState.subjects).forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        select.appendChild(option);
      });
      
      const newOption = document.createElement('option');
      newOption.value = '__new__';
      newOption.textContent = '+ เพิ่มวิชาใหม่';
      select.appendChild(newOption);
    }

    function saveQuiz(event) {
      event.preventDefault();
      
      let subject = document.getElementById('quiz-subject').value;
      const quizName = document.getElementById('quiz-name').value;
      const quizLink = document.getElementById('quiz-link').value;
      const quizDescription = document.getElementById('quiz-description').value;
      const expiryDate = formatExpiryDate(document.getElementById('quiz-expiry').value);
      const status = document.getElementById('quiz-status').value;
      
      if (subject === '__new__') {
        subject = prompt('ชื่อวิชาใหม่:');
        if (!subject) return;
      }
      
      const quiz = {
        id: Math.random().toString(36).substr(2, 9),
        quizName,
        quizLink,
        quizDescription,
        expiryDate,
        status,
        subject
      };
      
      if (!appState.subjects[subject]) {
        appState.subjects[subject] = [];
      }
      
      appState.subjects[subject].push(quiz);
      
      showToast('บันทึกควิซเสร็จสิ้น', 'success');
      closeQuizManager();
      
      if (appState.currentSubject === subject) {
        renderQuizzes(appState.subjects[subject]);
      } else {
        renderSubjects();
      }
    }

    function formatExpiryDate(datetimeLocal) {
      if (!datetimeLocal) return '';
      
      const date = new Date(datetimeLocal);
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      
      return `${day}/${month}/${year}, ${hours}:${minutes}`;
    }

    // Authentication
    function showAdminLogin() {
      document.getElementById('admin-login-modal').classList.remove('hidden');
    }

    function closeAdminLogin() {
      document.getElementById('admin-login-modal').classList.add('hidden');
    }

    function adminLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('admin-username').value;
      const password = document.getElementById('admin-password').value;
      
      // Simple authentication (in production, use proper authentication)
      if (username === 'admin' && password === 'admin123') {
        appState.isAuthenticated = true;
        appState.userRole = 'admin';
        showToast('เข้าสู่ระบบสำเร็จ', 'success');
        closeAdminLogin();
        updateAuthButton();
      } else {
        showToast('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', 'error');
      }
    }

    function updateAuthButton() {
      const authButton = document.getElementById('auth-button');
      if (appState.isAuthenticated) {
        authButton.innerHTML = '<i class="fas fa-user"></i><span class="hidden sm:inline ml-2">Admin</span>';
        authButton.onclick = logout;
      } else {
        authButton.innerHTML = '<i class="fas fa-sign-in-alt"></i><span class="hidden sm:inline ml-2">เข้าสู่ระบบ</span>';
        authButton.onclick = showAdminLogin;
      }
    }

    function logout() {
      if (confirm('ต้องการออกจากระบบหรือไม่?')) {
        appState.isAuthenticated = false;
        appState.userRole = 'guest';
        showToast('ออกจากระบบเรียบร้อย', 'info');
        updateAuthButton();
      }
    }

    // Admin Panel
    function showAdminPanel() {
      if (!appState.isAuthenticated) {
        showToast('กรุณาเข้าสู่ระบบก่อน', 'warning');
        showAdminLogin();
        return;
      }
      document.getElementById('admin-panel-modal').classList.remove('hidden');
    }

    function closeAdminPanel() {
      document.getElementById('admin-panel-modal').classList.add('hidden');
    }

    // Notifications
    function showNotifications() {
      document.getElementById('notifications-panel').classList.remove('hidden');
      updateNotificationCount();
    }

    function closeNotifications() {
      document.getElementById('notifications-panel').classList.add('hidden');
    }

    function updateNotificationCount() {
      const count = appState.notifications.length;
      const badges = [document.getElementById('notification-count'), document.getElementById('notification-count-mobile')];
      
      badges.forEach(badge => {
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      });
    }

    function addNotification(title, message, type = 'info') {
      const notification = {
        id: Date.now(),
        title,
        message,
        type,
        timestamp: new Date()
      };
      
      appState.notifications.unshift(notification);
      updateNotificationCount();
      renderNotifications();
    }

    function renderNotifications() {
      const list = document.getElementById('notification-list');
      
      if (appState.notifications.length === 0) {
        list.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-bell-slash text-3xl mb-2 opacity-50"></i>
            <p class="text-sm">ไม่มีการแจ้งเตือน</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = appState.notifications.map(notification => `
        <div class="bg-gray-50 p-4 rounded-xl">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-medium text-gray-800">${notification.title}</h4>
              <p class="text-sm text-gray-600 mt-1">${notification.message}</p>
              <p class="text-xs text-gray-500 mt-2">${formatTime(notification.timestamp)}</p>
            </div>
            <button onclick="removeNotification(${notification.id})" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function removeNotification(id) {
      appState.notifications = appState.notifications.filter(n => n.id !== id);
      updateNotificationCount();
      renderNotifications();
    }

    function formatTime(timestamp) {
      const now = new Date();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'เมื่อสักครู่';
      if (diff < 3600000) return `${Math.floor(diff / 60000)} นาทีที่แล้ว`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)} ชั่วโมงที่แล้ว`;
      return timestamp.toLocaleDateString('th-TH');
    }

    // Other Functions
    function goBackToSubjects() {
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('subjects-section').classList.remove('hidden');
      appState.currentSubject = null;
    }

    function showHome() {
      goBackToSubjects();
    }

    function exportData() {
      const dataStr = JSON.stringify(appState.subjects, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `allquiz-export-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ส่งออกข้อมูลเสร็จสิ้น', 'success');
    }

    function refreshData() {
      cache.clear();
      loadData();
      showToast('กำลังรีเฟรชข้อมูล', 'info');
    }

    function clearCache() {
      cache.clear();
      showToast('ล้างแคชเสร็จสิ้น', 'success');
    }

    function backupData() {
      exportData();
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      updateAuthButton();
      
      // Welcome notification
      setTimeout(() => {
        addNotification('ยินดีต้อนรับ', 'ระบบ Allquiz พร้อมใช้งานแล้ว', 'success');
      }, 2000);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        // Close all modals
        document.querySelectorAll('.modal-overlay').forEach(modal => {
          modal.classList.add('hidden');
        });
      }
    });

    // Handle touch events for better mobile experience
    let touchStartX = 0;
    let touchEndX = 0;

    document.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    document.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;
      
      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0 && appState.currentSubject) {
          // Swipe left - could implement next quiz
        } else if (diff < 0 && appState.currentSubject) {
          // Swipe right - go back
          goBackToSubjects();
        }
      }
    }

    // Optimize for different screen sizes
    function optimizeForDevice() {
      const isMobile = window.innerWidth < 768;
      
      if (isMobile) {
        // Mobile optimizations
        document.querySelectorAll('.modal-content').forEach(modal => {
          modal.style.maxHeight = '85vh';
        });
      }
    }

    window.addEventListener('resize', optimizeForDevice);
    optimizeForDevice();

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      if (event.error && event.error.message && !event.error.message.includes('Script error')) {
        showToast('เกิดข้อผิดพลาด กรุณาลองใหม่', 'error');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });
  </script>
</body>
</html>
