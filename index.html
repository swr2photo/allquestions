<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Allquiz - Enhanced Real-time Quiz Management System">
  <title>Allquiz - Enhanced Admin System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007AFF',
            secondary: '#5856D6',
            accent: '#FF3B30',
            success: '#34C759',
            warning: '#FF9500',
            ios: {
              gray: '#F2F2F7',
              darkGray: '#8E8E93',
              lightGray: '#F8F8F8'
            }
          },
          fontFamily: {
            'sf': ['SF Pro Display', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-ring': 'pulseRing 2s infinite',
            'slide-up': 'slideUp 0.3s ease-out',
            'scale-in': 'scaleIn 0.2s ease-out',
            'notification-slide': 'notificationSlide 0.4s ease-out',
            'realtime-glow': 'realtimeGlow 2s ease-in-out infinite alternate',
            'skeleton': 'skeleton 1.5s ease-in-out infinite alternate',
          }
        }
      }
    }
  </script>
  
  <style>
    @keyframes pulseRing {
      0% { transform: scale(0.9); opacity: 1; }
      100% { transform: scale(1.2); opacity: 0; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes notificationSlide {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes realtimeGlow {
      from { box-shadow: 0 0 20px rgba(52, 199, 89, 0.5); }
      to { box-shadow: 0 0 30px rgba(52, 199, 89, 0.8); }
    }

    @keyframes skeleton {
      from { background-color: #e5e7eb; }
      to { background-color: #f3f4f6; }
    }
    
    .glass-morphism {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .realtime-indicator {
      position: relative;
    }
    
    .realtime-indicator::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: #34C759;
      animation: pulse-ring 2s infinite;
      z-index: -1;
    }
    
    .notification-toast {
      animation: notification-slide 0.4s ease-out;
    }
    
    .analytics-chart {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .quiz-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    .loading-dots {
      display: inline-block;
    }
    
    .loading-dots::after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .animate-slide-up {
      animation: slideUp 0.5s ease-out forwards;
    }
    
    .animate-scale-in {
      animation: scaleIn 0.3s ease-out forwards;
    }

    .skeleton {
      animation: skeleton 1.5s ease-in-out infinite alternate;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.75rem;
      outline: none;
      transition: all 0.2s;
      background: #f9fafb;
    }

    .form-input:focus {
      border-color: #007AFF;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
      background: white;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: #007AFF;
      color: white;
    }

    .btn-primary:hover {
      background: #0056cc;
      transform: translateY(-1px);
    }

    .btn-success {
      background: #34C759;
      color: white;
    }

    .btn-success:hover {
      background: #28a745;
    }

    .btn-danger {
      background: #FF3B30;
      color: white;
    }

    .btn-danger:hover {
      background: #dc3545;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-content {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      max-height: 90vh;
      overflow-y: auto;
      width: 100%;
      max-width: 600px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .table th,
    .table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .table tr:hover {
      background: #f9fafb;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success {
      background: #dcfce7;
      color: #166534;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .fast-load {
      transition: all 0.15s ease-out;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-sf">
  
  <!-- Real-time Status Bar -->
  <div id="realtime-status" class="fixed top-0 left-0 right-0 bg-success text-white text-center py-2 text-sm z-50 realtime-glow">
    <div class="flex items-center justify-center space-x-2">
      <div class="w-3 h-3 bg-white rounded-full realtime-indicator"></div>
      <span>ระบบพร้อมใช้งาน - โหลดเร็ว</span>
      <span id="last-sync-time" class="opacity-75"></span>
    </div>
  </div>

  <!-- Enhanced Navigation -->
  <nav class="fixed top-12 left-1/2 transform -translate-x-1/2 z-40">
    <div class="glass-morphism px-6 py-3 rounded-3xl flex items-center space-x-4">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-xl flex items-center justify-center">
          <i class="fas fa-graduation-cap text-white"></i>
        </div>
        <span class="text-gray-800 font-semibold">Allquiz Enhanced</span>
      </div>
      
      <div class="flex items-center space-x-3">
        <button onclick="window.toggleRealTimeNotifications()" class="relative p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-bell text-gray-700"></i>
          <span id="notification-count" class="absolute -top-1 -right-1 w-5 h-5 bg-accent text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
        </button>
        
        <button onclick="window.toggleAnalytics()" class="p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-chart-line text-gray-700"></i>
        </button>
        
        <button onclick="window.showAdminPanel()" class="p-2 rounded-lg hover:bg-white/20 transition-colors">
          <i class="fas fa-cog text-gray-700"></i>
        </button>

        <button onclick="window.showQuizManager()" class="p-2 rounded-lg hover:bg-white/20 transition-colors bg-primary/10">
          <i class="fas fa-edit text-primary"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-40 flex items-center justify-center hidden">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">กำลังโหลดข้อมูล...</p>
      <p class="text-gray-500 text-sm">ใช้ Cache เพื่อโหลดเร็วขึ้น</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="pt-32 pb-8 px-4">
    <div class="max-w-7xl mx-auto">
      
      <!-- Enhanced Hero Section -->
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
          Allquiz Enhanced
        </h1>
        <p class="text-gray-600 text-xl mb-8">ระบบเฉลยคำตอบแบบเรียลไทม์พร้อมการจัดการข้อมูล</p>
        
        <!-- Performance Stats -->
        <div class="flex justify-center space-x-8 mb-8">
          <div class="text-center">
            <div class="text-3xl font-bold text-primary" id="total-subjects">0</div>
            <div class="text-sm text-gray-500">วิชา</div>
            <div class="w-8 h-1 bg-primary/20 rounded-full mx-auto mt-1">
              <div class="h-full bg-primary rounded-full transition-all duration-500" style="width: 75%"></div>
            </div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-secondary" id="total-quizzes">0</div>
            <div class="text-sm text-gray-500">ควิซทั้งหมด</div>
            <div class="w-8 h-1 bg-secondary/20 rounded-full mx-auto mt-1">
              <div class="h-full bg-secondary rounded-full transition-all duration-500" style="width: 60%"></div>
            </div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-success" id="active-quizzes">0</div>
            <div class="text-sm text-gray-500">พร้อมใช้</div>
            <div class="w-8 h-1 bg-success/20 rounded-full mx-auto mt-1">
              <div class="h-full bg-success rounded-full transition-all duration-500" style="width: 90%"></div>
            </div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-orange-500" id="load-time">0ms</div>
            <div class="text-sm text-gray-500">เวลาโหลด</div>
            <div class="w-8 h-1 bg-orange-200 rounded-full mx-auto mt-1">
              <div class="h-full bg-orange-500 rounded-full transition-all duration-500" style="width: 85%"></div>
            </div>
          </div>
        </div>

        <!-- Connection Status -->
        <div class="inline-flex items-center space-x-2 bg-green-50 text-green-700 px-4 py-2 rounded-full text-sm">
          <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
          <span>โหลดแบบ Cache</span>
          <span id="cache-status">•</span>
          <span id="sync-indicator">พร้อมใช้งาน</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="mb-8">
        <div class="glass-morphism rounded-3xl p-6 border">
          <div class="flex flex-wrap gap-3 justify-center">
            <button onclick="window.showQuizManager()" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              เพิ่มควิซใหม่
            </button>
            <button onclick="window.showBulkImport()" class="btn btn-success">
              <i class="fas fa-upload"></i>
              นำเข้าข้อมูล
            </button>
            <button onclick="window.exportAllData()" class="btn btn-secondary">
              <i class="fas fa-download"></i>
              ส่งออกข้อมูล
            </button>
            <button onclick="window.refreshCache()" class="btn btn-warning">
              <i class="fas fa-sync-alt"></i>
              รีเฟรชข้อมูล
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced Search -->
      <div class="mb-8">
        <div class="glass-morphism rounded-3xl p-6 border">
          <div class="relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input 
              type="text" 
              id="search-input"
              placeholder="ค้นหาวิชาหรือควิซ... (ค้นหาทันที - ไม่ต้องรอโหลด)"
              class="w-full pl-12 pr-20 py-4 bg-white/50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-primary/50 text-gray-800"
            >
            <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
              <span id="search-results-count" class="text-xs text-gray-500 hidden"></span>
              <button onclick="window.toggleSearchFilters()" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg">
                <i class="fas fa-filter"></i>
              </button>
            </div>
          </div>
          
          <!-- Search Filters -->
          <div id="search-filters" class="hidden mt-4 pt-4 border-t border-gray-200">
            <div class="flex flex-wrap gap-2">
              <button onclick="window.filterByStatus('all')" class="filter-btn active px-3 py-1 bg-primary text-white rounded-full text-sm">
                ทั้งหมด
              </button>
              <button onclick="window.filterByStatus('active')" class="filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                พร้อมใช้
              </button>
              <button onclick="window.filterByStatus('expired')" class="filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                หมดอายุ
              </button>
              <button onclick="window.filterByStatus('updated')" class="filter-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">
                อัพเดตล่าสุด
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Subjects Grid -->
      <section id="subjects-section">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl font-bold text-gray-800">เลือกวิชาที่ต้องการ</h2>
          <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-500">โหลดจาก Cache:</span>
            <span id="last-update-display" class="text-sm font-medium text-primary">ทันที</span>
          </div>
        </div>
        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <!-- Skeleton Loaders -->
          <div class="skeleton-card glass-morphism rounded-3xl p-6 border">
            <div class="text-center">
              <div class="w-20 h-20 skeleton rounded-3xl mx-auto mb-4"></div>
              <div class="h-6 skeleton rounded mb-3 mx-auto w-3/4"></div>
              <div class="h-4 skeleton rounded mx-auto w-1/2"></div>
            </div>
          </div>
          <div class="skeleton-card glass-morphism rounded-3xl p-6 border">
            <div class="text-center">
              <div class="w-20 h-20 skeleton rounded-3xl mx-auto mb-4"></div>
              <div class="h-6 skeleton rounded mb-3 mx-auto w-3/4"></div>
              <div class="h-4 skeleton rounded mx-auto w-1/2"></div>
            </div>
          </div>
          <div class="skeleton-card glass-morphism rounded-3xl p-6 border">
            <div class="text-center">
              <div class="w-20 h-20 skeleton rounded-3xl mx-auto mb-4"></div>
              <div class="h-6 skeleton rounded mb-3 mx-auto w-3/4"></div>
              <div class="h-4 skeleton rounded mx-auto w-1/2"></div>
            </div>
          </div>
          <div class="skeleton-card glass-morphism rounded-3xl p-6 border">
            <div class="text-center">
              <div class="w-20 h-20 skeleton rounded-3xl mx-auto mb-4"></div>
              <div class="h-6 skeleton rounded mb-3 mx-auto w-3/4"></div>
              <div class="h-4 skeleton rounded mx-auto w-1/2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Quiz List Section -->
      <section id="quiz-section" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 id="quiz-section-title" class="text-3xl font-bold text-gray-800">ควิซในวิชา</h2>
            <p class="text-gray-600 mt-1">จัดการและแก้ไขได้ทันที</p>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="window.addQuizToSubject()" class="btn btn-primary">
              <i class="fas fa-plus"></i>เพิ่มควิซ
            </button>
            <button onclick="window.sortQuizzes('name')" class="px-4 py-2 bg-gray-100 rounded-xl text-sm hover:bg-gray-200 transition-colors">
              <i class="fas fa-sort-alpha-down mr-2"></i>เรียงตามชื่อ
            </button>
            <button onclick="window.sortQuizzes('date')" class="px-4 py-2 bg-gray-100 rounded-xl text-sm hover:bg-gray-200 transition-colors">
              <i class="fas fa-clock mr-2"></i>ล่าสุด
            </button>
            <button onclick="window.goBackToSubjects()" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
              <i class="fas fa-arrow-left mr-2"></i>กลับ
            </button>
          </div>
        </div>
        <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Quizzes will be loaded here -->
        </div>
      </section>
    </div>
  </div>

  <!-- Quiz Manager Modal -->
  <div id="quiz-manager-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-2xl font-bold text-gray-800">จัดการควิซ</h3>
          <button onclick="window.closeQuizManager()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <!-- Add/Edit Form -->
        <form id="quiz-form" onsubmit="window.saveQuiz(event)">
          <input type="hidden" id="quiz-id" />
          <input type="hidden" id="quiz-action" value="add" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-2">วิชา</label>
              <select id="quiz-subject" class="form-input" required>
                <option value="">เลือกวิชา</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อควิซ</label>
              <input type="text" id="quiz-name" class="form-input" placeholder="ชื่อควิซ" required />
            </div>
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">ลิงก์ควิซ</label>
            <input type="url" id="quiz-link" class="form-input" placeholder="https://..." required />
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
            <textarea id="quiz-description" class="form-input" rows="3" placeholder="คำอธิบายควิซ (ไม่บังคับ)"></textarea>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-2">วันหมดอายุ</label>
              <input type="datetime-local" id="quiz-expiry" class="form-input" />
            </div>
            
            <div class="form-group">
              <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
              <select id="quiz-status" class="form-input">
                <option value="อัพเดตล่าสุด">อัพเดตล่าสุด</option>
                <option value="รออัพเดต">รออัพเดต</option>
                <option value="ปิดปรับปรุง">ปิดปรับปรุง</option>
              </select>
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="window.closeQuizManager()" class="btn btn-secondary">
              ยกเลิก
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              <span id="save-btn-text">บันทึกควิซ</span>
            </button>
          </div>
        </form>
        
        <!-- Quiz List -->
        <div class="mt-8 pt-6 border-t">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold">ควิซทั้งหมด</h4>
            <div class="flex space-x-2">
              <button onclick="window.exportQuizData()" class="btn btn-secondary btn-sm">
                <i class="fas fa-download"></i>
                ส่งออก
              </button>
              <button onclick="window.refreshQuizList()" class="btn btn-primary btn-sm">
                <i class="fas fa-sync-alt"></i>
                รีเฟรช
              </button>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th>วิชา</th>
                  <th>ชื่อควิซ</th>
                  <th>สถานะ</th>
                  <th>หมดอายุ</th>
                  <th>จัดการ</th>
                </tr>
              </thead>
              <tbody id="quiz-table-body">
                <tr>
                  <td colspan="5" class="text-center text-gray-500 py-8">
                    <i class="fas fa-search text-2xl mb-2"></i>
                    <p>ไม่มีข้อมูลควิซ</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Import Modal -->
  <div id="bulk-import-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-2xl font-bold text-gray-800">นำเข้าข้อมูลจำนวนมาก</h3>
          <button onclick="window.closeBulkImport()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <div class="mb-6">
          <h4 class="text-lg font-semibold mb-2">วิธีการนำเข้า</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="window.showCsvImport()" class="p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary transition-colors text-center">
              <i class="fas fa-file-csv text-3xl text-gray-400 mb-2"></i>
              <p class="font-medium">CSV ไฟล์</p>
              <p class="text-sm text-gray-500">นำเข้าจากไฟล์ CSV</p>
            </button>
            
            <button onclick="window.showJsonImport()" class="p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary transition-colors text-center">
              <i class="fas fa-code text-3xl text-gray-400 mb-2"></i>
              <p class="font-medium">JSON ข้อมูล</p>
              <p class="text-sm text-gray-500">นำเข้าแบบ JSON</p>
            </button>
            
            <button onclick="window.showManualBulk()" class="p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary transition-colors text-center">
              <i class="fas fa-keyboard text-3xl text-gray-400 mb-2"></i>
              <p class="font-medium">ป้อนข้อมูล</p>
              <p class="text-sm text-gray-500">พิมพ์หลายรายการ</p>
            </button>
          </div>
        </div>
        
        <!-- CSV Import -->
        <div id="csv-import-section" class="hidden">
          <h4 class="text-lg font-semibold mb-2">นำเข้าไฟล์ CSV</h4>
          <div class="mb-4">
            <input type="file" id="csv-file" accept=".csv" class="form-input" />
            <p class="text-sm text-gray-500 mt-1">
              รูปแบบ: Subject, QuizName, QuizLink, Description, ExpiryDate, Status
            </p>
          </div>
          <button onclick="window.importCsvFile()" class="btn btn-primary">
            <i class="fas fa-upload"></i>
            นำเข้าข้อมูล
          </button>
        </div>
        
        <!-- Manual Bulk Entry -->
        <div id="manual-bulk-section" class="hidden">
          <h4 class="text-lg font-semibold mb-2">ป้อนข้อมูลหลายรายการ</h4>
          <textarea id="bulk-text" class="form-input" rows="10" placeholder="วิชาคณิตศาสตร์|ควิซที่ 1|https://example.com|คำอธิบาย|2024-12-31 23:59|อัพเดตล่าสุด
วิชาฟิสิกส์|ควิซที่ 2|https://example.com|คำอธิบาย|2024-12-31 23:59|อัพเดตล่าสุด

แต่ละบรรทัด = 1 ควิซ
แยกด้วย | (แท่งตั้ง)"></textarea>
          <div class="flex justify-between items-center mt-4">
            <p class="text-sm text-gray-500">แยกข้อมูลด้วย | (แท่งตั้ง) - แต่ละบรรทัดคือ 1 ควิซ</p>
            <button onclick="window.importBulkText()" class="btn btn-primary">
              <i class="fas fa-plus"></i>
              เพิ่มทั้งหมด
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-primary rounded-2xl flex items-center justify-center">
              <i class="fas fa-shield-alt text-white text-xl"></i>
            </div>
            <div>
              <h2 class="text-2xl font-bold">Admin Panel</h2>
              <p class="text-gray-300">ระบบจัดการขั้นสูง</p>
            </div>
          </div>
          <button onclick="window.closeAdminPanel()" class="text-white/70 hover:text-white transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Performance Stats -->
          <div class="bg-blue-50 rounded-2xl p-4">
            <h3 class="font-semibold text-gray-800 mb-3">ประสิทธิภาพระบบ</h3>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">เวลาโหลด:</span>
                <span class="text-sm font-medium" id="admin-load-time">< 100ms</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">ขนาด Cache:</span>
                <span class="text-sm font-medium" id="cache-size">0 KB</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">ควิซในระบบ:</span>
                <span class="text-sm font-medium" id="admin-total-quizzes">0</span>
              </div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div class="bg-green-50 rounded-2xl p-4">
            <h3 class="font-semibold text-gray-800 mb-3">การดำเนินการด่วน</h3>
            <div class="space-y-2">
              <button onclick="window.clearAllCache()" class="w-full btn btn-secondary btn-sm">
                <i class="fas fa-trash"></i>
                ล้าง Cache
              </button>
              <button onclick="window.backupData()" class="w-full btn btn-primary btn-sm">
                <i class="fas fa-save"></i>
                สำรองข้อมูล
              </button>
              <button onclick="window.resetSystem()" class="w-full btn btn-danger btn-sm">
                <i class="fas fa-refresh"></i>
                รีเซ็ตระบบ
              </button>
            </div>
          </div>
          
          <!-- System Info -->
          <div class="bg-purple-50 rounded-2xl p-4">
            <h3 class="font-semibold text-gray-800 mb-3">ข้อมูลระบบ</h3>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">เวอร์ชัน:</span>
                <span class="text-sm font-medium">2.0.0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">อัพเดตล่าสุด:</span>
                <span class="text-sm font-medium" id="last-admin-update">เมื่อสักครู่</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">โหมด:</span>
                <span class="text-sm font-medium text-green-600">ออนไลน์</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- System Health -->
        <div class="mt-6 bg-gray-50 rounded-2xl p-4">
          <h3 class="font-semibold text-gray-800 mb-3">สถานะระบบ</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                <i class="fas fa-database text-green-600"></i>
              </div>
              <p class="text-sm font-medium text-gray-800">การจัดเก็บ</p>
              <p class="text-xs text-green-600">ปกติ</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                <i class="fas fa-tachometer-alt text-green-600"></i>
              </div>
              <p class="text-sm font-medium text-gray-800">ประสิทธิภาพ</p>
              <p class="text-xs text-green-600">เยี่ยม</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                <i class="fas fa-shield-alt text-green-600"></i>
              </div>
              <p class="text-sm font-medium text-gray-800">ความปลอดภัย</p>
              <p class="text-xs text-green-600">ปลอดภัย</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-2">
                <i class="fas fa-sync-alt text-green-600"></i>
              </div>
              <p class="text-sm font-medium text-gray-800">ซิงค์ข้อมูล</p>
              <p class="text-xs text-green-600">พร้อม</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-6 right-6 space-y-3 z-50">
    <!-- Toast notifications will appear here -->
  </div>

  <script>
    // Enhanced Configuration for Fast Loading
    const CONFIG = {
      SHEET_ID: "1-7p30j2PR8oLeyJ02vMq1ut5IZ6iSh8zvMFS50w74Lc",
      QUIZ_RANGE: "Allquestions",
      API_KEY: "AIzaSyDpvXNmtRybEEu9JXzKOWF3F61-3tM5SCE",
      REALTIME_SYNC_INTERVAL: 30000,
      NOTIFICATION_TIMEOUT: 5000,
      MAX_NOTIFICATIONS: 100,
      CONNECTION_TIMEOUT: 5000,
      CACHE_DURATION: 5 * 60 * 1000, // 5 minutes cache
      FAST_LOAD: true,
      AUTO_SAVE: true,
      DEBOUNCE_DELAY: 300
    };

    // Global State with Cache Support
    let state = {
      subjects: {},
      currentSubject: null,
      notifications: [],
      isConnected: true,
      lastSync: null,
      searchResults: null,
      currentFilter: 'all',
      sortOrder: 'name',
      cacheEnabled: true,
      loadTime: 0,
      analytics: {
        pageViews: 0,
        quizAccesses: 0,
        totalUsers: 0,
        errorCount: 0
      }
    };

    // Fast Cache System
    class FastCache {
      constructor() {
        this.prefix = 'allquiz_';
        this.enabled = true;
      }

      set(key, data, ttl = CONFIG.CACHE_DURATION) {
        if (!this.enabled) return;
        
        try {
          const item = {
            data: data,
            timestamp: Date.now(),
            ttl: ttl
          };
          const storageData = JSON.stringify(item);
          document.getElementById('cache-size').textContent = Math.round(storageData.length / 1024) + ' KB';
          
          // Use variable instead of localStorage
          window[this.prefix + key] = item;
        } catch (error) {
          console.warn('Cache set failed:', error);
        }
      }

      get(key) {
        if (!this.enabled) return null;
        
        try {
          const item = window[this.prefix + key];
          if (!item) return null;
          
          if (Date.now() - item.timestamp > item.ttl) {
            this.delete(key);
            return null;
          }
          
          return item.data;
        } catch (error) {
          console.warn('Cache get failed:', error);
          return null;
        }
      }

      delete(key) {
        try {
          delete window[this.prefix + key];
        } catch (error) {
          console.warn('Cache delete failed:', error);
        }
      }

      clear() {
        try {
          Object.keys(window).forEach(key => {
            if (key.startsWith(this.prefix)) {
              delete window[key];
            }
          });
          showToast('ล้าง Cache เสร็จสิ้น', 'success');
        } catch (error) {
          console.warn('Cache clear failed:', error);
        }
      }

      size() {
        try {
          let size = 0;
          Object.keys(window).forEach(key => {
            if (key.startsWith(this.prefix)) {
              size += JSON.stringify(window[key]).length;
            }
          });
          return Math.round(size / 1024);
        } catch (error) {
          return 0;
        }
      }
    }

    const cache = new FastCache();

    // Fast Loading System
    class FastLoader {
      constructor() {
        this.loadStartTime = 0;
      }

      async loadData() {
        this.loadStartTime = performance.now();
        showLoadingOverlay(true);
        
        try {
          // Try cache first
          const cachedData = cache.get('subjects_data');
          if (cachedData && CONFIG.FAST_LOAD) {
            await this.processData(cachedData);
            hideSkeletonLoaders();
            showLoadingOverlay(false);
            this.updateLoadTime();
            showToast('โหลดจาก Cache สำเร็จ', 'success');
            
            // Background refresh
            setTimeout(() => this.refreshData(), 1000);
            return;
          }

          // Load from API
          await this.refreshData();
          
        } catch (error) {
          console.error('Load failed:', error);
          showToast('การโหลดล้มเหลว กำลังใช้ข้อมูลตัวอย่าง', 'warning');
          await this.loadSampleData();
        }
      }

      async refreshData() {
        try {
          const data = await SheetsAPI.readData();
          cache.set('subjects_data', data);
          await this.processData(data);
          hideSkeletonLoaders();
          showLoadingOverlay(false);
          this.updateLoadTime();
          
        } catch (error) {
          throw error;
        }
      }

      async processData(rawData) {
        return new Promise((resolve) => {
          // Fast processing with setTimeout to prevent blocking
          setTimeout(() => {
            state.subjects = {};
            let totalQuizzes = 0;
            let activeQuizzes = 0;

            rawData.slice(1).forEach(row => {
              const [subject, quizName, quizLink, quizDescription, expiryDate, status] = row || [];
              
              if (subject && subject.trim()) {
                if (!state.subjects[subject]) {
                  state.subjects[subject] = [];
                }
                
                if (quizName) {
                  const quiz = { 
                    id: Date.now() + Math.random(),
                    quizName, 
                    quizLink, 
                    quizDescription, 
                    expiryDate, 
                    status,
                    subject,
                    lastUpdated: new Date().toLocaleString('th-TH')
                  };
                  
                  state.subjects[subject].push(quiz);
                  totalQuizzes++;
                  
                  if (quizLink && !this.isExpired(expiryDate)) {
                    activeQuizzes++;
                  }
                }
              }
            });

            // Fast counter animation
            this.fastAnimateCounter('total-subjects', Object.keys(state.subjects).length);
            this.fastAnimateCounter('total-quizzes', totalQuizzes);
            this.fastAnimateCounter('active-quizzes', activeQuizzes);

            renderSubjects();
            resolve();
          }, 10);
        });
      }

      async loadSampleData() {
        const sampleData = [
          ['Subject', 'QuizName', 'QuizLink', 'Description', 'ExpiryDate', 'Status'],
          ['คณิตศาสตร์', 'ควิซเรื่องเซต', 'https://example.com/quiz1', 'เรื่องเซตและความสัมพันธ์', '31/12/2024, 23:59', 'อัพเดตล่าสุด'],
          ['ฟิสิกส์', 'ควิซเรื่องแรง', 'https://example.com/quiz2', 'แรงและการเคลื่อนที่', '31/12/2024, 23:59', 'อัพเดตล่าสุด'],
          ['เคมี', 'ควิซเรื่องธาตุ', 'https://example.com/quiz3', 'ธาตุและสารประกอบ', '31/12/2024, 23:59', 'อัพเดตล่าสุด'],
          ['ชีววิทยา', 'ควิซเรื่องเซลล์', 'https://example.com/quiz4', 'โครงสร้างเซลล์', '31/12/2024, 23:59', 'อัพเดตล่าสุด']
        ];
        
        cache.set('subjects_data', sampleData);
        await this.processData(sampleData);
        hideSkeletonLoaders();
        showLoadingOverlay(false);
        this.updateLoadTime();
      }

      fastAnimateCounter(elementId, targetValue) {
        const element = document.getElementById(elementId);
        if (!element) return;
        element.textContent = targetValue;
      }

      updateLoadTime() {
        const loadTime = Math.round(performance.now() - this.loadStartTime);
        state.loadTime = loadTime;
        document.getElementById('load-time').textContent = loadTime + 'ms';
        document.getElementById('admin-load-time').textContent = loadTime + 'ms';
      }

      isExpired(expiryDate) {
        if (!expiryDate) return false;
        try {
          const [date, time] = expiryDate.split(", ");
          const [day, month, year] = date.split("/");
          const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
          return new Date(formattedDate).getTime() < Date.now();
        } catch {
          return false;
        }
      }
    }

    const fastLoader = new FastLoader();

    // Simplified Sheets API
    const SheetsAPI = {
      async readData(range = CONFIG.QUIZ_RANGE) {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
        
        try {
          const response = await fetch(url, {
            headers: {
              'Accept': 'application/json',
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          return data.values || [];
          
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      }
    };

    // Quiz Management System
    class QuizManager {
      constructor() {
        this.currentQuiz = null;
      }

      openManager() {
        this.populateSubjects();
        this.loadQuizList();
        document.getElementById('quiz-manager-modal').classList.remove('hidden');
      }

      closeManager() {
        document.getElementById('quiz-manager-modal').classList.add('hidden');
        this.resetForm();
      }

      populateSubjects() {
        const select = document.getElementById('quiz-subject');
        select.innerHTML = '<option value="">เลือกวิชา</option>';
        
        Object.keys(state.subjects).forEach(subject => {
          const option = document.createElement('option');
          option.value = subject;
          option.textContent = subject;
          select.appendChild(option);
        });

        // Add "New Subject" option
        const newOption = document.createElement('option');
        newOption.value = '__new__';
        newOption.textContent = '+ เพิ่มวิชาใหม่';
        select.appendChild(newOption);
      }

      loadQuizList() {
        const tbody = document.getElementById('quiz-table-body');
        tbody.innerHTML = '';

        let allQuizzes = [];
        Object.entries(state.subjects).forEach(([subject, quizzes]) => {
          quizzes.forEach(quiz => {
            allQuizzes.push({ ...quiz, subject });
          });
        });

        if (allQuizzes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-gray-500 py-8">
                <i class="fas fa-search text-2xl mb-2"></i>
                <p>ไม่มีข้อมูลควิซ</p>
              </td>
            </tr>
          `;
          return;
        }

        allQuizzes.forEach(quiz => {
          const row = document.createElement('tr');
          const isExpired = fastLoader.isExpired(quiz.expiryDate);
          
          row.innerHTML = `
            <td class="font-medium">${quiz.subject}</td>
            <td>${quiz.quizName}</td>
            <td>
              <span class="badge ${this.getStatusBadgeClass(quiz.status, isExpired)}">
                ${isExpired ? 'หมดอายุ' : quiz.status || 'ไม่ระบุ'}
              </span>
            </td>
            <td class="text-sm text-gray-600">
              ${quiz.expiryDate ? this.formatDate(quiz.expiryDate) : 'ไม่ระบุ'}
            </td>
            <td>
              <div class="flex space-x-1">
                <button onclick="window.editQuiz('${quiz.id}')" class="text-blue-600 hover:text-blue-800 p-1">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="window.deleteQuiz('${quiz.id}')" class="text-red-600 hover:text-red-800 p-1">
                  <i class="fas fa-trash"></i>
                </button>
                <button onclick="window.duplicateQuiz('${quiz.id}')" class="text-green-600 hover:text-green-800 p-1">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      }

      getStatusBadgeClass(status, isExpired) {
        if (isExpired) return 'badge-danger';
        
        switch (status) {
          case 'อัพเดตล่าสุด': return 'badge-success';
          case 'รออัพเดต': return 'badge-warning';
          case 'ปิดปรับปรุง': return 'badge-danger';
          default: return 'badge-warning';
        }
      }

      formatDate(dateString) {
        try {
          const [date, time] = dateString.split(", ");
          return date + (time ? ` ${time}` : '');
        } catch {
          return dateString;
        }
      }

      saveQuiz(event) {
        event.preventDefault();
        
        const formData = {
          subject: document.getElementById('quiz-subject').value,
          quizName: document.getElementById('quiz-name').value,
          quizLink: document.getElementById('quiz-link').value,
          quizDescription: document.getElementById('quiz-description').value,
          expiryDate: this.formatExpiryDate(document.getElementById('quiz-expiry').value),
          status: document.getElementById('quiz-status').value
        };

        // Handle new subject
        if (formData.subject === '__new__') {
          const newSubject = prompt('ชื่อวิชาใหม่:');
          if (!newSubject) return;
          formData.subject = newSubject.trim();
        }

        // Validation
        if (!formData.subject || !formData.quizName || !formData.quizLink) {
          showToast('กรุณากรอกข้อมูลที่จำเป็น', 'error');
          return;
        }

        const action = document.getElementById('quiz-action').value;
        const quizId = document.getElementById('quiz-id').value;

        if (action === 'edit' && quizId) {
          this.updateQuiz(quizId, formData);
        } else {
          this.addQuiz(formData);
        }
      }

      addQuiz(quizData) {
        const quiz = {
          id: Date.now() + Math.random(),
          ...quizData,
          lastUpdated: new Date().toLocaleString('th-TH')
        };

        if (!state.subjects[quizData.subject]) {
          state.subjects[quizData.subject] = [];
        }

        state.subjects[quizData.subject].push(quiz);
        this.saveToCache();
        this.resetForm();
        this.loadQuizList();
        
        showToast('เพิ่มควิซเสร็จสิ้น', 'success');
        
        // Update display if viewing this subject
        if (state.currentSubject === quizData.subject) {
          renderQuizzes(state.subjects[quizData.subject]);
        } else {
          renderSubjects();
        }
      }

      updateQuiz(quizId, quizData) {
        let found = false;
        
        Object.entries(state.subjects).forEach(([subject, quizzes]) => {
          const quizIndex = quizzes.findIndex(q => q.id == quizId);
          if (quizIndex !== -1) {
            // Remove from old subject if subject changed
            if (subject !== quizData.subject) {
              quizzes.splice(quizIndex, 1);
              if (quizzes.length === 0) {
                delete state.subjects[subject];
              }
              
              // Add to new subject
              if (!state.subjects[quizData.subject]) {
                state.subjects[quizData.subject] = [];
              }
              state.subjects[quizData.subject].push({
                id: quizId,
                ...quizData,
                lastUpdated: new Date().toLocaleString('th-TH')
              });
            } else {
              // Update in same subject
              state.subjects[subject][quizIndex] = {
                id: quizId,
                ...quizData,
                lastUpdated: new Date().toLocaleString('th-TH')
              };
            }
            found = true;
          }
        });

        if (found) {
          this.saveToCache();
          this.resetForm();
          this.loadQuizList();
          showToast('แก้ไขควิซเสร็จสิ้น', 'success');
          
          // Update display
          if (state.currentSubject) {
            renderQuizzes(state.subjects[state.currentSubject] || []);
          } else {
            renderSubjects();
          }
        }
      }

      editQuiz(quizId) {
        let targetQuiz = null;
        
        Object.entries(state.subjects).forEach(([subject, quizzes]) => {
          const quiz = quizzes.find(q => q.id == quizId);
          if (quiz) {
            targetQuiz = { ...quiz, subject };
          }
        });

        if (!targetQuiz) {
          showToast('ไม่พบควิซที่ต้องการแก้ไข', 'error');
          return;
        }

        // Fill form
        document.getElementById('quiz-id').value = targetQuiz.id;
        document.getElementById('quiz-action').value = 'edit';
        document.getElementById('quiz-subject').value = targetQuiz.subject;
        document.getElementById('quiz-name').value = targetQuiz.quizName;
        document.getElementById('quiz-link').value = targetQuiz.quizLink;
        document.getElementById('quiz-description').value = targetQuiz.quizDescription || '';
        document.getElementById('quiz-status').value = targetQuiz.status || 'อัพเดตล่าสุด';
        
        if (targetQuiz.expiryDate) {
          document.getElementById('quiz-expiry').value = this.parseExpiryDate(targetQuiz.expiryDate);
        }

        document.getElementById('save-btn-text').textContent = 'อัพเดตควิซ';
        
        // Scroll to top of form
        document.getElementById('quiz-form').scrollIntoView({ behavior: 'smooth' });
      }

      deleteQuiz(quizId) {
        if (!confirm('ต้องการลบควิซนี้หรือไม่?')) return;

        let found = false;
        Object.entries(state.subjects).forEach(([subject, quizzes]) => {
          const quizIndex = quizzes.findIndex(q => q.id == quizId);
          if (quizIndex !== -1) {
            quizzes.splice(quizIndex, 1);
            if (quizzes.length === 0) {
              delete state.subjects[subject];
            }
            found = true;
          }
        });

        if (found) {
          this.saveToCache();
          this.loadQuizList();
          showToast('ลบควิซเสร็จสิ้น', 'success');
          
          // Update display
          if (state.currentSubject) {
            renderQuizzes(state.subjects[state.currentSubject] || []);
          } else {
            renderSubjects();
          }
        }
      }

      duplicateQuiz(quizId) {
        let targetQuiz = null;
        
        Object.entries(state.subjects).forEach(([subject, quizzes]) => {
          const quiz = quizzes.find(q => q.id == quizId);
          if (quiz) {
            targetQuiz = { ...quiz, subject };
          }
        });

        if (!targetQuiz) return;

        const newQuiz = {
          id: Date.now() + Math.random(),
          quizName: targetQuiz.quizName + ' (สำเนา)',
          quizLink: targetQuiz.quizLink,
          quizDescription: targetQuiz.quizDescription,
          expiryDate: targetQuiz.expiryDate,
          status: targetQuiz.status,
          subject: targetQuiz.subject,
          lastUpdated: new Date().toLocaleString('th-TH')
        };

        state.subjects[targetQuiz.subject].push(newQuiz);
        this.saveToCache();
        this.loadQuizList();
        showToast('คัดลอกควิซเสร็จสิ้น', 'success');
        
        // Update display
        if (state.currentSubject === targetQuiz.subject) {
          renderQuizzes(state.subjects[targetQuiz.subject]);
        } else {
          renderSubjects();
        }
      }

      formatExpiryDate(datetimeLocal) {
        if (!datetimeLocal) return '';
        
        try {
          const date = new Date(datetimeLocal);
          const day = date.getDate().toString().padStart(2, '0');
          const month = (date.getMonth() + 1).toString().padStart(2, '0');
          const year = date.getFullYear();
          const hours = date.getHours().toString().padStart(2, '0');
          const minutes = date.getMinutes().toString().padStart(2, '0');
          
          return `${day}/${month}/${year}, ${hours}:${minutes}`;
        } catch {
          return '';
        }
      }

      parseExpiryDate(dateString) {
        if (!dateString) return '';
        
        try {
          const [date, time] = dateString.split(", ");
          const [day, month, year] = date.split("/");
          const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
          
          if (time) {
            return `${formattedDate}T${time}`;
          }
          return `${formattedDate}T00:00`;
        } catch {
          return '';
        }
      }

      resetForm() {
        document.getElementById('quiz-form').reset();
        document.getElementById('quiz-id').value = '';
        document.getElementById('quiz-action').value = 'add';
        document.getElementById('save-btn-text').textContent = 'บันทึกควิซ';
      }

      saveToCache() {
        cache.set('subjects_data', this.convertToRawData());
      }

      convertToRawData() {
        const rawData = [['Subject', 'QuizName', 'QuizLink', 'Description', 'ExpiryDate', 'Status']];
        
        Object.entries(state.subjects).forEach(([subject, quizzes]) => {
          quizzes.forEach(quiz => {
            rawData.push([
              subject,
              quiz.quizName,
              quiz.quizLink,
              quiz.quizDescription || '',
              quiz.expiryDate || '',
              quiz.status || ''
            ]);
          });
        });
        
        return rawData;
      }
    }

    const quizManager = new QuizManager();

    // Bulk Import System
    class BulkImporter {
      showModal() {
        document.getElementById('bulk-import-modal').classList.remove('hidden');
      }

      closeModal() {
        document.getElementById('bulk-import-modal').classList.add('hidden');
        this.hideAllSections();
      }

      showCsvImport() {
        this.hideAllSections();
        document.getElementById('csv-import-section').classList.remove('hidden');
      }

      showManualBulk() {
        this.hideAllSections();
        document.getElementById('manual-bulk-section').classList.remove('hidden');
      }

      hideAllSections() {
        document.getElementById('csv-import-section').classList.add('hidden');
        document.getElementById('manual-bulk-section').classList.add('hidden');
      }

      importCsvFile() {
        const fileInput = document.getElementById('csv-file');
        const file = fileInput.files[0];
        
        if (!file) {
          showToast('กรุณาเลือกไฟล์ CSV', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csvData = this.parseCsv(e.target.result);
            this.importData(csvData);
          } catch (error) {
            showToast('ไฟล์ CSV ไม่ถูกต้อง', 'error');
          }
        };
        reader.readAsText(file);
      }

      importBulkText() {
        const text = document.getElementById('bulk-text').value.trim();
        if (!text) {
          showToast('กรุณาป้อนข้อมูล', 'error');
          return;
        }

        const lines = text.split('\n').filter(line => line.trim());
        const data = [];
        
        lines.forEach(line => {
          const parts = line.split('|').map(part => part.trim());
          if (parts.length >= 3) { // At least subject, name, link
            data.push(parts);
          }
        });

        if (data.length === 0) {
          showToast('ไม่พบข้อมูลที่ถูกต้อง', 'error');
          return;
        }

        this.importData(data);
      }

      parseCsv(csvText) {
        const lines = csvText.split('\n');
        const result = [];
        
        lines.forEach(line => {
          if (line.trim()) {
            // Simple CSV parsing - in real app would use proper CSV parser
            const parts = line.split(',').map(part => part.trim().replace(/^"|"$/g, ''));
            result.push(parts);
          }
        });
        
        return result.slice(1); // Skip header
      }

      importData(data) {
        let imported = 0;
        let errors = 0;

        data.forEach(row => {
          try {
            const [subject, quizName, quizLink, description, expiryDate, status] = row;
            
            if (!subject || !quizName || !quizLink) {
              errors++;
              return;
            }

            const quiz = {
              id: Date.now() + Math.random() + imported,
              quizName: quizName.trim(),
              quizLink: quizLink.trim(),
              quizDescription: description ? description.trim() : '',
              expiryDate: expiryDate ? expiryDate.trim() : '',
              status: status ? status.trim() : 'อัพเดตล่าสุด',
              subject: subject.trim(),
              lastUpdated: new Date().toLocaleString('th-TH')
            };

            if (!state.subjects[quiz.subject]) {
              state.subjects[quiz.subject] = [];
            }

            state.subjects[quiz.subject].push(quiz);
            imported++;

          } catch (error) {
            errors++;
          }
        });

        quizManager.saveToCache();
        renderSubjects();
        this.closeModal();
        
        showToast(`นำเข้าสำเร็จ ${imported} รายการ${errors > 0 ? `, ล้มเหลว ${errors} รายการ` : ''}`, 'success');
      }
    }

    const bulkImporter = new BulkImporter();

    // UI Helper Functions
    function showLoadingOverlay(show) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function hideSkeletonLoaders() {
      document.querySelectorAll('.skeleton-card').forEach(card => {
        card.style.display = 'none';
      });
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      toast.className = `${colors[type]} text-white px-6 py-4 rounded-2xl shadow-lg transform translate-x-full transition-transform duration-300`;
      toast.innerHTML = `
        <div class="flex items-center space-x-2">
          <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Enhanced UI Functions
    function renderSubjects() {
      const grid = document.getElementById('subjects-grid');
      
      // Clear skeleton loaders
      grid.querySelectorAll('.skeleton-card').forEach(card => card.remove());
      
      const subjects = state.searchResults || state.subjects;

      if (Object.keys(subjects).length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-book-open text-gray-400 text-6xl mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-600 mb-2">ไม่มีข้อมูลวิชา</h3>
            <p class="text-gray-500">เพิ่มควิซใหม่เพื่อเริ่มต้นใช้งาน</p>
            <button onclick="window.showQuizManager()" class="btn btn-primary mt-4">
              <i class="fas fa-plus"></i>
              เพิ่มควิซแรก
            </button>
          </div>
        `;
        return;
      }

      grid.innerHTML = '';
      Object.entries(subjects).forEach(([subject, quizzes], index) => {
        const card = createEnhancedSubjectCard(subject, quizzes, index);
        grid.appendChild(card);
      });
    }

    function createEnhancedSubjectCard(subject, quizzes, index) {
      const availableQuizzes = quizzes.filter(q => q.quizName && q.quizLink && !fastLoader.isExpired(q.expiryDate)).length;
      const expiringSoon = quizzes.filter(q => fastLoader.isExpiringSoon && fastLoader.isExpiringSoon(q.expiryDate)).length;
      const hasQuizzes = quizzes.some(q => q.quizName);
      
      const card = document.createElement('div');
      card.className = `quiz-card glass-morphism rounded-3xl p-6 border cursor-pointer fast-load ${hasQuizzes ? 'hover:shadow-2xl' : 'opacity-75'}`;
      card.style.animationDelay = `${index * 50}ms`; // Faster animation
      
      const icon = getSubjectIcon(subject);
      
      let statusIndicator = '';
      if (expiringSoon > 0) {
        statusIndicator = `
          <div class="absolute top-4 right-4 w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>
          <div class="absolute top-2 right-2 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">
            ${expiringSoon} ใกล้หมดอายุ
          </div>
        `;
      }
      
      card.innerHTML = `
        <div class="relative">
          ${statusIndicator}
          <div class="text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-primary to-secondary rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-lg">
              <i class="fas ${icon} text-white text-3xl"></i>
            </div>
            <h3 class="font-bold text-gray-800 mb-3 text-xl">${subject}</h3>
            ${!hasQuizzes ? 
              '<div class="inline-block px-4 py-2 bg-yellow-100 text-yellow-800 text-sm rounded-2xl font-medium">รออัพเดต</div>' :
              `<div class="space-y-2">
                <div class="inline-block px-4 py-2 bg-green-100 text-green-800 text-sm rounded-2xl font-medium">
                  ${availableQuizzes} ควิซพร้อมใช้
                </div>
                ${expiringSoon > 0 ? 
                  `<div class="inline-block px-4 py-2 bg-orange-100 text-orange-800 text-sm rounded-2xl font-medium">
                    ${expiringSoon} ใกล้หมดอายุ
                  </div>` : ''
                }
              </div>`
            }
            <div class="mt-4 text-xs text-gray-500">
              โหลดจาก: Cache (${state.loadTime}ms)
            </div>
            <div class="mt-2 flex justify-center space-x-2">
              <button onclick="event.stopPropagation(); window.editSubject('${subject}')" class="text-gray-400 hover:text-blue-600 p-1">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="event.stopPropagation(); window.addQuizToSubject('${subject}')" class="text-gray-400 hover:text-green-600 p-1">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      if (hasQuizzes) {
        card.addEventListener('click', () => {
          showQuizzes(subject);
          state.analytics.quizAccesses++;
        });
      }
      
      return card;
    }

    function getSubjectIcon(subject) {
      const icons = {
        'คอมพิวเตอร์': 'fa-laptop-code',
        'คณิตศาสตร์': 'fa-calculator',
        'คณิต': 'fa-calculator',
        'วิทยาศาสตร์': 'fa-flask',
        'วิทย์': 'fa-flask',
        'ภาษา': 'fa-language',
        'ประวัติศาสตร์': 'fa-landmark',
        'ประวัติ': 'fa-landmark',
        'ภูมิศาสตร์': 'fa-globe',
        'ภูมิ': 'fa-globe',
        'ฟิสิกส์': 'fa-atom',
        'ฟิสิก': 'fa-atom',
        'เคมี': 'fa-vial',
        'ชีววิทยา': 'fa-dna',
        'ชีวะ': 'fa-dna',
        'อังกฤษ': 'fa-language',
        'english': 'fa-language',
        'default': 'fa-book'
      };
      
      for (const [key, icon] of Object.entries(icons)) {
        if (subject.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      return icons.default;
    }

    function showQuizzes(subject) {
      state.currentSubject = subject;
      const quizzes = state.subjects[subject];
      
      document.getElementById('subjects-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-section-title').textContent = `ควิซในวิชา ${subject}`;
      
      renderQuizzes(quizzes);
    }

    function renderQuizzes(quizzes) {
      const grid = document.getElementById('quiz-grid');
      grid.innerHTML = '';

      const sortedQuizzes = [...quizzes].sort((a, b) => {
        if (state.sortOrder === 'name') {
          return (a.quizName || '').localeCompare(b.quizName || '');
        } else {
          return new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0);
        }
      });

      sortedQuizzes.forEach((quiz, index) => {
        if (!quiz.quizName) return;
        
        const card = createEnhancedQuizCard(quiz, index);
        grid.appendChild(card);
      });
    }

    function createEnhancedQuizCard(quiz, index) {
      const isExpiredQuiz = fastLoader.isExpired(quiz.expiryDate);
      const isExpiringSoon = fastLoader.isExpiringSoon && fastLoader.isExpiringSoon(quiz.expiryDate);
      const countdown = quiz.expiryDate ? calculateCountdown(quiz.expiryDate) : null;
      
      const card = document.createElement('div');
      card.className = 'quiz-card glass-morphism rounded-3xl p-6 border fast-load hover:shadow-2xl animate-slide-up';
      card.style.animationDelay = `${index * 50}ms`;
      
      let statusBadge = '';
      let statusIndicator = '';
      
      if (isExpiredQuiz) {
        statusBadge = '<div class="inline-block px-4 py-2 bg-red-100 text-red-800 text-sm rounded-2xl font-medium mb-3">หมดอายุแล้ว</div>';
        statusIndicator = '<div class="absolute top-4 right-4 w-3 h-3 bg-red-500 rounded-full"></div>';
      } else if (isExpiringSoon) {
        statusBadge = `<div class="inline-block px-4 py-2 bg-orange-100 text-orange-800 text-sm rounded-2xl font-medium mb-3"><i class="fas fa-clock mr-1"></i>${countdown}</div>`;
        statusIndicator = '<div class="absolute top-4 right-4 w-3 h-3 bg-orange-500 rounded-full animate-pulse"></div>';
      } else if (quiz.status) {
        const statusColors = {
          'อัพเดตล่าสุด': 'bg-green-100 text-green-800',
          'รออัพเดต': 'bg-yellow-100 text-yellow-800',
          'ปิดปรับปรุง': 'bg-red-100 text-red-800'
        };
        const colorClass = statusColors[quiz.status] || 'bg-gray-100 text-gray-800';
        statusBadge = `<div class="inline-block px-4 py-2 ${colorClass} text-sm rounded-2xl font-medium mb-3">${quiz.status}</div>`;
      }
      
      card.innerHTML = `
        <div class="relative">
          ${statusIndicator}
          <div class="flex items-start space-x-4">
            <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center flex-shrink-0">
              <i class="fas fa-file-alt text-gray-600 text-2xl"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-bold text-gray-800 mb-2 text-lg leading-tight">${quiz.quizName}</h3>
              ${statusBadge}
              ${quiz.quizDescription ? `<p class="text-gray-600 text-sm mb-4 leading-relaxed">${quiz.quizDescription}</p>` : ''}
              
              <div class="flex items-center justify-between mt-4">
                <div class="flex space-x-2">
                  ${quiz.quizLink && !isExpiredQuiz ? 
                    `<button onclick="window.accessQuiz('${quiz.quizLink}', '${quiz.quizName}')" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white text-sm rounded-2xl hover:shadow-lg transition-all font-medium">
                      <i class="fas fa-external-link-alt mr-2"></i>ดูเฉลย
                    </button>` :
                    '<span class="px-4 py-2 bg-gray-100 text-gray-600 text-sm rounded-2xl font-medium">ไม่พร้อมใช้งาน</span>'
                  }
                  <button onclick="window.editQuiz('${quiz.id}')" class="inline-flex items-center px-3 py-2 bg-blue-100 text-blue-700 text-sm rounded-2xl hover:bg-blue-200 transition-all">
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
                
                <div class="text-right">
                  <div class="text-xs text-gray-500">อัพเดต: ${quiz.lastUpdated || 'ไม่ระบุ'}</div>
                  ${countdown && !isExpiredQuiz ? `<div class="text-xs text-orange-600 font-medium">${countdown}</div>` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }

    function calculateCountdown(expiryDate) {
      if (!expiryDate) return '';
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        const timeLeft = new Date(formattedDate).getTime() - Date.now();
        
        if (timeLeft <= 0) return 'หมดเวลา';
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 7) return `${days} วัน`;
        if (days > 0) return `${days} วัน ${hours} ชม.`;
        if (hours > 0) return `${hours} ชม. ${minutes} นาที`;
        return `${minutes} นาที`;
      } catch {
        return '';
      }
    }

    // Search Functions
    function handleSearch() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!query) {
        state.searchResults = null;
        document.getElementById('search-results-count').classList.add('hidden');
        renderSubjects();
        return;
      }

      const results = {};
      let totalResults = 0;
      
      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const matchingQuizzes = quizzes.filter(quiz => {
          if (state.currentFilter !== 'all') {
            if (state.currentFilter === 'active' && fastLoader.isExpired(quiz.expiryDate)) return false;
            if (state.currentFilter === 'expired' && !fastLoader.isExpired(quiz.expiryDate)) return false;
            if (state.currentFilter === 'updated' && quiz.status !== 'อัพเดตล่าสุด') return false;
          }
          
          return subject.toLowerCase().includes(query) ||
                 (quiz.quizName && quiz.quizName.toLowerCase().includes(query)) ||
                 (quiz.quizDescription && quiz.quizDescription.toLowerCase().includes(query));
        });
        
        if (matchingQuizzes.length > 0 || subject.toLowerCase().includes(query)) {
          results[subject] = quizzes;
          totalResults += matchingQuizzes.length;
        }
      });

      state.searchResults = results;
      
      const countElement = document.getElementById('search-results-count');
      countElement.textContent = `${totalResults} ผลลัพธ์`;
      countElement.classList.remove('hidden');
      
      renderSubjects();
    }

    // Debounced search for better performance
    let searchTimeout;
    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(handleSearch, CONFIG.DEBOUNCE_DELAY);
    }

    // Global function definitions for onclick handlers
    window.accessQuiz = function(link, name) {
      state.analytics.quizAccesses++;
      window.open(link, '_blank');
      showToast(`เปิดดูเฉลย: ${name}`, 'info');
    };

    window.showQuizManager = function() {
      quizManager.openManager();
    };

    window.closeQuizManager = function() {
      quizManager.closeManager();
    };

    window.saveQuiz = function(event) {
      quizManager.saveQuiz(event);
    };

    window.editQuiz = function(quizId) {
      quizManager.editQuiz(quizId);
      quizManager.openManager();
    };

    window.deleteQuiz = function(quizId) {
      quizManager.deleteQuiz(quizId);
    };

    window.duplicateQuiz = function(quizId) {
      quizManager.duplicateQuiz(quizId);
    };

    window.addQuizToSubject = function(subject) {
      if (subject) {
        quizManager.openManager();
        setTimeout(() => {
          document.getElementById('quiz-subject').value = subject;
        }, 100);
      } else {
        quizManager.openManager();
      }
    };

    window.showBulkImport = function() {
      bulkImporter.showModal();
    };

    window.closeBulkImport = function() {
      bulkImporter.closeModal();
    };

    window.showCsvImport = function() {
      bulkImporter.showCsvImport();
    };

    window.showManualBulk = function() {
      bulkImporter.showManualBulk();
    };

    window.importCsvFile = function() {
      bulkImporter.importCsvFile();
    };

    window.importBulkText = function() {
      bulkImporter.importBulkText();
    };

    window.exportAllData = function() {
      const data = quizManager.convertToRawData();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `allquiz-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      showToast('ส่งออกข้อมูลเสร็จสิ้น', 'success');
    };

    window.refreshCache = function() {
      showLoadingOverlay(true);
      setTimeout(() => {
        fastLoader.refreshData().then(() => {
          showToast('รีเฟรชข้อมูลเสร็จสิ้น', 'success');
        }).catch(error => {
          showToast('การรีเฟรชล้มเหลว', 'error');
        });
      }, 500);
    };

    window.refreshQuizList = function() {
      quizManager.loadQuizList();
      showToast('รีเฟรชรายการควิซแล้ว', 'info');
    };

    window.exportQuizData = function() {
      const data = quizManager.convertToRawData();
      const csvContent = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `allquiz-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      showToast('ส่งออก CSV เสร็จสิ้น', 'success');
    };

    window.toggleSearchFilters = function() {
      const filters = document.getElementById('search-filters');
      filters.classList.toggle('hidden');
    };

    window.filterByStatus = function(status) {
      state.currentFilter = status;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      event.target.classList.remove('bg-gray-200', 'text-gray-700');
      event.target.classList.add('bg-primary', 'text-white');
      
      handleSearch();
    };

    window.sortQuizzes = function(order) {
      state.sortOrder = order;
      if (state.currentSubject) {
        renderQuizzes(state.subjects[state.currentSubject]);
      }
    };

    window.goBackToSubjects = function() {
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('subjects-section').classList.remove('hidden');
      state.currentSubject = null;
    };

    window.editSubject = function(subject) {
      const newName = prompt('ชื่อวิชาใหม่:', subject);
      if (newName && newName.trim() && newName.trim() !== subject) {
        const quizzes = state.subjects[subject];
        delete state.subjects[subject];
        
        quizzes.forEach(quiz => {
          quiz.subject = newName.trim();
          quiz.lastUpdated = new Date().toLocaleString('th-TH');
        });
        
        state.subjects[newName.trim()] = quizzes;
        quizManager.saveToCache();
        renderSubjects();
        showToast('แก้ไชื่อวิชาเสร็จสิ้น', 'success');
      }
    };

    // Admin Functions
    window.showAdminPanel = function() {
      updateAdminData();
      document.getElementById('admin-modal').classList.remove('hidden');
    };

    window.closeAdminPanel = function() {
      document.getElementById('admin-modal').classList.add('hidden');
    };

    window.clearAllCache = function() {
      if (confirm('ต้องการล้าง Cache ทั้งหมดหรือไม่?')) {
        cache.clear();
        updateAdminData();
      }
    };

    window.backupData = function() {
      const backupData = {
        subjects: state.subjects,
        metadata: {
          exportDate: new Date().toISOString(),
          totalQuizzes: Object.values(state.subjects).reduce((sum, quizzes) => sum + quizzes.length, 0),
          totalSubjects: Object.keys(state.subjects).length,
          version: '2.0.0'
        }
      };
      
      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `allquiz-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      showToast('สำรองข้อมูลเสร็จสิ้น', 'success');
    };

    window.resetSystem = function() {
      if (confirm('ต้องการรีเซ็ตระบบหรือไม่? ข้อมูลทั้งหมดจะถูกลบ!')) {
        if (confirm('ยืนยันการรีเซ็ต? การกระทำนี้ไม่สามารถยกเลิกได้!')) {
          cache.clear();
          state.subjects = {};
          state.searchResults = null;
          renderSubjects();
          updateAdminData();
          showToast('รีเซ็ตระบบเสร็จสิ้น', 'success');
        }
      }
    };

    // Analytics and Notification Functions
    window.toggleRealTimeNotifications = function() {
      showToast('ระบบแจ้งเตือนพร้อมใช้งาน', 'info');
    };

    window.toggleAnalytics = function() {
      showToast('Analytics พร้อมใช้งาน', 'info');
    };

    // Helper Functions
    function updateAdminData() {
      const totalQuizzes = Object.values(state.subjects).reduce((sum, quizzes) => sum + quizzes.length, 0);
      
      document.getElementById('admin-total-quizzes').textContent = totalQuizzes;
      document.getElementById('cache-size').textContent = cache.size() + ' KB';
      document.getElementById('last-admin-update').textContent = new Date().toLocaleTimeString('th-TH');
      
      // Update performance stats
      fastLoader.animateCounter('total-subjects', Object.keys(state.subjects).length);
      fastLoader.animateCounter('total-quizzes', totalQuizzes);
      fastLoader.animateCounter('active-quizzes', 
        Object.values(state.subjects).reduce((sum, quizzes) => 
          sum + quizzes.filter(q => q.quizLink && !fastLoader.isExpired(q.expiryDate)).length, 0)
      );
    }

    // Enhanced isExpiringSoon function for fastLoader
    fastLoader.isExpiringSoon = function(expiryDate, daysThreshold = 7) {
      if (!expiryDate) return false;
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        const timeLeft = new Date(formattedDate).getTime() - Date.now();
        const daysLeft = timeLeft / (1000 * 60 * 60 * 24);
        return daysLeft > 0 && daysLeft <= daysThreshold;
      } catch {
        return false;
      }
    };

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize search with debouncing
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', debouncedSearch);
        
        // Show initial loading
        showLoadingOverlay(true);
        
        // Initialize fast loading system
        await fastLoader.loadData();
        
        // Update admin data
        updateAdminData();
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
          fastLoader.refreshData().catch(error => {
            console.warn('Auto-refresh failed:', error);
          });
        }, 5 * 60 * 1000);
        
        console.log('Allquiz Enhanced initialized successfully');
        
      } catch (error) {
        console.error('Application initialization failed:', error);
        showToast('เกิดข้อผิดพลาดในการเริ่มต้นระบบ', 'error');
        showLoadingOverlay(false);
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (event) => {
      // Ctrl+N: New Quiz
      if (event.ctrlKey && event.key === 'n') {
        event.preventDefault();
        window.showQuizManager();
      }
      
      // Ctrl+R: Refresh
      if (event.ctrlKey && event.key === 'r') {
        event.preventDefault();
        window.refreshCache();
      }
      
      // Escape: Close modals
      if (event.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(modal => {
          if (!modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
          }
        });
        document.getElementById('admin-modal').classList.add('hidden');
      }
    });

    // Auto-save functionality
    let autoSaveTimeout;
    function autoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        if (CONFIG.AUTO_SAVE) {
          quizManager.saveToCache();
        }
      }, 2000);
    }

    // Listen for data changes
    const originalPush = Array.prototype.push;
    Array.prototype.push = function(...args) {
      const result = originalPush.apply(this, args);
      autoSave();
      return result;
    };

    // Performance monitoring
    const performanceObserver = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'navigation') {
          document.getElementById('load-time').textContent = Math.round(entry.loadEventEnd - entry.loadEventStart) + 'ms';
        }
      });
    });

    performanceObserver.observe({ entryTypes: ['navigation'] });

    // Service Worker registration for offline support (if needed)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(error => {
        console.log('Service Worker registration failed:', error);
      });
    }

    // Initialize tooltips and help system
    function initializeHelp() {
      const helpTips = [
        { element: '#search-input', tip: 'พิมพ์เพื่อค้นหาแบบ Real-time' },
        { element: '[onclick*="showQuizManager"]', tip: 'Ctrl+N เพื่อเพิ่มควิซใหม่' },
        { element: '[onclick*="refreshCache"]', tip: 'Ctrl+R เพื่อรีเฟรชข้อมูล' }
      ];
      
      helpTips.forEach(({ element, tip }) => {
        const el = document.querySelector(element);
        if (el) {
          el.title = tip;
        }
      });
    }

    // Initialize help system after DOM load
    setTimeout(initializeHelp, 1000);
  </script>
</body>
</html>
