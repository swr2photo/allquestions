<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allquiz - ระบบเฉลยคำตอบ</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007AFF',
            secondary: '#5856D6',
            accent: '#FF3B30',
            success: '#34C759',
            warning: '#FF9500',
          },
          fontFamily: {
            'sf': ['SF Pro Display', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s ease-in-out infinite',
            'bounce-gentle': 'bounce 2s infinite',
            'slide-up': 'slideUp 0.5s ease-out',
            'fade-in': 'fadeIn 0.6s ease-out',
          }
        }
      }
    }
  </script>
  
  <style>
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .maintenance-overlay {
      background: linear-gradient(135deg, 
        rgba(0, 122, 255, 0.1) 0%,
        rgba(88, 86, 214, 0.1) 50%,
        rgba(255, 59, 48, 0.1) 100%);
      backdrop-filter: blur(20px);
    }
    
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-sf">
  
  <!-- Maintenance Mode Overlay -->
  <div id="maintenance-overlay" class="hidden fixed inset-0 maintenance-overlay z-50 flex items-center justify-center p-4">
    <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-md p-8 text-center animate-slide-up">
      <div class="w-20 h-20 bg-warning rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse-slow">
        <i class="fas fa-tools text-white text-2xl"></i>
      </div>
      
      <h2 class="text-2xl font-bold text-gray-800 mb-4">เว็บไซต์กำลังพัฒนา</h2>
      <p class="text-gray-600 mb-6">ขออภัยในความไม่สะดวก เรากำลังปรับปรุงระบบให้ดีขึ้น</p>
      
      <div class="space-y-3">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-500">ความคืบหน้า:</span>
          <span class="text-primary font-semibold" id="maintenance-progress">75%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-primary h-2 rounded-full transition-all duration-500" style="width: 75%"></div>
        </div>
      </div>
      
      <div class="mt-6 pt-6 border-t border-gray-200">
        <p class="text-xs text-gray-500 mb-3">สำหรับผู้ดูแลระบบ:</p>
        <button onclick="showAdminAccess()" class="px-4 py-2 bg-primary text-white rounded-xl text-sm hover:bg-blue-600 transition-colors">
          <i class="fas fa-key mr-2"></i>เข้าสู่ระบบ
        </button>
      </div>
    </div>
  </div>

  <!-- Admin Access Modal -->
  <div id="admin-access-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-sm p-6 animate-slide-up">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-shield-alt text-white text-xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800">ยืนยันตัวตน</h3>
      </div>
      
      <form class="space-y-4" onsubmit="checkMaintenanceAccess(event)">
        <input type="password" id="maintenance-password" placeholder="รหัสผ่านเข้าใช้งาน" 
               class="w-full px-4 py-3 bg-white/50 rounded-xl border border-white/30 outline-none focus:ring-2 focus:ring-primary/50">
        
        <div class="flex space-x-3">
          <button type="button" onclick="hideAdminAccess()" 
                  class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-xl">ยกเลิก</button>
          <button type="submit" 
                  class="flex-1 px-4 py-3 bg-primary text-white rounded-xl">เข้าสู่ระบบ</button>
        </div>
      </form>
      
      <div id="access-error" class="hidden mt-4 text-red-600 text-sm text-center">
        รหัสผ่านไม่ถูกต้อง
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-app" class="animate-fade-in">
    
    <!-- Dynamic Island Navigation -->
    <nav class="fixed top-4 left-1/2 transform -translate-x-1/2 z-40">
      <div class="glass-effect px-6 py-3 rounded-3xl flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-6 h-6 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
            <i class="fas fa-graduation-cap text-white text-xs"></i>
          </div>
          <span class="text-gray-800 font-semibold text-sm">Allquiz</span>
        </div>
        
        <div class="flex items-center space-x-3">
          <button onclick="toggleNotifications()" class="relative text-gray-600 hover:text-primary transition-colors p-1">
            <i class="fas fa-bell text-sm"></i>
            <span id="notification-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-accent rounded-full animate-pulse hidden"></span>
          </button>
          
          <button onclick="toggleMaintenanceMode()" class="relative text-gray-600 hover:text-primary transition-colors p-1">
            <i class="fas fa-cog text-sm"></i>
            <span id="maintenance-indicator" class="absolute -top-1 -right-1 w-2 h-2 bg-warning rounded-full hidden"></span>
          </button>
          
          <button onclick="showAdminPanel()" class="relative text-gray-600 hover:text-primary transition-colors p-1">
            <i class="fas fa-shield-alt text-sm"></i>
            <span id="admin-indicator" class="absolute -top-1 -right-1 w-2 h-2 bg-success rounded-full hidden"></span>
          </button>
        </div>
      </div>
    </nav>

    <!-- System Notifications -->
    <div id="system-notifications" class="fixed top-20 left-4 right-4 z-30 space-y-3">
      <!-- System notifications will appear here -->
    </div>

    <!-- Content -->
    <div class="pt-24 pb-8 px-4">
      <div class="max-w-7xl mx-auto">
        
        <!-- Hero Section -->
        <div class="text-center mb-12">
          <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
            Allquiz
          </h1>
          <p class="text-gray-600 text-lg mb-8">ระบบเฉลยคำตอบที่อัพเดตแบบเรียลไทม์</p>
          
          <!-- Live Stats -->
          <div class="flex justify-center space-x-8 mb-8">
            <div class="text-center">
              <div class="text-2xl font-bold text-primary" id="total-subjects">0</div>
              <div class="text-sm text-gray-500">วิชา</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-secondary" id="total-quizzes">0</div>
              <div class="text-sm text-gray-500">ควิซ</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-success" id="last-updated">-</div>
              <div class="text-sm text-gray-500">อัพเดตล่าสุด</div>
            </div>
          </div>

          <!-- Data Source Status -->
          <div class="inline-flex items-center space-x-2 glass-effect px-4 py-2 rounded-full text-sm">
            <div id="data-status-indicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
            <span id="data-status-text" class="text-gray-600">กำลังโหลดข้อมูล...</span>
          </div>
        </div>

        <!-- Search Section -->
        <div class="mb-8">
          <div class="glass-effect rounded-3xl p-6 shadow-xl">
            <div class="relative">
              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              <input 
                type="text" 
                id="search-input"
                placeholder="ค้นหาวิชาหรือควิซ..."
                class="w-full pl-12 pr-4 py-4 bg-white/50 rounded-2xl border border-white/30 outline-none focus:ring-2 focus:ring-primary/50 text-gray-800"
                oninput="handleSearch()"
              >
            </div>
          </div>
        </div>

        <!-- Subjects Grid -->
        <section id="subjects-section">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">วิชาที่มีอยู่</h2>
            <button onclick="refreshData()" class="flex items-center space-x-2 glass-effect px-4 py-2 rounded-xl text-gray-600 hover:text-primary transition-colors">
              <i class="fas fa-sync-alt text-sm"></i>
              <span class="text-sm">รีเฟรช</span>
            </button>
          </div>
          
          <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Subjects will be loaded here -->
          </div>
        </section>

        <!-- Quiz List Section -->
        <section id="quiz-section" class="hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 id="quiz-section-title" class="text-2xl font-bold text-gray-800">ควิซในวิชา</h2>
            <button onclick="goBackToSubjects()" class="flex items-center space-x-2 glass-effect px-4 py-2 rounded-xl text-gray-600 hover:text-primary transition-colors">
              <i class="fas fa-arrow-left text-sm"></i>
              <span class="text-sm">กลับ</span>
            </button>
          </div>
          
          <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Quizzes will be loaded here -->
          </div>
        </section>
      </div>
    </div>

    <!-- Notifications Panel -->
    <div id="notifications-panel" class="fixed top-0 right-0 h-full w-96 transform translate-x-full transition-transform duration-300 z-40">
      <div class="h-full glass-effect border-l border-white/30 p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-gray-800">ประกาศและแจ้งเตือน</h3>
          <button onclick="toggleNotifications()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- Notification Tabs -->
        <div class="flex space-x-1 mb-6 bg-white/30 rounded-xl p-1">
          <button onclick="switchNotificationTab('updates')" class="notification-tab flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all bg-white text-primary shadow-sm">
            อัพเดต
          </button>
          <button onclick="switchNotificationTab('system')" class="notification-tab flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all text-gray-600">
            ระบบ
          </button>
        </div>
        
        <div id="notifications-content" class="space-y-3 overflow-y-auto" style="max-height: calc(100vh - 200px);">
          <!-- Notifications will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
        
        <!-- Admin Header -->
        <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                <i class="fas fa-shield-alt text-white"></i>
              </div>
              <div>
                <h2 class="text-xl font-semibold">ระบบจัดการ</h2>
                <p class="text-gray-300 text-sm">Real-time Data Management</p>
              </div>
            </div>
            <button onclick="closeAdminPanel()" class="text-white/70 hover:text-white transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <!-- Admin Content -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
          
          <!-- Login Form -->
          <div id="admin-login" class="text-center max-w-sm mx-auto">
            <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-lock text-primary text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-6">เข้าสู่ระบบผู้ดูแล</h3>
            
            <form class="space-y-4" onsubmit="handleAdminLogin(event)">
              <input 
                type="text" 
                id="admin-username" 
                placeholder="ชื่อผู้ใช้"
                class="w-full px-4 py-3 bg-white/50 rounded-xl border border-white/30 outline-none focus:ring-2 focus:ring-primary/50"
                required
              >
              <input 
                type="password" 
                id="admin-password" 
                placeholder="รหัสผ่าน"
                class="w-full px-4 py-3 bg-white/50 rounded-xl border border-white/30 outline-none focus:ring-2 focus:ring-primary/50"
                required
              >
              <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-xl hover:shadow-lg transition-all font-medium"
              >
                เข้าสู่ระบบ
              </button>
              
              <div id="admin-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-lg p-3">
                ข้อมูลไม่ถูกต้อง
              </div>
            </form>
          </div>

          <!-- Admin Dashboard -->
          <div id="admin-dashboard" class="hidden">
            
            <!-- Real-time Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-white/50 rounded-xl p-4 border border-white/30">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-blue-600" id="admin-total-subjects">0</div>
                    <div class="text-sm text-gray-600">วิชาทั้งหมด</div>
                  </div>
                  <i class="fas fa-book text-blue-400 text-xl"></i>
                </div>
              </div>
              
              <div class="bg-white/50 rounded-xl p-4 border border-white/30">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-green-600" id="admin-total-quizzes">0</div>
                    <div class="text-sm text-gray-600">ควิซทั้งหมด</div>
                  </div>
                  <i class="fas fa-question-circle text-green-400 text-xl"></i>
                </div>
              </div>
              
              <div class="bg-white/50 rounded-xl p-4 border border-white/30">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-purple-600" id="admin-active-quizzes">0</div>
                    <div class="text-sm text-gray-600">ควิซที่ใช้งานได้</div>
                  </div>
                  <i class="fas fa-check-circle text-purple-400 text-xl"></i>
                </div>
              </div>
              
              <div class="bg-white/50 rounded-xl p-4 border border-white/30">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-yellow-600" id="admin-last-sync">-</div>
                    <div class="text-sm text-gray-600">Sync ล่าสุด</div>
                  </div>
                  <i class="fas fa-sync-alt text-yellow-400 text-xl"></i>
                </div>
              </div>
            </div>

            <!-- Admin Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              
              <!-- Data Management -->
              <div class="bg-white/50 rounded-xl p-6 border border-white/30">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">จัดการข้อมูล</h4>
                <div class="space-y-3">
                  <button onclick="forceDataSync()" class="w-full bg-primary text-white py-3 rounded-xl hover:bg-blue-600 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>ดึงข้อมูลใหม่
                  </button>
                  <button onclick="showDataDetails()" class="w-full bg-secondary text-white py-3 rounded-xl hover:bg-purple-600 transition-colors">
                    <i class="fas fa-database mr-2"></i>รายละเอียดข้อมูล
                  </button>
                  <button onclick="exportSystemData()" class="w-full bg-success text-white py-3 rounded-xl hover:bg-green-600 transition-colors">
                    <i class="fas fa-download mr-2"></i>Export ข้อมูล
                  </button>
                </div>
              </div>

              <!-- System Announcements -->
              <div class="bg-white/50 rounded-xl p-6 border border-white/30">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">ประกาศระบบ</h4>
                <div class="space-y-3">
                  <input type="text" id="announcement-title" placeholder="หัวข้อประกาศ" 
                         class="w-full px-3 py-2 bg-white/50 rounded-lg border border-white/30 outline-none focus:ring-2 focus:ring-primary/50">
                  <textarea id="announcement-content" placeholder="เนื้อหาประกาศ" rows="2"
                            class="w-full px-3 py-2 bg-white/50 rounded-lg border border-white/30 outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
                  <div class="flex space-x-2">
                    <select id="announcement-type" class="flex-1 px-3 py-2 bg-white/50 rounded-lg border border-white/30 outline-none focus:ring-2 focus:ring-primary/50">
                      <option value="info">ข้อมูลทั่วไป</option>
                      <option value="update">อัพเดต</option>
                      <option value="warning">คำเตือน</option>
                      <option value="urgent">เร่งด่วน</option>
                    </select>
                    <button onclick="createSystemAnnouncement()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                      ประกาศ
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Maintenance Mode Toggle -->
            <div class="bg-white/50 rounded-xl p-6 border border-white/30 mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="text-lg font-semibold text-gray-800">โหมดบำรุงรักษา</h4>
                  <p class="text-sm text-gray-600">ปิดเว็บไซต์ชั่วคราวเพื่อบำรุงรักษา</p>
                </div>
                <div class="flex items-center space-x-3">
                  <span class="text-sm text-gray-600" id="maintenance-status">ปิด</span>
                  <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="maintenance-toggle" class="sr-only peer" onchange="toggleMaintenanceMode()">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Real-time Activity Log -->
            <div class="bg-white/50 rounded-xl p-6 border border-white/30">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">กิจกรรมล่าสุด</h4>
              <div id="activity-log" class="space-y-2 max-h-40 overflow-y-auto">
                <!-- Activity items will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 space-y-3 z-50">
      <!-- Toast notifications will appear here -->
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-40">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600">กำลังโหลดข้อมูล...</p>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      SHEET_ID: "1-7p30j2PR8oLeyJ02vMq1ut5IZ6iSh8zvMFS50w74Lc",
      SHEET_RANGE: "Allquestions",
      API_KEY: "AIzaSyB4AyLjp-qzWqGm9uoKBeF2G8XUwk-eWPw",
      ADMIN_CREDENTIALS: {
        username: "admin",
        password: "allquiz2025"
      },
      MAINTENANCE_PASSWORD: "maintenance123",
      AUTO_REFRESH_INTERVAL: 60000, // 1 minute
      UPDATE_CHECK_INTERVAL: 30000, // 30 seconds
    };

    // Global state
    let state = {
      subjects: {},
      rawData: [],
      lastUpdate: null,
      dataHash: null,
      isMaintenanceMode: false,
      isAdminLoggedIn: false,
      notifications: [],
      systemAnnouncements: [],
      currentNotificationTab: 'updates',
      activityLog: [],
      autoRefreshEnabled: true,
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      checkMaintenanceMode();
      if (!state.isMaintenanceMode) {
        await initializeApp();
        startAutoRefresh();
        startUpdateChecker();
      }
    });

    // Check maintenance mode
    function checkMaintenanceMode() {
      const isMaintenanceMode = localStorage.getItem('maintenanceMode') === 'true';
      if (isMaintenanceMode) {
        state.isMaintenanceMode = true;
        document.getElementById('maintenance-overlay').classList.remove('hidden');
        document.getElementById('main-app').style.display = 'none';
      }
    }

    // Show admin access for maintenance
    function showAdminAccess() {
      document.getElementById('admin-access-modal').classList.remove('hidden');
    }

    function hideAdminAccess() {
      document.getElementById('admin-access-modal').classList.add('hidden');
      document.getElementById('maintenance-password').value = '';
      document.getElementById('access-error').classList.add('hidden');
    }

    function checkMaintenanceAccess(event) {
      event.preventDefault();
      const password = document.getElementById('maintenance-password').value;
      
      if (password === CONFIG.MAINTENANCE_PASSWORD) {
        state.isMaintenanceMode = false;
        localStorage.setItem('maintenanceMode', 'false');
        document.getElementById('maintenance-overlay').classList.add('hidden');
        document.getElementById('main-app').style.display = 'block';
        hideAdminAccess();
        initializeApp();
        logActivity('Maintenance mode disabled via emergency access');
      } else {
        document.getElementById('access-error').classList.remove('hidden');
        document.getElementById('maintenance-password').value = '';
      }
    }

    // Initialize main app
    async function initializeApp() {
      try {
        await loadData();
        setupEventListeners();
        hideLoading();
        logActivity('Application initialized successfully');
      } catch (error) {
        console.error('Failed to initialize:', error);
        updateDataStatus('error', 'ไม่สามารถโหลดข้อมูลได้');
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
        hideLoading();
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', handleSearch);
      
      // Prevent common shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') ||
            (e.ctrlKey && e.key === 'u')) {
          e.preventDefault();
        }
      });
      
      document.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    // Data management
    async function loadData() {
      updateDataStatus('loading', 'กำลังโหลดข้อมูล...');
      
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_RANGE}?key=${CONFIG.API_KEY}`;
      
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        if (data.values && data.values.length > 1) {
          const newHash = btoa(JSON.stringify(data.values));
          const hasUpdates = state.dataHash && state.dataHash !== newHash;
          
          state.rawData = data.values;
          state.dataHash = newHash;
          state.lastUpdate = new Date();
          
          processData();
          updateUI();
          updateDataStatus('connected', 'เชื่อมต่อแล้ว');
          
          if (hasUpdates) {
            checkForQuizUpdates();
            showToast('พบข้อมูลใหม่!', 'success');
            logActivity('Data updated from Google Sheets');
          }
          
        } else {
          throw new Error('No data found');
        }
      } catch (error) {
        updateDataStatus('error', 'ข้อผิดพลาด');
        throw error;
      }
    }

    // Process raw data
    function processData() {
      state.subjects = {};
      let totalQuizzes = 0;
      let activeQuizzes = 0;
      
      state.rawData.slice(1).forEach((row, index) => {
        const [subject, quizName, quizLink, quizDescription, expiryDate, status, lastModified] = row || [];
        
        if (subject && subject.trim()) {
          if (!state.subjects[subject]) {
            state.subjects[subject] = [];
          }
          
          if (quizName) {
            const quiz = {
              id: `quiz_${index}`,
              quizName,
              quizLink,
              quizDescription,
              expiryDate,
              status,
              lastModified: lastModified || 'ไม่ระบุ',
              subject,
              isActive: quizLink && !isExpired(expiryDate)
            };
            
            state.subjects[subject].push(quiz);
            totalQuizzes++;
            
            if (quiz.isActive) {
              activeQuizzes++;
            }
          }
        }
      });
      
      // Update stats
      updateStats(Object.keys(state.subjects).length, totalQuizzes, activeQuizzes);
    }

    // Check for quiz updates
    function checkForQuizUpdates() {
      const updatedQuizzes = [];
      const now = new Date();
      const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
      
      Object.values(state.subjects).flat().forEach(quiz => {
        if (quiz.lastModified && quiz.lastModified !== 'ไม่ระบุ') {
          try {
            const modifiedDate = new Date(quiz.lastModified);
            if (modifiedDate > oneHourAgo) {
              updatedQuizzes.push(quiz);
            }
          } catch (e) {
            // Invalid date format
          }
        }
      });
      
      if (updatedQuizzes.length > 0) {
        addUpdateNotifications(updatedQuizzes);
      }
    }

    // Add update notifications
    function addUpdateNotifications(quizzes) {
      quizzes.forEach(quiz => {
        const notification = {
          id: Date.now() + Math.random(),
          type: 'update',
          title: `ควิซอัพเดต: ${quiz.quizName}`,
          content: `วิชา ${quiz.subject} มีการอัพเดตเมื่อ ${quiz.lastModified}`,
          timestamp: new Date().toLocaleString('th-TH'),
          quiz: quiz
        };
        
        state.notifications.unshift(notification);
        logActivity(`Quiz updated: ${quiz.quizName} in ${quiz.subject}`);
      });
      
      updateNotificationBadge();
      
      if (state.notifications.length > 0) {
        showSystemNotification(
          'มีควิซใหม่ที่อัพเดต',
          `อัพเดต ${quizzes.length} ควิซ`,
          'update'
        );
      }
    }

    // Update UI
    function updateUI() {
      renderSubjects();
      updateNotificationContent();
      
      if (state.isAdminLoggedIn) {
        updateAdminStats();
      }
    }

    // Update stats
    function updateStats(subjects, quizzes, active) {
      document.getElementById('total-subjects').textContent = subjects;
      document.getElementById('total-quizzes').textContent = quizzes;
      document.getElementById('last-updated').textContent = state.lastUpdate ? 
        state.lastUpdate.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'}) : '-';
    }

    // Update data status indicator
    function updateDataStatus(status, text) {
      const indicator = document.getElementById('data-status-indicator');
      const statusText = document.getElementById('data-status-text');
      
      const statusColors = {
        loading: 'bg-yellow-400',
        connected: 'bg-green-400',
        error: 'bg-red-400'
      };
      
      indicator.className = `w-2 h-2 rounded-full ${statusColors[status] || 'bg-gray-400'}`;
      statusText.textContent = text;
      
      if (status === 'connected') {
        indicator.classList.add('animate-pulse');
      } else {
        indicator.classList.remove('animate-pulse');
      }
    }

    // Render subjects
    function renderSubjects() {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';

      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const card = createSubjectCard(subject, quizzes);
        grid.appendChild(card);
      });
    }

    // Create subject card
    function createSubjectCard(subject, quizzes) {
      const availableQuizzes = quizzes.filter(q => q.isActive).length;
      const hasQuizzes = quizzes.some(q => q.quizName);
      const recentUpdates = quizzes.filter(q => {
        if (!q.lastModified || q.lastModified === 'ไม่ระบุ') return false;
        try {
          const modifiedDate = new Date(q.lastModified);
          const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
          return modifiedDate > dayAgo;
        } catch {
          return false;
        }
      }).length;
      
      const card = document.createElement('div');
      card.className = `glass-effect rounded-3xl p-6 shadow-lg cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 animate-slide-up ${hasQuizzes ? 'hover:shadow-primary/20' : ''}`;
      
      const icon = getSubjectIcon(subject);
      
      card.innerHTML = `
        <div class="text-center">
          <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
            <i class="fas ${icon} text-white text-2xl"></i>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2 text-lg">${subject}</h3>
          
          <div class="space-y-2">
            ${!hasQuizzes ? 
              '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full">รออัพเดต</span>' :
              `<span class="inline-block px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">${availableQuizzes} ควิซ</span>`
            }
            
            ${recentUpdates > 0 ? 
              `<div><span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full animate-pulse">
                <i class="fas fa-clock mr-1"></i>${recentUpdates} อัพเดตใหม่
              </span></div>` : ''
            }
          </div>
        </div>
      `;
      
      if (hasQuizzes) {
        card.addEventListener('click', () => showQuizzes(subject));
      }
      
      return card;
    }

    // Get subject icon
    function getSubjectIcon(subject) {
      const icons = {
        'คอมพิวเตอร์': 'fa-laptop-code',
        'คณิตศาสตร์': 'fa-calculator',
        'วิทยาศาสตร์': 'fa-flask',
        'ภาษา': 'fa-language',
        'ฟิสิกส์': 'fa-atom',
        'เคมี': 'fa-vial',
        'ชีววิทยา': 'fa-dna',
        'ประวัติศาสตร์': 'fa-landmark',
        'default': 'fa-book'
      };
      
      for (const [key, icon] of Object.entries(icons)) {
        if (subject.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      return icons.default;
    }

    // Show quizzes for subject
    function showQuizzes(subject) {
      const quizzes = state.subjects[subject];
      
      document.getElementById('subjects-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-section-title').textContent = `ควิซในวิชา ${subject}`;
      
      renderQuizzes(quizzes);
      logActivity(`Viewed quizzes for subject: ${subject}`);
    }

    // Render quizzes
    function renderQuizzes(quizzes) {
      const grid = document.getElementById('quiz-grid');
      grid.innerHTML = '';

      quizzes.forEach(quiz => {
        if (!quiz.quizName) return;
        
        const card = createQuizCard(quiz);
        grid.appendChild(card);
      });
    }

    // Create quiz card
    function createQuizCard(quiz) {
      const isExpiredQuiz = isExpired(quiz.expiryDate);
      const countdown = quiz.expiryDate ? calculateCountdown(quiz.expiryDate) : null;
      const isRecentUpdate = isRecentUpdate(quiz.lastModified);
      
      const card = document.createElement('div');
      card.className = 'glass-effect rounded-3xl p-6 shadow-lg transition-all duration-300 hover:shadow-xl animate-slide-up';
      
      let statusBadge = '';
      if (quiz.status) {
        const statusColors = {
          'อัพเดตล่าสุด': 'bg-green-100 text-green-800',
          'รออัพเดต': 'bg-yellow-100 text-yellow-800',
          'ปิดปรับปรุง': 'bg-red-100 text-red-800'
        };
        const colorClass = statusColors[quiz.status] || 'bg-gray-100 text-gray-800';
        statusBadge = `<span class="inline-block px-3 py-1 ${colorClass} text-sm rounded-full mb-3">${quiz.status}</span>`;
      } else if (countdown) {
        statusBadge = isExpiredQuiz ? 
          '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 text-sm rounded-full mb-3">หมดเวลา</span>' :
          `<span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full mb-3"><i class="fas fa-clock mr-1"></i>${countdown}</span>`;
      }
      
      card.innerHTML = `
        <div class="flex items-start space-x-4">
          <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <i class="fas fa-file-alt text-gray-600 text-lg"></i>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center space-x-2 mb-2">
              <h3 class="font-semibold text-gray-800 text-lg leading-tight">${quiz.quizName}</h3>
              ${isRecentUpdate ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full animate-pulse">ใหม่!</span>' : ''}
            </div>
            
            ${statusBadge}
            ${quiz.quizDescription ? `<p class="text-gray-600 text-sm mb-4 leading-relaxed">${quiz.quizDescription}</p>` : ''}
            
            <div class="flex items-center justify-between">
              ${quiz.quizLink && !isExpiredQuiz ? 
                `<a href="${quiz.quizLink}" target="_blank" onclick="logQuizAccess('${quiz.quizName}')" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white text-sm rounded-xl hover:shadow-lg transition-all">
                  <i class="fas fa-external-link-alt mr-2"></i>ดูเฉลย
                </a>` :
                '<span class="px-4 py-2 bg-gray-100 text-gray-600 text-sm rounded-xl">ไม่พร้อมใช้งาน</span>'
              }
              
              <div class="text-xs text-gray-500">
                ${quiz.lastModified !== 'ไม่ระบุ' ? `อัพเดต: ${formatDate(quiz.lastModified)}` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }

    // Go back to subjects
    function goBackToSubjects() {
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('subjects-section').classList.remove('hidden');
    }

    // Search functionality
    function handleSearch() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!query) {
        renderSubjects();
        return;
      }

      const filteredSubjects = {};
      
      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const matchingQuizzes = quizzes.filter(quiz => 
          subject.toLowerCase().includes(query) ||
          (quiz.quizName && quiz.quizName.toLowerCase().includes(query)) ||
          (quiz.quizDescription && quiz.quizDescription.toLowerCase().includes(query))
        );
        
        if (matchingQuizzes.length > 0 || subject.toLowerCase().includes(query)) {
          filteredSubjects[subject] = quizzes;
        }
      });

      renderFilteredSubjects(filteredSubjects);
      logActivity(`Search performed: ${query}`);
    }

    // Render filtered subjects
    function renderFilteredSubjects(subjects) {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';

      if (Object.keys(subjects).length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">ไม่พบผลการค้นหา</h3>
            <p class="text-gray-500">ลองใช้คำค้นหาอื่นหรือตรวจสอบการสะกดคำ</p>
          </div>
        `;
        return;
      }

      Object.entries(subjects).forEach(([subject, quizzes]) => {
        const card = createSubjectCard(subject, quizzes);
        grid.appendChild(card);
      });
    }

    // Notifications
    function toggleNotifications() {
      const panel = document.getElementById('notifications-panel');
      panel.classList.toggle('translate-x-full');
      
      if (!panel.classList.contains('translate-x-full')) {
        updateNotificationContent();
      }
    }

    function switchNotificationTab(tab) {
      state.currentNotificationTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.notification-tab').forEach(btn => {
        btn.classList.remove('bg-white', 'text-primary', 'shadow-sm');
        btn.classList.add('text-gray-600');
      });
      event.target.classList.add('bg-white', 'text-primary', 'shadow-sm');
      event.target.classList.remove('text-gray-600');
      
      updateNotificationContent();
    }

    function updateNotificationContent() {
      const container = document.getElementById('notifications-content');
      let notifications = [];
      
      if (state.currentNotificationTab === 'updates') {
        notifications = state.notifications.filter(n => n.type === 'update');
      } else {
        notifications = state.systemAnnouncements;
      }
      
      container.innerHTML = '';
      
      if (notifications.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-bell-slash text-gray-400 text-2xl mb-2"></i>
            <p class="text-gray-500">ไม่มีการแจ้งเตือน</p>
          </div>
        `;
        return;
      }
      
      notifications.forEach(notification => {
        const item = createNotificationItem(notification);
        container.appendChild(item);
      });
    }

    function createNotificationItem(notification) {
      const item = document.createElement('div');
      item.className = 'glass-effect rounded-xl p-4 border border-white/30 animate-slide-up';
      
      const typeIcons = {
        update: 'fa-sync-alt text-blue-500',
        info: 'fa-info-circle text-blue-500',
        warning: 'fa-exclamation-triangle text-yellow-500',
        urgent: 'fa-exclamation-circle text-red-500'
      };
      
      const icon = typeIcons[notification.type] || typeIcons.info;
      
      item.innerHTML = `
        <div class="flex items-start space-x-3">
          <i class="fas ${icon} mt-1"></i>
          <div class="flex-1">
            <h4 class="font-medium text-gray-800 mb-1">${notification.title}</h4>
            <p class="text-gray-600 text-sm mb-2">${notification.content}</p>
            <span class="text-xs text-gray-500">${notification.timestamp}</span>
            ${notification.quiz ? 
              `<div class="mt-2">
                <a href="${notification.quiz.quizLink}" target="_blank" class="text-primary hover:text-blue-600 text-sm">
                  <i class="fas fa-external-link-alt mr-1"></i>ดูควิซ
                </a>
              </div>` : ''
            }
          </div>
        </div>
      `;
      
      return item;
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      const unreadCount = state.notifications.length + state.systemAnnouncements.length;
      
      if (unreadCount > 0) {
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function showSystemNotification(title, content, type = 'info') {
      const container = document.getElementById('system-notifications');
      
      const notification = document.createElement('div');
      notification.className = `glass-effect rounded-xl p-4 shadow-lg animate-slide-up`;
      
      const typeColors = {
        info: 'border-blue-300',
        update: 'border-green-300',
        warning: 'border-yellow-300',
        urgent: 'border-red-300'
      };
      
      notification.style.borderLeft = `4px solid`;
      notification.classList.add(typeColors[type] || typeColors.info);
      
      notification.innerHTML = `
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h4 class="font-medium text-gray-800">${title}</h4>
            <p class="text-gray-600 text-sm mt-1">${content}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-3">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      container.appendChild(notification);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }

    // Admin panel
    function showAdminPanel() {
      document.getElementById('admin-panel').classList.remove('hidden');
    }

    function closeAdminPanel() {
      document.getElementById('admin-panel').classList.add('hidden');
      if (!state.isAdminLoggedIn) {
        document.getElementById('admin-username').value = '';
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-error').classList.add('hidden');
      }
    }

    function handleAdminLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('admin-username').value;
      const password = document.getElementById('admin-password').value;
      
      if (username === CONFIG.ADMIN_CREDENTIALS.username && 
          password === CONFIG.ADMIN_CREDENTIALS.password) {
        
        state.isAdminLoggedIn = true;
        document.getElementById('admin-login').classList.add('hidden');
        document.getElementById('admin-dashboard').classList.remove('hidden');
        document.getElementById('admin-indicator').classList.remove('hidden');
        
        updateAdminStats();
        loadActivityLog();
        
        logActivity('Admin login successful');
        showToast('เข้าสู่ระบบสำเร็จ', 'success');
      } else {
        document.getElementById('admin-error').classList.remove('hidden');
        document.getElementById('admin-password').value = '';
        logActivity('Failed admin login attempt');
      }
    }

    function updateAdminStats() {
      const subjects = Object.keys(state.subjects).length;
      const totalQuizzes = Object.values(state.subjects).reduce((acc, quizzes) => acc + quizzes.length, 0);
      const activeQuizzes = Object.values(state.subjects).flat().filter(q => q.isActive).length;
      
      document.getElementById('admin-total-subjects').textContent = subjects;
      document.getElementById('admin-total-quizzes').textContent = totalQuizzes;
      document.getElementById('admin-active-quizzes').textContent = activeQuizzes;
      document.getElementById('admin-last-sync').textContent = state.lastUpdate ? 
        state.lastUpdate.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'}) : '-';
    }

    // Admin functions
    async function forceDataSync() {
      showToast('กำลังดึงข้อมูลใหม่...', 'info');
      try {
        await loadData();
        showToast('ดึงข้อมูลสำเร็จ', 'success');
        logActivity('Manual data sync performed');
      } catch (error) {
        showToast('เกิดข้อผิดพลาดในการดึงข้อมูล', 'error');
      }
    }

    function showDataDetails() {
      const details = {
        totalRows: state.rawData.length,
        totalSubjects: Object.keys(state.subjects).length,
        totalQuizzes: Object.values(state.subjects).reduce((acc, quizzes) => acc + quizzes.length, 0),
        lastUpdate: state.lastUpdate?.toLocaleString('th-TH') || 'ไม่ระบุ',
        dataHash: state.dataHash?.substring(0, 8) + '...' || 'ไม่ระบุ'
      };
      
      const message = `
        รายละเอียดข้อมูล:
        • แถวทั้งหมด: ${details.totalRows}
        • วิชาทั้งหมด: ${details.totalSubjects}
        • ควิซทั้งหมด: ${details.totalQuizzes}
        • อัพเดตล่าสุด: ${details.lastUpdate}
        • Hash: ${details.dataHash}
      `;
      
      alert(message);
      logActivity('Data details viewed');
    }

    function exportSystemData() {
      const exportData = {
        subjects: state.subjects,
        notifications: state.notifications,
        systemAnnouncements: state.systemAnnouncements,
        stats: {
          totalSubjects: Object.keys(state.subjects).length,
          totalQuizzes: Object.values(state.subjects).reduce((acc, quizzes) => acc + quizzes.length, 0),
          exportTime: new Date().toISOString()
        }
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `allquiz_export_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      logActivity('System data exported');
      showToast('Export สำเร็จ', 'success');
    }

    function createSystemAnnouncement() {
      const title = document.getElementById('announcement-title').value.trim();
      const content = document.getElementById('announcement-content').value.trim();
      const type = document.getElementById('announcement-type').value;
      
      if (!title || !content) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
        return;
      }
      
      const announcement = {
        id: Date.now(),
        type,
        title,
        content,
        timestamp: new Date().toLocaleString('th-TH')
      };
      
      state.systemAnnouncements.unshift(announcement);
      
      // Clear form
      document.getElementById('announcement-title').value = '';
      document.getElementById('announcement-content').value = '';
      
      // Show system notification
      showSystemNotification(title, content, type);
      updateNotificationBadge();
      
      logActivity(`System announcement created: ${title}`);
      showToast('ประกาศสำเร็จ', 'success');
    }

    function toggleMaintenanceMode() {
      const toggle = document.getElementById('maintenance-toggle');
      const status = document.getElementById('maintenance-status');
      
      state.isMaintenanceMode = toggle.checked;
      localStorage.setItem('maintenanceMode', state.isMaintenanceMode.toString());
      
      status.textContent = state.isMaintenanceMode ? 'เปิด' : 'ปิด';
      
      if (state.isMaintenanceMode) {
        showToast('เปิดโหมดบำรุงรักษา', 'warning');
        logActivity('Maintenance mode enabled');
        
        setTimeout(() => {
          location.reload();
        }, 2000);
      } else {
        showToast('ปิดโหมดบำรุงรักษา', 'success');
        logActivity('Maintenance mode disabled');
      }
    }

    // Activity logging
    function logActivity(message) {
      const entry = {
        timestamp: new Date().toLocaleString('th-TH'),
        message,
        type: 'system'
      };
      
      state.activityLog.unshift(entry);
      
      // Keep only last 50 entries
      if (state.activityLog.length > 50) {
        state.activityLog = state.activityLog.slice(0, 50);
      }
      
      updateActivityLog();
    }

    function loadActivityLog() {
      updateActivityLog();
    }

    function updateActivityLog() {
      const container = document.getElementById('activity-log');
      container.innerHTML = '';
      
      state.activityLog.slice(0, 10).forEach(entry => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between text-sm py-1';
        
        item.innerHTML = `
          <span class="text-gray-700">${entry.message}</span>
          <span class="text-gray-500 text-xs">${entry.timestamp.split(' ')[1]}</span>
        `;
        
        container.appendChild(item);
      });
    }

    function logQuizAccess(quizName) {
      logActivity(`Quiz accessed: ${quizName}`);
    }

    // Auto refresh
    function startAutoRefresh() {
      if (!state.autoRefreshEnabled) return;
      
      setInterval(async () => {
        if (!state.isMaintenanceMode && state.autoRefreshEnabled) {
          try {
            await loadData();
          } catch (error) {
            console.error('Auto refresh failed:', error);
          }
        }
      }, CONFIG.AUTO_REFRESH_INTERVAL);
    }

    function startUpdateChecker() {
      setInterval(async () => {
        if (!state.isMaintenanceMode && state.autoRefreshEnabled) {
          try {
            // Quick check for updates without full reload
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/A1:A1?key=${CONFIG.API_KEY}`;
            const response = await fetch(url);
            
            if (response.ok) {
              updateDataStatus('connected', 'เชื่อมต่อแล้ว');
            }
          } catch (error) {
            updateDataStatus('error', 'ขาดการเชื่อมต่อ');
          }
        }
      }, CONFIG.UPDATE_CHECK_INTERVAL);
    }

    // Utility functions
    function refreshData() {
      forceDataSync();
    }

    function isExpired(expiryDate) {
      if (!expiryDate) return false;
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        return new Date(formattedDate).getTime() < Date.now();
      } catch {
        return false;
      }
    }

    function calculateCountdown(expiryDate) {
      if (!expiryDate) return '';
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        const timeLeft = new Date(formattedDate).getTime() - Date.now();
        
        if (timeLeft <= 0) return 'หมดเวลา';
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (days > 0) return `${days} วัน`;
        if (hours > 0) return `${hours} ชม.`;
        return 'น้อยกว่า 1 ชม.';
      } catch {
        return '';
      }
    }

    function isRecentUpdate(lastModified) {
      if (!lastModified || lastModified === 'ไม่ระบุ') return false;
      try {
        const modifiedDate = new Date(lastModified);
        const hourAgo = new Date(Date.now() - 60 * 60 * 1000);
        return modifiedDate > hourAgo;
      } catch {
        return false;
      }
    }

    function formatDate(dateString) {
      if (!dateString || dateString === 'ไม่ระบุ') return 'ไม่ระบุ';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('th-TH') + ' ' + date.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'});
      } catch {
        return dateString;
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      toast.className = `${colors[type]} text-white px-6 py-4 rounded-2xl shadow-lg transform translate-x-full transition-transform duration-300`;
      toast.textContent = message;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }
  </script>
</body>
</html>
