<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Allquiz เว็บไซต์เฉลยคำตอบรายวิชาต่างๆ">
  <title>Allquiz - Complete Admin System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007AFF',
            secondary: '#5856D6',
            accent: '#FF3B30',
            success: '#34C759',
            warning: '#FF9500',
            ios: {
              gray: '#F2F2F7',
              darkGray: '#8E8E93',
              lightGray: '#F8F8F8'
            }
          },
          fontFamily: {
            'sf': ['SF Pro Display', 'system-ui', 'sans-serif'],
          },
          animation: {
            'island-expand': 'islandExpand 0.3s ease-out',
            'island-contract': 'islandContract 0.3s ease-out',
            'blob': 'blob 7s infinite',
            'float': 'float 6s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'slide-in': 'slideIn 0.3s ease-out',
          },
          backdropBlur: {
            'ios': '20px',
          }
        }
      }
    }
  </script>
  
  <style>
    @keyframes islandExpand {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes blob {
      0% { transform: translate(0px, 0px) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
      100% { transform: translate(0px, 0px) scale(1); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 20px rgba(0, 122, 255, 0.4); }
      to { box-shadow: 0 0 40px rgba(0, 122, 255, 0.8); }
    }
    
    .glass-morphism {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .dynamic-island {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(20px);
      border-radius: 25px;
    }
    
    .ios-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .notification-dot {
      animation: pulse 2s infinite;
    }
    
    ::-webkit-scrollbar {
      width: 4px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
    
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .slide-transition {
      transition: transform 0.3s ease-out;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-sf overflow-x-hidden">
  
  <!-- Background Elements -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-20 left-20 w-72 h-72 bg-blue-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
    <div class="absolute top-40 right-20 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
    <div class="absolute -bottom-8 left-40 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
  </div>

  <!-- Dynamic Island Navigation -->
  <nav class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50">
    <div class="dynamic-island px-6 py-3 flex items-center space-x-4 animate-island-expand">
      <div class="flex items-center space-x-2">
        <div class="w-6 h-6 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
          <i class="fas fa-graduation-cap text-white text-xs"></i>
        </div>
        <span class="text-white font-semibold text-sm">Allquiz</span>
      </div>
      
      <div class="flex items-center space-x-3">
        <button onclick="toggleNotifications()" class="relative text-white/80 hover:text-white transition-colors p-1">
          <i class="fas fa-bell text-sm"></i>
          <span id="notification-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-accent rounded-full notification-dot hidden"></span>
        </button>
        
        <button onclick="showAdminPanel()" class="relative text-white/80 hover:text-white transition-colors p-1">
          <i class="fas fa-shield-alt text-sm"></i>
          <span id="admin-indicator" class="absolute -top-1 -right-1 w-2 h-2 bg-success rounded-full hidden"></span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Admin Announcement Banner -->
  <div id="announcement-banner" class="hidden fixed top-20 left-4 right-4 z-40">
    <div class="glass-morphism rounded-2xl p-4 border border-white/30 shadow-xl animate-slide-in">
      <div class="flex items-start space-x-3">
        <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fas fa-bullhorn text-white text-sm"></i>
        </div>
        <div class="flex-1">
          <h4 class="font-semibold text-gray-800 mb-1" id="announcement-title">ประกาศสำคัญ</h4>
          <p class="text-gray-600 text-sm" id="announcement-content">เนื้อหาประกาศ</p>
          <span class="text-xs text-gray-500" id="announcement-time">เมื่อสักครู่</span>
        </div>
        <button onclick="dismissAnnouncement()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="pt-24 pb-8 px-4">
    <div class="max-w-7xl mx-auto">
      
      <!-- Hero Section -->
      <div class="text-center mb-12 animate-float">
        <h1 class="text-4xl md:text-6xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-4">
          Allquiz
        </h1>
        <p class="text-gray-600 text-lg md:text-xl mb-8">ระบบเฉลยคำตอบที่ปลอดภัยและทันสมัย</p>
        
        <!-- Quick Stats -->
        <div class="flex justify-center space-x-8 mb-8">
          <div class="text-center">
            <div class="text-2xl font-bold text-primary" id="total-subjects">0</div>
            <div class="text-sm text-gray-500">วิชา</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-secondary" id="total-quizzes">0</div>
            <div class="text-sm text-gray-500">ควิซ</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-success" id="active-quizzes">0</div>
            <div class="text-sm text-gray-500">พร้อมใช้</div>
          </div>
        </div>
      </div>

      <!-- Search Section -->
      <div class="mb-8">
        <div class="ios-card rounded-3xl p-6 shadow-xl border">
          <div class="relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input 
              type="text" 
              id="search-input"
              placeholder="ค้นหาวิชาหรือควิซ..."
              class="w-full pl-12 pr-4 py-4 bg-ios-gray rounded-2xl border-none outline-none focus:ring-2 focus:ring-primary/50 text-gray-800"
              oninput="handleSearch()"
            >
          </div>
        </div>
      </div>

      <!-- Subjects Grid -->
      <section id="subjects-section">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">เลือกวิชาที่ต้องการ</h2>
        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <!-- Subjects will be loaded here -->
        </div>
      </section>

      <!-- Quiz List Section -->
      <section id="quiz-section" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 id="quiz-section-title" class="text-2xl font-bold text-gray-800">ควิซในวิชา</h2>
          <button onclick="goBackToSubjects()" class="ios-card px-4 py-2 rounded-xl flex items-center space-x-2 text-gray-600 hover:text-primary transition-colors">
            <i class="fas fa-arrow-left"></i>
            <span>กลับ</span>
          </button>
        </div>
        <div id="quiz-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Quizzes will be loaded here -->
        </div>
      </section>
    </div>
  </div>

  <!-- Notifications Panel -->
  <div id="notifications-panel" class="fixed top-0 right-0 h-full w-96 transform translate-x-full transition-transform duration-300 z-40">
    <div class="h-full glass-morphism border-l border-white/30 p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-800">การแจ้งเตือน</h3>
        <button onclick="toggleNotifications()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-3" id="notifications-list">
        <!-- Notifications will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="admin-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="ios-card rounded-3xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden">
      
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
              <i class="fas fa-shield-alt text-white"></i>
            </div>
            <div>
              <h2 class="text-xl font-semibold">ระบบจัดการ Admin</h2>
              <p class="text-gray-300 text-sm">Complete Control Panel</p>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <span class="text-sm text-gray-300" id="admin-session-info">Session Active</span>
            <button onclick="closeAdminPanel()" class="text-white/70 hover:text-white transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Admin Content -->
      <div class="flex h-full" style="max-height: calc(90vh - 120px);">
        
        <!-- Sidebar -->
        <div class="w-64 bg-gray-50 p-4 border-r">
          <div id="admin-login-sidebar" class="text-center">
            <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-lock text-primary text-xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">เข้าสู่ระบบ</h3>
            
            <form class="space-y-3">
              <input 
                type="text" 
                id="admin-username" 
                placeholder="ชื่อผู้ใช้"
                class="w-full px-3 py-2 bg-white rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-primary/50 text-sm"
              >
              <input 
                type="password" 
                id="admin-password" 
                placeholder="รหัสผ่าน"
                class="w-full px-3 py-2 bg-white rounded-lg border border-gray-300 outline-none focus:ring-2 focus:ring-primary/50 text-sm"
              >
              <button 
                type="button" 
                onclick="handleAdminLogin()"
                class="w-full bg-primary text-white py-2 rounded-lg hover:bg-blue-600 transition-all font-medium text-sm"
              >
                เข้าสู่ระบบ
              </button>
              
              <div id="admin-error" class="hidden text-accent text-xs bg-red-50 border border-red-200 rounded-lg p-2">
                ข้อมูลไม่ถูกต้อง
              </div>
            </form>
          </div>

          <!-- Admin Navigation -->
          <nav id="admin-nav" class="hidden space-y-2">
            <button onclick="switchAdminTab('dashboard')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all bg-primary text-white">
              <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
            </button>
            <button onclick="switchAdminTab('announcements')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-bullhorn mr-2"></i>ประกาศ
            </button>
            <button onclick="switchAdminTab('quizzes')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-question-circle mr-2"></i>จัดการควิซ
            </button>
            <button onclick="switchAdminTab('users')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-users mr-2"></i>ผู้ใช้งาน
            </button>
            <button onclick="switchAdminTab('analytics')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-chart-line mr-2"></i>สถิติ
            </button>
            <button onclick="switchAdminTab('settings')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-cog mr-2"></i>ตั้งค่า
            </button>
            <button onclick="switchAdminTab('logs')" class="admin-nav-btn w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-gray-100">
              <i class="fas fa-file-alt mr-2"></i>บันทึกกิจกรรม
            </button>
            
            <div class="border-t pt-2 mt-4">
              <button onclick="logoutAdmin()" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 transition-all">
                <i class="fas fa-sign-out-alt mr-2"></i>ออกจากระบบ
              </button>
            </div>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-y-auto">
          
          <!-- Dashboard Tab -->
          <div id="tab-dashboard" class="admin-tab-content hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Dashboard</h3>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-blue-50 rounded-xl p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-blue-600" id="dash-visitors">0</div>
                    <div class="text-sm text-gray-600">ผู้เยี่ยมชมวันนี้</div>
                  </div>
                  <i class="fas fa-users text-blue-400 text-xl"></i>
                </div>
              </div>
              
              <div class="bg-green-50 rounded-xl p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-green-600" id="dash-downloads">0</div>
                    <div class="text-sm text-gray-600">ดาวน์โหลดวันนี้</div>
                  </div>
                  <i class="fas fa-download text-green-400 text-xl"></i>
                </div>
              </div>
              
              <div class="bg-purple-50 rounded-xl p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-purple-600" id="dash-active">0</div>
                    <div class="text-sm text-gray-600">ผู้ใช้ออนไลน์</div>
                  </div>
                  <i class="fas fa-globe text-purple-400 text-xl"></i>
                </div>
              </div>
              
              <div class="bg-yellow-50 rounded-xl p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-2xl font-bold text-yellow-600" id="dash-alerts">0</div>
                    <div class="text-sm text-gray-600">แจ้งเตือนรอ</div>
                  </div>
                  <i class="fas fa-bell text-yellow-400 text-xl"></i>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-xl border p-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">กิจกรรมล่าสุด</h4>
              <div id="recent-activity" class="space-y-3">
                <!-- Activity items will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Announcements Tab -->
          <div id="tab-announcements" class="admin-tab-content hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">จัดการประกาศ</h3>
            
            <!-- Create Announcement -->
            <div class="bg-white rounded-xl border p-6 mb-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">สร้างประกาศใหม่</h4>
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <input 
                    type="text" 
                    id="announcement-title-input" 
                    placeholder="หัวข้อประกาศ"
                    class="px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50"
                  >
                  <select id="announcement-type" class="px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50">
                    <option value="info">ข้อมูลทั่วไป</option>
                    <option value="warning">คำเตือน</option>
                    <option value="urgent">เร่งด่วน</option>
                  </select>
                </div>
                
                <textarea 
                  id="announcement-content-input" 
                  placeholder="เนื้อหาประกาศ"
                  rows="3"
                  class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50 resize-none"
                ></textarea>
                
                <div class="flex space-x-3">
                  <button onclick="createAnnouncement()" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
                    <i class="fas fa-bullhorn mr-2"></i>ประกาศ
                  </button>
                  <button onclick="scheduleAnnouncement()" class="px-6 py-3 bg-secondary text-white rounded-xl hover:bg-purple-600 transition-colors">
                    <i class="fas fa-clock mr-2"></i>กำหนดเวลา
                  </button>
                </div>
              </div>
            </div>

            <!-- Announcements List -->
            <div class="bg-white rounded-xl border p-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">ประกาศทั้งหมด</h4>
              <div id="announcements-list" class="space-y-3">
                <!-- Announcements will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Quiz Management Tab -->
          <div id="tab-quizzes" class="admin-tab-content hidden">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-800">จัดการควิซ</h3>
              <button onclick="showAddQuizModal()" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
                <i class="fas fa-plus mr-2"></i>เพิ่มควิซใหม่
              </button>
            </div>
            
            <!-- Quiz Filter -->
            <div class="bg-white rounded-xl border p-4 mb-6">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="quiz-filter-subject" class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" onchange="filterQuizzes()">
                  <option value="">ทุกวิชา</option>
                </select>
                <select id="quiz-filter-status" class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" onchange="filterQuizzes()">
                  <option value="">ทุกสถานะ</option>
                  <option value="อัพเดตล่าสุด">อัพเดตล่าสุด</option>
                  <option value="รออัพเดต">รออัพเดต</option>
                  <option value="ปิดปรับปรุง">ปิดปรับปรุง</option>
                </select>
                <input type="text" id="quiz-search" placeholder="ค้นหาควิซ..." class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" oninput="filterQuizzes()">
                <button onclick="exportQuizzes()" class="px-4 py-2 bg-success text-white rounded-lg hover:bg-green-600 transition-colors">
                  <i class="fas fa-download mr-2"></i>Export
                </button>
              </div>
            </div>

            <!-- Quiz Table -->
            <div class="bg-white rounded-xl border overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อควิซ</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วิชา</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันหมดอายุ</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การจัดการ</th>
                    </tr>
                  </thead>
                  <tbody id="quiz-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Quiz rows will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Users Tab -->
          <div id="tab-users" class="admin-tab-content hidden">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-800">จัดการผู้ใช้งาน</h3>
              <button onclick="exportUsers()" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
                <i class="fas fa-download mr-2"></i>Export ข้อมูล
              </button>
            </div>
            
            <!-- User Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-white rounded-xl border p-4">
                <div class="text-2xl font-bold text-blue-600" id="total-users">0</div>
                <div class="text-sm text-gray-600">ผู้ใช้ทั้งหมด</div>
              </div>
              <div class="bg-white rounded-xl border p-4">
                <div class="text-2xl font-bold text-green-600" id="active-users">0</div>
                <div class="text-sm text-gray-600">ผู้ใช้ที่ใช้งาน</div>
              </div>
              <div class="bg-white rounded-xl border p-4">
                <div class="text-2xl font-bold text-yellow-600" id="new-users">0</div>
                <div class="text-sm text-gray-600">ผู้ใช้ใหม่วันนี้</div>
              </div>
            </div>

            <!-- User Activity Log -->
            <div class="bg-white rounded-xl border p-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">กิจกรรมผู้ใช้งาน</h4>
              <div id="user-activity" class="space-y-3">
                <!-- User activity will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Analytics Tab -->
          <div id="tab-analytics" class="admin-tab-content hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">สถิติและการวิเคราะห์</h3>
            
            <!-- Time Range Selector -->
            <div class="bg-white rounded-xl border p-4 mb-6">
              <div class="flex items-center space-x-4">
                <label class="text-sm font-medium text-gray-700">ช่วงเวลา:</label>
                <select id="analytics-range" class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" onchange="updateAnalytics()">
                  <option value="today">วันนี้</option>
                  <option value="week">7 วันที่ผ่านมา</option>
                  <option value="month">30 วันที่ผ่านมา</option>
                  <option value="year">1 ปีที่ผ่านมา</option>
                </select>
                <button onclick="refreshAnalytics()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                  <i class="fas fa-sync-alt mr-2"></i>อัพเดต
                </button>
              </div>
            </div>

            <!-- Analytics Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white rounded-xl border p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">การเข้าชมรายวัน</h4>
                <div id="visits-chart" class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                  <span class="text-gray-500">กราฟการเข้าชม</span>
                </div>
              </div>
              
              <div class="bg-white rounded-xl border p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">ควิซยอดนิยม</h4>
                <div id="popular-quizzes" class="space-y-3">
                  <!-- Popular quizzes will be loaded here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div id="tab-settings" class="admin-tab-content hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">ตั้งค่าระบบ</h3>
            
            <!-- General Settings -->
            <div class="bg-white rounded-xl border p-6 mb-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">ตั้งค่าทั่วไป</h4>
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อเว็บไซต์</label>
                    <input type="text" id="site-name" value="Allquiz" class="w-full px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบายเว็บไซต์</label>
                    <input type="text" id="site-description" value="ระบบเฉลยคำตอบที่ปลอดภัยและทันสมัย" class="w-full px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50">
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Google Sheets ID</label>
                    <input type="text" id="sheets-id" value="1-7p30j2PR8oLeyJ02vMq1ut5IZ6iSh8zvMFS50w74Lc" class="w-full px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input type="password" id="api-key" value="AIzaSyB4AyLjp-qzWqGm9uoKBeF2G8XUwk-eWPw" class="w-full px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50">
                  </div>
                </div>
              </div>
            </div>

            <!-- Security Settings -->
            <div class="bg-white rounded-xl border p-6 mb-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">ความปลอดภัย</h4>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-gray-800">เปิดใช้การแจ้งเตือนความปลอดภัย</div>
                    <div class="text-sm text-gray-600">แจ้งเตือนเมื่อมีการเข้าสู่ระบบผิดปกติ</div>
                  </div>
                  <input type="checkbox" id="security-alerts" checked class="w-5 h-5 text-primary rounded focus:ring-primary">
                </div>
                
                <div class="flex items-center justify-between">
                  <div>
                    <div class="font-medium text-gray-800">บังคับใช้ HTTPS</div>
                    <div class="text-sm text-gray-600">เปลี่ยนเส้นทางทุกการเชื่อมต่อไปยัง HTTPS</div>
                  </div>
                  <input type="checkbox" id="force-https" checked class="w-5 h-5 text-primary rounded focus:ring-primary">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนครั้งที่พยายามเข้าสู่ระบบสูงสุด</label>
                    <input type="number" id="max-login-attempts" value="3" min="1" max="10" class="w-full px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เวลาล็อก (นาที)</label>
                    <input type="number" id="lockout-duration" value="5" min="1" max="60" class="w-full px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50">
                  </div>
                </div>
              </div>
            </div>

            <!-- Backup & Restore -->
            <div class="bg-white rounded-xl border p-6">
              <h4 class="text-lg font-semibold text-gray-800 mb-4">สำรองข้อมูลและกู้คืน</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="backupData()" class="px-4 py-3 bg-success text-white rounded-lg hover:bg-green-600 transition-colors">
                  <i class="fas fa-download mr-2"></i>สำรองข้อมูล
                </button>
                <button onclick="document.getElementById('restore-file').click()" class="px-4 py-3 bg-warning text-white rounded-lg hover:bg-yellow-600 transition-colors">
                  <i class="fas fa-upload mr-2"></i>กู้คืนข้อมูล
                </button>
                <button onclick="resetSystem()" class="px-4 py-3 bg-accent text-white rounded-lg hover:bg-red-600 transition-colors">
                  <i class="fas fa-redo mr-2"></i>รีเซ็ตระบบ
                </button>
              </div>
              <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreData(event)">
            </div>

            <!-- Save Settings -->
            <div class="mt-6">
              <button onclick="saveSettings()" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
                <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่า
              </button>
            </div>
          </div>

          <!-- Activity Logs Tab -->
          <div id="tab-logs" class="admin-tab-content hidden">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-semibold text-gray-800">บันทึกกิจกรรม</h3>
              <div class="flex space-x-2">
                <button onclick="clearLogs()" class="px-4 py-2 bg-accent text-white rounded-xl hover:bg-red-600 transition-colors">
                  <i class="fas fa-trash mr-2"></i>ลบบันทึก
                </button>
                <button onclick="exportLogs()" class="px-4 py-2 bg-success text-white rounded-xl hover:bg-green-600 transition-colors">
                  <i class="fas fa-download mr-2"></i>Export
                </button>
              </div>
            </div>
            
            <!-- Log Filters -->
            <div class="bg-white rounded-xl border p-4 mb-6">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="log-level-filter" class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" onchange="filterLogs()">
                  <option value="">ทุกระดับ</option>
                  <option value="info">ข้อมูล</option>
                  <option value="warning">คำเตือน</option>
                  <option value="error">ข้อผิดพลาด</option>
                  <option value="admin">ผู้ดูแลระบบ</option>
                </select>
                <input type="date" id="log-date-filter" class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" onchange="filterLogs()">
                <input type="text" id="log-search" placeholder="ค้นหาในบันทึก..." class="px-4 py-2 bg-ios-gray rounded-lg border-none outline-none focus:ring-2 focus:ring-primary/50" oninput="filterLogs()">
                <button onclick="refreshLogs()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                  <i class="fas fa-sync-alt mr-2"></i>รีเฟรช
                </button>
              </div>
            </div>

            <!-- Activity Logs -->
            <div class="bg-white rounded-xl border">
              <div class="max-h-96 overflow-y-auto">
                <table class="w-full">
                  <thead class="bg-gray-50 sticky top-0">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เวลา</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ระดับ</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กิจกรรม</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                    </tr>
                  </thead>
                  <tbody id="logs-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Logs will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div id="quiz-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="ios-card rounded-3xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden">
      <div class="bg-gradient-to-r from-primary to-secondary text-white p-6">
        <div class="flex items-center justify-between">
          <h3 id="quiz-modal-title" class="text-xl font-semibold">เพิ่มควิซใหม่</h3>
          <button onclick="closeQuizModal()" class="text-white/70 hover:text-white transition-colors">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6 overflow-y-auto">
        <form id="quiz-form" class="space-y-4">
          <input type="hidden" id="quiz-id" value="">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">วิชา</label>
              <select id="quiz-subject" class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50" required>
                <option value="">เลือกวิชา</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
              <select id="quiz-status" class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50">
                <option value="">ไม่ระบุ</option>
                <option value="อัพเดตล่าสุด">อัพเดตล่าสุด</option>
                <option value="รออัพเดต">รออัพเดต</option>
                <option value="ปิดปรับปรุง">ปิดปรับปรุง</option>
              </select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อควิซ <span class="text-red-500">*</span></label>
            <input type="text" id="quiz-name" class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ลิงก์เฉลย</label>
            <input type="url" id="quiz-link" class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
            <textarea id="quiz-description" rows="3" class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">วันหมดอายุ</label>
            <input type="datetime-local" id="quiz-expiry" class="w-full px-4 py-3 bg-ios-gray rounded-xl border-none outline-none focus:ring-2 focus:ring-primary/50">
          </div>
          
          <div class="flex space-x-3">
            <button type="button" onclick="closeQuizModal()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition-colors">
              ยกเลิก
            </button>
            <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl hover:bg-blue-600 transition-colors">
              <i class="fas fa-save mr-2"></i>บันทึก
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-6 right-6 space-y-3 z-50">
    <!-- Toast notifications will appear here -->
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-40">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-gray-200 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600">กำลังโหลด...</p>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      SHEET_ID: "1-7p30j2PR8oLeyJ02vMq1ut5IZ6iSh8zvMFS50w74Lc",
      SHEET_RANGE: "Allquestions",
      API_KEY: "AIzaSyB4AyLjp-qzWqGm9uoKBeF2G8XUwk-eWPw",
      ADMIN_CREDENTIALS: {
        username: "admin",
        password: "allquiz2025"
      },
      SECURITY: {
        maxLoginAttempts: 3,
        lockoutDuration: 300000,
        sessionTimeout: 3600000,
      }
    };

    // Global state
    let state = {
      subjects: {},
      currentSubject: null,
      isAdminLoggedIn: false,
      loginAttempts: 0,
      lastActivity: Date.now(),
      notifications: [],
      announcements: [],
      searchResults: null,
      activityLogs: [],
      users: [],
      currentQuiz: null,
    };

    // Security measures
    const security = {
      validateSession() {
        const now = Date.now();
        if (now - state.lastActivity > CONFIG.SECURITY.sessionTimeout) {
          this.logout();
          return false;
        }
        state.lastActivity = now;
        return true;
      },

      logout() {
        state.isAdminLoggedIn = false;
        sessionStorage.removeItem('adminSession');
        closeAdminPanel();
        logActivity('admin', 'Admin session expired');
        showToast('Session expired', 'warning');
      },

      checkLoginAttempts() {
        const attempts = parseInt(localStorage.getItem('loginAttempts') || '0');
        const lastAttempt = parseInt(localStorage.getItem('lastLoginAttempt') || '0');
        const now = Date.now();
        
        if (now - lastAttempt > CONFIG.SECURITY.lockoutDuration) {
          localStorage.removeItem('loginAttempts');
          localStorage.removeItem('lastLoginAttempt');
          return true;
        }
        
        return attempts < CONFIG.SECURITY.maxLoginAttempts;
      },

      recordFailedLogin() {
        const attempts = parseInt(localStorage.getItem('loginAttempts') || '0') + 1;
        localStorage.setItem('loginAttempts', attempts.toString());
        localStorage.setItem('lastLoginAttempt', Date.now().toString());
        
        logActivity('warning', `Failed login attempt ${attempts}`);
        
        if (attempts >= CONFIG.SECURITY.maxLoginAttempts) {
          showToast(`Too many failed attempts. Try again in ${CONFIG.SECURITY.lockoutDuration / 60000} minutes.`, 'error');
        }
      }
    };

    // Activity logging
    function logActivity(level, message, details = '') {
      const entry = {
        timestamp: new Date().toLocaleString('th-TH'),
        level,
        message,
        details,
        ip: 'Client IP' // In real app, get from server
      };
      
      state.activityLogs.unshift(entry);
      
      // Keep only last 1000 entries
      if (state.activityLogs.length > 1000) {
        state.activityLogs = state.activityLogs.slice(0, 1000);
      }
      
      // Save to localStorage
      localStorage.setItem('activityLogs', JSON.stringify(state.activityLogs));
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      await initializeApp();
      setupEventListeners();
      startActivityMonitoring();
      loadStoredData();
    });

    async function initializeApp() {
      try {
        logActivity('info', 'Application started');
        await loadSubjects();
        loadAnnouncements();
        updateStats();
        generateSampleUsers();
        hideLoading();
      } catch (error) {
        console.error('Failed to initialize:', error);
        logActivity('error', 'Application initialization failed', error.message);
        showToast('Failed to load data', 'error');
      }
    }

    function loadStoredData() {
      // Load activity logs
      const logs = localStorage.getItem('activityLogs');
      if (logs) {
        state.activityLogs = JSON.parse(logs);
      }
    }

    function setupEventListeners() {
      // Search
      document.getElementById('search-input').addEventListener('input', handleSearch);
      
      // Activity monitoring
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, () => {
          state.lastActivity = Date.now();
        }, { passive: true });
      });

      // Admin form
      document.getElementById('admin-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAdminLogin();
      });

      // Quiz form
      document.getElementById('quiz-form').addEventListener('submit', handleQuizSubmit);
    }

    function startActivityMonitoring() {
      setInterval(() => {
        if (state.isAdminLoggedIn) {
          security.validateSession();
        }
      }, 60000);
    }

    async function loadSubjects() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_RANGE}?key=${CONFIG.API_KEY}`;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.values) {
          processSubjectData(data.values);
          renderSubjects();
          populateSubjectOptions();
        }
      } catch (error) {
        throw new Error('Failed to fetch data from Google Sheets');
      }
    }

    function processSubjectData(rawData) {
      state.subjects = {};
      let totalQuizzes = 0;
      let activeQuizzes = 0;

      rawData.slice(1).forEach(row => {
        const [subject, quizName, quizLink, quizDescription, expiryDate, status] = row || [];
        
        if (subject && subject.trim()) {
          if (!state.subjects[subject]) {
            state.subjects[subject] = [];
          }
          
          if (quizName) {
            const quiz = { 
              id: Date.now() + Math.random(),
              quizName, 
              quizLink, 
              quizDescription, 
              expiryDate, 
              status,
              subject 
            };
            state.subjects[subject].push(quiz);
            totalQuizzes++;
            
            if (quizLink && !isExpired(expiryDate)) {
              activeQuizzes++;
            }
          }
        }
      });

      document.getElementById('total-subjects').textContent = Object.keys(state.subjects).length;
      document.getElementById('total-quizzes').textContent = totalQuizzes;
      document.getElementById('active-quizzes').textContent = activeQuizzes;
    }

    function populateSubjectOptions() {
      const select = document.getElementById('quiz-subject');
      const filterSelect = document.getElementById('quiz-filter-subject');
      
      // Clear existing options
      select.innerHTML = '<option value="">เลือกวิชา</option>';
      filterSelect.innerHTML = '<option value="">ทุกวิชา</option>';
      
      Object.keys(state.subjects).forEach(subject => {
        const option1 = new Option(subject, subject);
        const option2 = new Option(subject, subject);
        select.appendChild(option1);
        filterSelect.appendChild(option2);
      });
    }

    function renderSubjects() {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';

      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const card = createSubjectCard(subject, quizzes);
        grid.appendChild(card);
      });
    }

    function createSubjectCard(subject, quizzes) {
      const availableQuizzes = quizzes.filter(q => q.quizName && q.quizLink && !isExpired(q.expiryDate)).length;
      const hasQuizzes = quizzes.some(q => q.quizName);
      
      const card = document.createElement('div');
      card.className = `ios-card rounded-3xl p-6 shadow-lg border cursor-pointer transition-all duration-300 hover:shadow-xl hover:-translate-y-1 animate-slide-in ${hasQuizzes ? 'hover:shadow-primary/20' : ''}`;
      
      const icon = getSubjectIcon(subject);
      
      card.innerHTML = `
        <div class="text-center">
          <div class="w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
            <i class="fas ${icon} text-white text-2xl"></i>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2 text-lg">${subject}</h3>
          ${!hasQuizzes ? 
            '<span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full">รออัพเดต</span>' :
            `<span class="inline-block px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">${availableQuizzes} ควิซพร้อมใช้</span>`
          }
        </div>
      `;
      
      if (hasQuizzes) {
        card.addEventListener('click', () => {
          showQuizzes(subject);
          logActivity('info', `Viewed quizzes for subject: ${subject}`);
        });
      }
      
      return card;
    }

    function getSubjectIcon(subject) {
      const icons = {
        'คอมพิวเตอร์': 'fa-laptop-code',
        'คณิตศาสตร์': 'fa-calculator',
        'วิทยาศาสตร์': 'fa-flask',
        'ภาษา': 'fa-language',
        'default': 'fa-book'
      };
      
      for (const [key, icon] of Object.entries(icons)) {
        if (subject.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      return icons.default;
    }

    function showQuizzes(subject) {
      state.currentSubject = subject;
      const quizzes = state.subjects[subject];
      
      document.getElementById('subjects-section').classList.add('hidden');
      document.getElementById('quiz-section').classList.remove('hidden');
      document.getElementById('quiz-section-title').textContent = `ควิซในวิชา ${subject}`;
      
      renderQuizzes(quizzes);
    }

    function renderQuizzes(quizzes) {
      const grid = document.getElementById('quiz-grid');
      grid.innerHTML = '';

      quizzes.forEach((quiz, index) => {
        if (!quiz.quizName) return;
        
        const card = createQuizCard(quiz, index);
        grid.appendChild(card);
      });
    }

    function createQuizCard(quiz, index) {
      const isExpiredQuiz = isExpired(quiz.expiryDate);
      const countdown = quiz.expiryDate ? calculateCountdown(quiz.expiryDate) : null;
      
      const card = document.createElement('div');
      card.className = 'ios-card rounded-3xl p-6 shadow-lg border transition-all duration-300 hover:shadow-xl animate-slide-in';
      
      let statusBadge = '';
      if (quiz.status) {
        const statusColors = {
          'อัพเดตล่าสุด': 'bg-green-100 text-green-800',
          'รออัพเดต': 'bg-yellow-100 text-yellow-800',
          'ปิดปรับปรุง': 'bg-red-100 text-red-800'
        };
        const colorClass = statusColors[quiz.status] || 'bg-gray-100 text-gray-800';
        statusBadge = `<span class="inline-block px-3 py-1 ${colorClass} text-sm rounded-full mb-3">${quiz.status}</span>`;
      } else if (countdown) {
        statusBadge = isExpiredQuiz ? 
          '<span class="inline-block px-3 py-1 bg-red-100 text-red-800 text-sm rounded-full mb-3">หมดเวลา</span>' :
          `<span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full mb-3"><i class="fas fa-clock mr-1"></i>${countdown}</span>`;
      }
      
      card.innerHTML = `
        <div class="flex items-start space-x-4">
          <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <i class="fas fa-file-alt text-gray-600 text-lg"></i>
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="font-semibold text-gray-800 mb-2 text-lg leading-tight">${quiz.quizName}</h3>
            ${statusBadge}
            ${quiz.quizDescription ? `<p class="text-gray-600 text-sm mb-4 leading-relaxed">${quiz.quizDescription}</p>` : ''}
            
            <div class="flex items-center justify-between">
              ${quiz.quizLink && !isExpiredQuiz ? 
                `<a href="${quiz.quizLink}" target="_blank" onclick="logQuizAccess('${quiz.quizName}')" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white text-sm rounded-xl hover:shadow-lg transition-all">
                  <i class="fas fa-external-link-alt mr-2"></i>ดูเฉลย
                </a>` :
                '<span class="px-4 py-2 bg-gray-100 text-gray-600 text-sm rounded-xl">ไม่พร้อมใช้งาน</span>'
              }
              
              ${state.isAdminLoggedIn ? 
                `<button onclick="editQuiz('${quiz.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                  <i class="fas fa-edit"></i>
                </button>` : ''
              }
            </div>
          </div>
        </div>
      `;
      
      return card;
    }

    function logQuizAccess(quizName) {
      logActivity('info', `Quiz accessed: ${quizName}`);
    }

    function goBackToSubjects() {
      document.getElementById('quiz-section').classList.add('hidden');
      document.getElementById('subjects-section').classList.remove('hidden');
      state.currentSubject = null;
    }

    // Search functionality
    function handleSearch() {
      const query = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!query) {
        state.searchResults = null;
        renderSubjects();
        return;
      }

      const results = {};
      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const matchingQuizzes = quizzes.filter(quiz => 
          subject.toLowerCase().includes(query) ||
          (quiz.quizName && quiz.quizName.toLowerCase().includes(query)) ||
          (quiz.quizDescription && quiz.quizDescription.toLowerCase().includes(query))
        );
        
        if (matchingQuizzes.length > 0 || subject.toLowerCase().includes(query)) {
          results[subject] = quizzes;
        }
      });

      state.searchResults = results;
      renderSearchResults(results);
      logActivity('info', `Search performed: ${query}`);
    }

    function renderSearchResults(results) {
      const grid = document.getElementById('subjects-grid');
      grid.innerHTML = '';

      if (Object.keys(results).length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i class="fas fa-search text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">ไม่พบผลการค้นหา</h3>
            <p class="text-gray-500">ลองใช้คำค้นหาอื่นหรือตรวจสอบการสะกดคำ</p>
          </div>
        `;
        return;
      }

      Object.entries(results).forEach(([subject, quizzes]) => {
        const card = createSubjectCard(subject, quizzes);
        grid.appendChild(card);
      });
    }

    // Admin functions
    function showAdminPanel() {
      document.getElementById('admin-modal').classList.remove('hidden');
    }

    function closeAdminPanel() {
      document.getElementById('admin-modal').classList.add('hidden');
      if (!state.isAdminLoggedIn) {
        document.getElementById('admin-username').value = '';
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-error').classList.add('hidden');
      }
    }

    function handleAdminLogin() {
      if (!security.checkLoginAttempts()) {
        showToast('Too many failed attempts', 'error');
        return;
      }

      const username = document.getElementById('admin-username').value;
      const password = document.getElementById('admin-password').value;
      
      if (username === CONFIG.ADMIN_CREDENTIALS.username && 
          password === CONFIG.ADMIN_CREDENTIALS.password) {
        
        state.isAdminLoggedIn = true;
        sessionStorage.setItem('adminSession', Date.now().toString());
        localStorage.removeItem('loginAttempts');
        localStorage.removeItem('lastLoginAttempt');
        
        document.getElementById('admin-login-sidebar').classList.add('hidden');
        document.getElementById('admin-nav').classList.remove('hidden');
        document.getElementById('admin-indicator').classList.remove('hidden');
        
        showToast('เข้าสู่ระบบสำเร็จ', 'success');
        switchAdminTab('dashboard');
        loadAdminData();
        logActivity('admin', 'Admin login successful');
      } else {
        document.getElementById('admin-error').classList.remove('hidden');
        security.recordFailedLogin();
        document.getElementById('admin-password').value = '';
      }
    }

    function logoutAdmin() {
      logActivity('admin', 'Admin logout');
      state.isAdminLoggedIn = false;
      sessionStorage.removeItem('adminSession');
      
      document.getElementById('admin-login-sidebar').classList.remove('hidden');
      document.getElementById('admin-nav').classList.add('hidden');
      document.getElementById('admin-indicator').classList.add('hidden');
      
      // Clear form
      document.getElementById('admin-username').value = '';
      document.getElementById('admin-password').value = '';
      document.getElementById('admin-error').classList.add('hidden');
      
      showToast('ออกจากระบบสำเร็จ', 'info');
    }

    function loadAdminData() {
      updateDashboardStats();
      loadRecentActivity();
      loadQuizTable();
      loadUserActivity();
      loadActivityLogs();
    }

    function switchAdminTab(tabName) {
      // Update navigation
      document.querySelectorAll('.admin-nav-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
      });
      event.target.classList.add('bg-primary', 'text-white');
      event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');

      // Update content
      document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');

      // Load tab-specific data
      switch(tabName) {
        case 'dashboard':
          updateDashboardStats();
          break;
        case 'announcements':
          renderAnnouncementsList();
          break;
        case 'quizzes':
          loadQuizTable();
          break;
        case 'users':
          loadUserStats();
          break;
        case 'analytics':
          updateAnalytics();
          break;
        case 'logs':
          loadActivityLogs();
          break;
      }
    }

    // Dashboard functions
    function updateDashboardStats() {
      document.getElementById('dash-visitors').textContent = Math.floor(Math.random() * 500) + 100;
      document.getElementById('dash-downloads').textContent = Math.floor(Math.random() * 100) + 50;
      document.getElementById('dash-active').textContent = Math.floor(Math.random() * 50) + 10;
      document.getElementById('dash-alerts').textContent = state.notifications.length;
    }

    function loadRecentActivity() {
      const container = document.getElementById('recent-activity');
      container.innerHTML = '';

      const recentLogs = state.activityLogs.slice(0, 10);
      
      recentLogs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
        
        const iconClass = {
          'info': 'fa-info-circle text-blue-500',
          'warning': 'fa-exclamation-triangle text-yellow-500',
          'error': 'fa-exclamation-circle text-red-500',
          'admin': 'fa-shield-alt text-purple-500'
        }[log.level] || 'fa-info-circle text-gray-500';
        
        item.innerHTML = `
          <i class="fas ${iconClass}"></i>
          <div class="flex-1">
            <div class="text-sm font-medium text-gray-800">${log.message}</div>
            <div class="text-xs text-gray-500">${log.timestamp}</div>
          </div>
        `;
        
        container.appendChild(item);
      });
    }

    // Announcement functions
    function createAnnouncement() {
      const title = document.getElementById('announcement-title-input').value.trim();
      const content = document.getElementById('announcement-content-input').value.trim();
      const type = document.getElementById('announcement-type').value;
      
      if (!title || !content) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
        return;
      }

      const announcement = {
        id: Date.now(),
        title,
        content,
        type,
        timestamp: new Date().toLocaleString('th-TH'),
        active: true
      };

      state.announcements.unshift(announcement);
      saveAnnouncements();
      showActiveAnnouncement(announcement);
      renderAnnouncementsList();
      
      // Clear form
      document.getElementById('announcement-title-input').value = '';
      document.getElementById('announcement-content-input').value = '';
      
      logActivity('admin', `Created announcement: ${title}`);
      showToast('ประกาศสำเร็จ', 'success');
    }

    function scheduleAnnouncement() {
      showToast('ฟีเจอร์กำหนดเวลาประกาศจะพัฒนาในอนาคต', 'info');
    }

    function showActiveAnnouncement(announcement) {
      const banner = document.getElementById('announcement-banner');
      const title = document.getElementById('announcement-title');
      const content = document.getElementById('announcement-content');
      const time = document.getElementById('announcement-time');
      
      title.textContent = announcement.title;
      content.textContent = announcement.content;
      time.textContent = announcement.timestamp;
      
      banner.classList.remove('hidden');
      
      if (announcement.type !== 'urgent') {
        setTimeout(() => {
          banner.classList.add('hidden');
        }, 10000);
      }
    }

    function dismissAnnouncement() {
      document.getElementById('announcement-banner').classList.add('hidden');
    }

    function loadAnnouncements() {
      const saved = localStorage.getItem('announcements');
      if (saved) {
        state.announcements = JSON.parse(saved);
        
        const latest = state.announcements.find(a => a.active);
        if (latest) {
          showActiveAnnouncement(latest);
        }
      }
    }

    function saveAnnouncements() {
      localStorage.setItem('announcements', JSON.stringify(state.announcements));
    }

    function renderAnnouncementsList() {
      const list = document.getElementById('announcements-list');
      list.innerHTML = '';

      state.announcements.forEach(announcement => {
        const item = document.createElement('div');
        item.className = 'bg-ios-gray rounded-xl p-4';
        
        const typeColors = {
          info: 'text-blue-600',
          warning: 'text-yellow-600',
          urgent: 'text-red-600'
        };
        
        item.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h5 class="font-medium text-gray-800">${announcement.title}</h5>
              <p class="text-gray-600 text-sm mt-1">${announcement.content}</p>
              <div class="flex items-center space-x-2 mt-2">
                <span class="text-xs ${typeColors[announcement.type]} px-2 py-1 bg-white rounded-full">${announcement.type}</span>
                <span class="text-xs text-gray-500">${announcement.timestamp}</span>
              </div>
            </div>
            <div class="flex space-x-2 ml-2">
              <button onclick="toggleAnnouncement(${announcement.id})" class="text-gray-400 hover:text-blue-600 transition-colors">
                <i class="fas ${announcement.active ? 'fa-eye-slash' : 'fa-eye'} text-sm"></i>
              </button>
              <button onclick="deleteAnnouncement(${announcement.id})" class="text-gray-400 hover:text-red-600 transition-colors">
                <i class="fas fa-trash text-sm"></i>
              </button>
            </div>
          </div>
        `;
        
        list.appendChild(item);
      });
    }

    function toggleAnnouncement(id) {
      const announcement = state.announcements.find(a => a.id === id);
      if (announcement) {
        announcement.active = !announcement.active;
        saveAnnouncements();
        renderAnnouncementsList();
        logActivity('admin', `Toggled announcement: ${announcement.title}`);
      }
    }

    function deleteAnnouncement(id) {
      state.announcements = state.announcements.filter(a => a.id !== id);
      saveAnnouncements();
      renderAnnouncementsList();
      logActivity('admin', 'Deleted announcement');
      showToast('ลบประกาศแล้ว', 'success');
    }

    // Quiz Management
    function showAddQuizModal() {
      state.currentQuiz = null;
      document.getElementById('quiz-modal-title').textContent = 'เพิ่มควิซใหม่';
      document.getElementById('quiz-form').reset();
      document.getElementById('quiz-id').value = '';
      document.getElementById('quiz-modal').classList.remove('hidden');
    }

    function editQuiz(quizId) {
      // Find quiz in all subjects
      let foundQuiz = null;
      let foundSubject = null;
      
      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        const quiz = quizzes.find(q => q.id == quizId);
        if (quiz) {
          foundQuiz = quiz;
          foundSubject = subject;
        }
      });
      
      if (foundQuiz) {
        state.currentQuiz = foundQuiz;
        document.getElementById('quiz-modal-title').textContent = 'แก้ไขควิซ';
        document.getElementById('quiz-id').value = foundQuiz.id;
        document.getElementById('quiz-subject').value = foundSubject;
        document.getElementById('quiz-name').value = foundQuiz.quizName || '';
        document.getElementById('quiz-link').value = foundQuiz.quizLink || '';
        document.getElementById('quiz-description').value = foundQuiz.quizDescription || '';
        document.getElementById('quiz-status').value = foundQuiz.status || '';
        
        // Format expiry date
        if (foundQuiz.expiryDate) {
          try {
            const [datePart, timePart] = foundQuiz.expiryDate.split(", ");
            if (datePart) {
              const [day, month, year] = datePart.split("/");
              const formattedDate = `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}T${timePart || "00:00"}`;
              document.getElementById('quiz-expiry').value = formattedDate;
            }
          } catch (error) {
            console.error("Error formatting date:", error);
          }
        }
        
        document.getElementById('quiz-modal').classList.remove('hidden');
      }
    }

    function closeQuizModal() {
      document.getElementById('quiz-modal').classList.add('hidden');
      state.currentQuiz = null;
    }

    function handleQuizSubmit(e) {
      e.preventDefault();
      
      const quizData = {
        id: document.getElementById('quiz-id').value || Date.now() + Math.random(),
        subject: document.getElementById('quiz-subject').value,
        quizName: document.getElementById('quiz-name').value,
        quizLink: document.getElementById('quiz-link').value,
        quizDescription: document.getElementById('quiz-description').value,
        status: document.getElementById('quiz-status').value,
        expiryDate: formatExpiryDate(document.getElementById('quiz-expiry').value)
      };
      
      if (!quizData.subject || !quizData.quizName) {
        showToast('กรุณากรอกข้อมูลที่จำเป็น', 'warning');
        return;
      }
      
      // Initialize subject if not exists
      if (!state.subjects[quizData.subject]) {
        state.subjects[quizData.subject] = [];
      }
      
      if (state.currentQuiz) {
        // Update existing quiz
        const quizIndex = state.subjects[quizData.subject].findIndex(q => q.id == quizData.id);
        if (quizIndex !== -1) {
          state.subjects[quizData.subject][quizIndex] = quizData;
          logActivity('admin', `Updated quiz: ${quizData.quizName}`);
          showToast('อัพเดตควิซสำเร็จ', 'success');
        }
      } else {
        // Add new quiz
        state.subjects[quizData.subject].push(quizData);
        logActivity('admin', `Added new quiz: ${quizData.quizName}`);
        showToast('เพิ่มควิซสำเร็จ', 'success');
      }
      
      closeQuizModal();
      renderSubjects();
      populateSubjectOptions();
      loadQuizTable();
      updateStats();
    }

    function formatExpiryDate(dateTimeValue) {
      if (!dateTimeValue) return '';
      
      try {
        const [datePart, timePart] = dateTimeValue.split('T');
        const [year, month, day] = datePart.split('-');
        return `${day}/${month}/${year}, ${timePart}`;
      } catch (error) {
        return '';
      }
    }

    function loadQuizTable() {
      const tbody = document.getElementById('quiz-table-body');
      tbody.innerHTML = '';
      
      Object.entries(state.subjects).forEach(([subject, quizzes]) => {
        quizzes.forEach(quiz => {
          if (!quiz.quizName) return;
          
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          
          const statusColor = {
            'อัพเดตล่าสุด': 'bg-green-100 text-green-800',
            'รออัพเดต': 'bg-yellow-100 text-yellow-800',
            'ปิดปรับปรุง': 'bg-red-100 text-red-800'
          }[quiz.status] || 'bg-gray-100 text-gray-800';
          
          const expiryStatus = quiz.expiryDate ? 
            (isExpired(quiz.expiryDate) ? 
              '<span class="text-red-600">หมดเวลา</span>' : 
              '<span class="text-green-600">ปกติ</span>') : 
            '<span class="text-gray-500">ไม่ระบุ</span>';
          
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${quiz.quizName}</div>
              <div class="text-sm text-gray-500">${quiz.quizDescription || 'ไม่มีคำอธิบาย'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${subject}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                ${quiz.status || 'ไม่ระบุ'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              ${expiryStatus}
              ${quiz.expiryDate ? `<br><small class="text-gray-500">${quiz.expiryDate}</small>` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <button onclick="editQuiz('${quiz.id}')" class="text-indigo-600 hover:text-indigo-900">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteQuiz('${quiz.id}', '${subject}')" class="text-red-600 hover:text-red-900">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      });
    }

    function deleteQuiz(quizId, subject) {
      if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบควิซนี้?')) {
        state.subjects[subject] = state.subjects[subject].filter(q => q.id != quizId);
        loadQuizTable();
        renderSubjects();
        updateStats();
        logActivity('admin', `Deleted quiz ID: ${quizId}`);
        showToast('ลบควิซสำเร็จ', 'success');
      }
    }

    function filterQuizzes() {
      // Implementation for filtering quizzes
      loadQuizTable(); // For now, just reload
    }

    function exportQuizzes() {
      const data = state.subjects;
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `quizzes_export_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      logActivity('admin', 'Exported quiz data');
      showToast('Export สำเร็จ', 'success');
    }

    // User Management
    function generateSampleUsers() {
      state.users = [
        { id: 1, name: 'ผู้ใช้ 1', email: 'user1@example.com', lastActive: '2 นาทีที่แล้ว', status: 'online' },
        { id: 2, name: 'ผู้ใช้ 2', email: 'user2@example.com', lastActive: '5 นาทีที่แล้ว', status: 'offline' },
        { id: 3, name: 'ผู้ใช้ 3', email: 'user3@example.com', lastActive: '1 ชั่วโมงที่แล้ว', status: 'online' },
      ];
    }

    function loadUserStats() {
      document.getElementById('total-users').textContent = state.users.length;
      document.getElementById('active-users').textContent = state.users.filter(u => u.status === 'online').length;
      document.getElementById('new-users').textContent = Math.floor(Math.random() * 5) + 1;
      
      loadUserActivity();
    }

    function loadUserActivity() {
      const container = document.getElementById('user-activity');
      container.innerHTML = '';

      state.users.forEach(user => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        
        const statusColor = user.status === 'online' ? 'bg-green-500' : 'bg-gray-400';
        
        item.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 ${statusColor} rounded-full flex items-center justify-center text-white text-sm font-semibold">
              ${user.name.charAt(0)}
            </div>
            <div>
              <div class="text-sm font-medium text-gray-900">${user.name}</div>
              <div class="text-xs text-gray-500">${user.email}</div>
            </div>
          </div>
          <div class="text-xs text-gray-500">${user.lastActive}</div>
        `;
        
        container.appendChild(item);
      });
    }

    function exportUsers() {
      const data = state.users;
      const csv = 'Name,Email,Last Active,Status\n' + 
                  data.map(u => `${u.name},${u.email},${u.lastActive},${u.status}`).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      URL.revokeObjectURL(url);
      logActivity('admin', 'Exported user data');
      showToast('Export ผู้ใช้สำเร็จ', 'success');
    }

    // Analytics
    function updateAnalytics() {
      const range = document.getElementById('analytics-range')?.value || 'today';
      
      // Generate sample data
      const popularQuizzes = [
        { name: 'คณิตศาสตร์ - แคลคูลัส', views: 245 },
        { name: 'ฟิสิกส์ - กลศาสตร์', views: 189 },
        { name: 'เคมี - อินทรีย์', views: 156 },
        { name: 'ชีววิทยา - เซลล์', views: 134 },
        { name: 'ภาษาอังกฤษ - Grammar', views: 98 }
      ];
      
      loadPopularQuizzes(popularQuizzes);
      loadVisitsChart(range);
    }

    function loadPopularQuizzes(quizzes) {
      const container = document.getElementById('popular-quizzes');
      container.innerHTML = '';

      quizzes.forEach((quiz, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        
        const rankColors = ['text-yellow-600', 'text-gray-600', 'text-orange-600'];
        const rankColor = rankColors[index] || 'text-blue-600';
        
        item.innerHTML = `
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 ${rankColor === 'text-yellow-600' ? 'bg-yellow-100' : rankColor === 'text-gray-600' ? 'bg-gray-100' : 'bg-blue-100'} rounded-full flex items-center justify-center">
              <span class="text-sm font-bold ${rankColor}">${index + 1}</span>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-900">${quiz.name}</div>
              <div class="text-xs text-gray-500">${quiz.views} ครั้ง</div>
            </div>
          </div>
          <div class="w-16 bg-gray-200 rounded-full h-2">
            <div class="bg-primary h-2 rounded-full" style="width: ${(quiz.views / quizzes[0].views) * 100}%"></div>
          </div>
        `;
        
        container.appendChild(item);
      });
    }

    function loadVisitsChart(range) {
      const chartContainer = document.getElementById('visits-chart');
      chartContainer.innerHTML = `
        <div class="w-full h-full flex items-center justify-center">
          <div class="text-center">
            <i class="fas fa-chart-line text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500">กราฟการเข้าชมสำหรับ ${range}</p>
            <p class="text-xs text-gray-400 mt-1">ข้อมูลจำลอง</p>
          </div>
        </div>
      `;
    }

    function refreshAnalytics() {
      showToast('รีเฟรชข้อมูลสำเร็จ', 'success');
      updateAnalytics();
    }

    // Settings Functions
    function saveSettings() {
      const settings = {
        siteName: document.getElementById('site-name').value,
        siteDescription: document.getElementById('site-description').value,
        sheetsId: document.getElementById('sheets-id').value,
        apiKey: document.getElementById('api-key').value,
        securityAlerts: document.getElementById('security-alerts').checked,
        forceHttps: document.getElementById('force-https').checked,
        maxLoginAttempts: document.getElementById('max-login-attempts').value,
        lockoutDuration: document.getElementById('lockout-duration').value
      };
      
      // Update CONFIG object
      CONFIG.SHEET_ID = settings.sheetsId;
      CONFIG.API_KEY = settings.apiKey;
      CONFIG.SECURITY.maxLoginAttempts = parseInt(settings.maxLoginAttempts);
      CONFIG.SECURITY.lockoutDuration = parseInt(settings.lockoutDuration) * 60000;
      
      // Save to localStorage
      localStorage.setItem('systemSettings', JSON.stringify(settings));
      
      logActivity('admin', 'System settings updated');
      showToast('บันทึกการตั้งค่าสำเร็จ', 'success');
    }

    function loadSettings() {
      const saved = localStorage.getItem('systemSettings');
      if (saved) {
        const settings = JSON.parse(saved);
        
        document.getElementById('site-name').value = settings.siteName || 'Allquiz';
        document.getElementById('site-description').value = settings.siteDescription || 'ระบบเฉลยคำตอบที่ปลอดภัยและทันสมัย';
        document.getElementById('sheets-id').value = settings.sheetsId || CONFIG.SHEET_ID;
        document.getElementById('api-key').value = settings.apiKey || CONFIG.API_KEY;
        document.getElementById('security-alerts').checked = settings.securityAlerts !== false;
        document.getElementById('force-https').checked = settings.forceHttps !== false;
        document.getElementById('max-login-attempts').value = settings.maxLoginAttempts || 3;
        document.getElementById('lockout-duration').value = settings.lockoutDuration || 5;
      }
    }

    function backupData() {
      const backupData = {
        subjects: state.subjects,
        announcements: state.announcements,
        settings: JSON.parse(localStorage.getItem('systemSettings') || '{}'),
        logs: state.activityLogs,
        timestamp: new Date().toISOString()
      };
      
      const json = JSON.stringify(backupData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `allquiz_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      logActivity('admin', 'System backup created');
      showToast('สำรองข้อมูลสำเร็จ', 'success');
    }

    function restoreData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (confirm('คุณแน่ใจหรือไม่ว่าต้องการกู้คืนข้อมูล? ข้อมูลปัจจุบันจะถูกแทนที่')) {
            // Restore data
            if (backupData.subjects) state.subjects = backupData.subjects;
            if (backupData.announcements) state.announcements = backupData.announcements;
            if (backupData.settings) localStorage.setItem('systemSettings', JSON.stringify(backupData.settings));
            if (backupData.logs) state.activityLogs = backupData.logs;
            
            // Save restored data
            saveAnnouncements();
            localStorage.setItem('activityLogs', JSON.stringify(state.activityLogs));
            
            // Refresh UI
            renderSubjects();
            loadSettings();
            loadAdminData();
            
            logActivity('admin', 'System data restored from backup');
            showToast('กู้คืนข้อมูลสำเร็จ', 'success');
          }
        } catch (error) {
          showToast('ไฟล์สำรองข้อมูลไม่ถูกต้อง', 'error');
        }
      };
      reader.readAsText(file);
    }

    function resetSystem() {
      if (confirm('คุณแน่ใจหรือไม่ว่าต้องการรีเซ็ตระบบทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
        // Clear all data
        localStorage.clear();
        sessionStorage.clear();
        
        // Reset state
        state.subjects = {};
        state.announcements = [];
        state.activityLogs = [];
        state.isAdminLoggedIn = false;
        
        logActivity('admin', 'System reset performed');
        showToast('รีเซ็ตระบบสำเร็จ', 'success');
        
        // Reload page
        setTimeout(() => {
          location.reload();
        }, 2000);
      }
    }

    // Activity Logs Functions
    function loadActivityLogs() {
      const tbody = document.getElementById('logs-table-body');
      tbody.innerHTML = '';
      
      const filteredLogs = getFilteredLogs();
      
      filteredLogs.forEach(log => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const levelColors = {
          'info': 'bg-blue-100 text-blue-800',
          'warning': 'bg-yellow-100 text-yellow-800',
          'error': 'bg-red-100 text-red-800',
          'admin': 'bg-purple-100 text-purple-800'
        };
        
        const levelColor = levelColors[log.level] || 'bg-gray-100 text-gray-800';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.timestamp}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${levelColor}">
              ${log.level.toUpperCase()}
            </span>
          </td>
          <td class="px-6 py-4 text-sm text-gray-900">${log.message}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.ip}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function getFilteredLogs() {
      let filtered = [...state.activityLogs];
      
      const levelFilter = document.getElementById('log-level-filter')?.value;
      const dateFilter = document.getElementById('log-date-filter')?.value;
      const searchFilter = document.getElementById('log-search')?.value.toLowerCase();
      
      if (levelFilter) {
        filtered = filtered.filter(log => log.level === levelFilter);
      }
      
      if (dateFilter) {
        filtered = filtered.filter(log => log.timestamp.includes(dateFilter));
      }
      
      if (searchFilter) {
        filtered = filtered.filter(log => 
          log.message.toLowerCase().includes(searchFilter) ||
          log.details.toLowerCase().includes(searchFilter)
        );
      }
      
      return filtered;
    }

    function filterLogs() {
      loadActivityLogs();
    }

    function refreshLogs() {
      loadActivityLogs();
      showToast('รีเฟรชบันทึกสำเร็จ', 'success');
    }

    function clearLogs() {
      if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบบันทึกกิจกรรมทั้งหมด?')) {
        state.activityLogs = [];
        localStorage.setItem('activityLogs', JSON.stringify([]));
        loadActivityLogs();
        logActivity('admin', 'Activity logs cleared');
        showToast('ลบบันทึกสำเร็จ', 'success');
      }
    }

    function exportLogs() {
      const logs = getFilteredLogs();
      const csv = 'Timestamp,Level,Message,Details,IP\n' + 
                  logs.map(l => `"${l.timestamp}","${l.level}","${l.message}","${l.details}","${l.ip}"`).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `activity_logs_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      URL.revokeObjectURL(url);
      logActivity('admin', 'Activity logs exported');
      showToast('Export บันทึกสำเร็จ', 'success');
    }

    // Notifications
    function toggleNotifications() {
      const panel = document.getElementById('notifications-panel');
      panel.classList.toggle('translate-x-full');
      
      if (!panel.classList.contains('translate-x-full')) {
        loadNotifications();
      }
    }

    function loadNotifications() {
      const list = document.getElementById('notifications-list');
      list.innerHTML = '';
      
      // Generate notifications from recent activities
      const recentLogs = state.activityLogs.slice(0, 10);
      
      if (recentLogs.length === 0) {
        list.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-bell-slash text-gray-400 text-2xl mb-2"></i>
            <p class="text-gray-500">ไม่มีการแจ้งเตือน</p>
          </div>
        `;
        return;
      }
      
      recentLogs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'ios-card rounded-xl p-4 border animate-slide-in';
        
        const icons = {
          info: 'fa-info-circle text-blue-500',
          warning: 'fa-exclamation-triangle text-yellow-500',
          error: 'fa-exclamation-circle text-red-500',
          admin: 'fa-shield-alt text-purple-500'
        };
        
        item.innerHTML = `
          <div class="flex items-start space-x-3">
            <i class="fas ${icons[log.level] || icons.info} mt-1"></i>
            <div class="flex-1">
              <p class="text-gray-800 text-sm">${log.message}</p>
              <span class="text-xs text-gray-500">${log.timestamp}</span>
            </div>
          </div>
        `;
        
        list.appendChild(item);
      });
      
      // Update notification badge
      const badge = document.getElementById('notification-badge');
      if (recentLogs.length > 0) {
        badge.classList.remove('hidden');
      }
    }

    // Utility functions
    function isExpired(expiryDate) {
      if (!expiryDate) return false;
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        return new Date(formattedDate).getTime() < Date.now();
      } catch {
        return false;
      }
    }

    function calculateCountdown(expiryDate) {
      if (!expiryDate) return '';
      try {
        const [date, time] = expiryDate.split(", ");
        const [day, month, year] = date.split("/");
        const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time || "00:00:00"}`;
        const timeLeft = new Date(formattedDate).getTime() - Date.now();
        
        if (timeLeft <= 0) return 'หมดเวลา';
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (days > 0) return `${days} วัน`;
        if (hours > 0) return `${hours} ชม.`;
        return 'น้อยกว่า 1 ชม.';
      } catch {
        return '';
      }
    }

    function updateStats() {
      const subjects = Object.keys(state.subjects).length;
      const totalQuizzes = Object.values(state.subjects).reduce((acc, quizzes) => acc + quizzes.length, 0);
      const activeQuizzes = Object.values(state.subjects)
        .flat()
        .filter(quiz => quiz.quizLink && !isExpired(quiz.expiryDate)).length;

      document.getElementById('total-subjects').textContent = subjects;
      document.getElementById('total-quizzes').textContent = totalQuizzes;
      document.getElementById('active-quizzes').textContent = activeQuizzes;
      
      if (activeQuizzes > 0) {
        document.getElementById('notification-badge').classList.remove('hidden');
      }
    }

    // Toast notifications
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      toast.className = `${colors[type]} text-white px-6 py-4 rounded-2xl shadow-lg transform translate-x-full transition-transform duration-300`;
      toast.textContent = message;
      
      document.getElementById('toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    // Security: Disable developer tools and right-click
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && e.key === 'I') ||
          (e.ctrlKey && e.key === 'u') ||
          (e.ctrlKey && e.key === 's')) {
        e.preventDefault();
        logActivity('warning', 'Attempted to access developer tools');
        return false;
      }
    });

    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      logActivity('warning', 'Right-click attempted');
      return false;
    });

    // Initialize settings on admin login
    setTimeout(() => {
      if (document.getElementById('site-name')) {
        loadSettings();
      }
    }, 1000);

    // Auto-save activity logs every 30 seconds
    setInterval(() => {
      if (state.activityLogs.length > 0) {
        localStorage.setItem('activityLogs', JSON.stringify(state.activityLogs));
      }
    }, 30000);

    // Performance monitoring
    function monitorPerformance() {
      if (performance.navigation.type === performance.navigation.TYPE_RELOAD) {
        logActivity('info', 'Page reloaded');
      }
      
      window.addEventListener('beforeunload', () => {
        logActivity('info', 'User left the page');
      });
    }

    // Initialize performance monitoring
    setTimeout(monitorPerformance, 1000);

    // Session management
    function updateSessionInfo() {
      if (state.isAdminLoggedIn) {
        const sessionStart = sessionStorage.getItem('adminSession');
        if (sessionStart) {
          const elapsed = Math.floor((Date.now() - parseInt(sessionStart)) / 1000 / 60);
          document.getElementById('admin-session-info').textContent = `Session: ${elapsed}m`;
        }
      }
    }

    // Update session info every minute
    setInterval(updateSessionInfo, 60000);

    // Final initialization
    document.addEventListener('DOMContentLoaded', () => {
      logActivity('info', 'DOM fully loaded');
      
      // Load any saved admin session
      const savedSession = sessionStorage.getItem('adminSession');
      if (savedSession && Date.now() - parseInt(savedSession) < CONFIG.SECURITY.sessionTimeout) {
        // Auto-login admin if session is valid
        setTimeout(() => {
          const loginEvent = new Event('click');
          Object.defineProperty(loginEvent, 'target', {
            value: document.querySelector('.admin-nav-btn'),
            enumerable: true
          });
          // Don't auto-login for security, just indicate session exists
        }, 100);
      }
    });
  </script>
</body>
</html>
