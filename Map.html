<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ตรวจสอบการเข้าถึงตำแหน่งบนมือถือ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      text-align: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 80%;
      max-width: 600px;
    }

    .btn {
      padding: 12px 24px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .btn:hover {
      background-color: #45a049;
    }

    .error-message {
      background-color: #f44336;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      display: none; /* ซ่อนข้อผิดพลาด */
    }

    .recommendation {
      background-color: #2196F3;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
      display: none; /* ซ่อนคำแนะนำ */
    }
  </style>
</head>
<body>
  <div class="modal-content">
    <h1>ตรวจสอบตำแหน่งของคุณ</h1>
    <p>เราจะตรวจสอบตำแหน่งของคุณเพื่อเข้าถึงฟอร์ม</p>
    <button class="btn" onclick="getLocationPermission()">ตรวจสอบตำแหน่ง</button>
  </div>

  <div class="error-message" id="error-message"></div>
  <div class="recommendation" id="recommendation"></div>

  <script>
    // ฟังก์ชันที่ใช้ตรวจสอบว่าเบราว์เซอร์รองรับ Geolocation หรือไม่
    function isGeolocationAvailable() {
      return 'geolocation' in navigator;
    }

    // ฟังก์ชันที่ดึงตำแหน่งผู้ใช้
    function getLocationPermission() {
      if (!isGeolocationAvailable()) {
        displayErrorMessage("ไม่รองรับ Geolocation", "เบราว์เซอร์ของคุณไม่รองรับการใช้บริการตำแหน่ง กรุณาใช้เบราว์เซอร์ที่รองรับ");
        return;
      }

      // เรียกใช้ Geolocation API
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;

          // ตรวจสอบตำแหน่งที่ได้รับ
          if (lat !== null && lon !== null) {
            // ตรวจสอบว่าตำแหน่งที่ได้อยู่ในพื้นที่ที่อนุญาตหรือไม่
            if (isWithinAllowedArea(lat, lon)) {
              window.location.href = "https://www.google.com/maps?q=" + lat + "," + lon; // เปลี่ยนเส้นทางไปยัง Google Maps
            } else {
              displayErrorMessage("ตำแหน่งไม่อนุญาต", "ตำแหน่งของคุณอยู่นอกพื้นที่ที่อนุญาต");
            }
          } else {
            displayErrorMessage("ไม่พบตำแหน่ง", "ไม่สามารถหาตำแหน่งของคุณได้");
          }
        },
        function (error) {
          handleLocationError(error);
        },
        {
          enableHighAccuracy: true, // เพิ่มความแม่นยำในการหาตำแหน่ง
          timeout: 10000, // ตั้งเวลา Timeout
          maximumAge: 0, // ไม่เก็บข้อมูลตำแหน่งก่อนหน้า
        }
      );
    }

    // ฟังก์ชันตรวจสอบตำแหน่งที่ได้รับ (ปรับตามพื้นที่ที่ต้องการ)
    function isWithinAllowedArea(lat, lon) {
      const allowedLat = 7.0114380; // กำหนดละติจูดที่อนุญาต
      const allowedLon = 100.5026383; // กำหนดลองจิจูดที่อนุญาต
      const radius = 1; // กำหนดรัศมีเป็น 1 กิโลเมตร

      const distance = getDistanceFromLatLonInKm(lat, lon, allowedLat, allowedLon);
      return distance <= radius;
    }

    // ฟังก์ชันคำนวณระยะห่างระหว่างสองตำแหน่ง (ใช้ Haversine formula)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // รัศมีโลกในกิโลเมตร
      const dLat = (lat2 - lat1) * (Math.PI / 180);
      const dLon = (lon2 - lon1) * (Math.PI / 180);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c; // คำนวณระยะห่าง
      return distance;
    }

    // ฟังก์ชันแสดงข้อความข้อผิดพลาด
    function displayErrorMessage(title, message) {
      const errorMessageElement = document.getElementById('error-message');
      errorMessageElement.innerHTML = `<h2>${title}</h2><p>${message}</p>`;
      errorMessageElement.style.display = 'block'; // แสดงข้อความข้อผิดพลาด
    }

    // ฟังก์ชันแสดงคำแนะนำ
    function displayRecommendationMessage(message) {
      const recommendationElement = document.getElementById('recommendation');
      recommendationElement.innerHTML = `<p>${message}</p>`;
      recommendationElement.style.display = 'block'; // แสดงคำแนะนำ
    }

    // ฟังก์ชันจัดการข้อผิดพลาดในการเข้าถึงตำแหน่ง
    function handleLocationError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          displayErrorMessage("การปฏิเสธการอนุญาต", "คุณปฏิเสธการอนุญาตการเข้าถึงตำแหน่ง กรุณาเปิดการเข้าถึงตำแหน่งในเบราว์เซอร์ของคุณ");
          break;
        case error.POSITION_UNAVAILABLE:
          displayErrorMessage("ไม่สามารถหาตำแหน่งได้", "ไม่สามารถหาตำแหน่งของคุณได้");
          break;
        case error.TIMEOUT:
          displayErrorMessage("หมดเวลาการขอข้อมูลตำแหน่ง", "การขอข้อมูลตำแหน่งหมดเวลา");
          break;
        default:
          displayErrorMessage("ข้อผิดพลาดที่ไม่รู้จัก", "เกิดข้อผิดพลาดไม่รู้จักในการขอข้อมูลตำแหน่ง");
          break;
      }
    }
  </script>
</body>
</html>
