<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกทรานสคริปต์กิจกรรมนักศึกษา</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5c6bc0;
            --primary-dark: #26418f;
            --primary-light: #8e99f3;
            --accent-color: #ff7043;
            --accent-dark: #c63f17;
            --text-color: #37474f;
            --light-bg: #f5f7ff;
            --card-bg: #ffffff;
            --success-color: #66bb6a;
            --error-color: #ef5350;
            --border-radius: 12px;
            --box-shadow: 0 8px 20px rgba(92, 107, 192, 0.15);
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Prompt', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 40px;
        }
        
        h1, h2 {
            color: var(--primary-dark);
            text-align: center;
            margin-bottom: 25px;
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            position: relative;
            padding-bottom: 15px;
        }
        
        h1:after {
            content: '';
            position: absolute;
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 30px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
            background-color: #f9faff;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-light);
            transition: var(--transition);
        }
        
        .form-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(92, 107, 192, 0.1);
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 16px;
            color: var(--text-color);
            transition: var(--transition);
            background-color: white;
            font-family: 'Prompt', sans-serif;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* สไตล์ลูกศรสำหรับ select ใน iOS และ Android */
        select {
            background-image: linear-gradient(45deg, transparent 50%, var(--primary-color) 50%),
                              linear-gradient(135deg, var(--primary-color) 50%, transparent 50%);
            background-position: calc(100% - 20px) center, calc(100% - 15px) center;
            background-size: 5px 5px, 5px 5px;
            background-repeat: no-repeat;
            padding-right: 30px; /* ให้มีพื้นที่สำหรับลูกศร */
        }
        
        select:focus, input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.2);
        }
        
        /* แก้ไขปัญหาแถบเลือกใน Safari บน iOS */
        select::-ms-expand {
            display: none;
        }
        
        /* ปรับปรุงสไตล์สำหรับ date input บนมือถือ */
        input[type="date"] {
            min-height: 44px; /* ความสูงขั้นต่ำที่ดีสำหรับการแตะบนมือถือ */
        }
        
        button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            margin-top: 10px;
            transition: var(--transition);
            font-family: 'Prompt', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(92, 107, 192, 0.3);
        }
        
        #scannerArea {
            width: 100%;
            height: 300px;
            border: 3px dashed #c5cae9;
            border-radius: var(--border-radius);
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            background-color: #f0f2ff;
        }
        
        #scannerArea.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.2);
        }
        
        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: calc(var(--border-radius) - 3px);
        }
        
        #studentList {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        #studentList th, #studentList td {
            padding: 12px 15px;
            text-align: left;
        }
        
        #studentList th {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        #studentList td {
            background-color: white;
            border-bottom: 1px solid #e0e6ff;
        }
        
        #studentList tr:last-child td {
            border-bottom: none;
        }
        
        #studentList tr:nth-child(even) td {
            background-color: #f9faff;
        }
        
        #studentList tr:hover td {
            background-color: #eef1ff;
        }
        
        .notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid var(--success-color);
        }
        
        .error {
            background-color: #fbe9e7;
            color: #d32f2f;
            border-left: 4px solid var(--error-color);
        }
        
        .hidden {
            display: none;
        }
        
        /* Action Buttons */
        .action-button {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            width: auto;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 5px;
            transition: var(--transition);
        }
        
        .action-button:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .delete-button {
            background: transparent;
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }
        
        .delete-button:hover {
            background-color: var(--error-color);
            color: white;
            box-shadow: 0 4px 8px rgba(239, 83, 80, 0.3);
        }
        
        #exportBtn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            margin-top: 25px;
        }
        
        #exportBtn:hover {
            background: linear-gradient(135deg, var(--accent-dark), var(--accent-color));
            box-shadow: 0 5px 15px rgba(255, 112, 67, 0.3);
        }
        
        /* Scanner Controls */
        .scanner-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .scanner-controls button {
            flex: 1;
        }
        
        /* Scanner Info */
        .scanner-info {
            text-align: center;
            font-size: 14px;
            color: #9e9e9e;
            margin-top: 10px;
        }
        
        /* Section */
        .section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }
        
        /* Status Indicator */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-active {
            background-color: var(--success-color);
        }
        
        .status-inactive {
            background-color: #9e9e9e;
        }
        
        /* Counter */
        .counter {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(92, 107, 192, 0.2);
        }
        
        .counter-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .counter-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            #scannerArea {
                height: 250px;
            }
            
            #studentList th, #studentList td {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .form-group {
                padding: 10px;
            }
            
            /* ปรับปรุงแถบเลือกบนมือถือ */
            select, input {
                font-size: 16px; /* ป้องกัน iOS ซูมเมื่อโฟกัส */
                height: 44px; /* ความสูงที่เพียงพอสำหรับการแตะบนมือถือ */
            }
            
            /* เพิ่มขนาดพื้นที่แตะสำหรับปุ่มบนมือถือ */
            button {
                min-height: 44px;
                padding: 10px 15px;
            }
        }
        
        @media (max-width: 480px) {
            #scannerArea {
                height: 200px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .action-button {
                padding: 4px 8px;
                font-size: 12px;
                min-height: 34px; /* ปรับความสูงขั้นต่ำของปุ่มจัดการ */
            }
            
            /* ปรับปรุงตารางบนหน้าจอขนาดเล็ก */
            #studentList {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch; /* ทำให้การเลื่อนบนมือถือลื่นไหล */
            }
            
            /* ให้แน่ใจว่าผู้ใช้มือถือสามารถเลื่อนได้ */
            .section {
                overflow-x: hidden;
            }
        }
        
        /* ปรับแต่งสำหรับ iOS */
        @supports (-webkit-touch-callout: none) {
            /* สไตล์เฉพาะสำหรับ iOS */
            input, select, button {
                /* ป้องกันการเปลี่ยนสีเป็นสีเทาเมื่อแตะ */
                -webkit-tap-highlight-color: transparent;
            }
            
            /* คืนค่าการปรับแต่งอัตโนมัติของ date picker บน iOS */
            input[type="date"] {
                line-height: normal !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ระบบบันทึกทรานสคริปต์กิจกรรมนักศึกษา</h1>
        
        <div class="section">
            <div class="counter">
                <div class="counter-value" id="studentCounter">0</div>
                <div class="counter-label">นักศึกษาที่ลงทะเบียน</div>
            </div>
            
            <div class="form-group">
                <label for="eventSelect">เลือกกิจกรรม:</label>
                <select id="eventSelect">
                    <option value="">-- เลือกกิจกรรม --</option>
                    <option value="orientation">ปฐมนิเทศนักศึกษาใหม่</option>
                    <option value="sport">กีฬาสีประจำปี</option>
                    <option value="volunteer">กิจกรรมจิตอาสา</option>
                    <option value="seminar">สัมมนาวิชาการ</option>
                    <option value="cultural">กิจกรรมวัฒนธรรม</option>
                    <option value="leadership">กิจกรรมพัฒนาผู้นำ</option>
                    <option value="career">กิจกรรมเตรียมความพร้อมสู่อาชีพ</option>
                    <option value="other">อื่นๆ</option>
                </select>
            </div>
            
            <div id="otherEventDiv" class="form-group hidden">
                <label for="otherEventName">ระบุชื่อกิจกรรม:</label>
                <input type="text" id="otherEventName" placeholder="ชื่อกิจกรรม">
            </div>
            
            <div class="form-group">
                <label for="eventHours">จำนวนชั่วโมงกิจกรรม:</label>
                <input type="number" id="eventHours" min="1" max="100" value="2">
            </div>
            
            <div class="form-group">
                <label for="eventDate">วันที่จัดกิจกรรม:</label>
                <input type="date" id="eventDate">
            </div>
        </div>
        
        <h2>สแกนบาร์โค้ดรหัสนักศึกษา</h2>
        
        <div class="section">
            <div id="scannerArea">
                <video id="scannerVideo" autoplay></video>
                <div id="focusIndicator"></div>
                <div id="objectDetectionArea"></div>
                <div id="objectIndicator">กำลังตรวจจับวัตถุ...</div>
            </div>
            
            <div class="scanner-controls">
                <button id="startScanBtn">
                    <span class="status-indicator status-inactive"></span> เริ่มการสแกน
                </button>
                <button id="stopScanBtn" class="hidden">
                    <span class="status-indicator status-active"></span> หยุดการสแกน
                </button>
            </div>
            
            <div class="scanner-info" id="scannerInfo">
                กดปุ่ม "เริ่มการสแกน" เพื่อใช้กล้องสแกนบาร์โค้ดรหัสนักศึกษา
            </div>
            
            <div id="notification" class="notification hidden"></div>
            
            <div id="manualEntryDiv" class="form-group">
                <label for="manualStudentId">หรือกรอกรหัสนักศึกษาด้วยตนเอง:</label>
                <input type="text" id="manualStudentId" placeholder="กรอกรหัสนักศึกษา 10 หลัก">
                <button id="addManualBtn">เพิ่มนักศึกษา</button>
            </div>
        </div>
        
        <h2>รายชื่อนักศึกษาที่เข้าร่วมกิจกรรม</h2>
        
        <div class="section">
            <table id="studentList">
                <thead>
                    <tr>
                        <th>ลำดับ</th>
                        <th>รหัสนักศึกษา</th>
                        <th>เวลาลงทะเบียน</th>
                        <th>จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                </tbody>
            </table>
            
            <button id="exportBtn">ส่งออกข้อมูล (CSV)</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const eventSelect = document.getElementById('eventSelect');
            const otherEventDiv = document.getElementById('otherEventDiv');
            const otherEventName = document.getElementById('otherEventName');
            const eventHours = document.getElementById('eventHours');
            const eventDate = document.getElementById('eventDate');
            const scannerArea = document.getElementById('scannerArea');
            const scannerVideo = document.getElementById('scannerVideo');
            const startScanBtn = document.getElementById('startScanBtn');
            const stopScanBtn = document.getElementById('stopScanBtn');
            const notification = document.getElementById('notification');
            const manualStudentId = document.getElementById('manualStudentId');
            const addManualBtn = document.getElementById('addManualBtn');
            const studentListBody = document.getElementById('studentList').querySelector('tbody');
            const exportBtn = document.getElementById('exportBtn');
            const studentCounter = document.getElementById('studentCounter');
            const scannerInfo = document.getElementById('scannerInfo');
            const focusIndicator = document.getElementById('focusIndicator');
            const objectDetectionArea = document.getElementById('objectDetectionArea');
            const objectIndicator = document.getElementById('objectIndicator');
            
            // ตัวแปรสำหรับการตรวจจับวัตถุและโฟกัส
            let objectDetectionInterval = null;
            let lastMotionTime = 0;
            let previousFrame = null;
            let motionDetected = false;
            let canvasContext = null;
            let motionCanvas = document.createElement('canvas');
            let motionCanvasContext = motionCanvas.getContext('2d', { willReadFrequently: true });
            
            // สร้าง hammer instance สำหรับการจัดการ touch events
            const scannerHammer = new Hammer(scannerArea);
            
            // Set today's date as default
            const today = new Date();
            eventDate.value = today.toISOString().split('T')[0];
            
            // Data storage
            let students = [];
            let scanning = false;
            
            // Event listeners
            eventSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    otherEventDiv.classList.remove('hidden');
                } else {
                    otherEventDiv.classList.add('hidden');
                }
            });
            
            startScanBtn.addEventListener('click', startScanner);
            stopScanBtn.addEventListener('click', stopScanner);
            addManualBtn.addEventListener('click', addManualStudent);
            exportBtn.addEventListener('click', exportData);
            
            // เพิ่ม event สำหรับการแตะที่พื้นที่สแกนเพื่อเริ่มสแกน
            scannerHammer.on('tap', function(e) {
                if (!scanning) {
                    startScanner();
                } else {
                    // หากกำลังสแกนอยู่ ให้พยายามโฟกัสใหม่
                    manualFocus();
                    
                    // หากแตะที่มุมขวาบนของพื้นที่สแกน ให้หยุดสแกน
                    const rect = scannerArea.getBoundingClientRect();
                    const x = e.center.x - rect.left;
                    const y = e.center.y - rect.top;
                    
                    if (x > rect.width * 0.8 && y < rect.height * 0.2) {
                        stopScanner();
                    }
                }
            });
            
            // ทำให้ form input ทำงานได้ดีบนมือถือ
            // ป้องกันปัญหา zoom เมื่อกดที่ input
            document.querySelectorAll('input, select').forEach(function(element) {
                element.addEventListener('touchstart', function(e) {
                    // ป้องกัน iOS double-tap zoom
                    e.target.focus();
                });
            });
            
            // เพิ่ม event listener สำหรับการกด Enter ใน manual input
            manualStudentId.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addManualStudent();
                    e.preventDefault(); // ป้องกันการ submit form
                }
            });
            
            // เพิ่ม event listener สำหรับการแตะที่ scannerArea เพื่อบังคับโฟกัส
            scannerArea.addEventListener('click', function() {
                if (scanning) {
                    manualFocus();
                }
            });
            
            // ฟังก์ชันสำหรับการบังคับโฟกัสกล้อง
            function manualFocus() {
                if (!scanning) return;
                
                const videoTrack = scannerVideo.srcObject?.getVideoTracks()[0];
                if (videoTrack) {
                    try {
                        // แสดงตัวบ่งชี้การโฟกัส
                        focusIndicator.classList.add('focusing');
                        
                        const capabilities = videoTrack.getCapabilities();
                        if (capabilities.focusMode) {
                            videoTrack.applyConstraints({
                                advanced: [{ focusMode: 'continuous' }]
                            })
                            .then(() => {
                                console.log('Camera refocused');
                                // ซ่อนตัวบ่งชี้หลังจาก 1.5 วินาที
                                setTimeout(() => {
                                    focusIndicator.classList.remove('focusing');
                                }, 1500);
                            })
                            .catch(e => {
                                console.log('Could not refocus camera:', e);
                                focusIndicator.classList.remove('focusing');
                            });
                        } else {
                            console.log('Focus mode not supported');
                            focusIndicator.classList.remove('focusing');
                        }
                    } catch (e) {
                        console.log('Error while trying to refocus:', e);
                        focusIndicator.classList.remove('focusing');
                    }
                }
            }
            
            // Functions
            function startScanner() {
                if (!validateEventSelection()) return;
                
                // ตรวจสอบว่าเป็นอุปกรณ์มือถือหรือไม่
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                scanning = true;
                startScanBtn.classList.add('hidden');
                stopScanBtn.classList.remove('hidden');
                scannerArea.classList.add('active');
                scannerInfo.textContent = isMobile ? 
                    'กำลังสแกน... ถือให้นิ่งและนำบาร์โค้ดมาอยู่ในพื้นที่สแกน' : 
                    'กำลังสแกน... นำบาร์โค้ดให้อยู่ในพื้นที่สแกนเพื่อบันทึกรหัสนักศึกษา';
                
                // เตรียมพร้อมสำหรับการตรวจจับวัตถุ
                objectDetectionArea.classList.remove('active');
                
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    // กำหนดค่าพารามิเตอร์สำหรับกล้อง
                    const videoConstraints = {
                        facingMode: "environment", // ใช้กล้องหลัง
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        // เพิ่มการตั้งค่าโฟกัสอัตโนมัติ
                        advanced: [
                            {
                                focusMode: "continuous", // โฟกัสอัตโนมัติแบบต่อเนื่อง
                                zoom: 0 // ไม่ซูม
                            }
                        ]
                    };
                    
                    navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: false })
                        .then(function(stream) {
                            scannerVideo.srcObject = stream;
                            scannerVideo.setAttribute("playsinline", true);
                            scannerVideo.setAttribute("autoplay", true);
                            
                            // ตรวจสอบข้อมูล track ของกล้อง
                            const videoTrack = stream.getVideoTracks()[0];
                            if (videoTrack) {
                                try {
                                    const capabilities = videoTrack.getCapabilities();
                                    
                                    // ตรวจสอบว่ากล้องรองรับการโฟกัสอัตโนมัติหรือไม่
                                    if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                                        const settings = { focusMode: 'continuous' };
                                        videoTrack.applyConstraints({ advanced: [settings] })
                                            .then(() => console.log('Auto focus enabled'))
                                            .catch(e => console.log('Could not enable auto focus:', e));
                                    } else {
                                        console.log('Auto focus not supported by this device');
                                    }
                                } catch (e) {
                                    console.log('Cannot access camera capabilities:', e);
                                }
                            }
                            
                            // เริ่มการตรวจจับวัตถุเมื่อวิดีโอพร้อม
                            scannerVideo.onloadedmetadata = function() {
                                // ตั้งค่าขนาด canvas สำหรับตรวจจับการเคลื่อนไหว
                                motionCanvas.width = scannerVideo.videoWidth / 4; // ลดขนาดเพื่อประสิทธิภาพ
                                motionCanvas.height = scannerVideo.videoHeight / 4;
                                startObjectDetection();
                            };
                            
                            Quagga.init({
                                inputStream: {
                                    name: "Live",
                                    type: "LiveStream",
                                    target: scannerVideo,
                                    constraints: {
                                        width: 800,
                                        height: 600,
                                    }
                                },
                                decoder: {
                                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
                                }
                            }, function(err) {
                                if (err) {
                                    showNotification('ไม่สามารถเริ่มการสแกนได้: ' + err, 'error');
                                    stopScanner();
                                    return;
                                }
                                
                                Quagga.start();
                                
                                Quagga.onDetected(function(result) {
                                    const code = result.codeResult.code;
                                    processStudentId(code);
                                });
                            });
                        })
                        .catch(function(error) {
                            showNotification('ไม่สามารถเข้าถึงกล้องได้: ' + error.message, 'error');
                            stopScanner();
                        });
                } else {
                    showNotification('เบราวเซอร์ของคุณไม่รองรับการเข้าถึงกล้อง', 'error');
                    stopScanner();
                }
            }
            
            function stopScanner() {
                if (scanning) {
                    Quagga.stop();
                    
                    // หยุดการตรวจจับวัตถุ
                    stopObjectDetection();
                    
                    // Stop the camera
                    if (scannerVideo.srcObject) {
                        const tracks = scannerVideo.srcObject.getTracks();
                        tracks.forEach(track => track.stop());
                        scannerVideo.srcObject = null;
                    }
                    
                    scanning = false;
                    startScanBtn.classList.remove('hidden');
                    stopScanBtn.classList.add('hidden');
                    scannerArea.classList.remove('active');
                    objectDetectionArea.classList.remove('active');
                    objectIndicator.classList.remove('show');
                    scannerInfo.textContent = 'กดปุ่ม "เริ่มการสแกน" เพื่อใช้กล้องสแกนบาร์โค้ดรหัสนักศึกษา';
                }
            }
            
            // ฟังก์ชันสำหรับการตรวจจับวัตถุที่เคลื่อนไหว
            function startObjectDetection() {
                if (!scanning) return;
                
                // เริ่มการตรวจจับทุก 100ms
                objectDetectionInterval = setInterval(() => {
                    detectObjectMotion();
                }, 100);
            }
            
            function stopObjectDetection() {
                if (objectDetectionInterval) {
                    clearInterval(objectDetectionInterval);
                    objectDetectionInterval = null;
                }
                
                previousFrame = null;
                motionDetected = false;
            }
            
            function detectObjectMotion() {
                if (!scanning || !scannerVideo.srcObject) return;
                
                try {
                    // วาดเฟรมปัจจุบันลงใน canvas
                    motionCanvasContext.drawImage(
                        scannerVideo, 
                        0, 0, 
                        scannerVideo.videoWidth, 
                        scannerVideo.videoHeight,
                        0, 0,
                        motionCanvas.width, 
                        motionCanvas.height
                    );
                    
                    // ดึงข้อมูลภาพจาก canvas
                    const currentFrame = motionCanvasContext.getImageData(
                        0, 0, 
                        motionCanvas.width, 
                        motionCanvas.height
                    );
                    
                    // หากไม่มีเฟรมก่อนหน้า ให้บันทึกเฟรมปัจจุบันและกลับ
                    if (!previousFrame) {
                        previousFrame = currentFrame;
                        return;
                    }
                    
                    // ตรวจสอบการเปลี่ยนแปลงระหว่างเฟรม
                    const changedPixels = calculateMotion(previousFrame.data, currentFrame.data);
                    const motionThreshold = (motionCanvas.width * motionCanvas.height) * 0.01; // 1% ของพิกเซลทั้งหมด
                    
                    // ถ้ามีการเปลี่ยนแปลงมากกว่าเกณฑ์ แสดงว่ามีวัตถุเคลื่อนไหว
                    if (changedPixels > motionThreshold) {
                        if (!motionDetected) {
                            console.log('Object motion detected');
                            motionDetected = true;
                            objectDetectionArea.classList.add('active');
                            objectIndicator.textContent = 'ตรวจพบวัตถุ - กำลังโฟกัส';
                            objectIndicator.classList.add('show');
                            
                            // เรียกการโฟกัสอัตโนมัติ
                            manualFocus();
                            
                            // บันทึกเวลาที่ตรวจพบการเคลื่อนไหวล่าสุด
                            lastMotionTime = Date.now();
                        } else {
                            // อัปเดตเวลาที่ตรวจพบการเคลื่อนไหวล่าสุด
                            lastMotionTime = Date.now();
                        }
                    } else {
                        // ตรวจสอบว่าไม่มีการเคลื่อนไหวเกินกว่า 2 วินาที
                        if (motionDetected && (Date.now() - lastMotionTime > 2000)) {
                            motionDetected = false;
                            objectDetectionArea.classList.remove('active');
                            objectIndicator.classList.remove('show');
                        }
                    }
                    
                    // บันทึกเฟรมปัจจุบันเป็นเฟรมก่อนหน้า
                    previousFrame = currentFrame;
                    
                } catch (error) {
                    console.error('Error in motion detection:', error);
                }
            }
            
            // คำนวณความแตกต่างระหว่างเฟรม
            function calculateMotion(previous, current) {
                let changedPixels = 0;
                const sensitivity = 30; // ความไวในการตรวจจับการเปลี่ยนแปลง (0-255)
                
                // ตรวจสอบทุกๆ พิกเซล (จริงๆ คือทุก 4 ค่าเพราะเป็น RGBA)
                for (let i = 0; i < previous.length; i += 4) {
                    // คำนวณความแตกต่างของแต่ละช่องสี
                    const rdiff = Math.abs(previous[i] - current[i]);
                    const gdiff = Math.abs(previous[i+1] - current[i+1]);
                    const bdiff = Math.abs(previous[i+2] - current[i+2]);
                    
                    // หากมีความแตกต่างเกินค่าความไว ถือว่าพิกเซลนี้มีการเปลี่ยนแปลง
                    if (rdiff > sensitivity || gdiff > sensitivity || bdiff > sensitivity) {
                        changedPixels++;
                    }
                }
                
                return changedPixels;
            }
            
            function addManualStudent() {
                if (!validateEventSelection()) return;
                
                const studentId = manualStudentId.value.trim();
                
                if (studentId.length !== 10 || isNaN(studentId)) {
                    showNotification('รหัสนักศึกษาต้องเป็นตัวเลข 10 หลัก', 'error');
                    return;
                }
                
                processStudentId(studentId);
                manualStudentId.value = '';
            }
            
            function processStudentId(studentId) {
                // Validate student ID format (assuming 10 digits)
                if (studentId.length !== 10 || isNaN(studentId)) {
                    showNotification('รหัสนักศึกษาไม่ถูกต้อง: ' + studentId, 'error');
                    return;
                }
                
                // Check if student already registered
                const existingStudent = students.find(s => s.id === studentId);
                if (existingStudent) {
                    showNotification('นักศึกษารหัส ' + studentId + ' ได้ลงทะเบียนแล้ว', 'error');
                    return;
                }
                
                // Add student to the list
                const timestamp = new Date().toLocaleString('th-TH');
                students.push({ 
                    id: studentId, 
                    timestamp: timestamp 
                });
                
                // Update the table
                updateStudentTable();
                updateStudentCounter();
                
                showNotification('บันทึกนักศึกษารหัส ' + studentId + ' เรียบร้อยแล้ว', 'success');
            }
            
            function updateStudentTable() {
                // Clear the table
                studentListBody.innerHTML = '';
                
                // Add each student to the table
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    
                    const numberCell = document.createElement('td');
                    numberCell.textContent = index + 1;
                    
                    const idCell = document.createElement('td');
                    idCell.textContent = student.id;
                    
                    const timestampCell = document.createElement('td');
                    timestampCell.textContent = student.timestamp;
                    
                    const actionCell = document.createElement('td');
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'ลบ';
                    deleteBtn.classList.add('action-button', 'delete-button');
                    deleteBtn.onclick = function() {
                        students.splice(index, 1);
                        updateStudentTable();
                        updateStudentCounter();
                        showNotification('ลบนักศึกษารหัส ' + student.id + ' เรียบร้อยแล้ว', 'success');
                    };
                    actionCell.appendChild(deleteBtn);
                    
                    row.appendChild(numberCell);
                    row.appendChild(idCell);
                    row.appendChild(timestampCell);
                    row.appendChild(actionCell);
                    
                    studentListBody.appendChild(row);
                });
            }
            
            function updateStudentCounter() {
                studentCounter.textContent = students.length;
            }
            
            function exportData() {
                if (!validateEventSelection()) return;
                if (students.length === 0) {
                    showNotification('ไม่มีข้อมูลนักศึกษาที่จะส่งออก', 'error');
                    return;
                }
                
                // Get event details
                const eventName = eventSelect.value === 'other' ? otherEventName.value : eventSelect.options[eventSelect.selectedIndex].text;
                const hours = eventHours.value;
                const date = eventDate.value;
                
                // Create CSV content with UTF-8 BOM to ensure proper Thai character encoding
                const BOM = "\uFEFF"; // UTF-8 BOM
                let csv = BOM + 'รหัสนักศึกษา,กิจกรรม,วันที่,ชั่วโมง,เวลาลงทะเบียน\n';
                
                students.forEach(student => {
                    // ใส่ double quotes รอบทุกฟิลด์เพื่อป้องกันปัญหาการแยกคอลัมน์
                    // และ escape double quotes ที่มีอยู่ในข้อความโดยการซ้ำ
                    const safeEventName = eventName.replace(/"/g, '""');
                    const safeTimestamp = student.timestamp.replace(/"/g, '""');
                    csv += `"${student.id}","${safeEventName}","${date}","${hours}","${safeTimestamp}"\n`;
                });
                
                try {
                    // Create safe filename by removing special characters
                    const safeEventName = eventName.replace(/[^\u0E00-\u0E7Fa-zA-Z0-9]/g, '_');
                    const safeFileName = `บันทึกกิจกรรม_${safeEventName}_${date}.csv`;
                    
                    // Create and trigger download
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', safeFileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Revoke the URL to free up memory
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showNotification('ส่งออกข้อมูลเรียบร้อยแล้ว', 'success');
                } catch (error) {
                    console.error('Error exporting data:', error);
                    showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
                }
            }
            
            function validateEventSelection() {
                if (!eventSelect.value) {
                    showNotification('กรุณาเลือกกิจกรรม', 'error');
                    return false;
                }
                
                if (eventSelect.value === 'other' && !otherEventName.value.trim()) {
                    showNotification('กรุณาระบุชื่อกิจกรรม', 'error');
                    return false;
                }
                
                if (!eventDate.value) {
                    showNotification('กรุณาระบุวันที่จัดกิจกรรม', 'error');
                    return false;
                }
                
                return true;
            }
            
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.remove('hidden');
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.classList.add('hidden');
                    }, 300);
                }, 3000);
            }
        });
    </script>
</body>
</html>
