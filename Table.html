<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ - PSU SIS (Fixed)</title>
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .font-thai { font-family: 'Prompt', sans-serif; }
        .schedule-container { min-width: 800px; }
        .course-block { min-height: 50px; }
        
        /* Modern Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced Gradients */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* Advanced Shadows */
        .shadow-glow {
            box-shadow: 0 0 40px rgba(103, 126, 234, 0.3);
        }
        
        .shadow-float {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(240, 240, 240, 0.4) 25%, 
                rgba(255, 255, 255, 0.6) 50%, 
                rgba(240, 240, 240, 0.4) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Hover Animations */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .schedule-container { min-width: 600px; }
            .course-block { font-size: 10px; min-height: 40px; }
        }
        
        /* Neon glow effect */
        .neon-blue {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .neon-green {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        .neon-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        .neon-purple {
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .status-connected {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .status-disconnected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .status-offline {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
        }
    </style>
</head>
<body class="min-h-screen font-thai gradient-primary">
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div class="font-bold mb-2">üîß Debug Information</div>
        <div id="debugInfo">
            <div>Status: <span id="debugStatus">Initializing...</span></div>
            <div>API URL: <span id="debugApiUrl">Not set</span></div>
            <div>Last Error: <span id="debugLastError">None</span></div>
            <div>Mode: <span id="debugMode">Online</span></div>
        </div>
        <button onclick="toggleOfflineMode()" class="mt-2 bg-blue-500 text-white px-2 py-1 rounded text-xs">
            Toggle Offline Mode
        </button>
    </div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status px-4 py-2 rounded-xl text-xs font-semibold status-disconnected hidden">
        <i class="fas fa-wifi mr-2"></i>
        <span id="connectionText">Checking connection...</span>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            <p class="text-white text-sm opacity-80" id="loadingMessage">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>
    </div>
    
    <div class="min-h-screen relative overflow-hidden">
        <!-- Animated Background -->
        <div class="absolute inset-0 opacity-30">
            <div class="absolute top-20 left-20 w-72 h-72 bg-white rounded-full mix-blend-multiply filter blur-xl animate-blob"></div>
            <div class="absolute top-40 right-20 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-8 left-40 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-4000"></div>
        </div>
        
        <div class="container mx-auto p-2 sm:p-6 max-w-7xl relative z-10">
            <!-- Header -->
            <div class="glass rounded-3xl shadow-float mb-6 p-6 hover-lift">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white drop-shadow-lg">
                        <i class="fas fa-graduation-cap text-yellow-300 mr-3"></i>
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        <span class="text-sm font-normal opacity-70 ml-2">v2.1.0 (Fixed)</span>
                    </h1>
                    <div class="flex items-center gap-4">
                        <div class="text-right text-sm text-white">
                            <div class="font-bold glass px-6 py-3 rounded-2xl backdrop-blur-sm border border-white border-opacity-20">
                                <i class="fas fa-user-graduate mr-2"></i>
                                <span id="studentInfo">‡∏ß‡∏µ‡∏£‡∏¢‡∏∏‡∏ó‡∏ò ‡πÅ‡∏Å‡πâ‡∏ß‡∏Ç‡∏≥ (6710210317)</span>
                            </div>
                            <div class="mt-2 text-white text-opacity-90 text-xs">
                                <i class="fas fa-university mr-2"></i>
                                ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ
                            </div>
                        </div>
                        <button onclick="toggleDebugPanel()" class="text-xs glass text-white px-4 py-2 rounded-xl hover:scale-105 transition-all">
                            <i class="fas fa-bug mr-2"></i>Debug
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
                <!-- Sidebar -->
                <div class="xl:col-span-1">
                    <div class="glass rounded-3xl shadow-float p-6 hover-lift">
                        <!-- Search Section -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                                <div class="w-10 h-10 gradient-success rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-search text-white"></i>
                                </div>
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
                            </h3>
                            <div class="relative mb-4">
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤..."
                                    class="w-full px-4 py-3 pl-12 glass-dark text-white placeholder-white placeholder-opacity-70 rounded-2xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-30 transition-all"
                                    maxlength="100"
                                >
                                <i class="fas fa-search absolute left-4 top-3.5 text-white text-opacity-70"></i>
                            </div>
                            
                            <!-- Filter Buttons -->
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <button class="filter-btn gradient-primary text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105 neon-blue" data-filter="all">
                                    <i class="fas fa-list mr-1"></i>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                                <button class="filter-btn glass-dark text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105" data-filter="required">
                                    <i class="fas fa-star mr-1"></i>‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
                                </button>
                                <button class="filter-btn glass-dark text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105" data-filter="elective">
                                    <i class="fas fa-check-circle mr-1"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                                </button>
                                <button class="filter-btn glass-dark text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105" data-filter="general">
                                    <i class="fas fa-book mr-1"></i>‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                                </button>
                            </div>
                        </div>

                        <!-- Course List -->
                        <div class="max-h-60 sm:max-h-96 overflow-y-auto space-y-3 custom-scroll" id="courseList">
                            <!-- Default skeleton while loading -->
                            <div id="courseListSkeleton">
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Area -->
                <div class="xl:col-span-3">
                    <div class="glass rounded-3xl shadow-float p-6 hover-lift">
                        <!-- Schedule Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <div class="w-12 h-12 gradient-secondary rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-calendar-alt text-white text-lg"></i>
                                </div>
                                ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </h2>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
                                <!-- Export Buttons -->
                                <div class="flex gap-2">
                                    <button onclick="exportPNG()" class="gradient-success text-white px-4 py-2 rounded-xl text-xs hover:scale-105 transition-all neon-green">
                                        <i class="fas fa-image mr-1"></i>PNG
                                    </button>
                                    <button onclick="exportPDF()" class="gradient-secondary text-white px-4 py-2 rounded-xl text-xs hover:scale-105 transition-all neon-red">
                                        <i class="fas fa-file-pdf mr-1"></i>PDF
                                    </button>
                                </div>
                                
                                <!-- View Toggle -->
                                <div class="flex glass-dark rounded-xl p-1">
                                    <button id="tableViewBtn" class="px-3 py-2 rounded-lg gradient-primary text-white transition-all text-xs neon-blue">
                                        <i class="fas fa-table mr-1"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                    </button>
                                    <button id="listViewBtn" class="px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-all text-xs">
                                        <i class="fas fa-list-ul mr-1"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                    </button>
                                </div>
                                
                                <select id="semesterSelect" class="px-4 py-2 glass-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-30 text-xs">
                                    <option value="2567/1">‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà 1/2567</option>
                                    <option value="2567/2">‡∏†‡∏≤‡∏Ñ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà 2/2567</option>
                                </select>
                            </div>
                        </div>

                        <!-- Table View -->
                        <div id="tableView" class="overflow-x-auto">
                            <!-- Skeleton Loading for Table -->
                            <div id="tableSkeleton" class="schedule-container space-y-2">
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                            </div>
                            
                            <div class="schedule-container hidden" id="scheduleContainer">
                                <table class="w-full border-collapse glass rounded-2xl overflow-hidden shadow-glow">
                                    <thead>
                                        <tr class="gradient-primary">
                                            <th class="border border-white border-opacity-20 p-3 text-center font-bold text-white text-sm w-24">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">08:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">09:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">10:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">11:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">12:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">13:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">14:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">15:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">16:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">17:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">18:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">19:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">20:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">21:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">22:00</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody">
                                        <!-- Schedule will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- List View -->
                        <div id="listView" class="hidden space-y-4">
                            <div id="courseListView">
                                <!-- List view will be generated here -->
                            </div>
                        </div>

                        <!-- Stats Panel -->
                        <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <!-- Stats Skeleton -->
                            <div id="statsSkeleton" class="contents">
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                            </div>
                            
                            <!-- Actual Stats -->
                            <div id="statsContent" class="contents hidden">
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-blue">
                                    <div class="text-2xl font-bold text-white" id="totalCredits">0</div>
                                    <div class="text-xs text-white text-opacity-80 mt-1">
                                        <i class="fas fa-coins mr-1"></i>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡∏£‡∏ß‡∏°
                                    </div>
                                </div>
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-green">
                                    <div class="text-2xl font-bold text-white" id="totalCourses">0</div>
                                    <div class="text-xs text-white text-opacity-80 mt-1">
                                        <i class="fas fa-book-open mr-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤
                                    </div>
                                </div>
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-red">
                                    <div class="text-2xl font-bold text-white" id="conflictCount">0</div>
                                    <div class="text-xs text-white text-opacity-80 mt-1">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á
                                    </div>
                                </div>
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-purple">
                                    <button 
                                        onclick="exportSchedule()" 
                                        class="gradient-primary text-white px-4 py-2 rounded-xl font-medium hover:scale-105 transition-all text-xs w-full"
                                    >
                                        <i class="fas fa-download mr-1"></i>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Configuration =====
        const CONFIG = {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó URL ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Google Apps Script Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            GAS_URL: 'https://script.google.com/macros/s/AKfycbwjbNn4Gxx488J2SblaAEYADcVOlPCjpetpztq97sWt5CqELjdWgY13cWQTd1XWkI_7/exec',
            TIMEOUT: 30000,
            RETRY_COUNT: 3,
            RETRY_DELAY: 1000,
            DEBUG_MODE: true
        };

        // ===== Global State =====
        const AppState = {
            isOnline: true,
            isOfflineMode: false,
            connectionStatus: 'checking',
            lastError: null,
            coursesDatabase: [],
            selectedCourses: [],
            currentView: 'table',
            debugInfo: {
                apiCalls: 0,
                errors: 0,
                lastApiCall: null
            }
        };

        // ===== Sample Data for Offline Mode =====
        const SAMPLE_COURSES = [
            {
                code: '344-201',
                name: '‡∏ä‡∏∏‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                credits: 6,
                type: 'required',
                schedule: {
                    day: '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',
                    startTime: '09:00',
                    endTime: '12:00',
                    room: 'NML1'
                }
            },
            {
                code: '344-221',
                name: '‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                credits: 2,
                type: 'required',
                schedule: {
                    day: '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£',
                    startTime: '10:00',
                    endTime: '12:00',
                    room: 'BSc0603'
                }
            },
            {
                code: '344-222',
                name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£',
                credits: 2,
                type: 'required',
                schedule: {
                    day: '‡∏û‡∏∏‡∏ò',
                    startTime: '13:00',
                    endTime: '15:00',
                    room: 'BSc0603'
                }
            },
            {
                code: '344-223',
                name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå',
                credits: 2,
                type: 'required',
                schedule: {
                    day: '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ',
                    startTime: '14:00',
                    endTime: '16:00',
                    room: 'BSc0603'
                }
            },
            {
                code: '315-201',
                name: '‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï',
                credits: 2,
                type: 'general',
                schedule: {
                    day: '‡∏®‡∏∏‡∏Å‡∏£‡πå',
                    startTime: '09:00',
                    endTime: '11:00',
                    room: 'NML1'
                }
            },
            {
                code: '322-102',
                name: 'CALCULUS II',
                credits: 3,
                type: 'required',
                schedule: {
                    day: '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£',
                    startTime: '09:00',
                    endTime: '12:00',
                    room: 'NML1'
                }
            },
            {
                code: '344-111',
                name: 'MODULE: PROGRAMMING CONCEPTS A',
                credits: 3,
                type: 'required',
                schedule: {
                    day: '‡∏û‡∏∏‡∏ò',
                    startTime: '10:00',
                    endTime: '13:00',
                    room: 'BSc0603(LAB)'
                }
            },
            {
                code: '460-001',
                name: 'ONLINE COURSE',
                credits: 2,
                type: 'elective',
                schedule: {
                    day: 'ONLINE',
                    startTime: 'FLEXIBLE',
                    endTime: 'FLEXIBLE',
                    room: 'ONLINE'
                }
            }
        ];

        // ===== Utility Functions =====
        function debugLog(message, data = null) {
            if (CONFIG.DEBUG_MODE) {
                console.log(`üîß [DEBUG] ${message}`, data || '');
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            const debugStatus = document.getElementById('debugStatus');
            const debugApiUrl = document.getElementById('debugApiUrl');
            const debugLastError = document.getElementById('debugLastError');
            const debugMode = document.getElementById('debugMode');
            
            if (debugStatus) debugStatus.textContent = AppState.connectionStatus;
            if (debugApiUrl) debugApiUrl.textContent = CONFIG.GAS_URL ? 'Set' : 'Not set';
            if (debugLastError) debugLastError.textContent = AppState.lastError || 'None';
            if (debugMode) debugMode.textContent = AppState.isOfflineMode ? 'Offline' : 'Online';
        }

        function showLoadingOverlay(show, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            
            if (show) {
                messageEl.textContent = message;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function updateConnectionStatus(status, message = '') {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            AppState.connectionStatus = status;
            
            statusEl.classList.remove('status-connected', 'status-disconnected', 'status-offline', 'hidden');
            
            switch (status) {
                case 'connected':
                    statusEl.classList.add('status-connected');
                    textEl.innerHTML = '<i class="fas fa-check mr-2"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                    break;
                case 'disconnected':
                    statusEl.classList.add('status-disconnected');
                    textEl.innerHTML = '<i class="fas fa-times mr-2"></i>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    break;
                case 'offline':
                    statusEl.classList.add('status-offline');
                    textEl.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
                    break;
                case 'checking':
                    statusEl.classList.add('status-disconnected');
                    textEl.innerHTML = '<i class="fas fa-sync fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
                    break;
            }
            
            if (message) {
                textEl.innerHTML += ` - ${message}`;
            }
            
            updateDebugInfo();
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 glass rounded-2xl p-6 shadow-glow transition-all transform translate-x-full max-w-md`;
            
            const colors = {
                success: 'border-l-4 border-green-400 neon-green',
                error: 'border-l-4 border-red-400 neon-red',
                warning: 'border-l-4 border-yellow-400',
                info: 'border-l-4 border-blue-400 neon-blue'
            };
            
            const icons = {
                success: 'fa-check-circle text-green-400',
                error: 'fa-exclamation-circle text-red-400',
                warning: 'fa-exclamation-triangle text-yellow-400',
                info: 'fa-info-circle text-blue-400'
            };
            
            notification.innerHTML = `
                <div class="flex items-start ${colors[type]}">
                    <div class="flex-shrink-0">
                        <i class="fas ${icons[type]} text-2xl mr-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-white font-semibold mb-1">
                            ${type === 'success' ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 
                              type === 'error' ? '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' :
                              type === 'warning' ? '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'}
                        </div>
                        <div class="text-white text-opacity-90 text-sm">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white text-opacity-60 hover:text-white ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // ===== API Functions =====
        async function callGoogleScript(functionName, parameters = {}, retryCount = 0) {
            try {
                debugLog(`API Call: ${functionName}`, parameters);
                AppState.debugInfo.apiCalls++;
                AppState.debugInfo.lastApiCall = new Date().toISOString();
                
                if (AppState.isOfflineMode) {
                    throw new Error('Offline mode enabled');
                }

                if (!CONFIG.GAS_URL) {
                    throw new Error('GAS_URL not configured');
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        function: functionName,
                        parameters: parameters
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                updateConnectionStatus('connected');
                AppState.lastError = null;
                
                debugLog(`API Success: ${functionName}`, result);
                return result;

            } catch (error) {
                debugLog(`API Error: ${functionName}`, error);
                AppState.debugInfo.errors++;
                AppState.lastError = error.message;
                
                if (error.name === 'AbortError') {
                    updateConnectionStatus('disconnected', 'Timeout');
                } else {
                    updateConnectionStatus('disconnected', error.message);
                }

                // Retry logic
                if (retryCount < CONFIG.RETRY_COUNT) {
                    debugLog(`Retrying API call: ${functionName} (${retryCount + 1}/${CONFIG.RETRY_COUNT})`);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                    return callGoogleScript(functionName, parameters, retryCount + 1);
                }

                // If all retries failed, fall back to offline mode
                if (!AppState.isOfflineMode) {
                    showNotification(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå`, 'warning');
                    AppState.isOfflineMode = true;
                    updateConnectionStatus('offline');
                }

                throw error;
            }
        }

        // ===== Offline Functions =====
        function loadOfflineCourses() {
            debugLog('Loading offline courses');
            return {
                success: true,
                data: SAMPLE_COURSES,
                count: SAMPLE_COURSES.length
            };
        }

        function saveOfflineSchedule(schedule) {
            debugLog('Saving offline schedule', schedule);
            // Save to localStorage for offline persistence
            const scheduleData = {
                studentId: '6710210317',
                semester: document.getElementById('semesterSelect').value,
                courses: schedule,
                savedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('psu_schedule_backup', JSON.stringify(scheduleData));
                return { success: true, message: 'Saved offline' };
            } catch (error) {
                return { success: false, message: 'Failed to save offline' };
            }
        }

        function loadOfflineSchedule() {
            debugLog('Loading offline schedule');
            try {
                const saved = localStorage.getItem('psu_schedule_backup');
                if (saved) {
                    const scheduleData = JSON.parse(saved);
                    return {
                        success: true,
                        data: scheduleData.courses || [],
                        loadedFrom: 'offline'
                    };
                }
            } catch (error) {
                debugLog('Error loading offline schedule', error);
            }
            
            return { success: true, data: [] };
        }

        function toggleOfflineMode() {
            AppState.isOfflineMode = !AppState.isOfflineMode;
            const mode = AppState.isOfflineMode ? 'offline' : 'connected';
            updateConnectionStatus(mode);
            
            showNotification(
                `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô${AppState.isOfflineMode ? '‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå' : '‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'}‡πÅ‡∏•‡πâ‡∏ß`,
                'info'
            );
            
            // Reload courses with new mode
            loadCoursesFromGAS();
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('hidden');
        }

        // ===== Main Course Functions =====
        async function loadCoursesFromGAS() {
            try {
                showSkeletonLoading();
                let result;
                
                if (AppState.isOfflineMode) {
                    result = loadOfflineCourses();
                } else {
                    result = await callGoogleScript('getAllCourses');
                }
                
                if (result.success) {
                    AppState.coursesDatabase = result.data.map(course => ({
                        code: course.code,
                        name: course.name,
                        credits: parseInt(course.credits) || 0,
                        type: course.type,
                        schedule: {
                            day: course.day || course.schedule?.day,
                            startTime: course.startTime || course.schedule?.startTime,
                            endTime: course.endTime || course.schedule?.endTime,
                            room: course.room || course.schedule?.room
                        }
                    }));
                    
                    displayCourses();
                    const mode = AppState.isOfflineMode ? ' (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)' : '';
                    showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ${result.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢${mode}`, 'success');
                } else {
                    throw new Error(result.message || 'Failed to load courses');
                }
            } catch (error) {
                debugLog('Load courses error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', 'error');
                
                // Try offline mode as fallback
                if (!AppState.isOfflineMode) {
                    debugLog('Falling back to offline mode');
                    const offlineResult = loadOfflineCourses();
                    if (offlineResult.success) {
                        AppState.coursesDatabase = offlineResult.data;
                        displayCourses();
                        showNotification('‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ó‡∏ô', 'info');
                    }
                }
            } finally {
                hideSkeletonLoading();
            }
        }

        async function saveScheduleToGAS() {
            if (AppState.selectedCourses.length === 0) return;
            
            try {
                const scheduleData = AppState.selectedCourses.map(course => ({
                    courseCode: course.code,
                    courseName: course.name,
                    credits: course.credits,
                    type: course.type,
                    day: course.schedule.day,
                    startTime: course.schedule.startTime,
                    endTime: course.schedule.endTime,
                    room: course.schedule.room,
                    visible: course.visible !== false
                }));

                let result;
                
                if (AppState.isOfflineMode) {
                    result = saveOfflineSchedule(scheduleData);
                } else {
                    result = await callGoogleScript('saveStudentSchedule', {
                        studentId: '6710210317',
                        semester: document.getElementById('semesterSelect').value,
                        courses: scheduleData
                    });
                }
                
                if (result.success) {
                    const mode = AppState.isOfflineMode ? ' (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)' : '';
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß${mode}`, 'success');
                    
                    if (result.conflicts && result.conflicts.length > 0) {
                        showNotification(`‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${result.conflicts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'warning');
                    }
                } else {
                    throw new Error(result.message || 'Failed to save schedule');
                }
            } catch (error) {
                debugLog('Save schedule error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
            }
        }

        async function loadScheduleFromGAS() {
            try {
                let result;
                
                if (AppState.isOfflineMode) {
                    result = loadOfflineSchedule();
                } else {
                    result = await callGoogleScript('getStudentSchedule', {
                        studentId: '6710210317',
                        semester: document.getElementById('semesterSelect').value
                    });
                }
                
                if (result.success && result.data.length > 0) {
                    AppState.selectedCourses = result.data.map(scheduleItem => ({
                        code: scheduleItem.courseCode,
                        name: scheduleItem.courseName || scheduleItem.name || '',
                        credits: parseInt(scheduleItem.credits) || 0,
                        type: scheduleItem.type || 'elective',
                        schedule: {
                            day: scheduleItem.day || '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå',
                            startTime: scheduleItem.startTime || '09:00',
                            endTime: scheduleItem.endTime || '12:00',
                            room: scheduleItem.room || 'TBA'
                        },
                        visible: scheduleItem.visible !== false,
                        color: { bg: 'bg-purple-200', border: 'border-purple-400', text: 'text-purple-800' }
                    }));
                    
                    updateScheduleDisplay();
                    updateListView();
                    updateStats();
                    
                    const mode = result.loadedFrom === 'offline' ? ' (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)' : '';
                    showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß${mode}`, 'info');
                }
            } catch (error) {
                debugLog('Load schedule error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
            }
        }

        // ===== UI Functions =====
        const timeSlots = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00'];
        const days = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå'];

        function initializeSchedule() {
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            
            days.forEach(day => {
                const row = document.createElement('tr');
                let dayIcon = getDayIcon(day);
                
                row.innerHTML = `
                    <td class="border border-white border-opacity-20 p-3 text-center glass font-bold text-white text-sm">
                        <i class="fas ${dayIcon} mr-2"></i>${day}
                    </td>
                    ${timeSlots.map(time => `<td class="border border-white border-opacity-20 p-1 h-20 relative" id="slot-${getDayCode(day)}-${time}"></td>`).join('')}
                `;
                scheduleBody.appendChild(row);
            });
        }

        function getDayIcon(day) {
            const icons = {
                '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå': 'fa-calendar-day',
                '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£': 'fa-calendar-week', 
                '‡∏û‡∏∏‡∏ò': 'fa-calendar-check',
                '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ': 'fa-calendar-alt',
                '‡∏®‡∏∏‡∏Å‡∏£‡πå': 'fa-calendar-plus'
            };
            return icons[day] || 'fa-calendar';
        }

        function getDayCode(day) {
            const dayMap = {
                '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå': 'mon',
                '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£': 'tue',
                '‡∏û‡∏∏‡∏ò': 'wed', 
                '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ': 'thu',
                '‡∏®‡∏∏‡∏Å‡∏£‡πå': 'fri'
            };
            return dayMap[day];
        }

        function displayCourses() {
            renderCourseList(AppState.coursesDatabase);
        }

        function renderCourseList(courses) {
            const courseList = document.getElementById('courseList');
            courseList.innerHTML = '';
            
            courses.forEach(course => {
                const courseItem = document.createElement('div');
                courseItem.className = 'glass-dark rounded-2xl p-4 cursor-pointer transition-all hover:scale-105 hover-lift';
                
                let typeIcon = getTypeIcon(course.type);
                
                courseItem.innerHTML = `
                    <div class="font-bold text-white text-sm flex items-center">
                        <div class="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center mr-3">
                            <i class="fas ${typeIcon} text-white text-xs"></i>
                        </div>
                        ${course.code}
                    </div>
                    <div class="text-white text-opacity-90 text-xs mt-2 leading-tight">${course.name}</div>
                    <div class="text-white text-opacity-70 text-xs mt-3 flex items-center">
                        <span class="glass px-2 py-1 rounded-lg mr-2">
                            <i class="fas fa-coins mr-1"></i>${course.credits} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï
                        </span>
                        <span class="glass px-2 py-1 rounded-lg">
                            ${getTypeLabel(course.type)}
                        </span>
                    </div>
                `;
                
                courseItem.addEventListener('click', () => addCourse(course));
                courseList.appendChild(courseItem);
            });
        }

        function getTypeIcon(type) {
            const icons = {
                'required': 'fa-star',
                'elective': 'fa-check-circle',
                'general': 'fa-book'
            };
            return icons[type] || 'fa-circle';
        }

        function getTypeLabel(type) {
            const labels = {
                'required': '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö',
                'elective': '‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
                'general': '‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'
            };
            return labels[type] || type;
        }

        function addCourse(course) {
            if (AppState.selectedCourses.find(c => c.code === course.code)) {
                showNotification(`‡∏ß‡∏¥‡∏ä‡∏≤ ${course.code} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
                return;
            }

            const securedCourse = {
                code: course.code,
                name: course.name,
                credits: parseInt(course.credits) || 0,
                type: course.type,
                schedule: course.schedule,
                color: { bg: 'bg-purple-200', border: 'border-purple-400', text: 'text-purple-800' },
                visible: true
            };

            AppState.selectedCourses.push(securedCourse);
            
            updateScheduleDisplay();
            updateListView();
            updateStats();
            showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤ ${course.code} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            
            // Auto-save
            saveScheduleToGAS().catch(error => {
                debugLog('Auto-save failed', error);
            });
        }

        function updateScheduleDisplay() {
            document.querySelectorAll('.course-block').forEach(block => block.remove());
            
            AppState.selectedCourses.forEach(course => {
                if (course.schedule.day === 'ONLINE' || !course.visible) return;
                
                const day = getDayCode(course.schedule.day);
                const startTime = course.schedule.startTime;
                const endTime = course.schedule.endTime;
                
                if (startTime === 'FLEXIBLE') return;
                
                const startHour = parseInt(startTime.split(':')[0]);
                const endHour = parseInt(endTime.split(':')[0]);
                const endMinute = parseInt(endTime.split(':')[1]);
                
                let startSlotTime = null;
                let duration = 1;
                
                for (let hour = startHour; hour >= 8; hour--) {
                    const timeStr = hour.toString().padStart(2, '0') + ':00';
                    if (timeSlots.includes(timeStr)) {
                        startSlotTime = timeStr;
                        break;
                    }
                }
                
                if (!startSlotTime) startSlotTime = '08:00';
                
                const endTotalHour = endMinute > 0 ? endHour + 1 : endHour;
                const startSlotHour = parseInt(startSlotTime.split(':')[0]);
                duration = Math.max(1, endTotalHour - startSlotHour);
                
                const slotId = `slot-${day}-${startSlotTime}`;
                const slot = document.getElementById(slotId);
                
                if (slot) {
                    const courseBlock = document.createElement('div');
                    courseBlock.className = `course-block absolute inset-1 glass rounded-2xl p-3 cursor-pointer transition-all hover:scale-105 z-10 border-2 border-white border-opacity-30 group`;
                    courseBlock.style.width = `${duration * 100 - 8}px`;
                    courseBlock.style.minHeight = '70px';
                    
                    courseBlock.innerHTML = `
                        <div class="text-sm font-bold text-white mb-1">
                            <i class="fas fa-book mr-1"></i>${course.code}
                        </div>
                        <div class="text-xs text-white text-opacity-90 mb-1">
                            <i class="fas fa-door-open mr-1"></i>${course.schedule.room}
                        </div>
                        <div class="text-xs text-white text-opacity-80 mb-1">
                            <i class="fas fa-clock mr-1"></i>${startTime}-${endTime}
                        </div>
                        <div class="text-xs text-white text-opacity-70">
                            <i class="fas fa-coins mr-1"></i>${course.credits} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï
                        </div>
                        
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all flex gap-1">
                            <button class="w-7 h-7 gradient-secondary rounded-full text-xs hover:scale-110 transition-all text-white flex items-center justify-center" onclick="removeCourse('${course.code}')" title="‡∏•‡∏ö">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="absolute bottom-1 left-1 right-1">
                            <span class="text-xs glass px-2 py-1 rounded-lg text-white text-opacity-80">
                                ${getTypeLabel(course.type)}
                            </span>
                        </div>
                    `;
                    
                    slot.appendChild(courseBlock);
                }
            });
        }

        function updateListView() {
            const listContainer = document.getElementById('courseListView');
            listContainer.innerHTML = '';
            
            const visibleCourses = AppState.selectedCourses.filter(c => c.visible);
            
            if (visibleCourses.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-white py-8">
                        <i class="fas fa-clipboard-list text-4xl mb-4 opacity-50"></i>
                        <p class="text-white text-opacity-70">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
                    </div>
                `;
                return;
            }

            visibleCourses.forEach(course => {
                const courseItem = document.createElement('div');
                courseItem.className = 'glass-dark rounded-2xl p-4 mb-3 hover-lift';
                
                courseItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-bold text-white text-sm mb-2">${course.code} - ${course.name}</div>
                            <div class="text-white text-opacity-70 text-xs">
                                <span class="mr-4"><i class="fas fa-coins mr-1"></i>${course.credits} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</span>
                                <span class="mr-4"><i class="fas fa-calendar mr-1"></i>${course.schedule.day}</span>
                                <span class="mr-4"><i class="fas fa-clock mr-1"></i>${course.schedule.startTime}-${course.schedule.endTime}</span>
                                <span><i class="fas fa-door-open mr-1"></i>${course.schedule.room}</span>
                            </div>
                        </div>
                        <button onclick="removeCourse('${course.code}')" class="gradient-secondary text-white px-3 py-2 rounded-xl text-xs hover:scale-105 transition-all">
                            <i class="fas fa-times mr-1"></i>‡∏•‡∏ö
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(courseItem);
            });
        }

        function updateStats() {
            const visibleCourses = AppState.selectedCourses.filter(c => c.visible);
            const totalCredits = visibleCourses.reduce((sum, course) => sum + course.credits, 0);
            const totalCourses = visibleCourses.length;
            const conflictCount = countConflicts();
            
            document.getElementById('totalCredits').textContent = totalCredits;
            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('conflictCount').textContent = conflictCount;
        }

        function countConflicts() {
            const visibleCourses = AppState.selectedCourses.filter(c => c.visible);
            let conflicts = 0;
            
            for (let i = 0; i < visibleCourses.length; i++) {
                for (let j = i + 1; j < visibleCourses.length; j++) {
                    if (visibleCourses[i].schedule.day === visibleCourses[j].schedule.day &&
                        visibleCourses[i].schedule.day !== 'ONLINE') {
                        conflicts++;
                    }
                }
            }
            return conflicts;
        }

        function removeCourse(courseCode) {
            AppState.selectedCourses = AppState.selectedCourses.filter(c => c.code !== courseCode);
            updateScheduleDisplay();
            updateListView();
            updateStats();
            showNotification(`‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ ${courseCode} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            
            // Auto-save
            saveScheduleToGAS().catch(error => {
                debugLog('Auto-save after remove failed', error);
            });
        }

        function searchCourses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.gradient-primary').dataset.filter;
            
            const filteredCourses = AppState.coursesDatabase.filter(course => {
                const matchesSearch = !searchTerm || 
                    course.code.toLowerCase().includes(searchTerm) ||
                    course.name.toLowerCase().includes(searchTerm);
                const matchesFilter = activeFilter === 'all' || course.type === activeFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            renderCourseList(filteredCourses);
        }

        function switchView(view) {
            AppState.currentView = view;
            const tableView = document.getElementById('tableView');
            const listView = document.getElementById('listView');
            const tableBtn = document.getElementById('tableViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (view === 'table') {
                tableView.classList.remove('hidden');
                listView.classList.add('hidden');
                tableBtn.classList.add('gradient-primary', 'neon-blue');
                tableBtn.classList.remove('hover:bg-white', 'hover:bg-opacity-10');
                listBtn.classList.remove('gradient-primary', 'neon-blue');
                listBtn.classList.add('hover:bg-white', 'hover:bg-opacity-10');
            } else {
                tableView.classList.add('hidden');
                listView.classList.remove('hidden');
                listBtn.classList.add('gradient-primary', 'neon-blue');
                listBtn.classList.remove('hover:bg-white', 'hover:bg-opacity-10');
                tableBtn.classList.remove('gradient-primary', 'neon-blue');
                tableBtn.classList.add('hover:bg-white', 'hover:bg-opacity-10');
                updateListView();
            }
        }

        // ===== Skeleton Loading Functions =====
        function showSkeletonLoading() {
            document.getElementById('courseListSkeleton').classList.remove('hidden');
            document.getElementById('tableSkeleton').classList.remove('hidden');
            document.getElementById('statsSkeleton').classList.remove('hidden');
            
            document.getElementById('scheduleContainer').classList.add('hidden');
            document.getElementById('statsContent').classList.add('hidden');
        }

        function hideSkeletonLoading() {
            document.getElementById('courseListSkeleton').classList.add('hidden');
            document.getElementById('tableSkeleton').classList.add('hidden');
            document.getElementById('statsSkeleton').classList.add('hidden');
            
            document.getElementById('scheduleContainer').classList.remove('hidden');
            document.getElementById('statsContent').classList.remove('hidden');
        }

        // ===== Export Functions =====
        async function exportPNG() {
            try {
                const element = document.getElementById('scheduleContainer');
                if (!element || element.classList.contains('hidden')) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
                    return;
                }
                
                showLoadingOverlay(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PNG...');
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                link.download = `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô_${document.getElementById('semesterSelect').value.replace('/', '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PNG ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                debugLog('PNG export error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PNG', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function exportPDF() {
            try {
                const element = document.getElementById('scheduleContainer');
                if (!element || element.classList.contains('hidden')) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning');
                    return;
                }
                
                showLoadingOverlay(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF...');
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                
                const imgWidth = 280;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô_${document.getElementById('semesterSelect').value.replace('/', '_')}.pdf`);
                
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                debugLog('PDF export error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function exportSchedule() {
            try {
                const scheduleData = {
                    student: "‡∏ß‡∏µ‡∏£‡∏¢‡∏∏‡∏ó‡∏ò ‡πÅ‡∏Å‡πâ‡∏ß‡∏Ç‡∏≥ (6710210317)",
                    semester: document.getElementById('semesterSelect').value,
                    courses: AppState.selectedCourses.filter(c => c.visible),
                    stats: {
                        totalCredits: AppState.selectedCourses.filter(c => c.visible).reduce((sum, course) => sum + course.credits, 0),
                        totalCourses: AppState.selectedCourses.filter(c => c.visible).length,
                        conflicts: countConflicts()
                    },
                    exportDate: new Date().toISOString(),
                    version: '2.1.0',
                    mode: AppState.isOfflineMode ? 'offline' : 'online'
                };
                
                const dataStr = JSON.stringify(scheduleData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `schedule_${scheduleData.semester.replace('/', '_')}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                debugLog('Export error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'error');
            }
        }

        // ===== Event Listeners =====
        function setupEventListeners() {
            // Search functionality
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchCourses, 300);
            });

            // View toggle buttons
            document.getElementById('tableViewBtn').addEventListener('click', () => switchView('table'));
            document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('gradient-primary', 'neon-blue');
                        b.classList.add('glass-dark');
                    });
                    btn.classList.remove('glass-dark');
                    btn.classList.add('gradient-primary', 'neon-blue');
                    searchCourses();
                });
            });

            // Semester selector
            document.getElementById('semesterSelect').addEventListener('change', () => {
                loadScheduleFromGAS();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close modals or panels
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (AppState.selectedCourses.length > 0) {
                        saveScheduleToGAS();
                    }
                }
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    toggleDebugPanel();
                }
            });
        }

        // ===== Initialize App =====
        async function initializeApp() {
            try {
                debugLog('Initializing app');
                updateConnectionStatus('checking');
                
                initializeSchedule();
                setupEventListeners();
                
                // Try to load courses
                await loadCoursesFromGAS();
                
                // Try to load existing schedule
                await loadScheduleFromGAS();
                
                updateStats();
                
                // Auto-save every 2 minutes
                setInterval(async () => {
                    if (AppState.selectedCourses.length > 0) {
                        try {
                            await saveScheduleToGAS();
                        } catch (error) {
                            debugLog('Auto-save failed', error);
                        }
                    }
                }, 120000);
                
                debugLog('App initialized successfully');
                
            } catch (error) {
                debugLog('App initialization error', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        }

        // ===== Start Application =====
        document.addEventListener('DOMContentLoaded', () => {
            showLoadingOverlay(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
            
            setTimeout(() => {
                initializeApp().finally(() => {
                    showLoadingOverlay(false);
                });
            }, 1000);
        });
    </script>
</body>
</html>
