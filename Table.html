<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดตารางเรียนอัตโนมัติ - PSU SIS (Enhanced)</title>
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .font-thai { font-family: 'Prompt', sans-serif; }
        .schedule-container { min-width: 800px; }
        .course-block { min-height: 50px; }
        
        /* Modern Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced Gradients */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .gradient-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* Advanced Shadows */
        .shadow-glow {
            box-shadow: 0 0 40px rgba(103, 126, 234, 0.3);
        }
        
        .shadow-float {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, 
                rgba(240, 240, 240, 0.4) 25%, 
                rgba(255, 255, 255, 0.6) 50%, 
                rgba(240, 240, 240, 0.4) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Hover Animations */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .schedule-container { min-width: 600px; }
            .course-block { font-size: 10px; min-height: 40px; }
        }
        
        /* Neon glow effect */
        .neon-blue {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .neon-green {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        .neon-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        .neon-purple {
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
        }
        
        .neon-orange {
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .status-connected {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .status-disconnected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .status-offline {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        /* API Status Panel */
        .api-status-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 10000;
            max-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        
        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen font-thai gradient-primary">
    
    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="text-center text-white">
            <div class="mb-8">
                <i class="fas fa-graduation-cap text-8xl mb-6 text-yellow-300"></i>
                <h1 class="text-4xl font-bold mb-4">ระบบจัดตารางเรียนอัตโนมัติ</h1>
                <p class="text-xl opacity-80">Prince of Songkla University</p>
                <div class="mt-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p id="initStatus">กำลังเริ่มต้นระบบ...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Status Panel -->
    <div id="apiStatusPanel" class="api-status-panel hidden">
        <div class="font-bold mb-3 flex items-center">
            <i class="fas fa-server mr-2"></i>
            API Status Monitor
            <button onclick="toggleApiStatus()" class="ml-auto text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-2">
            <div class="flex items-center">
                <span class="status-indicator" id="connectionIndicator"></span>
                <span>Connection: <span id="connectionStatusText">Checking...</span></span>
            </div>
            <div class="flex items-center">
                <span class="status-indicator status-warning"></span>
                <span>API URL: <span id="apiUrlStatus">Checking...</span></span>
            </div>
            <div class="flex items-center">
                <span class="status-indicator" id="dataIndicator"></span>
                <span>Data: <span id="dataStatusText">Loading...</span></span>
            </div>
            <div class="mt-3 pt-2 border-t border-gray-600 text-xs">
                <div>Mode: <span id="currentMode">Online</span></div>
                <div>Last Check: <span id="lastCheck">-</span></div>
                <div>Errors: <span id="errorCount">0</span></div>
            </div>
        </div>
        <div class="mt-3 flex gap-2">
            <button onclick="testConnection()" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">
                Test API
            </button>
            <button onclick="toggleOfflineMode()" class="bg-orange-600 hover:bg-orange-700 px-2 py-1 rounded text-xs">
                <span id="offlineBtnText">Go Offline</span>
            </button>
            <button onclick="openApiSettings()" class="bg-gray-600 hover:bg-gray-700 px-2 py-1 rounded text-xs">
                Settings
            </button>
        </div>
    </div>
    
    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass rounded-3xl p-8 max-w-lg w-full mx-4 shadow-glow">
            <h3 class="text-xl font-bold text-white mb-6 text-center">
                <div class="w-16 h-16 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-cog text-white text-2xl"></i>
                </div>
                การตั้งค่า API
            </h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-white mb-2">
                        <i class="fas fa-link mr-2"></i>Google Apps Script URL
                    </label>
                    <input 
                        type="url" 
                        id="apiUrlInput" 
                        class="w-full px-4 py-3 glass-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-30 transition-all"
                        placeholder="https://script.google.com/macros/s/..."
                    >
                    <p class="text-xs text-white text-opacity-70 mt-2">
                        ป้อน URL ของ Google Apps Script Web App ที่คุณ deploy แล้ว
                    </p>
                </div>
                
                <div class="bg-blue-500 bg-opacity-20 rounded-xl p-4">
                    <h4 class="font-bold text-white mb-2">
                        <i class="fas fa-info-circle mr-2"></i>วิธีการหา URL:
                    </h4>
                    <ol class="text-sm text-white text-opacity-90 space-y-1">
                        <li>1. เปิด Google Apps Script</li>
                        <li>2. คลิก "Deploy" → "New deployment"</li>
                        <li>3. เลือก "Web app"</li>
                        <li>4. คัดลอก URL ที่ได้</li>
                    </ol>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closeApiSettings()" class="flex-1 glass-dark text-white py-3 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all">
                        <i class="fas fa-times mr-2"></i>ยกเลิก
                    </button>
                    <button onclick="saveApiSettings()" class="flex-1 gradient-primary text-white py-3 rounded-xl hover:scale-105 transition-all neon-blue">
                        <i class="fas fa-save mr-2"></i>บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status px-4 py-2 rounded-xl text-xs font-semibold status-disconnected hidden">
        <i class="fas fa-wifi mr-2"></i>
        <span id="connectionText">Checking connection...</span>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white text-lg">กำลังโหลด...</p>
            <p class="text-white text-sm opacity-80" id="loadingMessage">กรุณารอสักครู่</p>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="mainApp" class="min-h-screen relative overflow-hidden hidden">
        <!-- Animated Background -->
        <div class="absolute inset-0 opacity-30">
            <div class="absolute top-20 left-20 w-72 h-72 bg-white rounded-full mix-blend-multiply filter blur-xl animate-blob"></div>
            <div class="absolute top-40 right-20 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-2000"></div>
            <div class="absolute -bottom-8 left-40 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl animate-blob animation-delay-4000"></div>
        </div>
        
        <div class="container mx-auto p-2 sm:p-6 max-w-7xl relative z-10">
            <!-- Header -->
            <div class="glass rounded-3xl shadow-float mb-6 p-6 hover-lift">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white drop-shadow-lg">
                        <i class="fas fa-graduation-cap text-yellow-300 mr-3"></i>
                        ระบบจัดตารางเรียนอัตโนมัติ
                        <span class="text-sm font-normal opacity-70 ml-2">v2.2.0 (Enhanced)</span>
                    </h1>
                    <div class="flex items-center gap-4">
                        <div class="text-right text-sm text-white">
                            <div class="font-bold glass px-6 py-3 rounded-2xl backdrop-blur-sm border border-white border-opacity-20">
                                <i class="fas fa-user-graduate mr-2"></i>
                                <span id="studentInfo">วีรยุทธ แก้วขำ (6710210317)</span>
                            </div>
                            <div class="mt-2 text-white text-opacity-90 text-xs">
                                <i class="fas fa-university mr-2"></i>
                                คณะวิทยาศาสตร์ วิทยาลัยเทคโนโลยี
                            </div>
                        </div>
                        <button onclick="toggleApiStatus()" class="text-xs glass text-white px-4 py-2 rounded-xl hover:scale-105 transition-all">
                            <i class="fas fa-server mr-2"></i>API Status
                        </button>
                    </div>
                </div>
            </div>

            <!-- API Status Warning -->
            <div id="apiWarning" class="glass rounded-2xl p-4 mb-6 hidden border-l-4 border-orange-400">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-orange-400 text-xl mr-3"></i>
                        <div>
                            <div class="text-white font-semibold">โหมดออฟไลน์</div>
                            <div class="text-white text-opacity-80 text-sm">ไม่สามารถเชื่อมต่อ API ได้ กำลังใช้ข้อมูลตัวอย่าง</div>
                        </div>
                    </div>
                    <button onclick="openApiSettings()" class="gradient-warning text-white px-4 py-2 rounded-xl hover:scale-105 transition-all text-sm neon-orange">
                        <i class="fas fa-cog mr-2"></i>ตั้งค่า
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
                <!-- Sidebar -->
                <div class="xl:col-span-1">
                    <div class="glass rounded-3xl shadow-float p-6 hover-lift">
                        <!-- Search Section -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                                <div class="w-10 h-10 gradient-success rounded-xl flex items-center justify-center mr-3">
                                    <i class="fas fa-search text-white"></i>
                                </div>
                                ค้นหารายวิชา
                            </h3>
                            <div class="relative mb-4">
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="พิมพ์รหัสวิชาหรือชื่อวิชา..."
                                    class="w-full px-4 py-3 pl-12 glass-dark text-white placeholder-white placeholder-opacity-70 rounded-2xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-30 transition-all"
                                    maxlength="100"
                                >
                                <i class="fas fa-search absolute left-4 top-3.5 text-white text-opacity-70"></i>
                            </div>
                            
                            <!-- Filter Buttons -->
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <button class="filter-btn gradient-primary text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105 neon-blue" data-filter="all">
                                    <i class="fas fa-list mr-1"></i>ทั้งหมด
                                </button>
                                <button class="filter-btn glass-dark text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105" data-filter="required">
                                    <i class="fas fa-star mr-1"></i>บังคับ
                                </button>
                                <button class="filter-btn glass-dark text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105" data-filter="elective">
                                    <i class="fas fa-check-circle mr-1"></i>เลือก
                                </button>
                                <button class="filter-btn glass-dark text-white px-3 py-2 rounded-xl text-xs font-medium transition-all hover:scale-105" data-filter="general">
                                    <i class="fas fa-book mr-1"></i>ศึกษาทั่วไป
                                </button>
                            </div>
                        </div>

                        <!-- Course List -->
                        <div class="max-h-60 sm:max-h-96 overflow-y-auto space-y-3 custom-scroll" id="courseList">
                            <!-- Default skeleton while loading -->
                            <div id="courseListSkeleton">
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                                <div class="skeleton h-20 rounded-2xl mb-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Area -->
                <div class="xl:col-span-3">
                    <div class="glass rounded-3xl shadow-float p-6 hover-lift">
                        <!-- Schedule Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-xl font-bold text-white flex items-center">
                                <div class="w-12 h-12 gradient-secondary rounded-xl flex items-center justify-center mr-4">
                                    <i class="fas fa-calendar-alt text-white text-lg"></i>
                                </div>
                                ตารางเรียน
                            </h2>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
                                <!-- Export Buttons -->
                                <div class="flex gap-2">
                                    <button onclick="exportPNG()" class="gradient-success text-white px-4 py-2 rounded-xl text-xs hover:scale-105 transition-all neon-green">
                                        <i class="fas fa-image mr-1"></i>PNG
                                    </button>
                                    <button onclick="exportPDF()" class="gradient-secondary text-white px-4 py-2 rounded-xl text-xs hover:scale-105 transition-all neon-red">
                                        <i class="fas fa-file-pdf mr-1"></i>PDF
                                    </button>
                                </div>
                                
                                <!-- View Toggle -->
                                <div class="flex glass-dark rounded-xl p-1">
                                    <button id="tableViewBtn" class="px-3 py-2 rounded-lg gradient-primary text-white transition-all text-xs neon-blue">
                                        <i class="fas fa-table mr-1"></i>ตาราง
                                    </button>
                                    <button id="listViewBtn" class="px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-all text-xs">
                                        <i class="fas fa-list-ul mr-1"></i>รายการ
                                    </button>
                                </div>
                                
                                <select id="semesterSelect" class="px-4 py-2 glass-dark text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-30 text-xs">
                                    <option value="2567/1">ภาคการศึกษาที่ 1/2567</option>
                                    <option value="2567/2">ภาคการศึกษาที่ 2/2567</option>
                                    <option value="2568/1">ภาคการศึกษาที่ 1/2568</option>
                                </select>
                            </div>
                        </div>

                        <!-- Table View -->
                        <div id="tableView" class="overflow-x-auto">
                            <!-- Skeleton Loading for Table -->
                            <div id="tableSkeleton" class="schedule-container space-y-2">
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                                <div class="skeleton h-16 rounded-2xl"></div>
                            </div>
                            
                            <div class="schedule-container hidden" id="scheduleContainer">
                                <table class="w-full border-collapse glass rounded-2xl overflow-hidden shadow-glow">
                                    <thead>
                                        <tr class="gradient-primary">
                                            <th class="border border-white border-opacity-20 p-3 text-center font-bold text-white text-sm w-24">วัน/เวลา</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">08:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">09:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">10:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">11:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">12:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">13:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">14:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">15:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">16:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">17:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">18:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">19:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">20:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">21:00</th>
                                            <th class="border border-white border-opacity-20 p-2 text-center font-bold text-white text-xs">22:00</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody">
                                        <!-- Schedule will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- List View -->
                        <div id="listView" class="hidden space-y-4">
                            <div id="courseListView">
                                <!-- List view will be generated here -->
                            </div>
                        </div>

                        <!-- Stats Panel -->
                        <div class="mt-6 grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <!-- Stats Skeleton -->
                            <div id="statsSkeleton" class="contents">
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                                <div class="glass rounded-2xl p-4 hover-lift">
                                    <div class="skeleton h-12 rounded-xl"></div>
                                </div>
                            </div>
                            
                            <!-- Actual Stats -->
                            <div id="statsContent" class="contents hidden">
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-blue">
                                    <div class="text-2xl font-bold text-white" id="totalCredits">0</div>
                                    <div class="text-xs text-white text-opacity-80 mt-1">
                                        <i class="fas fa-coins mr-1"></i>หน่วยกิตรวม
                                    </div>
                                </div>
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-green">
                                    <div class="text-2xl font-bold text-white" id="totalCourses">0</div>
                                    <div class="text-xs text-white text-opacity-80 mt-1">
                                        <i class="fas fa-book-open mr-1"></i>จำนวนวิชา
                                    </div>
                                </div>
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-red">
                                    <div class="text-2xl font-bold text-white" id="conflictCount">0</div>
                                    <div class="text-xs text-white text-opacity-80 mt-1">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>ความขัดแย้ง
                                    </div>
                                </div>
                                <div class="glass rounded-2xl p-4 text-center hover-lift neon-purple">
                                    <button 
                                        onclick="exportSchedule()" 
                                        class="gradient-primary text-white px-4 py-2 rounded-xl font-medium hover:scale-105 transition-all text-xs w-full"
                                    >
                                        <i class="fas fa-download mr-1"></i>ส่งออก JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Enhanced Configuration =====
        const CONFIG = {
            // Default API URL - แก้ไขได้ในหน้าการตั้งค่า
            DEFAULT_GAS_URL: 'https://script.google.com/a/macros/psusci.club/s/AKfycbyFCaj8E8KbUGRLdBsoBX03DMCMMH8Kw9DQ_UZyMUV1rgZ225CYB3kBmMirluV1rA6X/exec',
            TIMEOUT: 15000,
            RETRY_COUNT: 2,
            RETRY_DELAY: 1000,
            DEBUG_MODE: true,
            STORAGE_KEYS: {
                API_URL: 'psu_schedule_api_url',
                OFFLINE_MODE: 'psu_schedule_offline_mode',
                SCHEDULE_DATA: 'psu_schedule_data',
                LAST_SYNC: 'psu_schedule_last_sync'
            }
        };

        // ===== Enhanced Global State =====
        const AppState = {
            isOnline: true,
            isOfflineMode: false,
            connectionStatus: 'checking',
            lastError: null,
            apiUrl: '',
            coursesDatabase: [],
            selectedCourses: [],
            currentView: 'table',
            errorCount: 0,
            lastCheck: null,
            debugInfo: {
                apiCalls: 0,
                successfulCalls: 0,
                failedCalls: 0,
                lastApiCall: null,
                lastError: null
            }
        };

        // ===== Enhanced Sample Data =====
        const SAMPLE_COURSES = [
            {
                code: '344-201',
                name: 'ชุดวิชาการคำนวณทางวิทยาการคอมพิวเตอร์',
                credits: 6,
                type: 'required',
                day: 'จันทร์',
                startTime: '09:00',
                endTime: '12:00',
                room: 'NML1',
                instructor: 'อ.ดร.สมชาย'
            },
            {
                code: '344-221',
                name: 'สถาปัตยกรรมและองค์ประกอบคอมพิวเตอร์',
                credits: 2,
                type: 'required',
                day: 'อังคาร',
                startTime: '10:00',
                endTime: '12:00',
                room: 'BSc0603',
                instructor: 'อ.ดร.วิเชียร'
            },
            {
                code: '344-222',
                name: 'ระบบปฏิบัติการ',
                credits: 2,
                type: 'required',
                day: 'พุธ',
                startTime: '13:00',
                endTime: '15:00',
                room: 'BSc0603',
                instructor: 'อ.ดร.ประภาส'
            },
            {
                code: '344-223',
                name: 'พื้นฐานทางความปลอดภัยคอมพิวเตอร์',
                credits: 2,
                type: 'required',
                day: 'พฤหัสบดี',
                startTime: '14:00',
                endTime: '16:00',
                room: 'BSc0603',
                instructor: 'อ.ดร.กิตติ'
            },
            {
                code: '315-201',
                name: 'ชีวิตแห่งอนาคต',
                credits: 2,
                type: 'general',
                day: 'ศุกร์',
                startTime: '09:00',
                endTime: '11:00',
                room: 'NML1',
                instructor: 'อ.ดร.สุชาติ'
            },
            {
                code: '322-102',
                name: 'CALCULUS II',
                credits: 3,
                type: 'required',
                day: 'อังคาร',
                startTime: '09:00',
                endTime: '12:00',
                room: 'NML1',
                instructor: 'อ.ดร.วิทยา'
            },
            {
                code: '344-111',
                name: 'MODULE: PROGRAMMING CONCEPTS A',
                credits: 3,
                type: 'required',
                day: 'พุธ',
                startTime: '10:00',
                endTime: '13:00',
                room: 'BSc0603(LAB)',
                instructor: 'อ.จิรายุ'
            },
            {
                code: '460-001',
                name: 'ONLINE COURSE EXAMPLE',
                credits: 2,
                type: 'elective',
                day: 'ONLINE',
                startTime: 'FLEXIBLE',
                endTime: 'FLEXIBLE',
                room: 'ONLINE',
                instructor: 'อ.ดร.อนันต์'
            },
            {
                code: '344-301',
                name: 'วิทยาการข้อมูลขั้นสูง',
                credits: 3,
                type: 'elective',
                day: 'จันทร์',
                startTime: '13:00',
                endTime: '16:00',
                room: 'BSc0602',
                instructor: 'อ.ดร.ศิริ'
            },
            {
                code: '344-302',
                name: 'การเรียนรู้ของเครื่อง',
                credits: 3,
                type: 'elective',
                day: 'ศุกร์',
                startTime: '13:00',
                endTime: '16:00',
                room: 'BSc0601',
                instructor: 'อ.ดร.นิรันดร์'
            }
        ];

        // ===== Enhanced Utility Functions =====
        function debugLog(message, data = null) {
            if (CONFIG.DEBUG_MODE) {
                console.log(`🔧 [DEBUG] ${message}`, data || '');
                updateApiStatus();
            }
        }

        function updateInitStatus(message) {
            const statusEl = document.getElementById('initStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        function loadStoredSettings() {
            try {
                const storedUrl = localStorage.getItem(CONFIG.STORAGE_KEYS.API_URL);
                const storedOfflineMode = localStorage.getItem(CONFIG.STORAGE_KEYS.OFFLINE_MODE);
                
                if (storedUrl) {
                    AppState.apiUrl = storedUrl;
                    CONFIG.DEFAULT_GAS_URL = storedUrl;
                }
                
                if (storedOfflineMode === 'true') {
                    AppState.isOfflineMode = true;
                }
                
                debugLog('Settings loaded', {
                    apiUrl: AppState.apiUrl ? 'Set' : 'Not set',
                    offlineMode: AppState.isOfflineMode
                });
            } catch (error) {
                debugLog('Error loading settings', error);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem(CONFIG.STORAGE_KEYS.API_URL, AppState.apiUrl || '');
                localStorage.setItem(CONFIG.STORAGE_KEYS.OFFLINE_MODE, AppState.isOfflineMode.toString());
                debugLog('Settings saved');
            } catch (error) {
                debugLog('Error saving settings', error);
            }
        }

        function updateApiStatus() {
            const elements = {
                connectionIndicator: document.getElementById('connectionIndicator'),
                connectionStatusText: document.getElementById('connectionStatusText'),
                apiUrlStatus: document.getElementById('apiUrlStatus'),
                dataIndicator: document.getElementById('dataIndicator'),
                dataStatusText: document.getElementById('dataStatusText'),
                currentMode: document.getElementById('currentMode'),
                lastCheck: document.getElementById('lastCheck'),
                errorCount: document.getElementById('errorCount'),
                offlineBtnText: document.getElementById('offlineBtnText')
            };

            // Connection Status
            if (elements.connectionIndicator && elements.connectionStatusText) {
                if (AppState.isOfflineMode) {
                    elements.connectionIndicator.className = 'status-indicator status-warning';
                    elements.connectionStatusText.textContent = 'Offline Mode';
                } else if (AppState.connectionStatus === 'connected') {
                    elements.connectionIndicator.className = 'status-indicator status-online';
                    elements.connectionStatusText.textContent = 'Connected';
                } else {
                    elements.connectionIndicator.className = 'status-indicator status-error';
                    elements.connectionStatusText.textContent = 'Disconnected';
                }
            }

            // API URL Status
            if (elements.apiUrlStatus) {
                if (AppState.apiUrl) {
                    elements.apiUrlStatus.textContent = 'Configured';
                } else {
                    elements.apiUrlStatus.textContent = 'Not Set';
                }
            }

            // Data Status
            if (elements.dataIndicator && elements.dataStatusText) {
                if (AppState.coursesDatabase.length > 0) {
                    elements.dataIndicator.className = 'status-indicator status-online';
                    elements.dataStatusText.textContent = `${AppState.coursesDatabase.length} courses`;
                } else {
                    elements.dataIndicator.className = 'status-indicator status-warning';
                    elements.dataStatusText.textContent = 'No data';
                }
            }

            // Other status
            if (elements.currentMode) {
                elements.currentMode.textContent = AppState.isOfflineMode ? 'Offline' : 'Online';
            }
            
            if (elements.lastCheck) {
                elements.lastCheck.textContent = AppState.lastCheck || '-';
            }
            
            if (elements.errorCount) {
                elements.errorCount.textContent = AppState.errorCount.toString();
            }

            if (elements.offlineBtnText) {
                elements.offlineBtnText.textContent = AppState.isOfflineMode ? 'Go Online' : 'Go Offline';
            }
        }

        function showLoadingOverlay(show, message = 'กำลังโหลด...') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            
            if (show) {
                messageEl.textContent = message;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function updateConnectionStatus(status, message = '') {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            AppState.connectionStatus = status;
            AppState.lastCheck = new Date().toLocaleTimeString();
            
            statusEl.classList.remove('status-connected', 'status-disconnected', 'status-offline', 'hidden');
            
            switch (status) {
                case 'connected':
                    statusEl.classList.add('status-connected');
                    textEl.innerHTML = '<i class="fas fa-check mr-2"></i>เชื่อมต่อแล้ว';
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                    break;
                case 'disconnected':
                    statusEl.classList.add('status-disconnected');
                    textEl.innerHTML = '<i class="fas fa-times mr-2"></i>ไม่ได้เชื่อมต่อ';
                    break;
                case 'offline':
                    statusEl.classList.add('status-offline');
                    textEl.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>โหมดออฟไลน์';
                    break;
                case 'checking':
                    statusEl.classList.add('status-disconnected');
                    textEl.innerHTML = '<i class="fas fa-sync fa-spin mr-2"></i>กำลังตรวจสอบ...';
                    break;
            }
            
            if (message) {
                textEl.innerHTML += ` - ${message}`;
            }
            
            updateApiStatus();
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 glass rounded-2xl p-6 shadow-glow transition-all transform translate-x-full max-w-md`;
            
            const colors = {
                success: 'border-l-4 border-green-400 neon-green',
                error: 'border-l-4 border-red-400 neon-red',
                warning: 'border-l-4 border-yellow-400',
                info: 'border-l-4 border-blue-400 neon-blue'
            };
            
            const icons = {
                success: 'fa-check-circle text-green-400',
                error: 'fa-exclamation-circle text-red-400',
                warning: 'fa-exclamation-triangle text-yellow-400',
                info: 'fa-info-circle text-blue-400'
            };
            
            notification.innerHTML = `
                <div class="flex items-start ${colors[type]}">
                    <div class="flex-shrink-0">
                        <i class="fas ${icons[type]} text-2xl mr-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-white font-semibold mb-1">
                            ${type === 'success' ? 'สำเร็จ' : 
                              type === 'error' ? 'ข้อผิดพลาด' :
                              type === 'warning' ? 'คำเตือน' : 'แจ้งเตือน'}
                        </div>
                        <div class="text-white text-opacity-90 text-sm">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white text-opacity-60 hover:text-white ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // ===== Enhanced API Functions =====
        async function callGoogleScript(functionName, parameters = {}, retryCount = 0) {
            try {
                debugLog(`API Call: ${functionName}`, parameters);
                AppState.debugInfo.apiCalls++;
                AppState.debugInfo.lastApiCall = new Date().toISOString();
                
                if (AppState.isOfflineMode) {
                    throw new Error('Offline mode enabled');
                }

                if (!AppState.apiUrl) {
                    throw new Error('API URL not configured');
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

                const requestData = {
                    function: functionName,
                    parameters: parameters
                };

                debugLog('Request data', requestData);

                const response = await fetch(AppState.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                updateConnectionStatus('connected');
                AppState.lastError = null;
                AppState.debugInfo.successfulCalls++;
                
                debugLog(`API Success: ${functionName}`, result);
                return result;

            } catch (error) {
                debugLog(`API Error: ${functionName}`, error);
                AppState.debugInfo.failedCalls++;
                AppState.debugInfo.lastError = error.message;
                AppState.lastError = error.message;
                AppState.errorCount++;
                
                if (error.name === 'AbortError') {
                    updateConnectionStatus('disconnected', 'Timeout');
                } else {
                    updateConnectionStatus('disconnected', error.message);
                }

                // Retry logic
                if (retryCount < CONFIG.RETRY_COUNT) {
                    debugLog(`Retrying API call: ${functionName} (${retryCount + 1}/${CONFIG.RETRY_COUNT})`);
                    await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                    return callGoogleScript(functionName, parameters, retryCount + 1);
                }

                throw error;
            }
        }

        // ===== Enhanced Offline Functions =====
        function loadOfflineCourses() {
            debugLog('Loading offline courses');
            return {
                success: true,
                data: SAMPLE_COURSES,
                count: SAMPLE_COURSES.length
            };
        }

        function saveOfflineSchedule(schedule) {
            debugLog('Saving offline schedule', schedule);
            const scheduleData = {
                studentId: '6710210317',
                semester: document.getElementById('semesterSelect').value,
                courses: schedule,
                savedAt: new Date().toISOString()
            };
            
            try {
                localStorage.setItem(CONFIG.STORAGE_KEYS.SCHEDULE_DATA, JSON.stringify(scheduleData));
                localStorage.setItem(CONFIG.STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
                return { success: true, message: 'Saved offline' };
            } catch (error) {
                return { success: false, message: 'Failed to save offline' };
            }
        }

        function loadOfflineSchedule() {
            debugLog('Loading offline schedule');
            try {
                const saved = localStorage.getItem(CONFIG.STORAGE_KEYS.SCHEDULE_DATA);
                if (saved) {
                    const scheduleData = JSON.parse(saved);
                    return {
                        success: true,
                        data: scheduleData.courses || [],
                        loadedFrom: 'offline',
                        lastSync: scheduleData.savedAt
                    };
                }
            } catch (error) {
                debugLog('Error loading offline schedule', error);
            }
            
            return { success: true, data: [] };
        }

        // ===== UI Control Functions =====
        function toggleApiStatus() {
            const panel = document.getElementById('apiStatusPanel');
            panel.classList.toggle('hidden');
            updateApiStatus();
        }

        function toggleOfflineMode() {
            AppState.isOfflineMode = !AppState.isOfflineMode;
            saveSettings();
            
            if (AppState.isOfflineMode) {
                updateConnectionStatus('offline');
                showOfflineWarning(true);
                showNotification('เปลี่ยนเป็นโหมดออฟไลน์แล้ว', 'warning');
            } else {
                updateConnectionStatus('checking');
                showOfflineWarning(false);
                showNotification('เปลี่ยนเป็นโหมดออนไลน์แล้ว', 'info');
                // Try to reconnect
                loadCoursesFromGAS();
            }
            
            updateApiStatus();
        }

        function showOfflineWarning(show) {
            const warning = document.getElementById('apiWarning');
            if (show) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        async function testConnection() {
            if (!AppState.apiUrl) {
                showNotification('กรุณาตั้งค่า API URL ก่อน', 'warning');
                return;
            }

            showLoadingOverlay(true, 'กำลังทดสอบการเชื่อมต่อ...');
            
            try {
                updateConnectionStatus('checking', 'Testing...');
                const result = await callGoogleScript('getAllCourses', {});
                
                if (result.success) {
                    showNotification('การเชื่อมต่อ API สำเร็จ! 🎉', 'success');
                    updateConnectionStatus('connected');
                } else {
                    throw new Error(result.message || 'API returned error');
                }
            } catch (error) {
                showNotification(`การเชื่อมต่อล้มเหลว: ${error.message}`, 'error');
                updateConnectionStatus('disconnected', error.message);
            } finally {
                showLoadingOverlay(false);
            }
        }

        function openApiSettings() {
            const modal = document.getElementById('apiSettingsModal');
            const input = document.getElementById('apiUrlInput');
            
            input.value = AppState.apiUrl || '';
            modal.classList.remove('hidden');
        }

        function closeApiSettings() {
            const modal = document.getElementById('apiSettingsModal');
            modal.classList.add('hidden');
        }

        function saveApiSettings() {
            const input = document.getElementById('apiUrlInput');
            const newUrl = input.value.trim();
            
            if (newUrl && !newUrl.startsWith('https://script.google.com/')) {
                showNotification('กรุณาป้อน URL ที่ถูกต้องของ Google Apps Script', 'error');
                return;
            }
            
            AppState.apiUrl = newUrl;
            CONFIG.DEFAULT_GAS_URL = newUrl;
            saveSettings();
            
            closeApiSettings();
            
            if (newUrl) {
                showNotification('บันทึกการตั้งค่าเรียบร้อยแล้ว', 'success');
                // Test connection with new URL
                testConnection();
            } else {
                showNotification('ลบ API URL แล้ว ระบบจะใช้โหมดออฟไลน์', 'info');
                AppState.isOfflineMode = true;
                saveSettings();
                showOfflineWarning(true);
            }
            
            updateApiStatus();
        }

        // ===== Enhanced Course Management =====
        async function loadCoursesFromGAS() {
            try {
                updateInitStatus('กำลังโหลดข้อมูลรายวิชา...');
                showSkeletonLoading();
                let result;
                
                if (AppState.isOfflineMode || !AppState.apiUrl) {
                    result = loadOfflineCourses();
                    showOfflineWarning(true);
                } else {
                    try {
                        result = await callGoogleScript('getAllCourses');
                        showOfflineWarning(false);
                    } catch (error) {
                        debugLog('API failed, falling back to offline', error);
                        AppState.isOfflineMode = true;
                        saveSettings();
                        result = loadOfflineCourses();
                        showOfflineWarning(true);
                        showNotification('ไม่สามารถเชื่อมต่อ API ได้ ใช้ข้อมูลตัวอย่าง', 'warning');
                    }
                }
                
                if (result.success) {
                    AppState.coursesDatabase = result.data.map(course => ({
                        code: course.code,
                        name: course.name,
                        credits: parseInt(course.credits) || 0,
                        type: course.type,
                        schedule: {
                            day: course.day || course.schedule?.day,
                            startTime: course.startTime || course.schedule?.startTime,
                            endTime: course.endTime || course.schedule?.endTime,
                            room: course.room || course.schedule?.room
                        },
                        instructor: course.instructor || 'TBA'
                    }));
                    
                    displayCourses();
                    const mode = AppState.isOfflineMode ? ' (โหมดออฟไลน์)' : '';
                    updateInitStatus(`โหลดข้อมูล ${result.data.length} รายวิชาเรียบร้อย${mode}`);
                } else {
                    throw new Error(result.message || 'Failed to load courses');
                }
            } catch (error) {
                debugLog('Load courses error', error);
                updateInitStatus('เกิดข้อผิดพลาดในการโหลดข้อมูล');
                showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูลรายวิชา', 'error');
            } finally {
                hideSkeletonLoading();
            }
        }

        async function saveScheduleToGAS() {
            if (AppState.selectedCourses.length === 0) return;
            
            try {
                const scheduleData = AppState.selectedCourses.map(course => ({
                    courseCode: course.code,
                    courseName: course.name,
                    credits: course.credits,
                    type: course.type,
                    day: course.schedule.day,
                    startTime: course.schedule.startTime,
                    endTime: course.schedule.endTime,
                    room: course.schedule.room,
                    visible: course.visible !== false
                }));

                let result;
                
                if (AppState.isOfflineMode || !AppState.apiUrl) {
                    result = saveOfflineSchedule(scheduleData);
                } else {
                    try {
                        result = await callGoogleScript('saveStudentSchedule', {
                            studentId: '6710210317',
                            semester: document.getElementById('semesterSelect').value,
                            courses: scheduleData
                        });
                    } catch (error) {
                        debugLog('Save API failed, saving offline', error);
                        result = saveOfflineSchedule(scheduleData);
                    }
                }
                
                if (result.success) {
                    const mode = AppState.isOfflineMode ? ' (ออฟไลน์)' : '';
                    showNotification(`บันทึกตารางเรียนเรียบร้อยแล้ว${mode}`, 'success');
                    
                    if (result.conflicts && result.conflicts.length > 0) {
                        showNotification(`พบความขัดแย้งเวลา ${result.conflicts.length} รายการ`, 'warning');
                    }
                } else {
                    throw new Error(result.message || 'Failed to save schedule');
                }
            } catch (error) {
                debugLog('Save schedule error', error);
                showNotification('เกิดข้อผิดพลาดในการบันทึก', 'error');
            }
        }

        async function loadScheduleFromGAS() {
            try {
                let result;
                
                if (AppState.isOfflineMode || !AppState.apiUrl) {
                    result = loadOfflineSchedule();
                } else {
                    try {
                        result = await callGoogleScript('getStudentSchedule', {
                            studentId: '6710210317',
                            semester: document.getElementById('semesterSelect').value
                        });
                    } catch (error) {
                        debugLog('Load schedule API failed, loading offline', error);
                        result = loadOfflineSchedule();
                    }
                }
                
                if (result.success && result.data.length > 0) {
                    AppState.selectedCourses = result.data.map(scheduleItem => ({
                        code: scheduleItem.courseCode || scheduleItem.code,
                        name: scheduleItem.courseName || scheduleItem.name || '',
                        credits: parseInt(scheduleItem.credits) || 0,
                        type: scheduleItem.type || 'elective',
                        schedule: {
                            day: scheduleItem.day || 'จันทร์',
                            startTime: scheduleItem.startTime || '09:00',
                            endTime: scheduleItem.endTime || '12:00',
                            room: scheduleItem.room || 'TBA'
                        },
                        visible: scheduleItem.visible !== false,
                        color: { bg: 'bg-purple-200', border: 'border-purple-400', text: 'text-purple-800' }
                    }));
                    
                    updateScheduleDisplay();
                    updateListView();
                    updateStats();
                    
                    const mode = result.loadedFrom === 'offline' ? ' (จากข้อมูลออฟไลน์)' : '';
                    debugLog(`Loaded ${AppState.selectedCourses.length} courses${mode}`);
                }
            } catch (error) {
                debugLog('Load schedule error', error);
                showNotification('เกิดข้อผิดพลาดในการโหลดตารางเรียน', 'error');
            }
        }

        // ===== UI Functions =====
        const timeSlots = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00'];
        const days = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์'];

        function initializeSchedule() {
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            
            days.forEach(day => {
                const row = document.createElement('tr');
                let dayIcon = getDayIcon(day);
                
                row.innerHTML = `
                    <td class="border border-white border-opacity-20 p-3 text-center glass font-bold text-white text-sm">
                        <i class="fas ${dayIcon} mr-2"></i>${day}
                    </td>
                    ${timeSlots.map(time => `<td class="border border-white border-opacity-20 p-1 h-20 relative" id="slot-${getDayCode(day)}-${time}"></td>`).join('')}
                `;
                scheduleBody.appendChild(row);
            });
        }

        function getDayIcon(day) {
            const icons = {
                'จันทร์': 'fa-calendar-day',
                'อังคาร': 'fa-calendar-week', 
                'พุธ': 'fa-calendar-check',
                'พฤหัสบดี': 'fa-calendar-alt',
                'ศุกร์': 'fa-calendar-plus'
            };
            return icons[day] || 'fa-calendar';
        }

        function getDayCode(day) {
            const dayMap = {
                'จันทร์': 'mon',
                'อังคาร': 'tue',
                'พุธ': 'wed', 
                'พฤหัสบดี': 'thu',
                'ศุกร์': 'fri'
            };
            return dayMap[day];
        }

        function displayCourses() {
            renderCourseList(AppState.coursesDatabase);
        }

        function renderCourseList(courses) {
            const courseList = document.getElementById('courseList');
            courseList.innerHTML = '';
            
            if (courses.length === 0) {
                courseList.innerHTML = `
                    <div class="text-center text-white py-8">
                        <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                        <p class="text-white text-opacity-70">ไม่พบรายวิชา</p>
                    </div>
                `;
                return;
            }
            
            courses.forEach(course => {
                const courseItem = document.createElement('div');
                courseItem.className = 'glass-dark rounded-2xl p-4 cursor-pointer transition-all hover:scale-105 hover-lift';
                
                let typeIcon = getTypeIcon(course.type);
                
                courseItem.innerHTML = `
                    <div class="font-bold text-white text-sm flex items-center">
                        <div class="w-8 h-8 gradient-primary rounded-lg flex items-center justify-center mr-3">
                            <i class="fas ${typeIcon} text-white text-xs"></i>
                        </div>
                        ${course.code}
                    </div>
                    <div class="text-white text-opacity-90 text-xs mt-2 leading-tight">${course.name}</div>
                    <div class="text-white text-opacity-70 text-xs mt-3 flex flex-wrap gap-2">
                        <span class="glass px-2 py-1 rounded-lg">
                            <i class="fas fa-coins mr-1"></i>${course.credits} หน่วยกิต
                        </span>
                        <span class="glass px-2 py-1 rounded-lg">
                            ${getTypeLabel(course.type)}
                        </span>
                    </div>
                    <div class="text-white text-opacity-60 text-xs mt-2">
                        <i class="fas fa-calendar mr-1"></i>${course.schedule.day === 'ONLINE' ? 'ออนไลน์' : course.schedule.day}
                        ${course.schedule.day !== 'ONLINE' ? ` | <i class="fas fa-clock ml-2 mr-1"></i>${course.schedule.startTime}-${course.schedule.endTime}` : ''}
                    </div>
                `;
                
                courseItem.addEventListener('click', () => addCourse(course));
                courseList.appendChild(courseItem);
            });
        }

        function getTypeIcon(type) {
            const icons = {
                'required': 'fa-star',
                'elective': 'fa-check-circle',
                'general': 'fa-book'
            };
            return icons[type] || 'fa-circle';
        }

        function getTypeLabel(type) {
            const labels = {
                'required': 'วิชาบังคับ',
                'elective': 'วิชาเลือก',
                'general': 'ศึกษาทั่วไป'
            };
            return labels[type] || type;
        }

        function addCourse(course) {
            if (AppState.selectedCourses.find(c => c.code === course.code)) {
                showNotification(`วิชา ${course.code} อยู่ในตารางเรียนแล้ว`, 'warning');
                return;
            }

            // Check time conflicts
            if (course.schedule.day !== 'ONLINE') {
                const conflicts = checkTimeConflict(course);
                if (conflicts.length > 0) {
                    const conflictNames = conflicts.map(c => c.code).join(', ');
                    showNotification(`เวลาเรียนซ้อนกับ: ${conflictNames}`, 'warning');
                }
            }

            const securedCourse = {
                code: course.code,
                name: course.name,
                credits: parseInt(course.credits) || 0,
                type: course.type,
                schedule: course.schedule,
                instructor: course.instructor,
                color: getRandomColor(),
                visible: true
            };

            AppState.selectedCourses.push(securedCourse);
            
            updateScheduleDisplay();
            updateListView();
            updateStats();
            showNotification(`เพิ่มวิชา ${course.code} เรียบร้อยแล้ว`, 'success');
            
            // Auto-save
            saveScheduleToGAS().catch(error => {
                debugLog('Auto-save failed', error);
            });
        }

        function checkTimeConflict(newCourse) {
            const conflicts = [];
            
            if (newCourse.schedule.day === 'ONLINE') return conflicts;
            
            AppState.selectedCourses.forEach(course => {
                if (course.schedule.day === newCourse.schedule.day && 
                    course.visible && 
                    course.schedule.day !== 'ONLINE') {
                    
                    const start1 = timeToMinutes(course.schedule.startTime);
                    const end1 = timeToMinutes(course.schedule.endTime);
                    const start2 = timeToMinutes(newCourse.schedule.startTime);
                    const end2 = timeToMinutes(newCourse.schedule.endTime);
                    
                    if (start1 < end2 && end1 > start2) {
                        conflicts.push(course);
                    }
                }
            });
            
            return conflicts;
        }

        function timeToMinutes(timeStr) {
            if (timeStr === 'FLEXIBLE' || !timeStr) return 0;
            try {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            } catch (error) {
                return 0;
            }
        }

        function getRandomColor() {
            const colors = [
                { bg: 'bg-purple-200', border: 'border-purple-400', text: 'text-purple-800' },
                { bg: 'bg-blue-200', border: 'border-blue-400', text: 'text-blue-800' },
                { bg: 'bg-green-200', border: 'border-green-400', text: 'text-green-800' },
                { bg: 'bg-yellow-200', border: 'border-yellow-400', text: 'text-yellow-800' },
                { bg: 'bg-pink-200', border: 'border-pink-400', text: 'text-pink-800' },
                { bg: 'bg-indigo-200', border: 'border-indigo-400', text: 'text-indigo-800' }
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function updateScheduleDisplay() {
            document.querySelectorAll('.course-block').forEach(block => block.remove());
            
            AppState.selectedCourses.forEach(course => {
                if (course.schedule.day === 'ONLINE' || !course.visible) return;
                
                const day = getDayCode(course.schedule.day);
                const startTime = course.schedule.startTime;
                const endTime = course.schedule.endTime;
                
                if (startTime === 'FLEXIBLE') return;
                
                const startHour = parseInt(startTime.split(':')[0]);
                const endHour = parseInt(endTime.split(':')[0]);
                const endMinute = parseInt(endTime.split(':')[1]);
                
                let startSlotTime = null;
                let duration = 1;
                
                for (let hour = startHour; hour >= 8; hour--) {
                    const timeStr = hour.toString().padStart(2, '0') + ':00';
                    if (timeSlots.includes(timeStr)) {
                        startSlotTime = timeStr;
                        break;
                    }
                }
                
                if (!startSlotTime) startSlotTime = '08:00';
                
                const endTotalHour = endMinute > 0 ? endHour + 1 : endHour;
                const startSlotHour = parseInt(startSlotTime.split(':')[0]);
                duration = Math.max(1, endTotalHour - startSlotHour);
                
                const slotId = `slot-${day}-${startSlotTime}`;
                const slot = document.getElementById(slotId);
                
                if (slot) {
                    const courseBlock = document.createElement('div');
                    courseBlock.className = `course-block absolute inset-1 glass rounded-2xl p-3 cursor-pointer transition-all hover:scale-105 z-10 border-2 border-white border-opacity-30 group`;
                    courseBlock.style.width = `${duration * 100 - 8}px`;
                    courseBlock.style.minHeight = '70px';
                    
                    courseBlock.innerHTML = `
                        <div class="text-sm font-bold text-white mb-1">
                            <i class="fas fa-book mr-1"></i>${course.code}
                        </div>
                        <div class="text-xs text-white text-opacity-90 mb-1">
                            <i class="fas fa-door-open mr-1"></i>${course.schedule.room}
                        </div>
                        <div class="text-xs text-white text-opacity-80 mb-1">
                            <i class="fas fa-clock mr-1"></i>${startTime}-${endTime}
                        </div>
                        <div class="text-xs text-white text-opacity-70">
                            <i class="fas fa-coins mr-1"></i>${course.credits} หน่วยกิต
                        </div>
                        
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all flex gap-1">
                            <button class="w-7 h-7 gradient-secondary rounded-full text-xs hover:scale-110 transition-all text-white flex items-center justify-center" onclick="removeCourse('${course.code}')" title="ลบ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="absolute bottom-1 left-1 right-1">
                            <span class="text-xs glass px-2 py-1 rounded-lg text-white text-opacity-80">
                                ${getTypeLabel(course.type)}
                            </span>
                        </div>
                    `;
                    
                    slot.appendChild(courseBlock);
                }
            });
        }

        function updateListView() {
            const listContainer = document.getElementById('courseListView');
            listContainer.innerHTML = '';
            
            const visibleCourses = AppState.selectedCourses.filter(c => c.visible);
            
            if (visibleCourses.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center text-white py-8">
                        <i class="fas fa-clipboard-list text-4xl mb-4 opacity-50"></i>
                        <p class="text-white text-opacity-70">ยังไม่มีรายวิชาในตาราง</p>
                        <p class="text-white text-opacity-50 text-sm mt-2">คลิกที่รายวิชาด้านซ้ายเพื่อเพิ่มในตาราง</p>
                    </div>
                `;
                return;
            }

            visibleCourses.forEach(course => {
                const courseItem = document.createElement('div');
                courseItem.className = 'glass-dark rounded-2xl p-4 mb-3 hover-lift border-l-4 border-blue-400';
                
                courseItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-bold text-white text-sm mb-2 flex items-center">
                                <div class="w-6 h-6 gradient-primary rounded mr-3 flex items-center justify-center">
                                    <i class="fas ${getTypeIcon(course.type)} text-white text-xs"></i>
                                </div>
                                ${course.code} - ${course.name}
                            </div>
                            <div class="text-white text-opacity-70 text-xs grid grid-cols-2 md:grid-cols-4 gap-2">
                                <span><i class="fas fa-coins mr-1"></i>${course.credits} หน่วยกิต</span>
                                <span><i class="fas fa-calendar mr-1"></i>${course.schedule.day}</span>
                                <span><i class="fas fa-clock mr-1"></i>${course.schedule.startTime}-${course.schedule.endTime}</span>
                                <span><i class="fas fa-door-open mr-1"></i>${course.schedule.room}</span>
                            </div>
                            ${course.instructor ? `<div class="text-white text-opacity-60 text-xs mt-1">
                                <i class="fas fa-user mr-1"></i>${course.instructor}
                            </div>` : ''}
                        </div>
                        <button onclick="removeCourse('${course.code}')" class="gradient-secondary text-white px-3 py-2 rounded-xl text-xs hover:scale-105 transition-all ml-4">
                            <i class="fas fa-times mr-1"></i>ลบ
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(courseItem);
            });
        }

        function updateStats() {
            const visibleCourses = AppState.selectedCourses.filter(c => c.visible);
            const totalCredits = visibleCourses.reduce((sum, course) => sum + course.credits, 0);
            const totalCourses = visibleCourses.length;
            const conflictCount = countConflicts();
            
            document.getElementById('totalCredits').textContent = totalCredits;
            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('conflictCount').textContent = conflictCount;
        }

        function countConflicts() {
            const visibleCourses = AppState.selectedCourses.filter(c => c.visible && c.schedule.day !== 'ONLINE');
            let conflicts = 0;
            
            for (let i = 0; i < visibleCourses.length; i++) {
                for (let j = i + 1; j < visibleCourses.length; j++) {
                    if (visibleCourses[i].schedule.day === visibleCourses[j].schedule.day) {
                        const start1 = timeToMinutes(visibleCourses[i].schedule.startTime);
                        const end1 = timeToMinutes(visibleCourses[i].schedule.endTime);
                        const start2 = timeToMinutes(visibleCourses[j].schedule.startTime);
                        const end2 = timeToMinutes(visibleCourses[j].schedule.endTime);
                        
                        if (start1 < end2 && end1 > start2) {
                            conflicts++;
                        }
                    }
                }
            }
            return conflicts;
        }

        function removeCourse(courseCode) {
            AppState.selectedCourses = AppState.selectedCourses.filter(c => c.code !== courseCode);
            updateScheduleDisplay();
            updateListView();
            updateStats();
            showNotification(`ลบวิชา ${courseCode} เรียบร้อยแล้ว`, 'success');
            
            // Auto-save
            saveScheduleToGAS().catch(error => {
                debugLog('Auto-save after remove failed', error);
            });
        }

        function searchCourses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.gradient-primary').dataset.filter;
            
            const filteredCourses = AppState.coursesDatabase.filter(course => {
                const matchesSearch = !searchTerm || 
                    course.code.toLowerCase().includes(searchTerm) ||
                    course.name.toLowerCase().includes(searchTerm) ||
                    (course.instructor && course.instructor.toLowerCase().includes(searchTerm));
                const matchesFilter = activeFilter === 'all' || course.type === activeFilter;
                
                return matchesSearch && matchesFilter;
            });
            
            renderCourseList(filteredCourses);
        }

        function switchView(view) {
            AppState.currentView = view;
            const tableView = document.getElementById('tableView');
            const listView = document.getElementById('listView');
            const tableBtn = document.getElementById('tableViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (view === 'table') {
                tableView.classList.remove('hidden');
                listView.classList.add('hidden');
                tableBtn.classList.add('gradient-primary', 'neon-blue');
                tableBtn.classList.remove('hover:bg-white', 'hover:bg-opacity-10');
                listBtn.classList.remove('gradient-primary', 'neon-blue');
                listBtn.classList.add('hover:bg-white', 'hover:bg-opacity-10');
            } else {
                tableView.classList.add('hidden');
                listView.classList.remove('hidden');
                listBtn.classList.add('gradient-primary', 'neon-blue');
                listBtn.classList.remove('hover:bg-white', 'hover:bg-opacity-10');
                tableBtn.classList.remove('gradient-primary', 'neon-blue');
                tableBtn.classList.add('hover:bg-white', 'hover:bg-opacity-10');
                updateListView();
            }
        }

        // ===== Skeleton Loading Functions =====
        function showSkeletonLoading() {
            document.getElementById('courseListSkeleton').classList.remove('hidden');
            document.getElementById('tableSkeleton').classList.remove('hidden');
            document.getElementById('statsSkeleton').classList.remove('hidden');
            
            document.getElementById('scheduleContainer').classList.add('hidden');
            document.getElementById('statsContent').classList.add('hidden');
        }

        function hideSkeletonLoading() {
            document.getElementById('courseListSkeleton').classList.add('hidden');
            document.getElementById('tableSkeleton').classList.add('hidden');
            document.getElementById('statsSkeleton').classList.add('hidden');
            
            document.getElementById('scheduleContainer').classList.remove('hidden');
            document.getElementById('statsContent').classList.remove('hidden');
        }

        // ===== Export Functions =====
        async function exportPNG() {
            try {
                const element = document.getElementById('scheduleContainer');
                if (!element || element.classList.contains('hidden')) {
                    showNotification('กรุณาแสดงตารางเรียนก่อนส่งออก', 'warning');
                    return;
                }
                
                showLoadingOverlay(true, 'กำลังสร้างไฟล์ PNG...');
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                link.download = `ตารางเรียน_${document.getElementById('semesterSelect').value.replace('/', '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                showNotification('ส่งออกไฟล์ PNG เรียบร้อยแล้ว', 'success');
            } catch (error) {
                debugLog('PNG export error', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออก PNG', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function exportPDF() {
            try {
                const element = document.getElementById('scheduleContainer');
                if (!element || element.classList.contains('hidden')) {
                    showNotification('กรุณาแสดงตารางเรียนก่อนส่งออก', 'warning');
                    return;
                }
                
                showLoadingOverlay(true, 'กำลังสร้างไฟล์ PDF...');
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                
                const imgWidth = 280;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`ตารางเรียน_${document.getElementById('semesterSelect').value.replace('/', '_')}.pdf`);
                
                showNotification('ส่งออกไฟล์ PDF เรียบร้อยแล้ว', 'success');
            } catch (error) {
                debugLog('PDF export error', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออก PDF', 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function exportSchedule() {
            try {
                const scheduleData = {
                    student: "วีรยุทธ แก้วขำ (6710210317)",
                    semester: document.getElementById('semesterSelect').value,
                    courses: AppState.selectedCourses.filter(c => c.visible),
                    stats: {
                        totalCredits: AppState.selectedCourses.filter(c => c.visible).reduce((sum, course) => sum + course.credits, 0),
                        totalCourses: AppState.selectedCourses.filter(c => c.visible).length,
                        conflicts: countConflicts()
                    },
                    exportDate: new Date().toISOString(),
                    version: '2.2.0',
                    mode: AppState.isOfflineMode ? 'offline' : 'online',
                    apiUrl: AppState.apiUrl || 'not_set'
                };
                
                const dataStr = JSON.stringify(scheduleData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `schedule_${scheduleData.semester.replace('/', '_')}_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showNotification('ส่งออกตารางเรียนเรียบร้อยแล้ว', 'success');
            } catch (error) {
                debugLog('Export error', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออก', 'error');
            }
        }

        // ===== Event Listeners =====
        function setupEventListeners() {
            // Search functionality
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchCourses, 300);
            });

            // View toggle buttons
            document.getElementById('tableViewBtn').addEventListener('click', () => switchView('table'));
            document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('gradient-primary', 'neon-blue');
                        b.classList.add('glass-dark');
                    });
                    btn.classList.remove('glass-dark');
                    btn.classList.add('gradient-primary', 'neon-blue');
                    searchCourses();
                });
            });

            // Semester selector
            document.getElementById('semesterSelect').addEventListener('change', () => {
                loadScheduleFromGAS();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close modals
                    closeApiSettings();
                    toggleApiStatus();
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (AppState.selectedCourses.length > 0) {
                        saveScheduleToGAS();
                    }
                }
                if (e.key === 'F1') {
                    e.preventDefault();
                    toggleApiStatus();
                }
            });
        }

        // ===== Initialize App =====
        async function initializeApp() {
            try {
                debugLog('Initializing app');
                
                // Load stored settings first
                loadStoredSettings();
                
                // Initialize UI
                updateInitStatus('กำลังเตรียมหน้าจอ...');
                initializeSchedule();
                setupEventListeners();
                
                // Load courses
                await loadCoursesFromGAS();
                
                // Load existing schedule
                updateInitStatus('กำลังโหลดตารางเรียน...');
                await loadScheduleFromGAS();
                
                updateStats();
                
                // Setup auto-save
                setInterval(async () => {
                    if (AppState.selectedCourses.length > 0) {
                        try {
                            await saveScheduleToGAS();
                        } catch (error) {
                            debugLog('Auto-save failed', error);
                        }
                    }
                }, 120000); // Every 2 minutes
                
                updateInitStatus('เสร็จสิ้น! ระบบพร้อมใช้งาน');
                debugLog('App initialized successfully');
                
                // Show main app after delay
                setTimeout(() => {
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    // Show API status if there are issues
                    if (AppState.isOfflineMode || !AppState.apiUrl) {
                        setTimeout(() => {
                            toggleApiStatus();
                        }, 1000);
                    }
                }, 2000);
                
            } catch (error) {
                debugLog('App initialization error', error);
                updateInitStatus('เกิดข้อผิดพลาดในการเริ่มต้นระบบ');
                showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ', 'error');
                
                // Still show the app even if initialization failed
                setTimeout(() => {
                    document.getElementById('welcomeScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    openApiSettings(); // Open settings immediately if there's an error
                }, 3000);
            }
        }

        // ===== Start Application =====
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('DOM loaded, starting app initialization');
            
            // Start initialization after a short delay to show the welcome screen
            setTimeout(() => {
                initializeApp();
            }, 500);
        });

        // ===== Global Error Handler =====
        window.addEventListener('error', (event) => {
            debugLog('Global error caught', {
                message: event.error?.message,
                filename: event.filename,
                lineno: event.lineno
            });
            AppState.errorCount++;
            updateApiStatus();
        });

        window.addEventListener('unhandledrejection', (event) => {
            debugLog('Unhandled promise rejection', event.reason);
            AppState.errorCount++;
            updateApiStatus();
        });

        // ===== Utility Functions for Enhanced Features =====
        
        // Help system
        function showHelp() {
            const helpContent = `
                <div class="space-y-4">
                    <h4 class="font-bold text-white mb-4">🎓 คู่มือการใช้งาน</h4>
                    
                    <div class="space-y-3 text-sm text-white text-opacity-90">
                        <div class="flex items-start">
                            <i class="fas fa-search text-blue-400 mr-3 mt-1"></i>
                            <div>
                                <strong>การค้นหารายวิชา:</strong> พิมพ์รหัสวิชา ชื่อวิชา หรือชื่ออาจารย์ในช่องค้นหา
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <i class="fas fa-plus text-green-400 mr-3 mt-1"></i>
                            <div>
                                <strong>การเพิ่มวิชา:</strong> คลิกที่รายวิชาที่ต้องการเพื่อเพิ่มในตาราง
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <i class="fas fa-times text-red-400 mr-3 mt-1"></i>
                            <div>
                                <strong>การลบวิชา:</strong> คลิกปุ่ม X ในตารางหรือในมุมมองรายการ
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <i class="fas fa-download text-purple-400 mr-3 mt-1"></i>
                            <div>
                                <strong>การส่งออก:</strong> ใช้ปุ่ม PNG, PDF หรือ JSON เพื่อส่งออกตาราง
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <i class="fas fa-keyboard text-yellow-400 mr-3 mt-1"></i>
                            <div>
                                <strong>คีย์ลัด:</strong><br>
                                • Ctrl+S = บันทึกตาราง<br>
                                • F1 = เปิด/ปิด API Status<br>
                                • Esc = ปิดหน้าต่าง
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showNotification(helpContent, 'info', 10000);
        }

        // Performance monitoring
        function trackPerformance() {
            const perfData = {
                loadTime: performance.now(),
                coursesLoaded: AppState.coursesDatabase.length,
                selectedCourses: AppState.selectedCourses.length,
                apiCalls: AppState.debugInfo.apiCalls,
                errors: AppState.errorCount,
                mode: AppState.isOfflineMode ? 'offline' : 'online'
            };
            
            debugLog('Performance data', perfData);
            return perfData;
        }

        // Advanced features for power users
        function importScheduleFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.courses && Array.isArray(data.courses)) {
                                AppState.selectedCourses = data.courses;
                                updateScheduleDisplay();
                                updateListView();
                                updateStats();
                                showNotification(`นำเข้าตารางเรียน ${data.courses.length} รายวิชาเรียบร้อย`, 'success');
                            } else {
                                throw new Error('Invalid JSON format');
                            }
                        } catch (error) {
                            showNotification('ไฟล์ JSON ไม่ถูกต้อง', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Quick actions
        function clearAllCourses() {
            if (AppState.selectedCourses.length === 0) {
                showNotification('ไม่มีรายวิชาในตารางที่จะลบ', 'info');
                return;
            }
            
            if (confirm(`ต้องการลบรายวิชาทั้งหมด ${AppState.selectedCourses.length} รายการหรือไม่?`)) {
                AppState.selectedCourses = [];
                updateScheduleDisplay();
                updateListView();
                updateStats();
                showNotification('ลบรายวิชาทั้งหมดเรียบร้อยแล้ว', 'success');
                saveScheduleToGAS();
            }
        }

        function shuffleCourseColors() {
            AppState.selectedCourses.forEach(course => {
                course.color = getRandomColor();
            });
            updateScheduleDisplay();
            showNotification('เปลี่ยนสีรายวิชาเรียบร้อยแล้ว', 'info');
        }

        // Accessibility improvements
        function setupAccessibility() {
            // Add ARIA labels
            document.querySelectorAll('button').forEach(btn => {
                if (!btn.getAttribute('aria-label') && btn.textContent) {
                    btn.setAttribute('aria-label', btn.textContent.trim());
                }
            });
            
            // Add keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.altKey && e.key === 'h') {
                    e.preventDefault();
                    showHelp();
                }
                if (e.altKey && e.key === 'c') {
                    e.preventDefault();
                    clearAllCourses();
                }
                if (e.altKey && e.key === 'i') {
                    e.preventDefault();
                    importScheduleFromJSON();
                }
            });
        }

        // Statistics and analytics
        function generateAdvancedStats() {
            const stats = {
                basic: {
                    totalCourses: AppState.selectedCourses.filter(c => c.visible).length,
                    totalCredits: AppState.selectedCourses.filter(c => c.visible).reduce((sum, c) => sum + c.credits, 0),
                    conflicts: countConflicts()
                },
                byType: {},
                byDay: {},
                timeDistribution: {},
                performance: trackPerformance()
            };
            
            // Group by type
            AppState.selectedCourses.filter(c => c.visible).forEach(course => {
                if (!stats.byType[course.type]) {
                    stats.byType[course.type] = { count: 0, credits: 0 };
                }
                stats.byType[course.type].count++;
                stats.byType[course.type].credits += course.credits;
            });
            
            // Group by day
            AppState.selectedCourses.filter(c => c.visible).forEach(course => {
                if (!stats.byDay[course.schedule.day]) {
                    stats.byDay[course.schedule.day] = { count: 0, credits: 0 };
                }
                stats.byDay[course.schedule.day].count++;
                stats.byDay[course.schedule.day].credits += course.credits;
            });
            
            return stats;
        }

        // Initialize accessibility features when app is ready
        setTimeout(() => {
            setupAccessibility();
        }, 3000);

    </script>
</body>
</html>
