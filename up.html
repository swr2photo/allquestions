<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบการส่งรูปภาพนักศึกษา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Prompt', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="30" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .card-shadow {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .icon-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .filter-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .status-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .status-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .export-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .export-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .animate-bounce-slow {
            animation: bounce-slow 3s ease-in-out infinite;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="gradient-bg py-12">
        <div class="container mx-auto px-4">
            <div class="text-center relative z-10">
                <div class="animate-bounce-slow inline-block">
                    <i class="fas fa-cloud-upload-alt text-6xl text-white/80 mb-4"></i>
                </div>
                <h1 class="text-5xl font-bold text-white mb-4">
                    ระบบตรวจสอบการส่งรูปภาพนักศึกษา
                </h1>
                <p class="text-white/90 text-xl font-medium">
                    ตรวจสอบสถานะการส่งรูปภาพใน Google Drive พร้อมระบบกรองขั้นสูง
                </p>
                <div class="mt-6 flex justify-center gap-4">
                    <div class="stat-card px-6 py-3 rounded-2xl">
                        <i class="fas fa-users text-white/80 mr-2"></i>
                        <span class="text-white font-semibold">รองรับหลายรายการ</span>
                    </div>
                    <div class="stat-card px-6 py-3 rounded-2xl">
                        <i class="fas fa-filter text-white/80 mr-2"></i>
                        <span class="text-white font-semibold">กรองไฟล์ได้</span>
                    </div>
                    <div class="stat-card px-6 py-3 rounded-2xl">
                        <i class="fas fa-file-pdf text-white/80 mr-2"></i>
                        <span class="text-white font-semibold">ส่งออก PDF</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- การตั้งค่า -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-cogs icon-gradient text-3xl mr-3"></i>
                การตั้งค่า Google Drive
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-2">
                    <label class="flex items-center text-lg font-semibold text-gray-700 mb-3">
                        <i class="fas fa-folder text-blue-600 mr-2"></i>
                        Google Drive Folder ID
                    </label>
                    <input type="text" id="folderId" placeholder="ใส่ Folder ID ของ Google Drive"
                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-lg">
                    <p class="text-sm text-gray-500 mt-2 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        หา ID จาก URL: /folders/[ID นี่]
                    </p>
                </div>
                <div class="space-y-2">
                    <label class="flex items-center text-lg font-semibold text-gray-700 mb-3">
                        <i class="fas fa-key text-green-600 mr-2"></i>
                        Google API Key
                    </label>
                    <input type="password" id="apiKey" placeholder="ใส่ Google API Key"
                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-green-500/20 focus:border-green-500 transition-all duration-300 text-lg">
                    <p class="text-sm text-gray-500 mt-2 flex items-center">
                        <i class="fas fa-shield-alt mr-2"></i>
                        ต้องมีสิทธิ์ใน Google Drive API
                    </p>
                </div>
            </div>
        </div>

        <!-- ตัวเลือกการกรอง -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-filter icon-gradient text-3xl mr-3"></i>
                ตัวเลือกการกรอง
            </h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                        <i class="fas fa-image text-purple-600 mr-2"></i>
                        ประเภทไฟล์
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-images text-blue-600 mr-3 text-xl"></i>
                                <span class="font-medium">รูปภาพ</span>
                                <span class="text-sm text-gray-500 ml-2">(.jpg, .png, .gif)</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includeImages" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-pdf text-red-600 mr-3 text-xl"></i>
                                <span class="font-medium">PDF</span>
                                <span class="text-sm text-gray-500 ml-2">(.pdf)</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includePdf">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-gray-200">
                            <div class="flex items-center">
                                <i class="fas fa-file-word text-blue-700 mr-3 text-xl"></i>
                                <span class="font-medium">เอกสาร</span>
                                <span class="text-sm text-gray-500 ml-2">(.doc, .docx)</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includeDoc">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                        <i class="fas fa-calendar-alt text-green-600 mr-2"></i>
                        ช่วงเวลา
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันที่เริ่มต้น</label>
                            <input type="date" id="startDate" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-green-500/20 focus:border-green-500 transition-all duration-300">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">วันที่สิ้นสุด</label>
                            <input type="date" id="endDate" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-green-500/20 focus:border-green-500 transition-all duration-300">
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 flex items-center">
                        <i class="fas fa-sort-amount-down text-orange-600 mr-2"></i>
                        การเรียงลำดับ
                    </h3>
                    <div class="space-y-4">
                        <select id="sortBy" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-orange-500/20 focus:border-orange-500 transition-all duration-300">
                            <option value="studentId">รหัสนักศึกษา</option>
                            <option value="status">สถานะ</option>
                            <option value="fileCount">จำนวนไฟล์</option>
                            <option value="modifiedTime">วันที่แก้ไข</option>
                        </select>
                        <div class="flex items-center justify-between p-4 bg-white rounded-xl border-2 border-gray-200">
                            <span class="font-medium">เรียงจากมากไปน้อย</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sortDesc" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ช่องกรอกรหัสนักศึกษา -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-user-graduate icon-gradient text-3xl mr-3"></i>
                ตรวจสอบรหัสนักศึกษา
            </h2>
            <div class="grid md:grid-cols-4 gap-6">
                <div class="md:col-span-3">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">รหัสนักศึกษา (10 หลัก)</label>
                    <input type="text" id="studentId" placeholder="เช่น 6514567890" maxlength="10"
                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-lg">
                </div>
                <div class="flex items-end">
                    <button onclick="checkSingleStudent()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300 font-semibold text-lg flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i>
                        ตรวจสอบ
                    </button>
                </div>
            </div>
        </div>

        <!-- ตรวจสอบหลายรายการ -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-users icon-gradient text-3xl mr-3"></i>
                ตรวจสอบหลายรายการ
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">รายการรหัสนักศึกษา</label>
                    <textarea id="studentList" placeholder="ใส่รหัสนักศึกษาแต่ละบรรทัด&#10;6514567890&#10;6514567891&#10;6514567892" 
                              rows="12" class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all duration-300 text-lg"></textarea>
                </div>
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl border-2 border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-tags text-indigo-600 mr-2"></i>
                            ตัวกรองที่เลือก
                        </h3>
                        <div id="selectedFilters" class="flex flex-wrap gap-2 mb-4">
                            <!-- ตัวกรองจะแสดงที่นี่ -->
                        </div>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            ปรับตัวเลือกการกรองด้านบนเพื่อเปลี่ยนเงื่อนไขการค้นหา
                        </div>
                    </div>
                    <button onclick="checkMultipleStudents()" 
                            class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-semibold text-lg flex items-center justify-center">
                        <i class="fas fa-search-plus mr-2"></i>
                        ตรวจสอบทั้งหมด
                    </button>
                </div>
            </div>
        </div>

        <!-- ผลการตรวจสอบ -->
        <div id="results" class="glass-effect rounded-2xl card-shadow p-8 mb-8" style="display: none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-chart-bar icon-gradient text-3xl mr-3"></i>
                    ผลการตรวจสอบ
                </h2>
                <div class="flex gap-3">
                    <button onclick="exportToExcel()" 
                            class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all duration-300 font-semibold flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>
                        Excel
                    </button>
                    <button onclick="generatePDF()" 
                            class="export-btn">
                        <i class="fas fa-file-pdf mr-2"></i>
                        PDF Report
                    </button>
                </div>
            </div>
            <div id="summary" class="grid md:grid-cols-4 gap-6 mb-8"></div>
            <div id="resultList"></div>
        </div>

        <!-- โหลดดิ้ง -->
        <div id="loading" class="text-center py-16" style="display: none;">
            <div class="pulse-animation">
                <div class="inline-block">
                    <i class="fas fa-spinner fa-spin text-6xl text-blue-600"></i>
                </div>
            </div>
            <p class="mt-6 text-gray-600 text-xl font-medium">กำลังตรวจสอบข้อมูล...</p>
            <div class="mt-4 w-64 bg-gray-200 rounded-full h-3 mx-auto">
                <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
        let allResults = [];
        let allFiles = [];

        // อัพเดตตัวกรองที่เลือก
        function updateSelectedFilters() {
            const filtersDiv = document.getElementById('selectedFilters');
            const filters = [];
            
            if (document.getElementById('includeImages').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-images"></i> รูปภาพ</span>');
            }
            if (document.getElementById('includePdf').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-file-pdf"></i> PDF</span>');
            }
            if (document.getElementById('includeDoc').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-file-word"></i> เอกสาร</span>');
            }
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate) {
                filters.push(`<span class="filter-tag"><i class="fas fa-calendar-alt"></i> จาก ${startDate}</span>`);
            }
            if (endDate) {
                filters.push(`<span class="filter-tag"><i class="fas fa-calendar-alt"></i> ถึง ${endDate}</span>`);
            }
            
            filtersDiv.innerHTML = filters.length > 0 ? filters.join(' ') : '<span class="text-gray-500">ไม่มีตัวกรอง</span>';
        }

        // Event listeners สำหรับตัวกรอง
        document.getElementById('includeImages').addEventListener('change', updateSelectedFilters);
        document.getElementById('includePdf').addEventListener('change', updateSelectedFilters);
        document.getElementById('includeDoc').addEventListener('change', updateSelectedFilters);
        document.getElementById('startDate').addEventListener('change', updateSelectedFilters);
        document.getElementById('endDate').addEventListener('change', updateSelectedFilters);

        // เริ่มต้นแสดงตัวกรอง
        updateSelectedFilters();

        // ฟังก์ชันตรวจสอบความถูกต้องของรหัสนักศึกษา
        function validateStudentId(studentId) {
            const cleaned = studentId.trim();
            if (cleaned.length !== 10) {
                return { valid: false, message: 'รหัสนักศึกษาต้องมี 10 หลัก' };
            }
            if (!/^\d{10}$/.test(cleaned)) {
                return { valid: false, message: 'รหัสนักศึกษาต้องเป็นตัวเลขเท่านั้น' };
            }
            return { valid: true, studentId: cleaned };
        }

        // ฟังก์ชันดึงไฟล์จาก Google Drive
        async function fetchDriveFiles() {
            const folderId = document.getElementById('folderId').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!folderId || !apiKey) {
                alert('กรุณาใส่ Folder ID และ API Key');
                return null;
            }

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${apiKey}&fields=files(id,name,mimeType,modifiedTime)&pageSize=1000`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.files || [];
            } catch (error) {
                console.error('Error fetching files:', error);
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error.message);
                return null;
            }
        }

        // ฟังก์ชันตรวจสอบประเภทไฟล์
        function getFileType(mimeType, fileName) {
            const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const pdfTypes = ['application/pdf'];
            const docTypes = ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            
            if (imageTypes.includes(mimeType)) return 'image';
            if (pdfTypes.includes(mimeType)) return 'pdf';
            if (docTypes.includes(mimeType)) return 'doc';
            
            // ตรวจสอบจากชื่อไฟล์
            const ext = fileName.toLowerCase().split('.').pop();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'image';
            if (ext === 'pdf') return 'pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc';
            
            return 'other';
        }

        // ฟังก์ชันตรวจสอบนักศึกษารายเดียว
        async function checkSingleStudent() {
            const studentId = document.getElementById('studentId').value.trim();
            const validation = validateStudentId(studentId);
            
            if (!validation.valid) {
                alert(validation.message);
                return;
            }

            showLoading();
            updateProgress(20);
            
            if (allFiles.length === 0) {
                allFiles = await fetchDriveFiles();
                if (!allFiles) {
                    hideLoading();
                    return;
                }
            }

            updateProgress(80);
            const result = checkStudentFiles(validation.studentId, allFiles);
            allResults = [result];
            
            updateProgress(100);
            displayResults();
            hideLoading();
        }

        // ฟังก์ชันตรวจสอบหลายรายการ
        async function checkMultipleStudents() {
            const studentList = document.getElementById('studentList').value.trim();
            if (!studentList) {
                alert('กรุณาใส่รายการรหัสนักศึกษา');
                return;
            }

            showLoading();
            updateProgress(10);
            
            if (allFiles.length === 0) {
                allFiles = await fetchDriveFiles();
                if (!allFiles) {
                    hideLoading();
                    return;
                }
            }

            updateProgress(30);
            const studentIds = studentList.split('\n').map(id => id.trim()).filter(id => id);
            allResults = [];

            for (let i = 0; i < studentIds.length; i++) {
                const studentId = studentIds[i];
                const validation = validateStudentId(studentId);
                if (validation.valid) {
                    const result = checkStudentFiles(validation.studentId, allFiles);
                    allResults.push(result);
                } else {
                    allResults.push({
                        studentId: studentId,
                        status: 'invalid',
                        message: validation.message,
                        files: []
                    });
                }
                
                // อัพเดตความคืบหน้า
                updateProgress(30 + (i + 1) / studentIds.length * 60);
            }

            // เรียงลำดับผลลัพธ์
            sortResults();
            
            updateProgress(100);
            displayResults();
            hideLoading();
        }

        // ฟังก์ชันตรวจสอบไฟล์ของนักศึกษา
        function checkStudentFiles(studentId, files) {
            const includeImages = document.getElementById('includeImages').checked;
            const includePdf = document.getElementById('includePdf').checked;
            const includeDoc = document.getElementById('includeDoc').checked;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const studentFiles = files.filter(file => {
                const fileType = getFileType(file.mimeType, file.name);
                const matchesType = (includeImages && fileType === 'image') ||
                                  (includePdf && fileType === 'pdf') ||
                                  (includeDoc && fileType === 'doc');
                
                const matchesName = file.name.includes(studentId);
                
                // ตรวจสอบช่วงเวลา
                let matchesDate = true;
                if (startDate || endDate) {
                    const fileDate = new Date(file.modifiedTime);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate + 'T23:59:59') : null;
                    
                    if (start && fileDate < start) matchesDate = false;
                    if (end && fileDate > end) matchesDate = false;
                }
                
                return matchesType && matchesName && matchesDate;
            });

            let status = 'not_found';
            let message = 'ยังไม่ส่งไฟล์หรือชื่อไฟล์ไม่ถูกต้อง';

            if (studentFiles.length > 0) {
                status = 'found';
                message = `พบไฟล์ ${studentFiles.length} ไฟล์`;
            }

            return {
                studentId: studentId,
                status: status,
                message: message,
                files: studentFiles.map(file => ({
                    name: file.name,
                    type: getFileType(file.mimeType, file.name),
                    modifiedTime: file.modifiedTime,
                    size: file.size || 0
                }))
            };
        }

        // ฟังก์ชันเรียงลำดับผลลัพธ์
        function sortResults() {
            const sortBy = document.getElementById('sortBy').value;
            const sortDesc = document.getElementById('sortDesc').checked;
            
            allResults.sort((a, b) => {
                let aValue, bValue;
                
                switch (sortBy) {
                    case 'studentId':
                        aValue = a.studentId;
                        bValue = b.studentId;
                        break;
                    case 'status':
                        aValue = a.status === 'found' ? 1 : 0;
                        bValue = b.status === 'found' ? 1 : 0;
                        break;
                    case 'fileCount':
                        aValue = a.files.length;
                        bValue = b.files.length;
                        break;
                    case 'modifiedTime':
                        aValue = a.files.length > 0 ? new Date(a.files[0].modifiedTime) : new Date(0);
                        bValue = b.files.length > 0 ? new Date(b.files[0].modifiedTime) : new Date(0);
                        break;
                    default:
                        aValue = a.studentId;
                        bValue = b.studentId;
                }
                
                if (aValue < bValue) return sortDesc ? 1 : -1;
                if (aValue > bValue) return sortDesc ? -1 : 1;
                return 0;
            });
        }

        // ฟังก์ชันแสดงผลการตรวจสอบ
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const resultListDiv = document.getElementById('resultList');

            resultsDiv.style.display = 'block';

            // สรุปผล
            const total = allResults.length;
            const found = allResults.filter(r => r.status === 'found').length;
            const notFound = allResults.filter(r => r.status === 'not_found').length;
            const invalid = allResults.filter(r => r.status === 'invalid').length;
            const totalFiles = allResults.reduce((sum, r) => sum + r.files.length, 0);

            summaryDiv.innerHTML = `
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl text-center">
                    <i class="fas fa-users text-3xl mb-3"></i>
                    <div class="text-3xl font-bold">${total}</div>
                    <div class="text-blue-100">ทั้งหมด</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl text-center">
                    <i class="fas fa-check-circle text-3xl mb-3"></i>
                    <div class="text-3xl font-bold">${found}</div>
                    <div class="text-green-100">ส่งแล้ว</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-2xl text-center">
                    <i class="fas fa-times-circle text-3xl mb-3"></i>
                    <div class="text-3xl font-bold">${notFound + invalid}</div>
                    <div class="text-red-100">ยังไม่ส่ง</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-2xl text-center">
                    <i class="fas fa-files text-3xl mb-3"></i>
                    <div class="text-3xl font-bold">${totalFiles}</div>
                    <div class="text-purple-100">ไฟล์ทั้งหมด</div>
                </div>
            `;

            // รายการผลการตรวจสอบ
            let resultHTML = '<div class="space-y-6">';
            
            allResults.forEach(result => {
                const statusBadge = result.status === 'found' ? 
                    '<span class="status-badge status-success"><i class="fas fa-check-circle"></i> ส่งแล้ว</span>' :
                    result.status === 'invalid' ?
                    '<span class="status-badge status-warning"><i class="fas fa-exclamation-triangle"></i> ไม่ถูกต้อง</span>' :
                    '<span class="status-badge status-error"><i class="fas fa-times-circle"></i> ยังไม่ส่ง</span>';

                resultHTML += `
                    <div class="bg-white rounded-2xl p-6 border-2 ${result.status === 'found' ? 'border-green-200' : 'border-red-200'} hover:shadow-lg transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-user-graduate text-2xl text-gray-600 mr-3"></i>
                                <div>
                                    <div class="text-xl font-bold text-gray-800">${result.studentId}</div>
                                    <div class="text-sm text-gray-500">${result.message}</div>
                                </div>
                            </div>
                            ${statusBadge}
                        </div>
                        ${result.files.length > 0 ? `
                            <div class="border-t pt-4">
                                <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-folder-open mr-2"></i>
                                    ไฟล์ที่พบ (${result.files.length} ไฟล์)
                                </h4>
                                <div class="grid gap-3">
                                    ${result.files.map(file => `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                            <div class="flex items-center">
                                                <i class="fas fa-${file.type === 'image' ? 'image' : file.type === 'pdf' ? 'file-pdf' : 'file-word'} text-lg mr-3 ${file.type === 'image' ? 'text-blue-600' : file.type === 'pdf' ? 'text-red-600' : 'text-blue-700'}"></i>
                                                <div>
                                                    <div class="font-medium text-gray-800">${file.name}</div>
                                                    <div class="text-sm text-gray-500">${new Date(file.modifiedTime).toLocaleDateString('th-TH', { 
                                                        year: 'numeric', 
                                                        month: 'long', 
                                                        day: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}</div>
                                                </div>
                                            </div>
                                            <span class="text-xs bg-gray-200 px-2 py-1 rounded-full font-medium">
                                                ${file.type.toUpperCase()}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            resultHTML += '</div>';
            resultListDiv.innerHTML = resultHTML;
        }

        // ฟังก์ชันแสดงการโหลด
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }

        // ฟังก์ชันซ่อนการโหลด
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // ฟังก์ชันอัพเดตความคืบหน้า
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // ฟังก์ชันส่งออก Excel
        function exportToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "รหัสนักศึกษา,สถานะ,จำนวนไฟล์,รายละเอียด\n";
            
            allResults.forEach(result => {
                const status = result.status === 'found' ? 'ส่งแล้ว' : result.status === 'invalid' ? 'ไม่ถูกต้อง' : 'ยังไม่ส่ง';
                const fileDetails = result.files.map(f => f.name).join('; ');
                csvContent += `${result.studentId},${status},${result.files.length},"${fileDetails}"\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "student-submission-report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ฟังก์ชันสร้าง PDF
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // หัวข้อ
            doc.setFontSize(20);
            doc.text('Student Submission Report', 20, 20);
            
            const date = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            doc.setFontSize(12);
            doc.text(`Generated: ${date}`, 20, 30);
            
            // สรุปผล
            const total = allResults.length;
            const found = allResults.filter(r => r.status === 'found').length;
            const notFound = allResults.filter(r => r.status === 'not_found').length;
            const invalid = allResults.filter(r => r.status === 'invalid').length;
            const totalFiles = allResults.reduce((sum, r) => sum + r.files.length, 0);
            
            doc.setFontSize(16);
            doc.text('Summary', 20, 45);
            doc.setFontSize(12);
            doc.text(`Total Students: ${total}`, 20, 55);
            doc.text(`Submitted: ${found}`, 20, 65);
            doc.text(`Not Submitted: ${notFound + invalid}`, 20, 75);
            doc.text(`Total Files: ${totalFiles}`, 20, 85);
            
            // รายละเอียด
            doc.setFontSize(16);
            doc.text('Details', 20, 100);
            
            let y = 110;
            doc.setFontSize(10);
            
            allResults.forEach(result => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                const status = result.status === 'found' ? 'SUBMITTED' : result.status === 'invalid' ? 'INVALID' : 'NOT SUBMITTED';
                doc.text(`${result.studentId}: ${status}`, 20, y);
                y += 10;
                
                if (result.files.length > 0) {
                    result.files.forEach(file => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        const fileDate = new Date(file.modifiedTime).toLocaleDateString('th-TH');
                        doc.text(`  - ${file.name} (${file.type.toUpperCase()}) - ${fileDate}`, 25, y);
                        y += 8;
                    });
                }
                y += 5;
            });
            
            doc.save('student-submission-report.pdf');
        }

        // Event listeners
        document.getElementById('studentId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkSingleStudent();
            }
        });

        document.getElementById('studentId').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // เริ่มต้นอัพเดตตัวกรอง
        updateSelectedFilters();
    </script>
</body>
</html>
