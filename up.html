<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบการส่งรูปภาพนักศึกษา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Prompt', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="30" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .card-shadow {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .icon-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .filter-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .status-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .status-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .status-similar {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .status-nocode {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        .export-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .export-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }
        .export-btn.green {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .export-btn.green:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }
        .export-btn.purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        .export-btn.purple:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .animate-bounce-slow {
            animation: bounce-slow 3s ease-in-out infinite;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .filter-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .similar-match {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-left: 4px solid #3b82f6;
        }
        .no-code-file {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-left: 4px solid #6b7280;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="gradient-bg py-12">
        <div class="container mx-auto px-4">
            <div class="text-center relative z-10">
                <div class="animate-bounce-slow inline-block">
                    <i class="fas fa-cloud-upload-alt text-6xl text-white/80 mb-4"></i>
                </div>
                <h1 class="text-5xl font-bold text-white mb-4">
                    ระบบตรวจสอบการส่งรูปภาพนักศึกษา
                </h1>
                <p class="text-white/90 text-xl font-medium">
                    ตรวจสอบสถานะการส่งรูปภาพใน Google Drive พร้อมระบบกรองขั้นสูง
                </p>
                <div class="mt-6 flex justify-center gap-4">
                    <div class="stat-card px-6 py-3 rounded-2xl">
                        <i class="fas fa-users text-white/80 mr-2"></i>
                        <span class="text-white font-semibold">รองรับหลายรายการ</span>
                    </div>
                    <div class="stat-card px-6 py-3 rounded-2xl">
                        <i class="fas fa-filter text-white/80 mr-2"></i>
                        <span class="text-white font-semibold">กรองไฟล์ได้</span>
                    </div>
                    <div class="stat-card px-6 py-3 rounded-2xl">
                        <i class="fas fa-file-pdf text-white/80 mr-2"></i>
                        <span class="text-white font-semibold">ส่งออกหลายรูปแบบ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- การตั้งค่า -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-cogs icon-gradient text-3xl mr-3"></i>
                การตั้งค่า Google Drive
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-2">
                    <label class="flex items-center text-lg font-semibold text-gray-700 mb-3">
                        <i class="fas fa-folder text-blue-600 mr-2"></i>
                        Google Drive Folder ID
                    </label>
                    <input type="text" id="folderId" placeholder="ใส่ Folder ID ของ Google Drive"
                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-lg">
                    <p class="text-sm text-gray-500 mt-2 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        หา ID จาก URL: /folders/[ID นี่]
                    </p>
                </div>
                <div class="space-y-2">
                    <label class="flex items-center text-lg font-semibold text-gray-700 mb-3">
                        <i class="fas fa-key text-green-600 mr-2"></i>
                        Google API Key
                    </label>
                    <input type="password" id="apiKey" placeholder="ใส่ Google API Key"
                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-green-500/20 focus:border-green-500 transition-all duration-300 text-lg">
                    <p class="text-sm text-gray-500 mt-2 flex items-center">
                        <i class="fas fa-shield-alt mr-2"></i>
                        ต้องมีสิทธิ์ใน Google Drive API
                    </p>
                </div>
            </div>
        </div>

        <!-- ตัวเลือกการกรอง -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-filter icon-gradient text-3xl mr-3"></i>
                ตัวเลือกการกรอง
            </h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- ประเภทไฟล์ -->
                <div class="filter-section">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-image text-purple-600 mr-2"></i>
                        ประเภทไฟล์
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-images text-blue-600 mr-2"></i>
                                <span class="text-sm font-medium">รูปภาพ</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includeImages" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                                <span class="text-sm font-medium">PDF</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includePdf">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-file-word text-blue-700 mr-2"></i>
                                <span class="text-sm font-medium">เอกสาร</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="includeDoc">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- สถานะ -->
                <div class="filter-section">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-tasks text-green-600 mr-2"></i>
                        สถานะ
                    </h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="text-sm font-medium">ส่งแล้ว</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showSubmitted" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-times-circle text-red-600 mr-2"></i>
                                <span class="text-sm font-medium">ยังไม่ส่ง</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showNotSubmitted" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="text-sm font-medium">คล้ายคลึง</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showSimilar" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ช่วงเวลา -->
                <div class="filter-section">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                        ช่วงเวลา
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เริ่มต้น</label>
                            <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่สิ้นสุด</label>
                            <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                </div>

                <!-- การเรียงลำดับ -->
                <div class="filter-section">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-sort-amount-down text-orange-600 mr-2"></i>
                        การเรียงลำดับ
                    </h3>
                    <div class="space-y-3">
                        <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="studentId">รหัสนักศึกษา</option>
                            <option value="status">สถานะ</option>
                            <option value="fileCount">จำนวนไฟล์</option>
                            <option value="modifiedTime">วันที่แก้ไข</option>
                        </select>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <span class="text-sm font-medium">จากมากไปน้อย</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="sortDesc" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ช่องกรอกรหัสนักศึกษา -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-user-graduate icon-gradient text-3xl mr-3"></i>
                ตรวจสอบรหัสนักศึกษา
            </h2>
            <div class="grid md:grid-cols-4 gap-6">
                <div class="md:col-span-3">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">รหัสนักศึกษา (10 หลัก)</label>
                    <input type="text" id="studentId" placeholder="เช่น 6514567890" maxlength="10"
                           class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all duration-300 text-lg">
                </div>
                <div class="flex items-end">
                    <button onclick="checkSingleStudent()" 
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300 font-semibold text-lg flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i>
                        ตรวจสอบ
                    </button>
                </div>
            </div>
        </div>

        <!-- ตรวจสอบหลายรายการ -->
        <div class="glass-effect rounded-2xl card-shadow p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-users icon-gradient text-3xl mr-3"></i>
                ตรวจสอบหลายรายการ
            </h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <label class="block text-lg font-semibold text-gray-700 mb-3">รายการรหัสนักศึกษา</label>
                    <textarea id="studentList" placeholder="ใส่รหัสนักศึกษาแต่ละบรรทัด&#10;6514567890&#10;6514567891&#10;6514567892" 
                              rows="12" class="w-full px-6 py-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all duration-300 text-lg"></textarea>
                </div>
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl border-2 border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-tags text-indigo-600 mr-2"></i>
                            ตัวกรองที่เลือก
                        </h3>
                        <div id="selectedFilters" class="flex flex-wrap gap-2 mb-4">
                            <!-- ตัวกรองจะแสดงที่นี่ -->
                        </div>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>
                            ปรับตัวเลือกการกรองด้านบนเพื่อเปลี่ยนเงื่อนไขการค้นหา
                        </div>
                    </div>
                    <button onclick="checkMultipleStudents()" 
                            class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-semibold text-lg flex items-center justify-center">
                        <i class="fas fa-search-plus mr-2"></i>
                        ตรวจสอบทั้งหมด
                    </button>
                </div>
            </div>
        </div>

        <!-- ผลการตรวจสอบ -->
        <div id="results" class="glass-effect rounded-2xl card-shadow p-8 mb-8" style="display: none;">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-chart-bar icon-gradient text-3xl mr-3"></i>
                    ผลการตรวจสอบ
                </h2>
                <div class="flex gap-3">
                    <button onclick="exportToExcel()" 
                            class="export-btn green">
                        <i class="fas fa-file-excel mr-2"></i>
                        Excel
                    </button>
                    <button onclick="exportToPNG()" 
                            class="export-btn purple">
                        <i class="fas fa-image mr-2"></i>
                        PNG
                    </button>
                    <button onclick="generatePDF()" 
                            class="export-btn">
                        <i class="fas fa-file-pdf mr-2"></i>
                        PDF
                    </button>
                </div>
            </div>
            <div id="summary" class="grid md:grid-cols-2 lg:grid-cols-6 gap-4 mb-8"></div>
            <div id="resultList"></div>
        </div>

        <!-- ไฟล์ที่ไม่มีรหัสนักศึกษา -->
        <div id="orphanFiles" class="glass-effect rounded-2xl card-shadow p-8 mb-8" style="display: none;">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-file-question icon-gradient text-3xl mr-3"></i>
                ไฟล์ที่ไม่มีรหัสนักศึกษา
            </h2>
            <div id="orphanFilesList"></div>
        </div>

        <!-- โหลดดิ้ง -->
        <div id="loading" class="text-center py-16" style="display: none;">
            <div class="pulse-animation">
                <div class="inline-block">
                    <i class="fas fa-spinner fa-spin text-6xl text-blue-600"></i>
                </div>
            </div>
            <p class="mt-6 text-gray-600 text-xl font-medium">กำลังตรวจสอบข้อมูล...</p>
            <div class="mt-4 w-64 bg-gray-200 rounded-full h-3 mx-auto">
                <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <script>
let allResults = [];
        let allFiles = [];
        let orphanFiles = [];

        // อัพเดตตัวกรองที่เลือก
        function updateSelectedFilters() {
            const filtersDiv = document.getElementById('selectedFilters');
            const filters = [];
            
            if (document.getElementById('includeImages').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-images"></i> รูปภาพ</span>');
            }
            if (document.getElementById('includePdf').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-file-pdf"></i> PDF</span>');
            }
            if (document.getElementById('includeDoc').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-file-word"></i> เอกสาร</span>');
            }
            
            // ตัวกรองสถานะ
            if (document.getElementById('showSubmitted').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-check-circle"></i> ส่งแล้ว</span>');
            }
            if (document.getElementById('showNotSubmitted').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-times-circle"></i> ยังไม่ส่ง</span>');
            }
            if (document.getElementById('showSimilar').checked) {
                filters.push('<span class="filter-tag"><i class="fas fa-exclamation-triangle"></i> คล้ายคลึง</span>');
            }
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate) {
                filters.push(`<span class="filter-tag"><i class="fas fa-calendar-alt"></i> จาก ${startDate}</span>`);
            }
            if (endDate) {
                filters.push(`<span class="filter-tag"><i class="fas fa-calendar-alt"></i> ถึง ${endDate}</span>`);
            }
            
            const sortBy = document.getElementById('sortBy').value;
            const sortDesc = document.getElementById('sortDesc').checked;
            filters.push(`<span class="filter-tag"><i class="fas fa-sort"></i> เรียงตาม${getSortLabel(sortBy)} ${sortDesc ? 'มาก→น้อย' : 'น้อย→มาก'}</span>`);
            
            filtersDiv.innerHTML = filters.join(' ');
        }

        function getSortLabel(sortBy) {
            const labels = {
                'studentId': 'รหัสนักศึกษา',
                'status': 'สถานะ',
                'fileCount': 'จำนวนไฟล์',
                'modifiedTime': 'วันที่แก้ไข'
            };
            return labels[sortBy] || sortBy;
        }

        // ฟังก์ชันตรวจสอบรูปแบบรหัสนักศึกษา
        function isValidStudentId(studentId) {
            return /^\d{10}$/.test(studentId);
        }

        // ฟังก์ชันตรวจสอบไฟล์ประเภทใด
        function getFileType(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext)) {
                return 'image';
            } else if (['pdf'].includes(ext)) {
                return 'pdf';
            } else if (['doc', 'docx', 'txt', 'rtf'].includes(ext)) {
                return 'document';
            }
            return 'other';
        }

        // ฟังก์ชันตรวจสอบไฟล์ที่ควรรวมไว้
        function shouldIncludeFile(fileName) {
            const fileType = getFileType(fileName);
            const includeImages = document.getElementById('includeImages').checked;
            const includePdf = document.getElementById('includePdf').checked;
            const includeDoc = document.getElementById('includeDoc').checked;
            
            return (fileType === 'image' && includeImages) ||
                   (fileType === 'pdf' && includePdf) ||
                   (fileType === 'document' && includeDoc);
        }

        // ฟังก์ชันดึงไฟล์จาก Google Drive
        async function fetchDriveFiles() {
            const folderId = document.getElementById('folderId').value;
            const apiKey = document.getElementById('apiKey').value;
            
            if (!folderId || !apiKey) {
                alert('กรุณาใส่ Folder ID และ API Key');
                return [];
            }
            
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${apiKey}&fields=files(id,name,modifiedTime,size)`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                return data.files || [];
            } catch (error) {
                console.error('Error fetching files:', error);
                alert('เกิดข้อผิดพลาดในการดึงไฟล์: ' + error.message);
                return [];
            }
        }

        // ฟังก์ชันตรวจสอบรหัสนักศึกษาเดี่ยว
        async function checkSingleStudent() {
            const studentId = document.getElementById('studentId').value.trim();
            
            if (!isValidStudentId(studentId)) {
                alert('รหัสนักศึกษาต้องเป็นตัวเลข 10 หลัก');
                return;
            }
            
            await checkStudents([studentId]);
        }

        // ฟังก์ชันตรวจสอบหลายรายการ
        async function checkMultipleStudents() {
            const studentList = document.getElementById('studentList').value.trim();
            
            if (!studentList) {
                alert('กรุณาใส่รหัสนักศึกษา');
                return;
            }
            
            const studentIds = studentList.split('\n')
                .map(id => id.trim())
                .filter(id => id.length > 0);
            
            const invalidIds = studentIds.filter(id => !isValidStudentId(id));
            
            if (invalidIds.length > 0) {
                alert(`รหัสนักศึกษาไม่ถูกต้อง: ${invalidIds.join(', ')}`);
                return;
            }
            
            await checkStudents(studentIds);
        }

        // ฟังก์ชันหลักในการตรวจสอบ
        async function checkStudents(studentIds) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('orphanFiles').style.display = 'none';
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '10%';
            
            try {
                // ดึงไฟล์ทั้งหมด
                const files = await fetchDriveFiles();
                allFiles = files;
                progressBar.style.width = '30%';
                
                // แยกไฟล์และประมวลผล
                const results = [];
                orphanFiles = [];
                
                // ค้นหารหัสนักศึกษาในชื่อไฟล์
                const fileMap = new Map();
                const studentFileMap = new Map();
                
                files.forEach(file => {
                    if (!shouldIncludeFile(file.name)) return;
                    
                    fileMap.set(file.id, file);
                    
                    // หารหัสนักศึกษาในชื่อไฟล์
                    const studentIdMatch = file.name.match(/(\d{10})/);
                    if (studentIdMatch) {
                        const foundStudentId = studentIdMatch[1];
                        if (!studentFileMap.has(foundStudentId)) {
                            studentFileMap.set(foundStudentId, []);
                        }
                        studentFileMap.get(foundStudentId).push(file);
                    } else {
                        orphanFiles.push(file);
                    }
                });
                
                progressBar.style.width = '60%';
                
                // ประมวลผลสำหรับแต่ละนักศึกษา
                studentIds.forEach(studentId => {
                    const studentFiles = studentFileMap.get(studentId) || [];
                    const result = {
                        studentId,
                        files: studentFiles,
                        fileCount: studentFiles.length,
                        status: studentFiles.length > 0 ? 'submitted' : 'not_submitted',
                        lastModified: studentFiles.length > 0 ? 
                            Math.max(...studentFiles.map(f => new Date(f.modifiedTime).getTime())) : null
                    };
                    
                    // ตรวจสอบไฟล์ที่คล้ายคลึง
                    if (studentFiles.length > 1) {
                        result.status = 'similar';
                    }
                    
                    results.push(result);
                });
                
                progressBar.style.width = '90%';
                
                // กรองและเรียงลำดับผลลัพธ์
                allResults = filterAndSortResults(results);
                
                progressBar.style.width = '100%';
                
                // แสดงผลลัพธ์
                displayResults();
                
            } catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ฟังก์ชันกรองและเรียงลำดับ
        function filterAndSortResults(results) {
            const showSubmitted = document.getElementById('showSubmitted').checked;
            const showNotSubmitted = document.getElementById('showNotSubmitted').checked;
            const showSimilar = document.getElementById('showSimilar').checked;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filteredResults = results.filter(result => {
                // กรองตามสถานะ
                if (result.status === 'submitted' && !showSubmitted) return false;
                if (result.status === 'not_submitted' && !showNotSubmitted) return false;
                if (result.status === 'similar' && !showSimilar) return false;
                
                // กรองตามวันที่
                if (result.lastModified) {
                    const fileDate = new Date(result.lastModified);
                    if (startDate && fileDate < new Date(startDate)) return false;
                    if (endDate && fileDate > new Date(endDate + 'T23:59:59')) return false;
                }
                
                return true;
            });
            
            // เรียงลำดับ
            const sortBy = document.getElementById('sortBy').value;
            const sortDesc = document.getElementById('sortDesc').checked;
            
            filteredResults.sort((a, b) => {
                let aValue, bValue;
                
                switch (sortBy) {
                    case 'studentId':
                        aValue = a.studentId;
                        bValue = b.studentId;
                        break;
                    case 'status':
                        aValue = a.status;
                        bValue = b.status;
                        break;
                    case 'fileCount':
                        aValue = a.fileCount;
                        bValue = b.fileCount;
                        break;
                    case 'modifiedTime':
                        aValue = a.lastModified || 0;
                        bValue = b.lastModified || 0;
                        break;
                    default:
                        aValue = a.studentId;
                        bValue = b.studentId;
                }
                
                if (typeof aValue === 'string') {
                    return sortDesc ? bValue.localeCompare(aValue) : aValue.localeCompare(bValue);
                } else {
                    return sortDesc ? bValue - aValue : aValue - bValue;
                }
            });
            
            return filteredResults;
        }

        // ฟังก์ชันแสดงผลลัพธ์
        function displayResults() {
            document.getElementById('results').style.display = 'block';
            
            // แสดงสรุปผล
            displaySummary();
            
            // แสดงรายการผลลัพธ์
            displayResultList();
            
            // แสดงไฟล์ที่ไม่มีรหัสนักศึกษา
            if (orphanFiles.length > 0) {
                displayOrphanFiles();
            }
        }

        // ฟังก์ชันแสดงสรุปผล
        function displaySummary() {
            const summaryDiv = document.getElementById('summary');
            
            const totalCount = allResults.length;
            const submittedCount = allResults.filter(r => r.status === 'submitted').length;
            const notSubmittedCount = allResults.filter(r => r.status === 'not_submitted').length;
            const similarCount = allResults.filter(r => r.status === 'similar').length;
            const orphanCount = orphanFiles.length;
            
            summaryDiv.innerHTML = `
                <div class="stat-card p-6 rounded-xl text-center">
                    <i class="fas fa-users text-4xl text-blue-600 mb-3"></i>
                    <div class="text-3xl font-bold text-gray-800">${totalCount}</div>
                    <div class="text-gray-600 font-medium">รายการทั้งหมด</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <i class="fas fa-check-circle text-4xl text-green-600 mb-3"></i>
                    <div class="text-3xl font-bold text-gray-800">${submittedCount}</div>
                    <div class="text-gray-600 font-medium">ส่งแล้ว</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <i class="fas fa-times-circle text-4xl text-red-600 mb-3"></i>
                    <div class="text-3xl font-bold text-gray-800">${notSubmittedCount}</div>
                    <div class="text-gray-600 font-medium">ยังไม่ส่ง</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-600 mb-3"></i>
                    <div class="text-3xl font-bold text-gray-800">${similarCount}</div>
                    <div class="text-gray-600 font-medium">คล้ายคลึง</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <i class="fas fa-file-question text-4xl text-gray-600 mb-3"></i>
                    <div class="text-3xl font-bold text-gray-800">${orphanCount}</div>
                    <div class="text-gray-600 font-medium">ไฟล์ไม่มีรหัส</div>
                </div>
                <div class="stat-card p-6 rounded-xl text-center">
                    <i class="fas fa-percentage text-4xl text-purple-600 mb-3"></i>
                    <div class="text-3xl font-bold text-gray-800">${totalCount > 0 ? Math.round((submittedCount / totalCount) * 100) : 0}%</div>
                    <div class="text-gray-600 font-medium">อัตราส่ง</div>
                </div>
            `;
        }

        // ฟังก์ชันแสดงรายการผลลัพธ์
        function displayResultList() {
            const resultListDiv = document.getElementById('resultList');
            
            if (allResults.length === 0) {
                resultListDiv.innerHTML = '<div class="text-center py-8 text-gray-500">ไม่มีข้อมูลที่ตรงกับเงื่อนไข</div>';
                return;
            }
            
            let html = '<div class="space-y-4">';
            
            allResults.forEach(result => {
                const statusInfo = getStatusInfo(result.status);
                const lastModifiedText = result.lastModified ? 
                    new Date(result.lastModified).toLocaleDateString('th-TH', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'ไม่มีข้อมูล';
                
                html += `
                    <div class="bg-white p-6 rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-all duration-300">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div class="flex items-center mb-2 md:mb-0">
                                <i class="fas fa-user-circle text-3xl text-blue-600 mr-3"></i>
                                <div>
                                    <div class="text-xl font-bold text-gray-800">${result.studentId}</div>
                                    <div class="text-gray-600">${result.fileCount} ไฟล์</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="${statusInfo.badgeClass}">
                                    <i class="${statusInfo.icon}"></i>
                                    ${statusInfo.text}
                                </div>
                            </div>
                        </div>
                        
                        ${result.files.length > 0 ? `
                            <div class="border-t pt-4">
                                <h4 class="font-semibold text-gray-700 mb-2">ไฟล์ที่พบ:</h4>
                                <div class="grid md:grid-cols-2 gap-2">
                                    ${result.files.map(file => `
                                        <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                                            <i class="fas fa-file text-blue-600 mr-2"></i>
                                            <span class="text-sm text-gray-700 truncate">${file.name}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-2 text-sm text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>
                                    แก้ไขล่าสุด: ${lastModifiedText}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultListDiv.innerHTML = html;
        }

        // ฟังก์ชันแสดงไฟล์ที่ไม่มีรหัสนักศึกษา
        function displayOrphanFiles() {
            document.getElementById('orphanFiles').style.display = 'block';
            const orphanListDiv = document.getElementById('orphanFilesList');
            
            if (orphanFiles.length === 0) {
                orphanListDiv.innerHTML = '<div class="text-center py-8 text-gray-500">ไม่มีไฟล์ที่ไม่มีรหัสนักศึกษา</div>';
                return;
            }
            
            let html = '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">';
            
            orphanFiles.forEach(file => {
                html += `
                    <div class="no-code-file p-4 rounded-xl">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-file text-gray-600 mr-2"></i>
                            <div class="font-medium text-gray-800 truncate">${file.name}</div>
                        </div>
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-clock mr-1"></i>
                            ${new Date(file.modifiedTime).toLocaleDateString('th-TH')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            orphanListDiv.innerHTML = html;
        }

        // ฟังก์ชันได้ข้อมูลสถานะ
        function getStatusInfo(status) {
            switch (status) {
                case 'submitted':
                    return {
                        text: 'ส่งแล้ว',
                        icon: 'fas fa-check-circle',
                        badgeClass: 'status-badge status-success'
                    };
                case 'not_submitted':
                    return {
                        text: 'ยังไม่ส่ง',
                        icon: 'fas fa-times-circle',
                        badgeClass: 'status-badge status-error'
                    };
                case 'similar':
                    return {
                        text: 'คล้ายคลึง',
                        icon: 'fas fa-exclamation-triangle',
                        badgeClass: 'status-badge status-similar'
                    };
                default:
                    return {
                        text: 'ไม่ทราบ',
                        icon: 'fas fa-question-circle',
                        badgeClass: 'status-badge status-nocode'
                    };
            }
        }

        // ฟังก์ชันส่งออก Excel
        function exportToExcel() {
            let csvContent = "รหัสนักศึกษา,สถานะ,จำนวนไฟล์,วันที่แก้ไขล่าสุด,ชื่อไฟล์\n";
            
            allResults.forEach(result => {
                const statusText = getStatusInfo(result.status).text;
                const lastModified = result.lastModified ? 
                    new Date(result.lastModified).toLocaleDateString('th-TH') : 'ไม่มีข้อมูล';
                const fileNames = result.files.map(f => f.name).join('; ');
                
                csvContent += `${result.studentId},${statusText},${result.fileCount},${lastModified},"${fileNames}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `student_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ฟังก์ชันส่งออก PNG
        async function exportToPNG() {
            const element = document.getElementById('results');
            const canvas = await html2canvas(element, {
                backgroundColor: '#ffffff',
                scale: 2
            });
            
            const link = document.createElement('a');
            link.download = `student_report_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // ฟังก์ชันส่งออก PDF
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // เพิ่มฟอนต์ภาษาไทย (ถ้ามี)
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.text('Student Image Submission Report', 20, 20);
            
            let yPosition = 40;
            
            // สรุปผล
            doc.setFontSize(12);
            doc.text(`Total Students: ${allResults.length}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Submitted: ${allResults.filter(r => r.status === 'submitted').length}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Not Submitted: ${allResults.filter(r => r.status === 'not_submitted').length}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Similar: ${allResults.filter(r => r.status === 'similar').length}`, 20, yPosition);
            yPosition += 20;
            
            // รายละเอียด
            doc.setFontSize(10);
            allResults.forEach(result => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const statusText = getStatusInfo(result.status).text;
                doc.text(`${result.studentId} - ${statusText} (${result.fileCount} files)`, 20, yPosition);
                yPosition += 8;
            });
            
            doc.save(`student_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // อัพเดตตัวกรองเมื่อมีการเปลี่ยนแปลง
            const filterElements = [
                'includeImages', 'includePdf', 'includeDoc',
                'showSubmitted', 'showNotSubmitted', 'showSimilar',
                'startDate', 'endDate', 'sortBy', 'sortDesc'
            ];
            
            filterElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateSelectedFilters);
                }
            });
            
            // อัพเดตตัวกรองครั้งแรก
            updateSelectedFilters();
            
            // ตรวจสอบรูปแบบรหัสนักศึกษา
            document.getElementById('studentId').addEventListener('input', function() {
                const value = this.value.replace(/\D/g, '');
                if (value.length > 10) {
                    this.value = value.slice(0, 10);
                } else {
                    this.value = value;
                }
            });
        });

    </script>
</body>
</html>
